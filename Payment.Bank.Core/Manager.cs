using Gma.QrCodeNet.Encoding;
using Gma.QrCodeNet.Encoding.Windows.Render;
using Microsoft.Azure.NotificationHubs;
using MySql.Data.MySqlClient;
using Newtonsoft.Json;
using Payment.Bank.Core.Common;
using Payment.Bank.Core.Entity;
using Payment.Bank.Core.Model;
using Payment.Bank.Core.Model.Request;
using Payment.Bank.Core.Properties;
using Payment.Bank.Core.Services;
using Payment.Bank.Entity;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Data.Entity;
using System.Diagnostics;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Reflection;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Web;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Xml.Linq;

namespace Payment.Bank.Core
{

    public class Manager
    {
        private DAL.Context db;
        string internalKey = "http://softarch.ddns.net";
        DbConnection connection;
        int Timeout = 3600;


        #region Credit Card

        public List<YearModel> YearGet()
        {
            try
            {
                List<YearModel> years = new List<YearModel>();
                for (int i = DateTime.Now.Year; i <= DateTime.Now.Year + 5; i++)
                {
                    years.Add(new YearModel { YearID = i, Year = i });
                }
                return years;
            }
            catch (Exception ex)
            {
                return new List<YearModel>();
            }
        }

        public List<MonthModel> MonthGet()
        {
            try
            {
                List<MonthModel> months = new List<MonthModel>();

                months.Add(new MonthModel { MonthID = 1, Month = "01-ENE" });
                months.Add(new MonthModel { MonthID = 2, Month = "02-FEB" });
                months.Add(new MonthModel { MonthID = 3, Month = "03-MAR" });
                months.Add(new MonthModel { MonthID = 4, Month = "04-ABR" });
                months.Add(new MonthModel { MonthID = 5, Month = "05-MAY" });
                months.Add(new MonthModel { MonthID = 6, Month = "06-JUN" });
                months.Add(new MonthModel { MonthID = 7, Month = "07-JUL" });
                months.Add(new MonthModel { MonthID = 8, Month = "08-AGO" });
                months.Add(new MonthModel { MonthID = 9, Month = "09-SEP" });
                months.Add(new MonthModel { MonthID = 10, Month = "10-OCT" });
                months.Add(new MonthModel { MonthID = 11, Month = "11-NOV" });
                months.Add(new MonthModel { MonthID = 12, Month = "12-DIC" });

                return months;
            }
            catch (Exception ex)
            {
                return new List<MonthModel>();
            }
        }

        #endregion

        #region Security

        public DateTime HostDateTime(string EmpresaID = "", string LicenciaID = "")
        {
            return Task.Run(async () =>
            {
                var row = await getDateTime(EmpresaID, LicenciaID);
                return row;
            }).Result;
        }

        private async Task<DateTime> getDateTime(string EmpresaID, string LicenciaID)
        {
            try
            {
                var client = new HttpClient();

                client.DefaultRequestHeaders.Accept.Clear();
                client.DefaultRequestHeaders.Add("Appkey", EmpresaID);
                client.DefaultRequestHeaders.Add("MessageHash", Common.Security.GetHash(EmpresaID + internalKey, Common.HashType.MD5));
                client.DefaultRequestHeaders.Add("LicenciaID", LicenciaID);
                client.DefaultRequestHeaders.Add("Build", "0");

                client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

                client.Timeout = new TimeSpan(0, 10, 0);
                client.BaseAddress = new Uri(internalKey);
                var response = await client.GetAsync($"/api/i-Bank/getDateTime");
                if (!response.IsSuccessStatusCode)
                {
                    return DateTime.Now;
                }
                var result = await response.Content.ReadAsStringAsync();
                return JsonConvert.DeserializeObject<DateTime>(result);
            }
            catch
            {
                return DateTime.Now;
            }
        }

        public bool HasConnection()
        {
            try
            {
                HttpWebRequest request = (HttpWebRequest)WebRequest.Create("http://www.google.com");
                request.Timeout = 1000;
                request.Credentials = CredentialCache.DefaultNetworkCredentials;
                HttpWebResponse response = (HttpWebResponse)request.GetResponse();

                if (response.StatusCode == HttpStatusCode.OK)
                    return true;
                else
                    return false;
            }
            catch
            {
                return false;
            }
        }

        public bool GetKey(string EmpresaID, string Key)
        {
            bool result = Convert.ToBoolean(db.clsDispositivosBE.Where(x => x.EmpresaID == EmpresaID && x.DispositivoID == Key && x.EstadoID == true).Count());
            return result;
        }


        public OperationResult DispositivosCreate(string EmpresaID, string Key, string Dispositivo, bool EstadoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDispositivosBE.Where(x => x.DispositivoID == Key).FirstOrDefault();
                if (row == null)
                {
                    var BE = db.clsEmpresasBE.Where(x => x.EmpresaID == EmpresaID).FirstOrDefault();
                    int max = 0;
                    for (int i = 0; i <= 1000; i++)
                    {
                        if (Common.FingerPrint.GetHash(i.ToString()) == BE.Device)
                        {
                            max = i; break;
                        }
                    }
                    if (BE.Dispositivos.Count() < max)
                    {
                        db.clsDispositivosBE.Add(new clsDispositivosBE { DispositivoID = Key, Fecha = DateTime.Now, EmpresaID = EmpresaID, Dispositivo = Dispositivo, EstadoID = EstadoID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                        db.SaveChanges();
                        result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                    }
                    else
                    {
                        result = new OperationResult { ResponseCode = "01", ResponseMessage = "MaximumLicenseAllowed" };
                    }
                }
                else
                {
                    result = DispositivosUpdate(Key, EmpresaID, Dispositivo, row.EstadoID, Usuario);
                }
                return result;

            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DispositivosUpdate(string DispositivoID, string EmpresaID, string Dispositivo, bool EstadoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDispositivosBE.Where(x => x.DispositivoID == DispositivoID).FirstOrDefault();
                row.EmpresaID = EmpresaID;
                row.Dispositivo = Dispositivo;
                row.EstadoID = EstadoID;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public clsDispositivosBE DispositivosGetByDispositivoID(string DispositivoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsDispositivosBE.Where(x => x.DispositivoID == DispositivoID).FirstOrDefault();
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                return new clsDispositivosBE();
            }
        }

        public OperationResult DispositivosDelete(string DispositivoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDispositivosBE.Where(x => x.DispositivoID == DispositivoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsDispositivosBE> DispositivosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsDispositivosBE.Where(x => x.DispositivoID.Contains(Search) || x.Dispositivo.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsDispositivosBE.ToList();
                }
            }
            catch
            {
                return new List<clsDispositivosBE>();
            }
        }


        #endregion

        #region Usuarios

        public clsUsuariosBE LogIn(string Correo, string Contraseña)
        {
            try
            {
                db = new DAL.Context();
                var BE = db.clsPersonasBE.Where(x => x.Correo == Correo || x.Documento == Correo).ToList();
                string pwdEncoded = Common.Security.GetHash(BE.FirstOrDefault().Documento + Contraseña, Common.HashType.SHA256);
                pwdEncoded = Common.FingerPrint.GetHash(pwdEncoded);
                return db.clsUsuariosBE.Where(x => x.Personas.Correo == Correo && x.Contraseña == pwdEncoded).FirstOrDefault();
            }
            catch (Exception ex)
            {
                return new clsUsuariosBE();
            }
        }


        public string PinGetByDocumento(string Documento, string Contraseña)
        {
            db = new DAL.Context();
            var BE = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();
            string pwdEncoded = Common.Security.GetHash(Documento + Contraseña, Common.HashType.SHA256);
            pwdEncoded = Common.FingerPrint.GetHash(pwdEncoded);
            BE.Pin = pwdEncoded;
            BE.ModificadoPor = Documento;
            BE.FechaModificacion = DateTime.Now;
            db.Entry(BE).State = EntityState.Modified;
            db.SaveChanges();
            return Contraseña.ToString();
        }

        public clsUsuariosBE LogInMovil(string Documento, string Pin)
        {
            try
            {
                db = new DAL.Context();
                string pwdEncoded = Common.Security.GetHash(Documento + Pin, Common.HashType.SHA256);
                pwdEncoded = Common.FingerPrint.GetHash(pwdEncoded);
                var result = db.clsUsuariosBE.Where(x => x.Documento == Documento && x.Pin == pwdEncoded).FirstOrDefault();
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                return null;
            }
        }

        public String Bienvenida()
        {
            try
            {
                db = new DAL.Context();
                String Saludo = String.Empty;

                DataSet ds = new DataSet();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT CASE WHEN CAST(SYSDATE() AS time) BETWEEN '06:00:00:000' and '11:59:59:999' THEN 'goodDays' WHEN CAST(SYSDATE() AS time) BETWEEN '12:00:00:000' and '18:59:59:999' THEN 'goodAfternoom' ELSE 'goodNight' END as Saludo";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;

                MySqlDataReader drPersonas = cm.ExecuteReader();
                while (drPersonas.Read())
                {
                    Saludo = drPersonas["Saludo"].ToString();
                }

                return Saludo;
            }
            catch
            {
                return string.Empty;
            }
        }

        public OperationResult UsuariosCreate(string Documento, string Contraseña, int SucursalID, int JornadaID, int RolID, int LenguajeID, int PreguntaID, string Respuesta, string Pin, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                string pwdEncoded = Common.Security.GetHash(Documento + Contraseña, Common.HashType.SHA256);
                pwdEncoded = Common.FingerPrint.GetHash(pwdEncoded);
                string pinEncoded = Common.Security.GetHash(Documento + Pin, Common.HashType.SHA256);
                pinEncoded = Common.FingerPrint.GetHash(pinEncoded);

                Guid TokenID = Guid.NewGuid();

                db.clsUsuariosBE.Add(new clsUsuariosBE { Documento = Documento, Fecha = DateTime.Now, Contraseña = pwdEncoded, SucursalID = SucursalID, JornadaID = JornadaID, RolID = RolID, LenguajeID = LenguajeID, PreguntaID = PreguntaID, Respuesta = Common.clsMisc.Encryption(Respuesta), EstadoID = true, FechaTokenID = DateTime.Now, TokenID = TokenID.ToString(), Pin = pinEncoded, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult UsuariosUpdate(string Documento, string Contraseña, int SucursalID, int JornadaID, int RolID, int LenguajeID, int PreguntaID, string Respuesta, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();
                row.SucursalID = SucursalID;
                row.RolID = RolID;
                row.PreguntaID = PreguntaID;
                row.Respuesta = Common.clsMisc.Encryption(Respuesta);
                row.LenguajeID = LenguajeID;
                row.JornadaID = JornadaID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PasswordUpdateGetByDocumento(string Documento, string Contraseña, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                string pwdEncoded = Common.Security.GetHash(Documento + Contraseña, Common.HashType.SHA256);
                pwdEncoded = Common.FingerPrint.GetHash(pwdEncoded);

                var row = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();
                row.Contraseña = pwdEncoded;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "Contraseña cambiada correctamente." };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PinUpdateGetByDocumento(string Documento, string Contraseña, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                string pwdEncoded = Common.Security.GetHash(Documento + Contraseña, Common.HashType.SHA256);
                pwdEncoded = Common.FingerPrint.GetHash(pwdEncoded);

                var row = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();
                row.Pin = pwdEncoded;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "Contraseña cambiada correctamente." };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult UsuariosDelete(string Documento)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();
                row.EstadoID = false;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsUsuariosBE> UsuariosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsUsuariosBE.Where(x => x.Personas.Documento.Contains(Search) || x.Personas.Nombres.Contains(Search) || x.Personas.Apellidos.Contains(Search) || x.Personas.Ciudades.Ciudad.Contains(Search) || x.Personas.Correo.Contains(Search) || x.Personas.Telefono.Contains(Search) || x.Personas.Celular.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsUsuariosBE.ToList();
                }
            }
            catch
            {
                return new List<clsUsuariosBE>();
            }
        }

        public clsUsuariosBE UsuariosGetByDocumento(string Documento)
        {
            try
            {
                db = new DAL.Context();
                return db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();

            }
            catch
            {
                return new clsUsuariosBE();
            }
        }

        #endregion

        #region Lenguajes

        public List<clsEtiquetasBE> EtiquetasGet()
        {
            try
            {
                db = new DAL.Context();
                var BE = db.clsEtiquetasBE.ToList();
                return BE;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                return new List<clsEtiquetasBE>();
            }
        }

        #endregion

        #region copias de Seguridad

        public async Task<string> RemoteBackUp(string Url, int SucursalID, string EmpresaID = "", string LicenciaID = "")
        {
            string result = string.Empty;
            try
            {
                db = new DAL.Context();
                //var row = await getBackUp(Url, SucursalID, EmpresaID, LicenciaID);
                return Task.Run(async () =>
                {
                    var row = await getBackUp(Url, SucursalID, EmpresaID, LicenciaID);
                    return row.ToString();
                }).Result;

                return result;
            }
            catch 
            {
                return Task.Run(async () =>
                {
                    return string.Empty;
                }).Result;
            }
        }

        private async Task<string> getBackUp(string url, int SucursalID, string EmpresaID, string LicenciaID)
        {
            try
            {
                var client = new HttpClient();

                client.DefaultRequestHeaders.Accept.Clear();
                client.DefaultRequestHeaders.Add("Appkey", EmpresaID);
                client.DefaultRequestHeaders.Add("MessageHash", Common.Security.GetHash(EmpresaID + internalKey, Common.HashType.MD5));
                client.DefaultRequestHeaders.Add("LicenciaID", LicenciaID);
                client.DefaultRequestHeaders.Add("Build", "0");

                client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

                client.Timeout = new TimeSpan(0, 10, 0);
                client.BaseAddress = new Uri($"http://{url}");//https://localhost:44318/
                var response = await client.GetAsync($"/api/i-Bank/BackUp?SucursalID={SucursalID}");
                if (!response.IsSuccessStatusCode)
                {
                    return string.Empty;
                }

                var result = await response.Content.ReadAsStringAsync();
                string content = JsonConvert.DeserializeObject<string>(result);
                return content;
            }
            catch
            {
                return string.Empty;
            }
        }

        public Task<String> SetRemoteBackUpMySQL0(clsCopiasBE BE)
        {
            try
            {

                string psw = clsMisc.Decoding(BE.Password);
                string conexionString = $"server={BE.Database};user={BE.User};pwd={clsMisc.Decoding(BE.Password)};database={BE.Database};";
                string name = string.Format(BE.Database + "-{0}-{1}-{2}-{3}-{4}-{5}-{6}", DateTime.Now.Day, DateTime.Now.Month, DateTime.Now.Year, DateTime.Now.Hour, DateTime.Now.Minute, DateTime.Now.Second, DateTime.Now.Millisecond);

                DirectoryInfo BackUp = new DirectoryInfo(Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), "BackUp"));


                string temp = Path.Combine(BackUp.FullName, string.Format(BE.Database + "-{0}-{1}-{2}-{3}-{4}-{5}-{6}" + ".sql", DateTime.Now.Day, DateTime.Now.Month, DateTime.Now.Year, DateTime.Now.Hour, DateTime.Now.Minute, DateTime.Now.Second, DateTime.Now.Millisecond));

                string mysqldumpPath = Settings.Default.mysqldump;
                string arg = $" -h{BE.Host} -u{BE.User} --password={clsMisc.Decoding(BE.Password)} {BE.Database} -r {temp}";


                Process cmd = new Process();
                try
                {
                    ProcessStartInfo StartInfo = new ProcessStartInfo();
                    StartInfo.RedirectStandardError = true;
                    StartInfo.RedirectStandardOutput = true;

                    StartInfo.UseShellExecute = false;
                    StartInfo.CreateNoWindow = true;
                    StartInfo.ErrorDialog = false;

                    //mysqldump...
                    StartInfo.FileName = mysqldumpPath;
                    StartInfo.Arguments = arg;

                    cmd = Process.Start(StartInfo);
                    cmd.WaitForExit();

                    string errors = String.Empty;
                    while (!cmd.StandardError.EndOfStream)
                    {
                        errors += "<p>" + cmd.StandardError.ReadLine() + "</p>";
                    }

                    if (!String.IsNullOrEmpty(errors))
                    {

                    }
                }
                finally
                {
                    cmd.Close();
                    cmd.Dispose();
                }

                //using (Ionic.Zip.ZipFile zip = new Ionic.Zip.ZipFile())
                //{
                //    zip.Password = BE.EmpresaID;
                //    zip.AddDirectory(BackUp.FullName);
                //    zip.Save(Path.Combine(BE.Url, name + ".zip"));
                //}

                //System.IO.DirectoryInfo directoty = new DirectoryInfo(BackUp.FullName);
                //foreach (FileInfo archivo in directoty.GetFiles())
                //{
                //    archivo.Delete();
                //}



                return Task.Run(() =>
                {
                    return name + ".zip";
                });
            }
            catch (Exception ex)
            {
                return Task.Run(() =>
                {
                    return ex.Message + " | Ernesto Ventura" + ex.StackTrace;
                });
            }
            finally
            {

            }
        }

        public Task<String> SetBackUpMySQL(clsCopiasBE BE, bool upload = false)
        {
            
            try
            {
                string url = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), BE.EmpresaID);

                string psw = clsMisc.Decoding(BE.Password);
                //string conexionString = $"server={BE.Host};user={BE.User};pwd={clsMisc.Decoding(BE.Password)};database={BE.Database};";
                string name = string.Format(BE.Database + "-{0}-{1}-{2}-{3}-{4}-{5}-{6}", string.Format("{0:00}", DateTime.Now.Day), string.Format("{0:00}", DateTime.Now.Month), string.Format("{0:0000}", DateTime.Now.Year), string.Format("{0:00}", DateTime.Now.Hour), string.Format("{0:00}", DateTime.Now.Minute), string.Format("{0:00}", DateTime.Now.Second), string.Format("{0:000}", DateTime.Now.Millisecond));

                var BackUp = Directory.CreateDirectory(Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), "Copias"));

                string file = Path.Combine(BE.Url, BackUp.FullName, name + ".sql");

                string temp = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), BackUp.FullName, string.Format(BE.Database + "-{0}-{1}-{2}-{3}-{4}-{5}-{6}" + ".sql", string.Format("{0:00}", DateTime.Now.Day), string.Format("{0:00}", DateTime.Now.Month), string.Format("{0:0000}", DateTime.Now.Year), string.Format("{0:00}", DateTime.Now.Hour), string.Format("{0:00}", DateTime.Now.Minute), string.Format("{0:00}", DateTime.Now.Second), string.Format("{0:000}", DateTime.Now.Millisecond)));

                string mysqldumpPath = Settings.Default.mysqldump;
                string arg = $" -h {BE.Host} -u {BE.User} --password={clsMisc.Decoding(BE.Password)} {BE.Database} -r {temp}";

                List<clsFotografiasBE> photos = new List<clsFotografiasBE>();
                photos = FotografiasGet().ToList();
                if (photos.Count() > 0)
                {
                    FotografiasDeleteAll();
                }

                Process cmd = new Process();
                try
                {
                    ProcessStartInfo StartInfo = new ProcessStartInfo();
                    StartInfo.RedirectStandardError = true;
                    StartInfo.RedirectStandardOutput = true;

                    StartInfo.UseShellExecute = false;
                    StartInfo.CreateNoWindow = true;
                    StartInfo.ErrorDialog = false;

                    //mysqldump...
                    StartInfo.FileName = mysqldumpPath;
                    StartInfo.Arguments = arg;

                    cmd = Process.Start(StartInfo);
                    cmd.WaitForExit();

                    string errors = String.Empty;
                    while (!cmd.StandardError.EndOfStream)
                    {
                        errors += "<p>" + cmd.StandardError.ReadLine() + "</p>";
                    }

                    if (!String.IsNullOrEmpty(errors))
                    {

                    }
                }
                finally
                {
                    cmd.Close();
                    cmd.Dispose();
                }


                foreach (var photo in photos)
                {
                    FotografiasCreate(photo.Documento, photo.Foto, photo.Usuario);
                }

                try
                {
                    using (Ionic.Zip.ZipFile zip = new Ionic.Zip.ZipFile())
                    {
                        zip.Password = BE.EmpresaID;
                        zip.AddDirectory(BackUp.FullName);
                        zip.Save(Path.Combine(BE.Url, name + ".zip"));
                    }
                }
                catch { }

                System.IO.DirectoryInfo directoty = new DirectoryInfo(BackUp.FullName);
                foreach (FileInfo archivo in directoty.GetFiles())
                {
                    archivo.Delete();
                }

                if (upload)
                {
                    clsFtp ftp = new clsFtp();
                    ftp.UploadFile(BE.EmpresaID, Path.Combine(BE.Url, name + ".zip"));
                }

                return Task.Run(() =>
                {
                    return name + ".zip";
                });
            }
            catch (Exception ex)
            {
                return Task.Run(() =>
                {
                 

                    return ex.Message;
                });
            }
            finally
            {

            }
        }

        public Task<String> SetRemoteBackUpMySQL(clsCopiasBE BE, bool upload = false)
        {

            try
            {
                string url = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), BE.EmpresaID);
                DirectoryInfo folder;

                if (!Directory.Exists(url))
                {
                    folder = Directory.CreateDirectory(url);
                }
                else
                {
                    folder = new DirectoryInfo(url);
                }
                BE.Url = folder.FullName;

                var temp = Directory.CreateDirectory(Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), "Copias"));
                string name = string.Format(BE.Database + "-{0}-{1}-{2}-{3}-{4}-{5}-{6}", string.Format("{0:00}", DateTime.Now.Day), string.Format("{0:00}", DateTime.Now.Month), string.Format("{0:0000}", DateTime.Now.Year), string.Format("{0:00}", DateTime.Now.Hour), string.Format("{0:00}", DateTime.Now.Minute), string.Format("{0:00}", DateTime.Now.Second), string.Format("{0:000}", DateTime.Now.Millisecond));
                string filename = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), temp.Name, name + ".sql");

                List<clsFotografiasBE> photos = new List<clsFotografiasBE>();
                photos = FotografiasGet().ToList();
                if (photos.Count() > 0)
                {
                    FotografiasDeleteAll();
                }
                string connectionString = $"server={BE.Host};User Id={BE.User}; Persist Security Info=True;database={BE.Database};password={clsMisc.Decoding(BE.Password)};";
                using (MySqlConnector.MySqlConnection conn = new MySqlConnector.MySqlConnection(connectionString))
                {
                    using (MySqlConnector.MySqlCommand cmd = new MySqlConnector.MySqlCommand())
                    {
                        using (MySqlConnector.MySqlBackup mb = new MySqlConnector.MySqlBackup(cmd))
                        {
                            cmd.Connection = conn;
                            conn.Open();
                            mb.ExportToFile(filename);
                            conn.Close();
                        }
                    }
                }

                foreach (var photo in photos)
                {
                    FotografiasCreate(photo.Documento, photo.Foto, photo.Usuario);
                }

                using (Ionic.Zip.ZipFile zip = new Ionic.Zip.ZipFile())
                {
                    zip.Password = BE.EmpresaID;
                    zip.AddDirectory(temp.FullName);
                    zip.Save(Path.Combine(folder.FullName, name + ".zip"));
                }

                System.IO.DirectoryInfo directoty = new DirectoryInfo(temp.FullName);
                foreach (FileInfo archivo in directoty.GetFiles())
                {
                    archivo.Delete();
                }

                if (upload)
                {
                    clsFtp ftp = new clsFtp();
                    ftp.UploadFile(BE.EmpresaID, Path.Combine(folder.FullName, name + ".zip"));
                }


                return Task.Run(() =>
                {
                    return filename;
                });

            }
            catch (Exception ex)
            {
                return Task.Run(() =>
                {
                    return ex.Message;
                });
            }
        }

        #endregion

        #region Menu
        public List<clsProductosBE> ProductosGet(int RolID)
        {
            db = new DAL.Context();

            var BE = db.clsProductosBE.Where(x => x.Visible == true && x.Permisos.Where(a => a.Visible == true && a.PermisosRoles.Where(s => s.RolID == RolID).Count() > 0).Count() > 0).OrderBy(x => x.Orden).ToList();
            return BE;
        }

        public List<clsPermisosBE> PermisosGetByRolID(int RolID)
        {
            db = new DAL.Context();
            return (from P in db.clsPermisosBE join Pr in db.clsPermisosRolesBE on P.PermisoID equals Pr.PermisoID where P.Visible == true && Pr.RolID == RolID select P).OrderBy(x => x.Orden).ToList();
        }

        public List<clsPermisosRolesBE> PermisosRolesGetByPermisoID(int RolID, int PermisoID)
        {
            db = new DAL.Context();
            return (from P in db.clsPermisosRolesBE where P.RolID == RolID && P.PermisoID == PermisoID select P).ToList();
        }

        #endregion

        #region Remote Host

        public OperationResult HostUpdate()
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                foreach (var item in db.clsPersonasBE.Where(x => x.IsAsync == false).ToList())
                {
                    if (Common.Generic.ValidarDocumento(item.Documento))
                    {
                        Host.DAL.Context cx = new Host.DAL.Context();
                        var row = cx.clsPersonasBE.Where(x => x.Documento == item.Documento).FirstOrDefault();
                        if (!string.IsNullOrEmpty(row.Documento))
                        {
                            if (!string.IsNullOrEmpty(row.Direccion))
                            {
                                row.Direccion = item.Direccion.ToUpper();
                            }

                            if (!string.IsNullOrEmpty(row.Correo))
                            {
                                row.Correo = item.Correo.ToLower();
                            }

                            if (!string.IsNullOrEmpty(item.Telefono))
                            {
                                row.Telefono = item.Telefono;
                            }

                            if (!string.IsNullOrEmpty(item.Celular))
                            {
                                row.OperadorID = item.OperadorID;
                                row.Celular = item.Celular;
                            }
                            cx.Entry(row).State = EntityState.Modified;
                            cx.SaveChanges();
                            Console.WriteLine($"Actualizado Persona {item.Documento}");
                        }
                    }

                    var p = db.clsPersonasBE.Where(x => x.Documento == item.Documento).FirstOrDefault();
                    p.IsAsync = true;
                    db.Entry(p).State = EntityState.Modified;
                    db.SaveChanges();
                }

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult HostUpdateData()
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                Host.DAL.Context cx = new Host.DAL.Context();


                var empresa = db.clsEmpresasBE.FirstOrDefault();
                var row = cx.clsEmpresasBE.Where(x => x.EmpresaID == empresa.EmpresaID).FirstOrDefault();

                row.Empresa = empresa.Empresa;
                row.Direccion = empresa.Sucursales.FirstOrDefault().Direccion;
                row.Telefonos = empresa.Sucursales.FirstOrDefault().Telefonos;
                row.Rnc = empresa.Rnc;
                row.Correo = empresa.Sucursales.FirstOrDefault().Gerentes.Personas.Correo;
                row.Device = empresa.Device;
                row.CSR = empresa.CSR;
                row.Key = empresa.Key;
                //row.Payment = empresa.Payment;
                row.FechaModificacion = DateTime.Now;

                cx.Entry(row).State = EntityState.Modified;
                cx.SaveChanges();
                Console.Clear();
                Console.WriteLine("Update Bussines Data");


                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult HostHistoryData(DateTime Hasta, int SucursalID)
        {
            OperationResult result;
            try
            {
                Console.Clear();
                Console.WriteLine("************** Sync Data **************");
                db = new DAL.Context();

                var Rutas = db.clsRutasBE.ToList();

                foreach (var ruta in Rutas)
                {
                    //Host.Core.Manager core = new Host.Core.Manager();   
                    var ds = PrintListadoDataCreditoGetByFecha(Hasta, SucursalID, ruta.RutaID);
                    int x = 1;
                    List<Host.Entity.clsHistorialBE> BE = new List<Host.Entity.clsHistorialBE>();

                    foreach (DataRow item in ds.Tables["Contratos"].Rows)
                    {
                        if (item["Documento"].ToString().Length == 13)
                        {
                            if (Common.Generic.ValidarDocumento(item["Documento"].ToString()))
                            {
                                var EmpresaID = item["EmpresaID"].ToString();
                                var Documento = item["Documento"].ToString();
                                var ContratoID = int.Parse(item["ContratoID"].ToString());
                                var Fecha = DateTime.Parse(item["Fecha"].ToString());
                                var Vence = DateTime.Parse(item["Vence"].ToString());
                                var Monto = float.Parse(item["Monto"].ToString());
                                var Pagado = float.Parse(item["Pagado"].ToString());
                                var Balance = float.Parse(item["Balance"].ToString());
                                var Cuota = float.Parse(item["Cuota"].ToString());
                                var Cantidad = int.Parse(item["Cantidad"].ToString());
                                var Atraso = float.Parse(item["Atraso"].ToString());

                                float? MontoUltimoPago = null;
                                DateTime? FechaUltimoPago = null;

                                if (!string.IsNullOrEmpty(item["MontoUltimoPago"].ToString()))
                                {
                                    if (float.Parse(item["MontoUltimoPago"].ToString()) > 0)
                                    {
                                        MontoUltimoPago = float.Parse(item["MontoUltimoPago"].ToString());
                                    }
                                }

                                if (!string.IsNullOrEmpty(item["FechaUltimoPago"].ToString()))
                                {
                                    FechaUltimoPago = DateTime.Parse(item["FechaUltimoPago"].ToString());
                                }

                                var Status = item["Status"].ToString();
                                var Usuario = Environment.MachineName;

                                var data = new Payment.Host.Entity.clsHistorialBE { HistorialID = 0, Fecha = Fecha, Atraso = float.Parse(Atraso.ToString()), Balance = float.Parse(Balance.ToString()), Cantidad = Cantidad, ContratoID = ContratoID, Cuota = float.Parse(Cuota.ToString()), Documento = Documento, EmpresaID = EmpresaID, Monto = float.Parse(Monto.ToString()), FechaUltimoPago = FechaUltimoPago, MontoUltimoPago = float.Parse(MontoUltimoPago.ToString()), Pagado = float.Parse(Pagado.ToString()), Status = Status, Vence = Vence, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now };
                                SendHistorial(data);
                            }

                        }

                    }

                }

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public OperationResult SendHistorial(Payment.Host.Entity.clsHistorialBE data)
        {
            try
            {
                return Task.Run(async () =>
                {
                    var row = await getHistorialGetByEmpresaID(data);
                    if (row.ResponseCode == "00")
                    {
                        Console.WriteLine("Sending {0} {1}", data.Documento, data.Status);
                    }
                    return row;
                }).Result;

            }
            catch (Exception ex)
            {
                return new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
            }
        }



        private async Task<OperationResult> getHistorialGetByEmpresaID(Payment.Host.Entity.clsHistorialBE row, string EmpresaID = "", string LicenciaID = "")
        {
            try
            {
                var client = new HttpClient();

                client.DefaultRequestHeaders.Accept.Clear();
                client.DefaultRequestHeaders.Add("Appkey", EmpresaID);
                client.DefaultRequestHeaders.Add("MessageHash", Common.Security.GetHash(EmpresaID + internalKey, Common.HashType.MD5));
                client.DefaultRequestHeaders.Add("LicenciaID", LicenciaID);
                client.DefaultRequestHeaders.Add("Build", "0");


                client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

                var data = Generic.Encryption(JsonConvert.SerializeObject(row));

                client.Timeout = new TimeSpan(0, 10, 0);
                client.BaseAddress = new Uri("http://softarch.ddns.net/");
                var response = await client.GetAsync($"/api/i-Bank/HistorialCreate?data={data}");
                if (!response.IsSuccessStatusCode)
                {
                    return new OperationResult();
                }

                var result = await response.Content.ReadAsStringAsync();
                return JsonConvert.DeserializeObject<OperationResult>(result);
            }
            catch (Exception ex)
            {
                return new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
            }
        }



        #endregion

        #region Archivos

        #region Firmas

        public OperationResult FirmasCreate(string Documento, byte[] firma, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var BE = db.clsFirmasBE.Where(x => x.Documento == Documento).FirstOrDefault();
                if (BE == null)
                {
                    db.clsFirmasBE.Add(new clsFirmasBE { Documento = Documento, Fecha = DateTime.Now, Firma = firma, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                }
                else
                {
                    BE.Firma = firma;
                    BE.ModificadoPor = Usuario;
                    BE.FechaModificacion = DateTime.Now;
                    db.Entry(BE).State = EntityState.Modified;
                }
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex) { return new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message }; }
        }

        #endregion

        #region Personas

        public OperationResult PersonasCreate(int TipoDocumentoID, string Documento, DateTime FechaNacimiento, string Nombres, string Apellidos, string Apodo, string Fotografia, int CiudadID, string Direccion, string Correo, string Telefono, int OperadorID, string Celular, int SexoID, int EstadoCivilID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var existe = db.clsPersonasBE.Where(x => x.Documento == Documento);
                if (existe.Count() == 0)
                {
                    db.clsPersonasBE.Add(new clsPersonasBE {TipoDocumentoID = TipoDocumentoID, Documento = Documento, Fecha = DateTime.Now, FechaNacimiento = FechaNacimiento, Nombres = Nombres.ToUpper(), Apellidos = Apellidos.ToUpper(), Apodo = Apodo.ToUpper(), CiudadID = CiudadID, Direccion = Direccion.ToUpper(), Correo = Correo.Trim(), Telefono = Telefono, OperadorID = OperadorID, Celular = Celular, SexoID = SexoID, EstadoCivilID = EstadoCivilID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now, IsAsync = true });
                    db.SaveChanges();
                    result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };

                    if (!string.IsNullOrEmpty(Fotografia))
                    {
                        SavePic(Documento, Fotografia, Usuario);
                    }
                }
                else
                {
                    result = PersonasUpdate(TipoDocumentoID, Documento, FechaNacimiento, Nombres.ToUpper(), Apellidos.ToUpper(), Apodo.ToUpper(), Fotografia, CiudadID, Direccion.ToUpper(), Correo.Replace(" ", ""), Telefono, OperadorID, Celular, SexoID, EstadoCivilID, Usuario);
                }
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult FotografiasGetByDocumentoCloud(string documento)
        {
            OperationResult result = new OperationResult();
            try
            {
                db = new DAL.Context();
                WebClient client = new WebClient(); 
                //byte[] data = client.DownloadData(new Uri($"https://fotos.prestan2.com/api/test/foto2/{documento}?z=1")); 

                byte[] data = client.DownloadData(new Uri($"http://apps.softarch.ddns.net/photos/{Common.Generic.DocumentFormat(documento)}.jpg"));
                if (data.Length > 0)
                {
                    db.clsFotografiasBE.Add(new clsFotografiasBE { Documento = documento, Fecha = DateTime.Now, Foto = data, Usuario = documento, ModificadoPor = documento, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                }
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "Registro guardado correctamente." };
                return result;
            }
            catch (Exception ex)
            {
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public OperationResult FotografiasGetByDocumento(string Documento, bool IsRemoteQuery = false, string EmpresaID = "", string LicenciaID = "")
        {
            OperationResult result = new OperationResult();
            try
            {
                db = new DAL.Context();
               var  response = db.clsFotografiasBE.Where(x => x.Documento == Documento);
                if (response.Count() > 0)
                {
                    return new OperationResult { ResponseCode = "00", ResponseMessage="" };
                }
                else
                {
                    if (IsRemoteQuery == true)
                    {
                        return Task.Run(async () =>
                        {
                            var row = await getFotografiasGetByDocumento("http://softarch.ddns.net", Documento, EmpresaID, LicenciaID);

                            result = FotografiasCreate(row.Documento, row.Foto, row.Usuario);
                            //db.clsFotografiasBE.Add( new clsFotografiasBE() { Documento = row.Documento, Fecha = row.Fecha, Foto = row.Foto, Usuario = row.Usuario, FechaModificacion = row.FechaModificacion, ModificadoPor = row.ModificadoPor });
                            return result;
                        }).Result;
                    }
                }
                return result;

            }
            catch (Exception ex)
            {
                return result;
            }
        }

        private async Task<clsFotografiasBE> getFotografiasGetByDocumento(string url, string Documento, string EmpresaID, string LicenciaID)
        {
            try
            {
                var client = new HttpClient();

                client.DefaultRequestHeaders.Accept.Clear();
                client.DefaultRequestHeaders.Add("Appkey", EmpresaID);
                client.DefaultRequestHeaders.Add("MessageHash", Common.Security.GetHash(EmpresaID + internalKey, Common.HashType.MD5));
                client.DefaultRequestHeaders.Add("LicenciaID", LicenciaID);
                client.DefaultRequestHeaders.Add("Build", "0");

                client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

                client.Timeout = new TimeSpan(0, 10, 0);
                client.BaseAddress = new Uri(url);
                var response = await client.GetAsync($"/api/i-Bank/FotografiasGetByDocumento?Documento={Documento}");
                if (!response.IsSuccessStatusCode)
                {
                    return await getOtherFotografiasGetByDocumento("https://paymentbank.azurewebsites.net", Documento, EmpresaID, LicenciaID);
                }

                var result = await response.Content.ReadAsStringAsync();
                var row = JsonConvert.DeserializeObject<clsFotografiasBE>(result);
                if (string.IsNullOrEmpty(row.Documento))
                {
                    return await getOtherFotografiasGetByDocumento("https://paymentbank.azurewebsites.net", Documento, EmpresaID, LicenciaID);
                }

                return JsonConvert.DeserializeObject<clsFotografiasBE>(result);
            }
            catch
            {
                return await getOtherFotografiasGetByDocumento("https://paymentbank.azurewebsites.net", Documento, EmpresaID, LicenciaID);
            }
        }

        private async Task<clsFotografiasBE> getOtherFotografiasGetByDocumento(string url, string Documento, string EmpresaID, string LicenciaID)
        {
            try
            {
                var client = new HttpClient();

                client.DefaultRequestHeaders.Accept.Clear();
                client.DefaultRequestHeaders.Add("Appkey", EmpresaID);
                client.DefaultRequestHeaders.Add("MessageHash", Common.Security.GetHash(EmpresaID + internalKey, Common.HashType.MD5));
                client.DefaultRequestHeaders.Add("LicenciaID", LicenciaID);
                client.DefaultRequestHeaders.Add("Build", "0");

                client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

                client.Timeout = new TimeSpan(0, 10, 0);
                client.BaseAddress = new Uri(url);
                var response = await client.GetAsync($"/api/i-Bank/FotografiasGetByDocumento?Documento={Documento}");
                if (!response.IsSuccessStatusCode)
                {
                    return new clsFotografiasBE();
                }

                var result = await response.Content.ReadAsStringAsync();
                return JsonConvert.DeserializeObject<clsFotografiasBE>(result);
            }
            catch
            {
                return new clsFotografiasBE();
            }
        }


        public OperationResult FotografiasDeleteGetByDocumento(string documento)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsFotografiasBE.Where(x => x.Documento == documento).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "Registro guardado correctamente." };
                return result;
            }
            catch (Exception ex)
            {

                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public List<clsFotografiasBE> FotografiasGet()
        {
            try
            {
                db = new DAL.Context();
                return db.clsFotografiasBE.ToList();

            }
            catch
            {
                return new List<clsFotografiasBE>();
            }
        }

        public OperationResult FotografiasDeleteAll()
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsFotografiasBE.ToList();
                db.clsFotografiasBE.RemoveRange(row);
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "Registro guardado correctamente." };
                return result;
            }
            catch (Exception ex)
            {

                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult FotografiasCreate(string Documento, byte[] fotografia, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var BE = db.clsFotografiasBE.Where(x => x.Documento == Documento);
                if (BE.Count() == 0)
                {
                    db.clsFotografiasBE.Add(new clsFotografiasBE { Documento = Documento, Fecha = DateTime.Now, Foto = fotografia, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                }
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex) { return new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message }; }
        }

        private OperationResult SavePic(string Documento, string fotografia, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var BE = db.clsFotografiasBE.Where(x => x.Documento == Documento).FirstOrDefault();
                if (BE == null)
                {
                    db.clsFotografiasBE.Add(new clsFotografiasBE { Documento = Documento, Fecha = DateTime.Now, Foto = System.IO.File.ReadAllBytes(fotografia), Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                }
                else
                {
                    BE.Foto = System.IO.File.ReadAllBytes(fotografia);
                    BE.ModificadoPor = Usuario;
                    BE.FechaModificacion = DateTime.Now;
                    db.Entry(BE).State = EntityState.Modified;
                }
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex) { return new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message }; }
        }

        public OperationResult PersonasUpdate(int TipoDocumentoID, string Documento, DateTime FechaNacimiento, string Nombres, string Apellidos, string Apodo, string Fotografia, int CiudadID, string Direccion, string Correo, string Telefono, int OperadorID, string Celular, int SexoID, int EstadoCivilID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var _row = db.clsPersonasBE.Where(x => x.Documento == Documento);
                if (_row.Count() == 0)
                {
                    db.clsPersonasBE.Add(new clsPersonasBE { TipoDocumentoID = TipoDocumentoID, Documento = Documento, Fecha = DateTime.Now, FechaNacimiento = FechaNacimiento, Nombres = Nombres.ToUpper(), Apellidos = Apellidos.ToUpper(), Apodo = Apodo.ToUpper(), CiudadID = CiudadID, Direccion = Direccion.ToUpper(), Correo = Correo.Trim(), Telefono = Telefono, OperadorID = OperadorID, Celular = Celular, SexoID = SexoID, EstadoCivilID = EstadoCivilID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now, IsAsync = true });
                    db.SaveChanges();
                    result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };

                    if (!string.IsNullOrEmpty(Fotografia))
                    {
                        SavePic(Documento, Fotografia, Usuario);
                    }
                }
                else
                {
                    var row = _row.FirstOrDefault();
                    row.TipoDocumentoID = TipoDocumentoID;
                    row.Documento = Documento;
                    row.FechaNacimiento = FechaNacimiento;
                    row.Nombres = Nombres.ToUpper();
                    row.Apellidos = Apellidos.ToUpper();
                    row.Apodo = Apodo.ToUpper();

                    row.CiudadID = CiudadID;
                    row.Direccion = Direccion.ToUpper();
                    row.Correo = Correo.Trim();
                    row.Telefono = Telefono;
                    row.OperadorID = OperadorID;
                    row.Celular = Celular;
                    row.SexoID = SexoID;
                    row.EstadoCivilID = EstadoCivilID;
                    row.ModificadoPor = Usuario;
                    row.FechaModificacion = DateTime.Now;
                    row.IsAsync = false;
                    db.Entry(row).State = EntityState.Modified;
                    db.SaveChanges();
                    result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };

                    if (!string.IsNullOrEmpty(Fotografia))
                    {
                        SavePic(Documento, Fotografia, Usuario);
                    }
                }
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PersonasUpdateAsync(string Documento)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                var row = db.clsPersonasBE.Where(x => x.Documento == Documento).FirstOrDefault();
                if (row != null)
                {
                    row.IsAsync = true;
                    db.Entry(row).State = EntityState.Modified;
                    db.SaveChanges();
                }
                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public clsPersonasBE PersonasGetByDocumento(string Documento, bool IsRemoteQuery = false, string EmpresaID = "", string LicenciaID = "")
        {
            clsPersonasBE result = new clsPersonasBE();
            try
            {
                db = new DAL.Context();
                result = db.clsPersonasBE.Where(x => x.Documento == Documento).FirstOrDefault();
                if (result != null)
                {
                    return result;
                }
                else
                {
                    if (IsRemoteQuery == true)
                    {
                        return Task.Run(async () =>
                        {
                            var row = await getPersonasGetByDocumento("http://softarch.ddns.net", Documento, EmpresaID, LicenciaID);
                            List<clsReferenciasBE> referencias = new List<clsReferenciasBE>();
                            foreach (var e in row.Referencias)
                            {
                                referencias.Add(new clsReferenciasBE { Documento = e.Documento, Fecha = e.Fecha, Referencia = e.Referencia, Direccion = e.Direccion, Telefono = e.Telefono, FechaModificacion = e.FechaModificacion, ModificadoPor = e.ModificadoPor, ReferenciaID = e.ReferenciaID, TipoReferenciaID = e.TipoReferenciaID, Usuario = e.Usuario });
                            }
                            result = new clsPersonasBE() { Documento = row.Documento, Apellidos = row.Apellidos, Apodo = row.Apodo, Celular = row.Celular, CiudadID = row.CiudadID, Correo = row.Correo, Direccion = row.Direccion, EstadoCivilID = row.EstadoCivilID, Fecha = row.Fecha, FechaModificacion = row.FechaModificacion, FechaNacimiento = row.FechaNacimiento, Fotografia = row.Fotografia, IsAsync = row.IsAsync, ModificadoPor = row.ModificadoPor, Nombres = row.Nombres, OperadorID = row.OperadorID, SexoID = row.SexoID, Telefono = row.Telefono, Usuario = row.Usuario, Fotografias = row.Fotografias == null ? null : new clsFotografiasBE { Documento = row.Fotografias.Documento, Fecha = row.Fotografias.Fecha, Foto = row.Fotografias.Foto, Usuario = row.Fotografias.Usuario, FechaModificacion = row.Fotografias.FechaModificacion, ModificadoPor = row.Fotografias.ModificadoPor }, Referencias = referencias };
                            return result;
                        }).Result;
                    }
                }
                return result;

            }
            catch (Exception ex)
            {
                return result;
            }
        }

        private async Task<clsPersonasBE> getPersonasGetByDocumento(string url, string Documento, string EmpresaID, string LicenciaID)
        {
            try
            {
                var client = new HttpClient();

                client.DefaultRequestHeaders.Accept.Clear();
                client.DefaultRequestHeaders.Add("Appkey", EmpresaID);
                client.DefaultRequestHeaders.Add("MessageHash", Common.Security.GetHash(EmpresaID + internalKey, Common.HashType.MD5));
                client.DefaultRequestHeaders.Add("LicenciaID", LicenciaID);
                client.DefaultRequestHeaders.Add("Build", "0");

                client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

                client.Timeout = new TimeSpan(0, 10, 0);
                client.BaseAddress = new Uri(url);
                var response = await client.GetAsync($"/api/i-Bank/PersonasGetByDocumento?Documento={Documento}");
                if (!response.IsSuccessStatusCode)
                {
                    return await getOtherPersonasGetByDocumento("https://paymentbank.azurewebsites.net", Documento, EmpresaID, LicenciaID);
                }

                var result = await response.Content.ReadAsStringAsync();
                var row = JsonConvert.DeserializeObject<clsPersonasBE>(result);
                if (string.IsNullOrEmpty(row.Documento))
                {
                    return await getOtherPersonasGetByDocumento("https://paymentbank.azurewebsites.net", Documento, EmpresaID, LicenciaID);
                }

                return JsonConvert.DeserializeObject<clsPersonasBE>(result);
            }
            catch
            {
                return await getOtherPersonasGetByDocumento("https://paymentbank.azurewebsites.net", Documento, EmpresaID, LicenciaID);
            }
        }

        private async Task<clsPersonasBE> getOtherPersonasGetByDocumento(string url, string Documento, string EmpresaID, string LicenciaID)
        {
            try
            {
                var client = new HttpClient();

                client.DefaultRequestHeaders.Accept.Clear();
                client.DefaultRequestHeaders.Add("Appkey", EmpresaID);
                client.DefaultRequestHeaders.Add("MessageHash", Common.Security.GetHash(EmpresaID + internalKey, Common.HashType.MD5));
                client.DefaultRequestHeaders.Add("LicenciaID", LicenciaID);
                client.DefaultRequestHeaders.Add("Build", "0");

                client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

                client.Timeout = new TimeSpan(0, 10, 0);
                client.BaseAddress = new Uri(url);
                var response = await client.GetAsync($"/api/i-Bank/PersonasGetByDocumento?Documento={Documento}");
                if (!response.IsSuccessStatusCode)
                {
                    return new clsPersonasBE();
                }

                var result = await response.Content.ReadAsStringAsync();
                return JsonConvert.DeserializeObject<clsPersonasBE>(result);
            }
            catch
            {
                return new clsPersonasBE();
            }
        }

        public List<clsDataCreditosBE> DataCreditosGetByDocumento(string Documento, bool IsRemoteQuery = false, string EmpresaID = "", string LicenciaID = "")
        {
            List<clsDataCreditosBE> result = new List<clsDataCreditosBE>();
            try
            {
                db = new DAL.Context();

                if (IsRemoteQuery == true)
                {
                    return Task.Run(async () =>
                    {
                        var rows = await getDataCreditosGetByDocumento("http://softarch.ddns.net", Documento, EmpresaID, LicenciaID);
                        foreach (var item in rows)
                        {
                            result.Add(new clsDataCreditosBE { EmpresaID = item.EmpresaID, Empresa = item.Empresa, Fecha = item.Fecha, Vence = item.Vence, Documento = item.Documento, Monto = item.Monto, Pagado = item.Pagado, Balance = item.Balance, Cantidad = item.Cantidad, Cuota = item.Cuota, Atraso = item.Atraso, Status = item.Status });
                        }

                        return result;
                    }).Result;
                }

                return result;

            }
            catch (Exception ex)
            {
                return result;
            }
        }
        private async Task<List<clsDataCreditosBE>> getDataCreditosGetByDocumento(string url, string Documento, string EmpresaID, string LicenciaID)
        {
            try
            {
                var client = new HttpClient();

                client.DefaultRequestHeaders.Accept.Clear();
                client.DefaultRequestHeaders.Add("Appkey", EmpresaID);
                client.DefaultRequestHeaders.Add("MessageHash", Common.Security.GetHash(EmpresaID + internalKey, Common.HashType.MD5));
                client.DefaultRequestHeaders.Add("LicenciaID", LicenciaID);
                client.DefaultRequestHeaders.Add("Build", "0");

                client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

                client.Timeout = new TimeSpan(0, 10, 0);
                client.BaseAddress = new Uri(url);
                var response = await client.GetAsync($"/api/i-Bank/DataCreditosGetByDocumento?Documento={Documento}");
                if (!response.IsSuccessStatusCode)
                {
                    return await getOtherDataCreditosGetByDocumento("https://paymentbank.azurewebsites.net", Documento, EmpresaID, LicenciaID);
                }

                var result = await response.Content.ReadAsStringAsync();
                var row = JsonConvert.DeserializeObject<List<clsDataCreditosBE>>(result);
                if (string.IsNullOrEmpty(row.FirstOrDefault().Documento))
                {
                    return await getOtherDataCreditosGetByDocumento("https://paymentbank.azurewebsites.net", Documento, EmpresaID, LicenciaID);
                }

                return JsonConvert.DeserializeObject<List<clsDataCreditosBE>>(result);
            }
            catch(Exception ex)
            {
                return await getOtherDataCreditosGetByDocumento("https://paymentbank.azurewebsites.net", Documento, EmpresaID, LicenciaID);
            }
        }

        private async Task<List<clsDataCreditosBE>> getOtherDataCreditosGetByDocumento(string url, string Documento, string EmpresaID, string LicenciaID)
        {
            try
            {
                var client = new HttpClient();

                client.DefaultRequestHeaders.Accept.Clear();
                client.DefaultRequestHeaders.Add("Appkey", EmpresaID);
                client.DefaultRequestHeaders.Add("MessageHash", Common.Security.GetHash(EmpresaID + internalKey, Common.HashType.MD5));
                client.DefaultRequestHeaders.Add("LicenciaID", LicenciaID);
                client.DefaultRequestHeaders.Add("Build", "0");

                client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

                client.Timeout = new TimeSpan(0, 10, 0);
                client.BaseAddress = new Uri(url);
                var response = await client.GetAsync($"/api/i-Bank/DataCreditosGetByDocumento?Documento={Documento}");
                if (!response.IsSuccessStatusCode)
                {
                    return new List<clsDataCreditosBE>();
                }

                var result = await response.Content.ReadAsStringAsync();
                return JsonConvert.DeserializeObject<List<clsDataCreditosBE>>(result);
            }
            catch
            {
                return new List<clsDataCreditosBE>();
            }
        }


        public List<clsPersonasBE> PersonasGet()
        {
            List<clsPersonasBE> result = new List<clsPersonasBE>();
            try
            {
                db = new DAL.Context();
                result = db.clsPersonasBE.ToList();

                return result;
            }
            catch
            {
                return result;
            }
        }

        public clsFotografiasBE FotografiasGetByDocumento(string Documento)
        {
            try
            {
                db = new DAL.Context();
                return db.clsFotografiasBE.Where(x => x.Documento == Documento).FirstOrDefault();
            }
            catch
            {
                return new clsFotografiasBE();
            }
        }

        public List<clsPersonasBE> PersonasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                db.Database.CommandTimeout = 120;
                List<clsPersonasBE> BE = new List<clsPersonasBE>();

                //BE = (from P in db.clsPersonasBE join C in db.clsCiudadesBE on P.CiudadID equals C.CiudadID select new Personas { Documento = P.Documento, FechaNacimiento = P.FechaNacimiento, Completo = P.Nombres.Trim() + " " + P.Apellidos.Trim(), Ciudad = C.Ciudad, Telefono =P.Telefono, Celular = P.Celular}).ToList();
                BE = db.clsPersonasBE.ToList();
                if (!string.IsNullOrEmpty(Search))
                {
                    Search = Search.ToUpper();
                    BE = BE.Where(x => x.Documento.ToUpper().Contains(Search.ToUpper()) || x.Nombres.ToUpper().Contains(Search.ToUpper()) || x.Apellidos.ToUpper().Contains(Search.ToUpper()) || x.Ciudades.Ciudad.ToUpper().Contains(Search.ToUpper()) || x.Direccion.ToUpper().Contains(Search.ToUpper()) || x.Telefono.Contains(Search.ToUpper()) || x.Celular.Contains(Search.ToUpper())).ToList();
                }

                return BE.OrderBy(x => x.Documento).ToList();

            }
            catch
            {
                return new List<clsPersonasBE>();
            }
        }


        #endregion

        #region Clientes

        public OperationResult ClientesCreate(string Documento, int SucursalID, double Latitude, double Longitude, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                var row = db.clsClientesBE.Where(x => x.Documento == Documento && x.SucursalID == SucursalID).FirstOrDefault();
                if (row == null)
                {
                    ID = (db.clsClientesBE.Count() == 0 ? 100000 : db.clsClientesBE.Max(x => x.ClienteID)) + 1;
                    db.clsClientesBE.Add(new clsClientesBE { ClienteID = ID, Documento = Documento, Fecha = DateTime.Now, SucursalID = SucursalID, Latitude = Latitude, Longitude = Longitude, EstadoID = true, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                }
                else
                {
                    ID = row.ClienteID;
                    if (Longitude != 0 && Latitude != 0)
                    {
                        row.Longitude = Longitude;
                        row.Latitude = Latitude;
                        db.Entry(row).State = EntityState.Modified;
                        db.SaveChanges();

                        int value = (db.clsGeolocalizacionesBE.Count() == 0 ? 100000 : db.clsGeolocalizacionesBE.Max(x => x.GeolocalizacionID)) + 1;
                        db.clsGeolocalizacionesBE.Add(new clsGeolocalizacionesBE { GeolocalizacionID = value, Fecha = DateTime.Now, Documento = Documento, Latitude = Latitude, Longitude = Longitude, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                        db.SaveChanges();
                    }
                }
                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult ClientesUpdate(int ClienteID, string Documento, int SucursalID, double Latitude, double Longitude, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsClientesBE.Where(x => x.ClienteID == ClienteID).FirstOrDefault();
                row.Documento = Documento;
                if (Longitude != 0 && Latitude != 0)
                {
                    row.Longitude = Longitude;
                    row.Latitude = Latitude;
                }
                row.SucursalID = SucursalID;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();

                //int ID = (db.clsGeolocalizacionesBE.Count() == 0 ? 100000 : db.clsGeolocalizacionesBE.Max(x => x.GeolocalizacionID)) + 1;
                //db.clsGeolocalizacionesBE.Add(new clsGeolocalizacionesBE { GeolocalizacionID = ID, Fecha = DateTime.Now, Documento = Documento, Latitude = Latitude, Longitude = Longitude, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                //db.SaveChanges();

                result = new OperationResult { ResponseCode = "00", ResponseMessage = ClienteID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }


        public List<clsClientesBE> ClientesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsClientesBE.Where(x => x.Personas.Nombres.Contains(Search) || x.Personas.Apellidos.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsClientesBE.ToList();
                }
            }
            catch
            {
                return new List<clsClientesBE>();
            }
        }

        #endregion

        #region Gerentes

        public OperationResult GerentesCreate(string Documento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                string ID = string.Empty;

                var row = db.clsGerentesBE.Where(x => x.Documento == Documento).FirstOrDefault();
                if (row == null)
                {
                    db.clsGerentesBE.Add(new clsGerentesBE { Documento = Documento, Fecha = DateTime.Now, Estado = true, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                }
                else
                {
                    ID = db.clsGerentesBE.Where(x => x.Documento == Documento).FirstOrDefault().Documento;
                }
                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public List<clsGerentesBE> GerentesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsGerentesBE.Where(x => x.Personas.Nombres.Contains(Search) || x.Personas.Apellidos.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsGerentesBE.ToList();
                }
            }
            catch
            {
                return new List<clsGerentesBE>();
            }
        }

        public clsGerentesBE GerentesGetByDocumento(string Documento)
        {
            try
            {
                db = new DAL.Context();

                return db.clsGerentesBE.Where(x => x.Documento == Documento).FirstOrDefault();
                
            }
            catch
            {
                return new clsGerentesBE();
            }
        }

        #endregion

        #region Alguaciles

        public OperationResult AlguacilesCreate(string Documento, int SucursalID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                var row = db.clsAlguacilesBE.Where(x => x.Documento == Documento && x.SucursalID == SucursalID).FirstOrDefault();
                if (row == null)
                {
                    db.clsAlguacilesBE.Add(new clsAlguacilesBE { Documento = Documento, Fecha = DateTime.Now, SucursalID = SucursalID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                }
                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult AlguacilesUpdate(string Documento, int SucursalID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsAlguacilesBE.Where(x => x.Documento == Documento).FirstOrDefault();
                row.Documento = Documento;
                row.SucursalID = SucursalID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsAlguacilesBE> AlguacilesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsAlguacilesBE.Where(x => x.Personas.Nombres.Contains(Search) || x.Personas.Apellidos.Contains(Search) || x.Personas.Documento.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsAlguacilesBE.ToList();
                }
            }
            catch
            {
                return new List<clsAlguacilesBE>();
            }
        }

        public OperationResult AlguacilesDelete(String Documento, int SucursalID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsAlguacilesBE.Where(x => x.Documento == Documento && x.SucursalID == SucursalID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public clsAlguacilesBE AlguacilesGetByDocumento(string Documento, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsAlguacilesBE.Where(x => x.Documento == Documento && x.SucursalID == SucursalID).FirstOrDefault();
            }
            catch
            {
                return new clsAlguacilesBE();
            }
        }

        #endregion

        #region Oficiales

        public OperationResult OficialesCreate(string Documento, int SucursalID, float Porciento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                var row = db.clsOficialesBE.Where(x => x.Documento == Documento && x.SucursalID == SucursalID).FirstOrDefault();
                if (row == null)
                {
                    ID = (db.clsOficialesBE.Count() == 0 ? 100000 : db.clsOficialesBE.Max(x => x.OficialID)) + 1;
                    db.clsOficialesBE.Add(new clsOficialesBE { OficialID = ID, Documento = Documento, Fecha = DateTime.Now, SucursalID = SucursalID, Porciento = Porciento, EstadoID = true, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                }
                else
                {
                    ID = db.clsOficialesBE.Where(x => x.Documento == Documento && x.SucursalID == SucursalID).FirstOrDefault().OficialID;
                }
                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult OficialesUpdate(int OficialID, string Documento, int SucursalID, float Porciento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsOficialesBE.Where(x => x.OficialID == OficialID).FirstOrDefault();
                row.Documento = Documento;
                row.SucursalID = SucursalID;
                row.Porciento = Porciento;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public clsOficialesBE OficialesGetByOficialID(int OficialID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsOficialesBE.Where(x => x.OficialID == OficialID).FirstOrDefault();

            }
            catch
            {
                return new clsOficialesBE();
            }
        }

        public List<clsOficialesBE> OficialesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsOficialesBE.Where(x => x.Personas.Nombres.Contains(Search) || x.Personas.Apellidos.Contains(Search) || x.Personas.Documento.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsOficialesBE.ToList();
                }
            }
            catch
            {
                return new List<clsOficialesBE>();
            }
        }

        public OperationResult OficialesDelete(int OficialID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsOficialesBE.Where(x => x.OficialID == OficialID).FirstOrDefault();
                row.EstadoID = false;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public clsOficialesBE OficialesGetByDocumento(string Documento, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsOficialesBE.Where(x => x.Documento == Documento && x.SucursalID == SucursalID).FirstOrDefault();
            }
            catch
            {
                return new clsOficialesBE();
            }
        }

        #endregion

        #region Empleados

        public OperationResult EmpleadosCreate(string Documento, int SucursalID, int PuestoID, float Sueldo, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                var row = db.clsEmpleadosBE.Where(x => x.Documento == Documento && x.SucursalID == SucursalID).FirstOrDefault();
                if (row == null)
                {
                    ID = (db.clsEmpleadosBE.Count() == 0 ? 100000 : db.clsEmpleadosBE.Max(x => x.EmpleadoID)) + 1;
                    db.clsEmpleadosBE.Add(new clsEmpleadosBE { EmpleadoID = ID, Documento = Documento, Fecha = DateTime.Now, SucursalID = SucursalID, PuestoID = PuestoID, Sueldo = Sueldo, EstadoID = true, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                }
                else
                {
                    ID = db.clsEmpleadosBE.Where(x => x.Documento == Documento && x.SucursalID == SucursalID).FirstOrDefault().EmpleadoID;
                }
                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult EmpleadosUpdate(int EmpleadoID, string Documento, int SucursalID, int PuestoID, float Sueldo, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsEmpleadosBE.Where(x => x.EmpleadoID == EmpleadoID).FirstOrDefault();
                row.Documento = Documento;
                row.SucursalID = SucursalID;
                row.PuestoID = PuestoID;
                row.Sueldo = Sueldo;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public clsEmpleadosBE EmpleadosGetByEmpleadoID(int EmpleadoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsEmpleadosBE.Where(x => x.EmpleadoID == EmpleadoID).FirstOrDefault();

            }
            catch
            {
                return new clsEmpleadosBE();
            }
        }

        public List<clsEmpleadosBE> EmpleadosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsEmpleadosBE.Where(x => x.Personas.Nombres.Contains(Search) || x.Personas.Apellidos.Contains(Search) || x.Personas.Documento.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsEmpleadosBE.ToList();
                }
            }
            catch
            {
                return new List<clsEmpleadosBE>();
            }
        }

        public OperationResult EmpleadosDelete(int EmpleadoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsEmpleadosBE.Where(x => x.EmpleadoID == EmpleadoID).FirstOrDefault();
                row.EstadoID = false;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public clsEmpleadosBE EmpleadosGetByDocumento(string Documento, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsEmpleadosBE.Where(x => x.Documento == Documento && x.SucursalID == SucursalID).FirstOrDefault();
            }
            catch
            {
                return new clsEmpleadosBE();
            }
        }

        #endregion

        #region Garantes

        public OperationResult GarantesCreate(string Documento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var existe = db.clsGarantesBE.Where(x => x.Documento == Documento);
                if (existe.Count() == 0)
                {
                    db.clsGarantesBE.Add(new clsGarantesBE { Documento = Documento, Fecha = DateTime.Now, Estado = true, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                }
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        #endregion

        #region Datos Economicos

        public OperationResult DatosEconomicosCreate(string Documento, bool Trabaja, int InstitucionID, int OcupacionID, int HorarioID, int IngresoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDatosEconomicosBE.Where(x => x.Documento == Documento).FirstOrDefault();
                if (row != null)
                {
                    row.Trabaja = Trabaja;
                    row.InstitucionID = InstitucionID;
                    //row.Direccion = Direccion;
                    //row.Telefono = Telefono;
                    row.OcupacionID = OcupacionID;
                    row.HorarioID = HorarioID;
                    row.IngresoID = IngresoID;
                    row.FechaModificacion = DateTime.Now;
                    row.ModificadoPor = Usuario;
                    db.Entry(row).State = EntityState.Modified;
                }
                else
                {
                    db.clsDatosEconomicosBE.Add(new clsDatosEconomicosBE { Documento = Documento, Fecha = DateTime.Now, Trabaja = Trabaja, IngresoID = IngresoID, InstitucionID = InstitucionID, OcupacionID = OcupacionID, HorarioID = HorarioID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                }
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DatosEconomicosUpdate(string Documento, bool Trabaja, int InstitucionID, int OcupacionID, int HorarioID, int IngresoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDatosEconomicosBE.Where(x => x.Documento == Documento).FirstOrDefault();
                if (row != null)
                {
                    row.Trabaja = Trabaja;
                    row.InstitucionID = InstitucionID;
                    //row.Direccion = Direccion;
                    //row.Telefono = Telefono;
                    row.OcupacionID = OcupacionID;
                    row.HorarioID = HorarioID;
                    row.IngresoID = IngresoID;
                    row.FechaModificacion = DateTime.Now;
                    row.ModificadoPor = Usuario;
                    db.Entry(row).State = EntityState.Modified;
                }
                else
                {
                    db.clsDatosEconomicosBE.Add(new clsDatosEconomicosBE { Documento = Documento, Fecha = DateTime.Now, Trabaja = Trabaja, InstitucionID = InstitucionID, IngresoID = IngresoID, OcupacionID = OcupacionID, HorarioID = HorarioID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });

                }
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DatosEconomicosDelete(string Documento)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDatosEconomicosBE.Where(x => x.Documento == Documento).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        #endregion

        #region Solicitudes

        public OperationResult SolicitudesCreate(int ClienteID, int TipoSolicitudID, int CondicionID, int Tiempo, float Monto, int EstadoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = (db.clsSolicitudesBE.Count() == 0 ? 100000 : db.clsSolicitudesBE.Max(x => x.SolicitudID));
                db.clsSolicitudesBE.Add(new clsSolicitudesBE { ClienteID = ClienteID, SolicitudID = ID + 1, TipoSolicitudID = TipoSolicitudID, CondicionID = CondicionID, Tiempo = Tiempo, Monto = (decimal)Monto, EstadoID = EstadoID, Fecha = DateTime.Now, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = db.clsSolicitudesBE.Max(x => x.SolicitudID).ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult SolicitudesUpdate(int SolicitudID, int ClienteID, int TipoSolicitudID, int CondicionID, int Tiempo, decimal Monto, int EstadoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsSolicitudesBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();
                row.ClienteID = ClienteID;
                row.Tiempo = Tiempo;
                row.Monto = Monto;
                row.CondicionID = CondicionID;
                row.EstadoID = EstadoID;
                row.TipoSolicitudID = TipoSolicitudID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsSolicitudesBE> SolicitudesGetByDocumento(string Documento, int EstadoID)
        {
            try
            {
                db = new DAL.Context();
                List<clsSolicitudesBE> BE = new List<clsSolicitudesBE>();
                BE = db.clsSolicitudesBE.Where(x => x.EstadoID == EstadoID && x.Clientes.Documento == Documento).ToList();
                return BE.OrderBy(x => x.SolicitudID).ToList();
            }
            catch
            {
                return new List<clsSolicitudesBE>();
            }
        }

        public List<Solicitudes> SolicitudesGet(string Search, int EstadoID, string Documento)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();

                List<Solicitudes> BE = new List<Solicitudes>();
                if (row.Roles.ViewAllApplication == true)
                {
                    BE = (from S in db.clsSolicitudesBE.Where(x => x.EstadoID == EstadoID) join CI in db.clsClientesBE on S.ClienteID equals CI.ClienteID join P in db.clsPersonasBE on CI.Documento equals P.Documento join TS in db.clsTipoSolicitudesBE on S.TipoSolicitudID equals TS.TipoSolicitudID join CO in db.clsCondicionesBE on S.CondicionID equals CO.CondicionID select new Payment.Bank.Core.Entity.Solicitudes { SolicitudID = S.SolicitudID, Fecha = S.Fecha, Completo = P.Nombres + " " + P.Apellidos, Condicion = CO.Condicion, Tiempo = S.Tiempo, Monto = (float)S.Monto, EstadoID = S.EstadoID, TipoSolicitudID = TS.TipoSolicitudID, TipoSolicitud = TS.TipoSolicitud }).ToList();
                }
                else
                {
                    BE = (from S in db.clsSolicitudesBE.Where(x => x.EstadoID == EstadoID) join CI in db.clsClientesBE.Where(x => x.SucursalID == row.SucursalID) on S.ClienteID equals CI.ClienteID join P in db.clsPersonasBE on CI.Documento equals P.Documento join TS in db.clsTipoSolicitudesBE on S.TipoSolicitudID equals TS.TipoSolicitudID join CO in db.clsCondicionesBE on S.CondicionID equals CO.CondicionID select new Payment.Bank.Core.Entity.Solicitudes { SolicitudID = S.SolicitudID, Fecha = S.Fecha, Completo = P.Nombres + " " + P.Apellidos, Condicion = CO.Condicion, Tiempo = S.Tiempo, Monto = (float)S.Monto, EstadoID = S.EstadoID, TipoSolicitudID = TS.TipoSolicitudID, TipoSolicitud = TS.TipoSolicitud }).ToList();
                }

                if (!string.IsNullOrEmpty(Search))
                {
                    Search = Search.ToUpper();
                    BE = BE.Where(x => x.SolicitudID.ToString().Contains(Search) || x.Fecha.ToString().Contains(Search) || x.Completo.ToUpper().Contains(Search) || x.Tiempo.ToString().Contains(Search) || x.Monto.ToString().Contains(Search) || x.Condicion.ToUpper().Contains(Search) || x.TipoSolicitud.ToUpper().Contains(Search)).ToList();
                }
                return BE.OrderBy(x => x.SolicitudID).ToList();
            }
            catch
            {
                return new List<Solicitudes>();
            }
        }

        public clsSolicitudesBE SolicitudesGetBySolicitudID(int SolicitudID)
        {
            try
            {
                db = new DAL.Context();
                var result = db.clsSolicitudesBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();
                return result;
            }
            catch
            {
                return new clsSolicitudesBE();
            }
        }

        public OperationResult SolicitudesDelete(int SolicitudID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsSolicitudesBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public DataSet PrintSolicitudesGetBySolicitudID(int SolicitudID)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsSolicitudesBE.Where(x => x.SolicitudID == SolicitudID);
                DataSet ds = new DataSet();

                DataTable GarantiaPersonal = new DataTable("GarantiaPersonal");
                GarantiaPersonal.Columns.Add("Documento", typeof(string));
                GarantiaPersonal.Columns.Add("Nombres", typeof(string));
                GarantiaPersonal.Columns.Add("Apellidos", typeof(string));
                GarantiaPersonal.Columns.Add("Ciudad", typeof(string));
                GarantiaPersonal.Columns.Add("Direccion", typeof(string));
                GarantiaPersonal.Columns.Add("Correo", typeof(string));
                GarantiaPersonal.Columns.Add("Telefono", typeof(string));
                GarantiaPersonal.Columns.Add("Celular", typeof(string));
                GarantiaPersonal.Columns.Add("Sexo", typeof(string));

                DataTable GarantiaHipotecaria = new DataTable("GarantiaHipotecaria");
                GarantiaHipotecaria.Columns.Add("Descripcion", typeof(string));


                DataTable GarantiaVehiculos = new DataTable("GarantiaVehiculos");
                GarantiaVehiculos.Columns.Add("TipoVehiculo", typeof(string));
                GarantiaVehiculos.Columns.Add("Marca", typeof(string));
                GarantiaVehiculos.Columns.Add("Modelo", typeof(string));
                GarantiaVehiculos.Columns.Add("Color", typeof(string));
                GarantiaVehiculos.Columns.Add("Chasis", typeof(string));
                GarantiaVehiculos.Columns.Add("Placa", typeof(string));
                GarantiaVehiculos.Columns.Add("Registro", typeof(string));
                GarantiaVehiculos.Columns.Add("FechaExpedicion", typeof(DateTime));
                GarantiaVehiculos.Columns.Add("Ano", typeof(int));


                DataTable GarantiaTarjetas = new DataTable("GarantiaTarjetas");
                GarantiaTarjetas.Columns.Add("SolicitudID", typeof(int));
                GarantiaTarjetas.Columns.Add("Fecha", typeof(DateTime));
                GarantiaTarjetas.Columns.Add("Holder", typeof(string));
                GarantiaTarjetas.Columns.Add("Numero", typeof(string));
                GarantiaTarjetas.Columns.Add("Mes", typeof(int));
                GarantiaTarjetas.Columns.Add("Ano", typeof(int));
                GarantiaTarjetas.Columns.Add("Cvv", typeof(int));
                GarantiaTarjetas.Columns.Add("Usuario", typeof(string));
                GarantiaTarjetas.Columns.Add("ModificadoPor", typeof(string));
                GarantiaTarjetas.Columns.Add("FechaModificacion", typeof(DateTime));


                var Solicitudes = from S in db.clsSolicitudesBE.Where(x => x.SolicitudID == SolicitudID) select new Solicitudes { SolicitudID = S.SolicitudID, Fecha = S.Fecha, ClienteID = S.ClienteID, CondicionID = S.CondicionID, EstadoID = S.EstadoID, Monto = (float)S.Monto, Tiempo = S.Tiempo, TipoSolicitudID = S.TipoSolicitudID, Usuario = S.Usuario, ModificadoPor = S.ModificadoPor, FechaModificacion = S.FechaModificacion };
                var Condiciones = from S in row select new Condiciones { CondicionID = S.CondicionID, Fecha = S.Fecha, Condicion = S.Condiciones.Condicion, Dias = S.Condiciones.Dias, IsDefault = S.Condiciones.IsDefault, Meses = S.Condiciones.Meses, Usuario = S.Usuario, ModificadoPor = S.ModificadoPor, FechaModificacion = S.FechaModificacion };
                var TipoSolicitudes = from S in row select new TipoSolicitudes { TipoSolicitudID = S.TipoSolicitudID, Fecha = S.TipoSolicitudes.Fecha, TipoSolicitud = S.TipoSolicitudes.TipoSolicitud, IsDefault = S.TipoSolicitudes.IsDefault, AuxiliarID = S.TipoSolicitudes.AuxiliarID, Usuario = S.Usuario, ModificadoPor = S.ModificadoPor, FechaModificacion = S.FechaModificacion };
                var Ocupaciones = from S in row select new Ocupaciones { OcupacionID = S.Clientes.Personas.DatosEconomicos.OcupacionID, Fecha = S.Clientes.Personas.DatosEconomicos.Fecha, Ocupacion = S.Clientes.Personas.DatosEconomicos.Ocupaciones.Ocupacion, Usuario = S.Usuario, ModificadoPor = S.ModificadoPor, FechaModificacion = S.FechaModificacion };
                var Horarios = from S in row select new Horarios { HorarioID = S.Clientes.Personas.DatosEconomicos.HorarioID, Fecha = S.Clientes.Personas.DatosEconomicos.Fecha, Horario = S.Clientes.Personas.DatosEconomicos.Horarios.Horario, Usuario = S.Usuario, ModificadoPor = S.ModificadoPor, FechaModificacion = S.FechaModificacion };
                var Ingresos = from S in row select new Ingresos { IngresoID = S.Clientes.Personas.DatosEconomicos.IngresoID, Fecha = S.Clientes.Personas.DatosEconomicos.Fecha, Ingreso = S.Clientes.Personas.DatosEconomicos.Ingresos.Ingreso, Usuario = S.Usuario, ModificadoPor = S.ModificadoPor, FechaModificacion = S.FechaModificacion };

                var Sucursales = from S in row select new Sucursales { SucursalID = S.Clientes.SucursalID, Fecha = S.Fecha, Sucursal = S.Clientes.Sucursales.Sucursal, CiudadID = S.Clientes.Sucursales.CiudadID, Documento = S.Clientes.Sucursales.Documento, EmpresaID = S.Clientes.Sucursales.Empresas.EmpresaID, Usuario = S.Usuario, ModificadoPor = S.ModificadoPor, FechaModificacion = S.FechaModificacion };
                var Empresas = from S in row select new Empresas { EmpresaID = S.Clientes.Sucursales.EmpresaID, Empresa = S.Clientes.Sucursales.Empresas.Empresa, Fecha = S.Clientes.Sucursales.Empresas.Fecha, Direccion = S.Clientes.Sucursales.Direccion, Rnc = S.Clientes.Sucursales.Empresas.Rnc, Siglas = S.Clientes.Sucursales.Empresas.Siglas, Telefonos = S.Clientes.Sucursales.Telefonos, Usuario = S.Clientes.Sucursales.Empresas.Usuario, ModificadoPor = S.Clientes.Sucursales.Empresas.ModificadoPor, FechaModificacion = S.Clientes.Sucursales.Empresas.FechaModificacion };
                var Clientes = from S in db.clsSolicitudesBE.Where(x => x.SolicitudID == SolicitudID) select new Clientes { ClienteID = S.Clientes.ClienteID, Documento = S.Clientes.Documento, SucursalID = S.Clientes.SucursalID, Estado = S.Clientes.EstadoID, Fecha = S.Clientes.Fecha, Usuario = S.Usuario, ModificadoPor = S.ModificadoPor, FechaModificacion = S.FechaModificacion };

                var Personas = from S in row select new Personas { Documento = S.Clientes.Personas.Documento, Fecha = S.Clientes.Personas.Fecha, FechaNacimiento = S.Clientes.Personas.FechaNacimiento, Nombres = S.Clientes.Personas.Nombres, Apellidos = S.Clientes.Personas.Apellidos, Apodo = S.Clientes.Personas.Apodo, Fotografia = S.Clientes.Personas.Fotografia, CiudadID = S.Clientes.Personas.CiudadID, Direccion = S.Clientes.Personas.Direccion, Celular = S.Clientes.Personas.Celular, Telefono = S.Clientes.Personas.Telefono, Correo = S.Clientes.Personas.Correo, Usuario = S.Usuario, ModificadoPor = S.ModificadoPor, FechaModificacion = S.FechaModificacion };
                var Ciudades = from S in row select new Ciudades { CiudadID = S.Clientes.Personas.Ciudades.CiudadID, Fecha = S.Clientes.Personas.Ciudades.Fecha, Ciudad = S.Clientes.Personas.Ciudades.Ciudad, ProvinciaID = S.Clientes.Personas.Ciudades.ProvinciaID, Usuario = S.Usuario, ModificadoPor = S.ModificadoPor, FechaModificacion = S.FechaModificacion };
                var EstadosCiviles = from S in row select new EstadosCiviles { EstadoCivilID = S.Clientes.Personas.EstadosCiviles.EstadoCivilID, Fecha = S.Clientes.Personas.EstadosCiviles.Fecha, EstadoCivil = S.Clientes.Personas.EstadosCiviles.EstadoCivil, Usuario = S.Usuario, ModificadoPor = S.ModificadoPor, FechaModificacion = S.FechaModificacion };
                var Referencias = from S in db.clsReferenciasBE.Where(x => x.Documento == row.FirstOrDefault().Clientes.Documento) select new Referencias { ReferenciaID = S.ReferenciaID, Fecha = S.Fecha, Documento = S.Documento, Referencia = S.Referencia, TipoReferencia = S.TipoReferencias.TipoReferencia, Telefono = S.Telefono, Direccion = S.Direccion, Usuario = S.Usuario, ModificadoPor = S.ModificadoPor, FechaModificacion = S.FechaModificacion };
                var DatosEconomicos = from S in row select new DatosEconomicos { Documento = S.Clientes.Personas.DatosEconomicos.Documento, Fecha = S.Clientes.Personas.DatosEconomicos.Fecha, Trabaja = S.Clientes.Personas.DatosEconomicos.Trabaja, Direccion = S.Clientes.Personas.DatosEconomicos.Instituciones.Direccion, Empresa = S.Clientes.Personas.DatosEconomicos.Instituciones.Institucion, HorarioID = S.Clientes.Personas.DatosEconomicos.HorarioID, IngresoID = S.Clientes.Personas.DatosEconomicos.IngresoID, OcupacionID = S.Clientes.Personas.DatosEconomicos.OcupacionID, Telefono = S.Clientes.Personas.DatosEconomicos.Instituciones.Telefono, Usuario = S.Usuario, ModificadoPor = S.ModificadoPor, FechaModificacion = S.FechaModificacion };


                DataTable Cuentas = new DataTable("Cuentas");
                Cuentas.Columns.Add("SolicitudID", typeof(int));
                Cuentas.Columns.Add("BarCode", typeof(byte[]));

                DataRow dataRow = Cuentas.NewRow();
                dataRow["SolicitudID"] = SolicitudID;
                dataRow["BarCode"] = ImageFromText(row.FirstOrDefault().SolicitudID.ToString());
                Cuentas.Rows.Add(dataRow);

                ds.Tables.Add(EntityToDataTable(Solicitudes, "Solicitudes"));
                ds.Tables.Add(EntityToDataTable(Condiciones, "Condiciones"));
                ds.Tables.Add(EntityToDataTable(TipoSolicitudes, "TipoSolicitudes"));
                ds.Tables.Add(EntityToDataTable(Sucursales, "Sucursales"));
                ds.Tables.Add(EntityToDataTable(Empresas, "Empresas"));
                ds.Tables.Add(EntityToDataTable(Ocupaciones, "Ocupaciones"));
                ds.Tables.Add(EntityToDataTable(Personas, "Personas"));
                ds.Tables.Add(EntityToDataTable(Horarios, "Horarios"));
                ds.Tables.Add(EntityToDataTable(Clientes, "Clientes"));
                ds.Tables.Add(EntityToDataTable(Ingresos, "Ingresos"));
                ds.Tables.Add(EntityToDataTable(Ciudades, "Ciudades"));
                ds.Tables.Add(EntityToDataTable(EstadosCiviles, "EstadosCiviles"));
                ds.Tables.Add(EntityToDataTable(Referencias, "Referencias"));

                switch (row.FirstOrDefault().TipoSolicitudID)
                {
                    case 1:
                        {
                            dataRow = GarantiaPersonal.NewRow();
                            dataRow["Documento"] = row.FirstOrDefault().GarantiaPersonal.Documento;
                            dataRow["Nombres"] = row.FirstOrDefault().GarantiaPersonal.Garantes.Personas.Nombres;
                            dataRow["Apellidos"] = row.FirstOrDefault().GarantiaPersonal.Garantes.Personas.Apellidos;
                            dataRow["Ciudad"] = row.FirstOrDefault().GarantiaPersonal.Garantes.Personas.Ciudades.Ciudad;
                            dataRow["Direccion"] = row.FirstOrDefault().GarantiaPersonal.Garantes.Personas.Direccion;
                            dataRow["Correo"] = row.FirstOrDefault().GarantiaPersonal.Garantes.Personas.Correo;
                            dataRow["Telefono"] = row.FirstOrDefault().GarantiaPersonal.Garantes.Personas.Telefono;
                            dataRow["Celular"] = row.FirstOrDefault().GarantiaPersonal.Garantes.Personas.Celular;
                            dataRow["Sexo"] = row.FirstOrDefault().GarantiaPersonal.Garantes.Personas.Sexos.Sexo;
                            GarantiaPersonal.Rows.Add(dataRow);

                        }
                        break;
                    case 2:
                        {
                            dataRow = GarantiaHipotecaria.NewRow();
                            dataRow["Descripcion"] = row.FirstOrDefault().GarantiaHipotecaria.Descripcion;

                            GarantiaHipotecaria.Rows.Add(dataRow);

                        }
                        break;
                    case 3:
                        {
                            dataRow = GarantiaVehiculos.NewRow();
                            dataRow["TipoVehiculo"] = row.FirstOrDefault().GarantiaVehiculos.TipoVehiculos.TipoVehiculo;
                            dataRow["Marca"] = row.FirstOrDefault().GarantiaVehiculos.Modelos.Marcas.Marca;
                            dataRow["Modelo"] = row.FirstOrDefault().GarantiaVehiculos.Modelos.Modelo;
                            dataRow["Color"] = row.FirstOrDefault().GarantiaVehiculos.Colores.Color;
                            dataRow["Chasis"] = row.FirstOrDefault().GarantiaVehiculos.Chasis;
                            dataRow["Placa"] = row.FirstOrDefault().GarantiaVehiculos.Placa;
                            dataRow["Registro"] = row.FirstOrDefault().GarantiaVehiculos.Registro;
                            dataRow["FechaExpedicion"] = row.FirstOrDefault().GarantiaVehiculos.FechaExpedicion;
                            dataRow["Ano"] = row.FirstOrDefault().GarantiaVehiculos.Ano;
                            GarantiaVehiculos.Rows.Add(dataRow);
                        }
                        break;
                    case 6:
                        {
                            dataRow = GarantiaTarjetas.NewRow();
                            dataRow["SolicitudID"] = row.FirstOrDefault().GarantiaTarjetas.SolicitudID;
                            dataRow["Fecha"] = row.FirstOrDefault().GarantiaTarjetas.Fecha;
                            dataRow["Holder"] = row.FirstOrDefault().GarantiaTarjetas.Holder;
                            dataRow["Numero"] = row.FirstOrDefault().GarantiaTarjetas.Numero;
                            dataRow["Mes"] = row.FirstOrDefault().GarantiaTarjetas.Mes;
                            dataRow["Ano"] = row.FirstOrDefault().GarantiaTarjetas.Ano;
                            dataRow["Cvv"] = row.FirstOrDefault().GarantiaTarjetas.Cvv;
                            dataRow["Usuario"] = row.FirstOrDefault().GarantiaTarjetas.Usuario;
                            dataRow["ModificadoPor"] = row.FirstOrDefault().GarantiaTarjetas.ModificadoPor;
                            dataRow["FechaModificacion"] = row.FirstOrDefault().GarantiaTarjetas.FechaModificacion;
                            GarantiaTarjetas.Rows.Add(dataRow);
                        }
                        break;

                    default: { } break;
                }


                ds.Tables.Add(EntityToDataTable(DatosEconomicos, "DatosEconomicos"));
                ds.Tables.Add(Cuentas);

                ds.Tables.Add(GarantiaPersonal);
                ds.Tables.Add(GarantiaHipotecaria);
                ds.Tables.Add(GarantiaVehiculos);
                ds.Tables.Add(GarantiaTarjetas);

                string path = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData);
                var file = Path.Combine(path, "ds.txt");
                using (StreamWriter sw = new StreamWriter(file))
                {
                    sw.Write(ds.GetXml());
                }

                return ds;
            }
            catch (Exception ex)
            {
                Core.Manager core = new Manager();
                core.NotificarException(ex);
                return new DataSet();
            }

        }

        public DataSet PrintArqueosGetByArqueoID(int ArqueoID)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsArqueosBE.Where(x => x.ArqueoID == ArqueoID).Include(x=>x.Turnos.Usuarios.Personas.Ciudades).Include(x=>x.Turnos.Cajas).FirstOrDefault();
                DataSet ds = new DataSet();

                DataTable Empresas = new DataTable("Empresas");
                Empresas.Columns.Add("Empresa", typeof(string));
                Empresas.Columns.Add("Direccion", typeof(string));
                Empresas.Columns.Add("Telefonos", typeof(string));
                Empresas.Columns.Add("Rnc", typeof(string));
                Empresas.Columns.Add("Sucursal", typeof(string));

                DataTable Arqueos = new DataTable("Arqueos");
                Arqueos.Columns.Add("ArqueoID", typeof(int));
                Arqueos.Columns.Add("TurnoID", typeof(int));
                Arqueos.Columns.Add("Fecha", typeof(DateTime));
                Arqueos.Columns.Add("Caja", typeof(string));
                Arqueos.Columns.Add("Documento", typeof(string));
                Arqueos.Columns.Add("Nombres", typeof(string));
                Arqueos.Columns.Add("Apellidos", typeof(string));
                Arqueos.Columns.Add("Foto", typeof(byte[]));
                Arqueos.Columns.Add("Direccion", typeof(string));
                Arqueos.Columns.Add("Ciudad", typeof(string));
                Arqueos.Columns.Add("Telefono", typeof(string));
                Arqueos.Columns.Add("Celular", typeof(string));

                Arqueos.Columns.Add("MontoInicial", typeof(decimal));
                Arqueos.Columns.Add("Efectivo", typeof(decimal));
                Arqueos.Columns.Add("Tarjeta", typeof(decimal));
                Arqueos.Columns.Add("Transferencia", typeof(decimal));
                Arqueos.Columns.Add("Cheque", typeof(decimal));
                Arqueos.Columns.Add("CajaGeneral", typeof(decimal));
                Arqueos.Columns.Add("Banco", typeof(decimal));
                Arqueos.Columns.Add("Monto", typeof(decimal));


                DataTable DetalleArqueos = new DataTable("DetalleArqueos");
                DetalleArqueos.Columns.Add("Denominacion", typeof(decimal));
                DetalleArqueos.Columns.Add("Cantidad", typeof(int));
                DetalleArqueos.Columns.Add("SubTotal", typeof(decimal));

                //Datos Empresas
                DataRow dataEmpresas = Empresas.NewRow();
                dataEmpresas["Empresa"] = row.Turnos.Usuarios.Sucursales.Empresas.Empresa;
                dataEmpresas["Direccion"] = row.Turnos.Usuarios.Sucursales.Direccion;
                dataEmpresas["Telefonos"] = row.Turnos.Usuarios.Sucursales.Telefonos;
                dataEmpresas["Rnc"] = row.Turnos.Usuarios.Sucursales.Empresas.Rnc;
                dataEmpresas["Sucursal"] = row.Turnos.Usuarios.Sucursales.Sucursal;
                Empresas.Rows.Add(dataEmpresas);

                //Datos Arqueos
                DataRow dataArqueos = Arqueos.NewRow();
                dataArqueos["ArqueoID"] = row.ArqueoID;
                dataArqueos["TurnoID"] = row.TurnoID;
                dataArqueos["Fecha"] = row.Fecha;
                dataArqueos["Caja"] = row.Turnos.Cajas.Caja;
                dataArqueos["Documento"] = row.Turnos.Documento;
                dataArqueos["Nombres"] = row.Turnos.Usuarios.Personas.Nombres;
                dataArqueos["Apellidos"] = row.Turnos.Usuarios.Personas.Apellidos;
                dataArqueos["Direccion"] = row.Turnos.Usuarios.Personas.Direccion;
                dataArqueos["Ciudad"] = row.Turnos.Usuarios.Personas.Ciudades.Ciudad;
                dataArqueos["Telefono"] = row.Turnos.Usuarios.Personas.Telefono;
                dataArqueos["Celular"] = row.Turnos.Usuarios.Personas.Celular;
                try
                {
                    dataArqueos["Foto"] = row.Turnos.Usuarios.Personas.Fotografias.Foto == null ? null : row.Turnos.Usuarios.Personas.Fotografias.Foto;
                }
                catch { }
                dataArqueos["MontoInicial"] = row.Turnos.Monto;

                //Recibos
                List<Core.Entity.Recibos> Recibos = new List<Core.Entity.Recibos>();
                Recibos = RecibosGroupByFormaPago(row.Turnos.Fecha, row.Turnos.Documento);

                //Rentas
                List<Core.Entity.Recibos> Rentas = new List<Core.Entity.Recibos>();
                Rentas = RentasGroupByFormaPago(row.Turnos.Fecha, row.Turnos.Documento);

                //Contratos
                List<Core.Entity.Recibos> Contratos = new List<Core.Entity.Recibos>();
                Contratos = ContratosGroupByFormaPago(row.Turnos.Fecha, row.Turnos.Documento);

                float _efectivos = (Recibos.Count() == 0 ? 0 : Recibos.Where(x => x.FormaPagoID == 1).Sum(x => x.Monto)) + (Rentas.Count() == 0 ? 0 : Rentas.Where(x => x.FormaPagoID == 1).Sum(x => x.Monto));
                float _tarjetas = (Recibos.Count() == 0 ? 0 : Recibos.Where(x => x.FormaPagoID == 2).Sum(x => x.Monto)) + (Rentas.Count() == 0 ? 0 : Rentas.Where(x => x.FormaPagoID == 2).Sum(x => x.Monto));
                float _cheques = (Recibos.Count() == 0 ? 0 : Recibos.Where(x => x.FormaPagoID == 3).Sum(x => x.Monto)) + (Rentas.Count() == 0 ? 0 : Rentas.Where(x => x.FormaPagoID == 3).Sum(x => x.Monto));
                float _transferencias = (Recibos.Count() == 0 ? 0 : Recibos.Where(x => x.FormaPagoID >= 4).Sum(x => x.Monto)) + (Rentas.Count() == 0 ? 0 : Rentas.Where(x => x.FormaPagoID >= 4).Sum(x => x.Monto));

                float _caja = Contratos.Count() == 0 ? 0 : Contratos.Where(x => x.FormaPagoID == 1).Sum(x => x.Monto);
                float _bancos = Contratos.Count() == 0 ? 0 : Contratos.Where(x => x.FormaPagoID != 1).Sum(x => x.Monto);

                dataArqueos["Efectivo"] = _efectivos;
                dataArqueos["Tarjeta"] = _tarjetas;
                dataArqueos["Transferencia"] = _transferencias;
                dataArqueos["Cheque"] = _cheques;
                dataArqueos["CajaGeneral"] = _caja;
                dataArqueos["Banco"] = _bancos;
                dataArqueos["Monto"] = (_efectivos + row.Turnos.Monto - _caja);

                Arqueos.Rows.Add(dataArqueos);

                //Datos DetalleArqueos
                foreach(var item in DetalleArqueosGetByArqueoID(row.ArqueoID))
                {
                    DataRow dataDetalleArqueos = DetalleArqueos.NewRow();
                    dataDetalleArqueos["Denominacion"] = item.Denominaciones.Denominacion;
                    dataDetalleArqueos["Cantidad"] = item.Cantidad;
                    dataDetalleArqueos["SubTotal"] = item.SubTotal;
                    DetalleArqueos.Rows.Add(dataDetalleArqueos);
                }

                ds.Tables.Add(Empresas);
                ds.Tables.Add(Arqueos);
                ds.Tables.Add(DetalleArqueos);

          

                return ds;
            }
            catch (Exception ex)
            {
                Core.Manager core = new Manager();
                core.NotificarException(ex);
                return new DataSet();
            }

        }

        #endregion

        #region ListaNegras

        public OperationResult ListaNegrasCreate(string Documento, string Motivo, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsListaNegrasBE.Where(x => x.Documento == Documento).FirstOrDefault();
                if (row == null)
                {
                    db.clsListaNegrasBE.Add(new clsListaNegrasBE { Documento = Documento, Fecha = DateTime.Now, Motivo = Motivo, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                }
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public List<clsListaNegrasBE> ListaNegrasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsListaNegrasBE.Where(x => x.Personas.Nombres.Contains(Search) || x.Personas.Apellidos.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsListaNegrasBE.ToList();
                }
            }
            catch
            {
                return new List<clsListaNegrasBE>();
            }
        }

        public clsListaNegrasBE ListaNegrasGetByDocumento(string Documento)
        {
            try
            {
                db = new DAL.Context();
                return db.clsListaNegrasBE.Where(x => x.Documento == Documento).FirstOrDefault();
            }
            catch
            {
                return new clsListaNegrasBE();
            }
        }

        public OperationResult ListaNegrasDelete(string Documento)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsListaNegrasBE.Where(x => x.Documento == Documento).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        #endregion

        #region Referencias

        public OperationResult ReferenciasCreate(int TipoReferenciaID, string Documento, string Referencia, string Direccion, String Telefono, string Usuario)
        {
            OperationResult result;
            try
            {
                int ID = 0;
                db = new DAL.Context();
                ID = (db.clsReferenciasBE.Count() == 0 ? 100000 : db.clsReferenciasBE.Max(x => x.ReferenciaID)) + 1;
                db.clsReferenciasBE.Add(new clsReferenciasBE { TipoReferenciaID = TipoReferenciaID, ReferenciaID = ID, Fecha = DateTime.Now, Documento = Documento, Referencia = Referencia, Direccion = Direccion, Telefono = Telefono, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ReferenciasUpdate(int ReferenciaID, int TipoReferenciaID, string Documento, string Referencia, string Direccion, String Telefono, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsReferenciasBE.Where(x => x.ReferenciaID == ReferenciaID).FirstOrDefault();
                row.TipoReferenciaID = TipoReferenciaID;
                row.Referencia = Referencia;
                row.Direccion = Direccion;
                row.Telefono = Telefono;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ReferenciasDeleteGetByDocumento(string Documento)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsReferenciasBE.Where(x => x.Documento == Documento);
                db.clsReferenciasBE.RemoveRange(row);
                db.SaveChanges();
                //foreach (clsReferenciasBE BE in row)
                //{
                //    var r = db.clsReferenciasBE.Where(x => x.ReferenciaID == BE.ReferenciaID).FirstOrDefault();
                //     db.Entry(r).State = EntityState.Deleted;
                //     db.SaveChanges();
                //}
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ReferenciasDelete(int ReferenciaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsReferenciasBE.Where(x => x.ReferenciaID == ReferenciaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsReferenciasBE> ReferenciasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsReferenciasBE.Where(x => x.Referencia.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsReferenciasBE.ToList();
                }
            }
            catch
            {
                return new List<clsReferenciasBE>();
            }
        }

        #endregion

        #region Notarios Publico

        public OperationResult NotariosPublicoCreate(int SucursalID, string Documento, string Direccion, string DocumentoPrimerTestigo, string NombrePrimerTestigo, string DireccionPrimerTestigo, string DocumentoSegundoTestigo, string NombreSegundoTestigo, string DireccionSegundoTestigo, string Exequatur, Boolean EstadoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = (db.clsOficialesBE.Count() == 0 ? 100000 : db.clsOficialesBE.Max(x => x.OficialID)) + 1;
                db.clsNotariosPublicoBE.Add(new clsNotariosPublicoBE { NotarioPublicoID = ID, SucursalID = SucursalID, Fecha = DateTime.Now, Documento = Documento, Direccion = Direccion, DocumentoPrimerTestigo = DocumentoPrimerTestigo, NombrePrimerTestigo = NombrePrimerTestigo, DireccionPrimerTestigo = DireccionPrimerTestigo, DocumentoSegundoTestigo = DocumentoSegundoTestigo, NombreSegundoTestigo = NombreSegundoTestigo, DireccionSegundoTestigo = DireccionSegundoTestigo, Exequatur = Exequatur, EstadoID = EstadoID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult NotariosPublicoUpdate(int SucursalID, string Documento, string Direccion, string DocumentoPrimerTestigo, string NombrePrimerTestigo, string DireccionPrimerTestigo, string DocumentoSegundoTestigo, string NombreSegundoTestigo, string DireccionSegundoTestigo, string Exequatur, Boolean EstadoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsNotariosPublicoBE.Where(x => x.Documento == Documento).FirstOrDefault();
                row.Direccion = Direccion;
                row.DocumentoPrimerTestigo = DocumentoPrimerTestigo;
                row.NombrePrimerTestigo = NombrePrimerTestigo;
                row.DireccionPrimerTestigo = DireccionPrimerTestigo;

                row.DocumentoSegundoTestigo = DocumentoSegundoTestigo;
                row.NombreSegundoTestigo = NombreSegundoTestigo;
                row.DireccionSegundoTestigo = DireccionSegundoTestigo;
                row.Exequatur = Exequatur;
                row.EstadoID = EstadoID;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult NotariosPublicoDelete(int NotarioPublicoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsNotariosPublicoBE.Where(x => x.NotarioPublicoID == NotarioPublicoID).FirstOrDefault();
                row.EstadoID = false;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsNotariosPublicoBE> NotariosPublicoGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsNotariosPublicoBE.Where(x => x.Personas.Apellidos.ToUpper().Contains(Search) || x.Personas.Nombres.ToUpper().Contains(Search) || x.Personas.Direccion.ToUpper().Contains(Search) || x.Personas.Telefono.ToUpper().Contains(Search) || x.Personas.Celular.ToUpper().Contains(Search) || x.Personas.Ciudades.Ciudad.ToUpper().Contains(Search)).ToList();
                }
                else
                {
                    return db.clsNotariosPublicoBE.ToList();
                }
            }
            catch
            {
                return new List<clsNotariosPublicoBE>();
            }
        }

        public clsNotariosPublicoBE NotariosPublicoGetByNotarioPublicoID(int NotarioPublicoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsNotariosPublicoBE.Where(x => x.NotarioPublicoID == NotarioPublicoID).FirstOrDefault();

            }
            catch
            {
                return new clsNotariosPublicoBE();
            }
        }

        public List<clsNotariosPublicoBE> NotariosPublicoGetBySucursalID(int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsNotariosPublicoBE.Where(x => x.SucursalID == SucursalID && x.EstadoID == true).ToList();

            }
            catch
            {
                return new List<clsNotariosPublicoBE>();
            }
        }

        public clsNotariosPublicoBE NotariosPublicoGetByDocumento(string Documento, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                var result = db.clsNotariosPublicoBE.Where(x => x.Documento == Documento && x.SucursalID == SucursalID).FirstOrDefault();
                return result;

            }
            catch
            {
                return new clsNotariosPublicoBE();
            }
        }


        #endregion

        #region Notarios Publico

        public OperationResult AbogadosCreate(int SucursalID, string Documento, string Direccion, string Exequatur, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                db.clsAbogadosBE.Add(new clsAbogadosBE { SucursalID = SucursalID, Fecha = DateTime.Now, Documento = Documento, Direccion = Direccion, Exequatur = Exequatur, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult AbogadosUpdate(int SucursalID, string Documento, string Direccion, string Exequatur, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsAbogadosBE.Where(x => x.SucursalID == SucursalID).FirstOrDefault();

                row.Direccion = Direccion;
                row.Exequatur = Exequatur;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult AbogadosDelete(int SucursalID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsAbogadosBE.Where(x => x.SucursalID == SucursalID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsAbogadosBE> AbogadosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    //return db.clsAbogadosBE.ToList();
                    return db.clsAbogadosBE.Where(x => x.Personas.Apellidos.ToUpper().Contains(Search) || x.Personas.Nombres.ToUpper().Contains(Search) || x.Personas.Direccion.ToUpper().Contains(Search) || x.Personas.Telefono.ToUpper().Contains(Search) || x.Personas.Celular.ToUpper().Contains(Search) || x.Personas.Ciudades.Ciudad.ToUpper().Contains(Search)).ToList();
                }
                else
                {
                    return db.clsAbogadosBE.ToList();
                }
            }
            catch
            {
                return new List<clsAbogadosBE>();
            }
        }

        public clsAbogadosBE AbogadosGet(int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsAbogadosBE.Where(x => x.SucursalID == SucursalID).FirstOrDefault();

            }
            catch
            {
                return new clsAbogadosBE();
            }
        }


        #endregion

        #region Sucursales

        public OperationResult SucursalesCreate(string Sucursal, string EmpresaID, int CiudadID, string Documento, string Direccion, string Telefonos, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsSucursalesBE.Count() == 0 ? 100000 : db.clsSucursalesBE.Max(x => x.SucursalID)) + 1;
                db.clsSucursalesBE.Add(new clsSucursalesBE { SucursalID = ID, Fecha = DateTime.Now, Sucursal = Sucursal, Direccion = Direccion, Telefonos = Telefonos, EmpresaID = EmpresaID, CiudadID = CiudadID, Documento = Documento, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult SucursalesUpdate(int SucursalID, string Sucursal, string EmpresaID, int CiudadID, string Documento, string Direccion, string Telefonos, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsSucursalesBE.Where(x => x.SucursalID == SucursalID).FirstOrDefault();
                row.Sucursal = Sucursal;
                row.EmpresaID = EmpresaID;
                row.CiudadID = CiudadID;
                row.Documento = Documento;
                row.Direccion = Direccion;
                row.Telefonos = Telefonos;
                row.ModificadoPor = Usuario;
                row.FechaModificacion = DateTime.Now;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult SucursalesDelete(int SucursalID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsSucursalesBE.Where(x => x.SucursalID == SucursalID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public clsSucursalesBE SucursalesGetBySucursalID(int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsSucursalesBE.Where(x => x.SucursalID == SucursalID).FirstOrDefault();
                return row;
            }
            catch
            {
                return new clsSucursalesBE();
            }
        }

        public List<clsSucursalesBE> SucursalesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsSucursalesBE.Where(x => x.Sucursal.Contains(Search) || x.Empresas.Empresa.Contains(Search) || x.Ciudades.Ciudad.Contains(Search) || x.Gerentes.Personas.Nombres.Contains(Search) || x.Gerentes.Personas.Apellidos.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsSucursalesBE.ToList();
                }
            }
            catch
            {
                return new List<clsSucursalesBE>();
            }
        }

        #endregion

        #region Empresas


        public OperationResult EmpresasUpdateMovilAccess(string EmpresaID, bool Key, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsEmpresasBE.Where(x => x.EmpresaID == EmpresaID).FirstOrDefault();

                row.Key = Common.FingerPrint.GetHash(Key.ToString());
                row.ModificadoPor = Usuario;
                row.FechaModificacion = DateTime.Now;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult EmpresasUpdatePlanID(string EmpresaID, int PlanID, int PaqueteID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsEmpresasBE.Where(x => x.EmpresaID == EmpresaID).FirstOrDefault();

                row.PlanID = PlanID;
                row.PaqueteID = PaqueteID;
                row.ModificadoPor = Usuario;
                row.FechaModificacion = DateTime.Now;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult EmpresasCreate(string EmpresaID, string Empresa, string Rnc, string Siglas, string Key, byte[] Logo, string CSR, string Device, int PlanID, int TipoEmpresaID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                db.clsEmpresasBE.Add(new clsEmpresasBE { EmpresaID = EmpresaID, Fecha = DateTime.Now, Empresa = Empresa, Logo = Logo, Siglas = Siglas, CSR = CSR, PlanID = PlanID, TipoEmpresaID = TipoEmpresaID, Device = Device, Rnc = Rnc, Key = Key, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult EmpresasUpdate(string EmpresaID, string Empresa, string Rnc, string Siglas, string Key, byte[] Logo, string CSR, string Device, int PlanID, int TipoEmpresaID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsEmpresasBE.Where(x => x.EmpresaID == EmpresaID).FirstOrDefault();
                row.Empresa = Empresa;
                row.EmpresaID = EmpresaID;
                row.Empresa = Empresa;
                row.Rnc = Rnc;
                row.PlanID = PlanID;
                row.Siglas = Siglas;
                row.CSR = CSR;
                row.TipoEmpresaID = TipoEmpresaID;
                if (Logo != null)
                {
                    row.Logo = Logo;
                }
                row.ModificadoPor = Usuario;
                row.FechaModificacion = DateTime.Now;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult EmpresasUpdatePaymentGetByEmpresaID(string EmpresaID, string Payment)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsEmpresasBE.Where(x => x.EmpresaID == EmpresaID).FirstOrDefault();
                row.Payment = Common.Generic.Encryption(Payment.Replace(" ", ""));
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult EmpresasDelete(string EmpresaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsEmpresasBE.Where(x => x.EmpresaID == EmpresaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public clsEmpresasBE EmpresasGetByEmpresaID(string EmpresaID)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsEmpresasBE.Where(x => x.EmpresaID == EmpresaID).FirstOrDefault();
                return row;
            }
            catch
            {
                return new clsEmpresasBE();
            }
        }

        public List<clsEmpresasBE> EmpresasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsEmpresasBE.Where(x => x.Empresa.Contains(Search) || x.Empresa.Contains(Search) || x.Rnc.Contains(Search) || x.Planes.Plan.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsEmpresasBE.ToList();
                }
            }
            catch
            {
                return new List<clsEmpresasBE>();
            }
        }


        #endregion

        #region Contratos

        public OperationResult ContratosCreate(DateTime Fecha, DateTime Vence, int SolicitudID, int TipoContratoID, string NumeroActo, float Comision, float Interes, float Mora, float Cuota, bool DataCredito, bool MoraAutomatica, bool LetterDelay, int DiasGracia, int NotarioPublicoID, int OficialID, int ZonaID, bool IsLegal, float Legal, bool IsSeguro, float Seguro, int ObjetivoID, bool InteresDiario, bool MoraDiaria, string Usuario, int EstadoID = 1)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = (db.clsContratosBE.Count() == 0 ? 100000 : db.clsContratosBE.Max(x => x.ContratoID));
                string Acto = string.Empty;

                if (string.IsNullOrEmpty(NumeroActo))
                {
                    var r = db.clsActosBE.Where(x => x.NotarioPublicoID == NotarioPublicoID);
                    if (r.Count() > 0)
                    {
                        var A = r.Where(x => x.Ano == Fecha.Year);
                        if (A.Count() > 0)
                        {
                            Acto = (A.FirstOrDefault().Acto + A.FirstOrDefault().Secuencia) + "-" + A.FirstOrDefault().Ano;
                            var record = db.clsActosBE.Where(x => x.ActoID == A.FirstOrDefault().ActoID).FirstOrDefault();
                            record.Acto = A.FirstOrDefault().Acto + A.FirstOrDefault().Secuencia;
                            db.Entry(record).State = EntityState.Modified;
                            db.SaveChanges();
                        }
                        else
                        {
                            db.clsActosBE.Add(new clsActosBE { Ano = Fecha.Year, Acto = 1, Secuencia = 1, Fecha = Fecha, NotarioPublicoID = NotarioPublicoID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                        }
                    }
                }
                else
                {
                    Acto = NumeroActo;
                }

                db.clsContratosBE.Add(new clsContratosBE { ContratoID = ID + 1, Fecha = Fecha, Vence = Vence, SolicitudID = SolicitudID, Acto = Acto, TipoContratoID = TipoContratoID, Comision = Comision, Interes = Interes, Mora = Mora, Cuota = Cuota, DataCredito = DataCredito, MoraAutomatica = MoraAutomatica, LetterDelay = LetterDelay, DiasGracia = DiasGracia, NotarioPublicoID = NotarioPublicoID, OficialID = OficialID, ZonaID = ZonaID, EstadoID = EstadoID, IsLegal = IsLegal, Legal = Legal, IsSeguro = IsSeguro, Seguro = Seguro, ObjetivoID = ObjetivoID, InteresDiario = InteresDiario, MoraDiaria = MoraDiaria, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = db.clsContratosBE.Max(x => x.ContratoID).ToString() };

                var row = db.clsSolicitudesBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();

                row.EstadoID = 3;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();

                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                return new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };

            }
        }

        public async Task<OperationResult> ContratosUpdate(int ContratoID, DateTime Fecha, DateTime Vence, int SolicitudID, string NumeroActo, int TipoContratoID, float Comision, float Interes, float Mora, float Cuota, bool DataCredito, bool MoraAutomatica, bool LetterDelay, int DiasGracia, int NotarioPublicoID, int OficialID, int ZonaID, bool IsLegal, float Legal, bool IsSeguro, float Seguro, int ObjetivoID, bool InteresDiario, bool MoraDiaria, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();

                var HasReceipt = db.clsDetalleRecibosBE.Where(x => x.Recibos.ContratoID == ContratoID);
                var row = db.clsContratosBE.Where(x => x.ContratoID == ContratoID).FirstOrDefault();

                bool _TipoContratoID = TipoContratoID == row.TipoContratoID ? false : true;
                bool _interes = Interes == row.Interes ? false : true;
                bool _comision = Comision == row.Comision ? false : true;
                bool _InteresDiario = InteresDiario == row.InteresDiario ? false : true;

                if (HasReceipt.Count() == 0)
                {
                    row.SolicitudID = SolicitudID;
                    row.Fecha = Fecha;
                    row.Vence = Vence;
                    row.Acto = NumeroActo;
                    row.TipoContratoID = TipoContratoID;
                    row.Comision = Comision;
                    row.Interes = Interes;
                    row.Mora = Mora;
                    row.Cuota = Cuota;
                    row.DataCredito = DataCredito;
                    row.MoraAutomatica = MoraAutomatica;
                    row.LetterDelay = LetterDelay;
                    row.DiasGracia = DiasGracia;
                    row.NotarioPublicoID = NotarioPublicoID;
                    row.OficialID = OficialID;
                    row.ZonaID = ZonaID;
                    row.IsLegal = IsLegal;
                    row.Legal = Legal;
                    row.IsSeguro = IsSeguro;
                    row.Seguro = Seguro;
                    row.EstadoID = row.EstadoID == 0 ? 1 : row.EstadoID;
                    row.ObjetivoID = ObjetivoID;
                    row.InteresDiario = InteresDiario;
                    row.MoraDiaria = MoraDiaria;
                    row.FechaModificacion = DateTime.Now;
                    row.ModificadoPor = Usuario;
                }
                else
                {
                    row.SolicitudID = SolicitudID;
                    row.Fecha = Fecha;
                    row.Vence = Vence;
                    row.Acto = NumeroActo;
                    row.TipoContratoID = TipoContratoID;
                    //row.Comision = Comision;
                    //row.Interes = Interes;
                    row.Mora = Mora;
                    row.Cuota = Cuota;
                    row.DataCredito = DataCredito;
                    row.MoraAutomatica = MoraAutomatica;
                    row.LetterDelay = LetterDelay;
                    row.DiasGracia = DiasGracia;
                    row.NotarioPublicoID = NotarioPublicoID;
                    row.OficialID = OficialID;
                    row.ZonaID = ZonaID;
                    row.IsLegal = IsLegal;
                    row.Legal = Legal;
                    row.IsSeguro = IsSeguro;
                    row.Seguro = Seguro;
                    row.ObjetivoID = ObjetivoID;
                    row.InteresDiario = InteresDiario;
                    row.MoraDiaria = MoraDiaria;
                    row.FechaModificacion = DateTime.Now;
                    row.ModificadoPor = Usuario;
                }

                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };

                if (_comision == true || _TipoContratoID == true || _interes == true || _InteresDiario == true)
                {
                   //await RecalcularRecibosGetByContratoID(ContratoID);
                }

                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public void CheckStatus()
        {
            try
            {
                Console.WriteLine("*********** Revisando estatus de contratos ***********", DateTime.Now);
                foreach (var row in ContratosGet())
                {
                    clsCuotasView Cuotas = new clsCuotasView();
                    Cuotas.SetDataSource(row.ContratoID, 0);
                    var R = Cuotas.GetGroup();
                    float balance = Cuotas.BalanceCapital() < 0 ? 0 : Cuotas.BalanceCapital();
                    if (balance <= row.Solicitudes.Clientes.Sucursales.Configuraciones.MinimumAmount)
                    {
                        ContratosDeleteGetByContratoID(row.ContratoID, 2, "SALDO A CONTRATO #" + string.Format("{0:000000}", row.ContratoID.ToString()), Environment.MachineName);
                        Console.WriteLine("SALDO A CONTRATO # {0}", string.Format("{0:000000}", row.ContratoID.ToString()));
                    }
                    else
                    {
                        //ContratosDeleteGetByContratoID(row.ContratoID, 1, "", row.ModificadoPor);
                        //Console.WriteLine("REACTIVANDO CONTRATO # {0}", string.Format("{0:000000}", row.ContratoID.ToString()));
                    }
                }
            }
            catch { }
        }

        public List<clsContratosBE> ContratosGetByTipoSolicitudID(int TipoSolicitudID, int EstadoID)
        {
            try
            {
                db = new DAL.Context();
                List<clsContratosBE> result = new List<clsContratosBE>();

                result = db.clsContratosBE.Where(x => x.EstadoID == 1 && x.Solicitudes.TipoSolicitudID == TipoSolicitudID).ToList();
                return result.OrderBy(x => x.ContratoID).ToList();
            }
            catch
            {
                return new List<clsContratosBE>();
            }
        }

        public List<Contratos> ContratosGet(string Search, int EstadoID, string Documento)
        {
            try
            {
                db = new DAL.Context();
                List<Contratos> BE = new List<Contratos>();
                List<Contratos> result = new List<Contratos>();

                var row = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();
                if (row.Roles.ViewAllContract == true)
                {
                    BE = (from C in db.clsContratosBE.Where(x => x.EstadoID == EstadoID) join S in db.clsSolicitudesBE on C.SolicitudID equals S.SolicitudID join CI in db.clsClientesBE on S.ClienteID equals CI.ClienteID join P in db.clsPersonasBE on CI.Documento equals P.Documento join TS in db.clsTipoSolicitudesBE on S.TipoSolicitudID equals TS.TipoSolicitudID join CO in db.clsCondicionesBE on S.CondicionID equals CO.CondicionID select new Contratos { ContratoID = C.ContratoID, Fecha = C.Fecha, Completo = P.Nombres + " " + P.Apellidos, Nombres = P.Nombres, Apellidos = P.Apellidos, Apodo = P.Apodo, Condicion = CO.Condicion, Tiempo = S.Tiempo, Monto = (float)S.Monto, EstadoID = C.EstadoID, TipoSolicitud = TS.TipoSolicitud, TipoSolicitudID = TS.TipoSolicitudID, Vence = C.Vence, }).ToList();
                }
                else
                {
                    BE = (from C in db.clsContratosBE.Where(x => x.EstadoID == EstadoID) join S in db.clsSolicitudesBE on C.SolicitudID equals S.SolicitudID join CI in db.clsClientesBE.Where(x => x.SucursalID == row.SucursalID) on S.ClienteID equals CI.ClienteID join P in db.clsPersonasBE on CI.Documento equals P.Documento join TS in db.clsTipoSolicitudesBE on S.TipoSolicitudID equals TS.TipoSolicitudID join CO in db.clsCondicionesBE on S.CondicionID equals CO.CondicionID select new Contratos { ContratoID = C.ContratoID, Fecha = C.Fecha, Completo = P.Nombres + " " + P.Apellidos, Nombres = P.Nombres, Apellidos = P.Apellidos, Apodo = P.Apodo, Condicion = CO.Condicion, Tiempo = S.Tiempo, Monto = (float)S.Monto, EstadoID = C.EstadoID, TipoSolicitud = TS.TipoSolicitud, TipoSolicitudID = TS.TipoSolicitudID, Vence = C.Vence }).ToList();
                }


                if (!string.IsNullOrEmpty(Search))
                {
                    Search = Search.ToUpper();
                    result = BE.Where(x => x.ContratoID.ToString().Contains(Search) || x.Fecha.ToString().Contains(Search) || x.Completo.ToUpper().Contains(Search) || x.Apodo.ToUpper().Contains(Search) || x.Tiempo.ToString().Contains(Search) || x.Monto.ToString().Contains(Search) || x.Condicion.ToUpper().Contains(Search) || x.TipoSolicitud.ToUpper().Contains(Search)).ToList();
                    //result = BE.Where(x => x.Completo.StartsWith(Search)).ToList();
                }
                else
                {
                    result = BE;
                }
                return result.OrderBy(x => x.ContratoID).ToList();
                //return result.OrderBy(x => x.Completo).ToList();
            }
            catch
            {
                return new List<Contratos>();
            }
        }

        public List<clsContratosBE> ContratosGetRutaID(int RutaID, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                List<clsContratosBE> BE = new List<clsContratosBE>();
                List<clsContratosBE> result = new List<clsContratosBE>();
                if (RutaID > 0)
                {
                    BE = db.clsContratosBE.Where(x => x.Zonas.RutaID == RutaID && x.EstadoID == 1).ToList();
                }
                else
                {
                    BE = db.clsContratosBE.Where(x => x.EstadoID == 1).ToList();
                }

                if (SucursalID > 0)
                {
                    result = BE.Where(x => x.Solicitudes.Clientes.SucursalID == SucursalID).ToList();
                }
                else
                {
                    result = BE;
                }
                return result;
            }
            catch
            {
                return new List<clsContratosBE>();
            }
        }



        public void ContratosCheckStatus(int ContratoID)
        {
            try
            {
                clsCuotasView Cuotas = new clsCuotasView();
                Cuotas.SetDataSource(ContratoID, 0);
                var R = Cuotas.GetGroup();

                var row = ContratosGetByContratoID(ContratoID);
                float balance = Cuotas.BalanceCapital() < 0 ? 0 : Cuotas.BalanceCapital();
                if (balance < row.Solicitudes.Clientes.Sucursales.Configuraciones.MinimumAmount)
                {
                    ContratosDeleteGetByContratoID(row.ContratoID, 2, "SALDO A CONTRATO #" + string.Format("{0:000000}", row.ContratoID.ToString()), Environment.MachineName);
                    Console.WriteLine("SALDO A CONTRATO # {0}", string.Format("{0:000000}", row.ContratoID.ToString()));
                }
                else
                {
                    ContratosDeleteGetByContratoID(row.ContratoID, 1, "", Environment.MachineName);
                    Console.WriteLine("REACTIVANDO CONTRATO # {0}", string.Format("{0:000000}", row.ContratoID.ToString()));
                }
            }
            catch
            {

            }
        }

        public List<clsContratosBE> ContratosGet()
        {
            try
            {
                db = new DAL.Context();
                return db.clsContratosBE.Where(x => x.EstadoID == 1).ToList();
            }
            catch
            {
                return new List<clsContratosBE>();
            }
        }

        public List<clsContratosBE> ContratosGetByDocumento(string Documento)
        {
            db = new DAL.Context();
            var result = db.clsContratosBE.Where(x => x.Solicitudes.Clientes.Documento == Documento).ToList();
            return result;
        }

        public DataSet ContratosGetByDocumento(DateTime Hasta, string Documento)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string exePath = AppDomain.CurrentDomain.BaseDirectory;

                string query = System.IO.File.ReadAllText(AppDomain.CurrentDomain.BaseDirectory + "/Script/DataCreditoGetByDocumento.txt");

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = 43200;

                cm.CommandText = query;
                cm.Parameters.Add(new MySqlParameter("@Documento", Documento));

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }

        }

        public DataSet PrintListadosContratosGetByRutaID(DateTime Hasta, int RutaID, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string exePath = AppDomain.CurrentDomain.BaseDirectory;

                string query = System.IO.File.ReadAllText(AppDomain.CurrentDomain.BaseDirectory + "/Script/DataCreditoGetByFecha.txt");

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;

                cm.CommandText = query;
                if (RutaID > 0)
                {
                    cm.CommandText = query + " AND (Zonas.RutaID = @RutaID)";
                    cm.Parameters.Add(new MySqlParameter("@RutaID", RutaID));
                }
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));

                cm.CommandType = CommandType.Text;
                cm.Connection = cn; //yyyymmdd hh:mm:ss.mmm
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));

                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }

        }


        public clsContratosBE ContratosGetByContratoID(int ContratoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsContratosBE.Where(x => x.ContratoID == ContratoID).FirstOrDefault();
            }
            catch
            {
                return new clsContratosBE();
            }
        }

        public OperationResult ContratosDeleteGetByContratoID(int ContratoID, int EstadoID, string Motivo, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsContratosBE.Where(x => x.ContratoID == ContratoID).FirstOrDefault();
                row.Motivo = Motivo;
                row.EstadoID = EstadoID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        #endregion

        #region Cuotas

        public OperationResult CuotasCreate(int Numero, DateTime Vence, int ContratoID, float Capital, float Comision, float Interes, float Mora, float Legal, float Seguro, float Balance, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                //DateTime _fecha = new DateTime(Vence.Year, Vence.Month, Vence.Day);
                DateTime _vence = Vence;//_fecha.Add(new TimeSpan(23, 59, 59));



                int ID = 0;
                //var HasReceipt = db.clsDetalleRecibosBE.Where(x => x.Recibos.ContratoID == ContratoID && x.Numero == Numero);
                var HasReceipt = db.clsCuotasBE.Where(x => x.ContratoID == ContratoID && x.Numero == Numero);
                
                if (HasReceipt.Count() == 0)
                {
                    //    ID = (db.clsCuotasBE.Count() == 0 ? 100000 : db.clsCuotasBE.Max(x => x.CuotaID)) +1;
                    //    db.clsCuotasBE.Add(new clsCuotasBE { CuotaID = ID, ContratoID = ContratoID, Numero = Numero, Vence = Vence, Capital = Capital, Comision = Comision, Interes = Interes, Mora = Mora, Legal = Legal, Seguro = Seguro, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    //    db.SaveChanges();

                    MySqlConnection cn = new MySqlConnection();
                    MySqlDataAdapter da = new MySqlDataAdapter();
                    cn.ConnectionString = db.Database.Connection.ConnectionString;


                    cn.Open();
                    MySqlCommand cmd = new MySqlCommand();
                    cmd.CommandText = "SELECT IFNULL(Max(CuotaID), 100000) +1 as CuotaID from Cuotas;";
                    cmd.CommandType = CommandType.Text;
                    cmd.Connection = cn;

                    MySqlDataReader drPersonas = cmd.ExecuteReader();
                    while (drPersonas.Read())
                    {
                        ID = int.Parse(drPersonas["CuotaID"].ToString());
                    }

                    cn.Close();

                    cn.Open();
                    // Create the InsertCommand.
                    cmd = new MySqlCommand("INSERT INTO Cuotas (CuotaID, Numero, ContratoID, Vence, Capital, Comision, Interes, Mora, Legal, Seguro, Balance, IsComputed, Usuario, ModificadoPor, FechaModificacion) VALUES (@CuotaID, @Numero, @ContratoID, @Vence, @Capital, @Comision, @Interes, @Mora, @Legal, @Seguro, @Balance, 0, @Usuario, @Usuario, SYSDATE());", cn);
                    cmd.Parameters.Add(new MySqlParameter("@CuotaID", ID));
                    cmd.Parameters.Add(new MySqlParameter("@Numero", Numero));
                    cmd.Parameters.Add(new MySqlParameter("@ContratoID", ContratoID));
                    cmd.Parameters.Add(new MySqlParameter("@Vence", _vence));
                    cmd.Parameters.Add(new MySqlParameter("@Capital", Capital));
                    cmd.Parameters.Add(new MySqlParameter("@Comision", Comision));
                    cmd.Parameters.Add(new MySqlParameter("@Interes", Interes));
                    cmd.Parameters.Add(new MySqlParameter("@Mora", Mora));
                    cmd.Parameters.Add(new MySqlParameter("@Legal", Legal));
                    cmd.Parameters.Add(new MySqlParameter("@Seguro", Seguro));
                    cmd.Parameters.Add(new MySqlParameter("@Balance", Balance));
                    cmd.Parameters.Add(new MySqlParameter("@Usuario", Usuario));

                    da.InsertCommand = cmd;
                    cmd.ExecuteNonQuery();
                    cn.Close();

                    result = new OperationResult { ResponseCode = "00", ResponseMessage = (ID).ToString() };

                }
                else
                {
                    result = CuotasUpdate(HasReceipt.FirstOrDefault().CuotaID, Numero, _vence, ContratoID, Capital, Comision, Interes, Mora, Legal, Seguro, Balance, Usuario);
                }

                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult CuotasUpdate(int CuotaID, int Numero, DateTime Vence, int ContratoID, float Capital, float Comision, float Interes, float Mora, float Legal, float Seguro, float Balance, string Usuario)
        {
            OperationResult result;
            try
            {

                MySqlConnection cn = new MySqlConnection();
                MySqlDataAdapter da = new MySqlDataAdapter();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                db = new DAL.Context();
                var row = db.clsCuotasBE.Where(x => x.ContratoID == ContratoID && x.Numero == Numero).FirstOrDefault();

                MySqlCommand cmd = new MySqlCommand();
                cmd.Connection = cn;

                cn.Open();
                // Create the InsertCommand.
                cmd = new MySqlCommand("UPDATE Cuotas set Numero = @Numero, ContratoID = @ContratoID, Vence =  @Vence, Capital = @Capital, Comision = @Comision, Interes = @Interes, Mora = Mora + @Mora, Legal = Legal+ @Legal, Seguro = Seguro + @Seguro, Balance = @Balance, IsComputed =0 , ModificadoPor = @Usuario, FechaModificacion = SYSDATE() where CuotaID = @CuotaID;", cn);

                cmd.Parameters.Add(new MySqlParameter("@CuotaID", row.CuotaID));
                cmd.Parameters.Add(new MySqlParameter("@Numero", Numero));
                cmd.Parameters.Add(new MySqlParameter("@ContratoID", ContratoID));
                cmd.Parameters.Add(new MySqlParameter("@Vence", Vence));
                cmd.Parameters.Add(new MySqlParameter("@Capital", Capital));
                cmd.Parameters.Add(new MySqlParameter("@Comision", Comision));
                cmd.Parameters.Add(new MySqlParameter("@Interes", Interes));
                cmd.Parameters.Add(new MySqlParameter("@Mora", Mora));
                cmd.Parameters.Add(new MySqlParameter("@Legal", Legal));
                cmd.Parameters.Add(new MySqlParameter("@Seguro", Seguro));
                cmd.Parameters.Add(new MySqlParameter("@Balance", Balance));
                cmd.Parameters.Add(new MySqlParameter("@Usuario", Usuario));

                da.UpdateCommand = cmd;
                cmd.ExecuteNonQuery();
                cn.Close();


                result = new OperationResult { ResponseCode = "00", ResponseMessage = (CuotaID).ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult CuotasUpdateBalanceGetByCuotaID(int CuotaID, float Balance)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCuotasBE.Where(x => x.CuotaID == CuotaID).FirstOrDefault();
                row.Balance = Balance;
                row.FechaModificacion = DateTime.Now;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult CuotasUpdateGetByCuotaID(int CuotaID, bool IsComputed)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCuotasBE.Where(x => x.CuotaID == CuotaID).FirstOrDefault();
                row.IsComputed = IsComputed;
                row.FechaModificacion = DateTime.Now;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult CuotasUpdateGetAll(int ContratoID, bool IsComputed)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                foreach (var item in db.clsCuotasBE.Where(x => x.ContratoID == ContratoID))
                {
                    var row = item;
                    row.IsComputed = IsComputed;
                    row.Balance = 0;
                    row.FechaModificacion = DateTime.Now;
                    db.Entry(row).State = EntityState.Modified;
                    db.SaveChanges();
                }

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsCuotasBE> CuotasGetByContratoID(int ContratoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsCuotasBE.Where(x => x.ContratoID == ContratoID).ToList();
            }
            catch
            {
                return new List<clsCuotasBE>();
            }
        }

        public List<clsCuotasBE> CuotasGet()
        {
            try
            {
                db = new DAL.Context();
                return db.clsCuotasBE.Where(x => x.Contratos.EstadoID == 1).ToList();
            }
            catch
            {
                return new List<clsCuotasBE>();
            }
        }

        public OperationResult CuotasDeleteGetByContratoID(int ContratoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCuotasBE.Where(x => x.ContratoID == ContratoID);
                var HasReceipt = db.clsDetalleRecibosBE.Where(x => x.Recibos.ContratoID == ContratoID);
                if (HasReceipt.Count() == 0)
                {
                    db.clsCuotasBE.RemoveRange(row);
                    db.SaveChanges();
                    result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                }
                else
                {
                    result = new OperationResult { ResponseCode = "00", ResponseMessage = "No se puede eliminar las cuotas de este contrato." };
                }
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public double CalcularRiesgoGetByContratoID(int ContratoID, DateTime Hasta)
        {

            try
            {
                using (var db = new DAL.Context())
                {
                    // Traemos todas las cuotas del contrato que vencen hasta la fecha indicada
                    var cuotasQuery =
                        from c in db.clsCuotasBE
                        join co in db.clsContratosBE on c.ContratoID equals co.ContratoID
                        where c.ContratoID == ContratoID
                              && c.Vence <= Hasta
                        select new
                        {
                            Cuota = c,
                            co.DiasGracia
                        };

                    var cuotas = cuotasQuery.ToList();

                    if (!cuotas.Any())
                        return 0;

                    int atrasadas = 0;

                    foreach (var item in cuotas)
                    {
                        var cuota = item.Cuota;
                        int diasGracia = item.DiasGracia;

                        // Ultima fecha de pago de esa cuota
                        var ultimaFechaPago = (
                            from r in db.clsRecibosBE
                            join dr in db.clsDetalleRecibosBE on r.ReciboID equals dr.ReciboID
                            where r.EstadoID == true
                                  && r.ContratoID == ContratoID
                                  && dr.CuotaID == cuota.CuotaID
                            select (DateTime?)r.Fecha
                        ).Max();

                        // Si no hay pagos, tomamos @Hasta
                        DateTime fechaComparada = ultimaFechaPago ?? Hasta;

                        // Diferencia en días (MySQL traduce la resta de DateTime)
                        int diasAtraso = (int)(fechaComparada - cuota.Vence).TotalDays;

                        if (diasAtraso >= diasGracia)
                            atrasadas++;
                    }

                    decimal total = cuotas.Count;
                    decimal riesgo = (atrasadas / total) * 100m;

                    return Convert.ToDouble(riesgo);
                }
            }
            catch(Exception ex)
            {
                return 0;
            }
        }


        #endregion Cuotas

        #region Nota de Debitos

        public OperationResult DetalleNotaDebitosCreate(int CuotaID, string Concepto, float Capital, float Comision, float Interes, float Mora, float Legal, float Seguro, bool IsAutomatic, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = (db.clsDetalleNotaDebitosBE.Count() == 0 ? 100000 : db.clsDetalleNotaDebitosBE.Max(x => x.NotaDebitoID));
                db.clsDetalleNotaDebitosBE.Add(new clsDetalleNotaDebitosBE { NotaDebitoID = ID + 1, Fecha = DateTime.Now, CuotaID = CuotaID, Concepto = Concepto, Capital = Capital, Comision = Comision, Interes = Interes, Mora = Mora, Legal = Legal, Seguro = Seguro, Usuario = Usuario, IsAutomatic = IsAutomatic, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }



        public OperationResult MorasAutomaticaCreate(int CuotaID, bool MoraDiaria, DateTime Fecha, string Concepto, float Mora, bool IsAutomatic, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var BE = db.clsCuotasBE.Where(x => x.CuotaID == CuotaID).FirstOrDefault();
                var row = db.clsDetalleNotaDebitosBE.Where(x => x.CuotaID == CuotaID).FirstOrDefault();

                if (row == null && (BE.Contratos.Cuota * BE.Contratos.Mora / 100) > BE.DetalleNotaDebitos.Sum(x => x.Mora))
                {
                    int ID = (db.clsDetalleNotaDebitosBE.Count() == 0 ? 100000 : db.clsDetalleNotaDebitosBE.Max(x => x.NotaDebitoID));
                    db.clsDetalleNotaDebitosBE.Add(new clsDetalleNotaDebitosBE { NotaDebitoID = ID + 1, Fecha = Fecha, CuotaID = CuotaID, Concepto = Concepto, Mora = Mora, IsAutomatic = IsAutomatic, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                }
                else
                {
                    if (row != null)
                    {
                        if (MoraDiaria == true)
                        {
                            row.Mora = Mora;
                        }
                        else
                        {
                            row.Mora = Mora;
                        }
                        row.ModificadoPor = Usuario;
                        row.FechaModificacion = DateTime.Now;
                        db.Entry(row).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult NotaDebitoInteresAutomaticaCreate(int CuotaID, bool InteresDiario, DateTime Fecha, string Concepto, float Interes, bool IsAutomatic, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();

                var BE = db.clsCuotasBE.Where(x => x.CuotaID == CuotaID).FirstOrDefault();
                //var row = db.clsDetalleNotaDebitosBE.Where(x => x.CuotaID == CuotaID && x.Fecha.Day == Fecha.Day && x.Fecha.Month == Fecha.Month && x.Fecha.Year == Fecha.Year).FirstOrDefault();
                var row = db.clsDetalleNotaDebitosBE.Where(x => x.CuotaID == CuotaID).FirstOrDefault();

                if (row == null)
                {
                    if (Interes > 1)
                    {
                        int ID = (db.clsDetalleNotaDebitosBE.Count() == 0 ? 100000 : db.clsDetalleNotaDebitosBE.Max(x => x.NotaDebitoID));
                        db.clsDetalleNotaDebitosBE.Add(new clsDetalleNotaDebitosBE { NotaDebitoID = ID + 1, Fecha = Fecha, CuotaID = CuotaID, Concepto = Concepto, Interes = Interes, IsAutomatic = IsAutomatic, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                        db.SaveChanges();
                    }
                }
                else
                {
                    if (row != null)
                    {
                        if (InteresDiario == true)
                        {
                            row.Interes = Interes;
                        }
                        else
                        {
                            
                            row.Interes = Interes < 1 ? row.Interes : Interes;
                        }
                        row.ModificadoPor = Usuario;
                        row.FechaModificacion = DateTime.Now;
                        db.Entry(row).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }



                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult NDInteresAutomaticaCreate(int CuotaID, bool InteresDiario, DateTime Fecha, string Concepto, float Interes, bool IsAutomatic, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();

                var BE = db.clsCuotasBE.Where(x => x.CuotaID == CuotaID).FirstOrDefault();
                var row = db.clsDetalleNotaDebitosBE.Where(x => x.CuotaID == CuotaID && x.Fecha == Fecha).FirstOrDefault();

                //if (row == null && (BE.Interes) > BE.DetalleNotaDebitos.Sum(x => x.Interes))
                if (row == null)
                {
                    if (Interes > 1)
                    {
                        int ID = (db.clsDetalleNotaDebitosBE.Count() == 0 ? 100000 : db.clsDetalleNotaDebitosBE.Max(x => x.NotaDebitoID));
                        db.clsDetalleNotaDebitosBE.Add(new clsDetalleNotaDebitosBE { NotaDebitoID = ID + 1, Fecha = Fecha, CuotaID = CuotaID, Concepto = Concepto, Interes = Interes, IsAutomatic = IsAutomatic, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                        db.SaveChanges();
                    }
                }
                else
                {
                    if (row != null)
                    {
                        if (InteresDiario == true)
                        {
                            row.Interes += Interes;
                        }
                        else
                        {
                            row.Interes = Interes < 1 ? row.Interes : Interes;
                        }
                        row.ModificadoPor = Usuario;
                        row.FechaModificacion = DateTime.Now;
                        db.Entry(row).State = EntityState.Modified;
                        db.SaveChanges();
                    }
                }



                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public List<clsDetalleNotaDebitosBE> DetalleNotaDebitosGetByContratoID(int ContratoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetalleNotaDebitosBE.Where(x => x.Cuotas.ContratoID == ContratoID).ToList();
            }
            catch
            {
                return new List<clsDetalleNotaDebitosBE>();
            }
        }

        public OperationResult DetalleNotaDebitosDeleteGetByContratoID(int ContratoID)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleNotaDebitosBE.Where(x => x.Cuotas.ContratoID == ContratoID).ToList();
                db.clsDetalleNotaDebitosBE.RemoveRange(row);
                db.SaveChanges();
                return new OperationResult { ResponseCode = "00", ResponseMessage = "" };
            }
            catch(Exception ex)
            {
                return new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message};
            }
        }

        public List<clsDetalleNotaDebitosBE> DetalleNotaDebitosGet(string Search = null)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsDetalleNotaDebitosBE.Where(x => x.Concepto.Contains(Search) || x.Cuotas.Contratos.Solicitudes.Clientes.Personas.Nombres.Contains(Search) || x.Cuotas.Contratos.Solicitudes.Clientes.Personas.Apellidos.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsDetalleNotaDebitosBE.ToList();
                }
            }
            catch
            {
                return new List<clsDetalleNotaDebitosBE>();
            }
        }

        #endregion

        #region Nota de Credito

        public OperationResult DetalleNotaCreditosCreate(int CuotaID, string Concepto, float Capital, float Comision, float Interes, float Mora, float Legal, float Seguro, bool IsAutomatic, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = (db.clsDetalleNotaCreditosBE.Count() == 0 ? 100000 : db.clsDetalleNotaCreditosBE.Max(x => x.NotaCreditoID));
                db.clsDetalleNotaCreditosBE.Add(new clsDetalleNotaCreditosBE { NotaCreditoID = ID + 1, Fecha = DateTime.Now, CuotaID = CuotaID, Concepto = Concepto, Capital = Capital, Comision = Comision, Interes = Interes, Mora = Mora, Legal = Legal, Seguro = Seguro, IsAutomatic = IsAutomatic, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public List<clsDetalleNotaCreditosBE> DetalleNotaCreditosGetByContratoID(int ContratoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetalleNotaCreditosBE.Where(x => x.Cuotas.ContratoID == ContratoID).ToList();
            }
            catch
            {
                return new List<clsDetalleNotaCreditosBE>();
            }
        }

        public OperationResult DetalleNotaCreditosDeleteGetByContratoID(int ContratoID)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleNotaCreditosBE.Where(x => x.Cuotas.ContratoID == ContratoID).ToList();
                db.clsDetalleNotaCreditosBE.RemoveRange(row);
                db.SaveChanges();
                return new OperationResult { ResponseCode = "00", ResponseMessage = "" };
            }
            catch (Exception ex)
            {
                return new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
            }
        }

        public List<clsDetalleNotaCreditosBE> DetalleNotaCreditosGet(string Search = null)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsDetalleNotaCreditosBE.Where(x => x.Concepto.Contains(Search) || x.Cuotas.Contratos.Solicitudes.Clientes.Personas.Nombres.Contains(Search) || x.Cuotas.Contratos.Solicitudes.Clientes.Personas.Apellidos.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsDetalleNotaCreditosBE.ToList();
                }
            }
            catch
            {
                return new List<clsDetalleNotaCreditosBE>();
            }
        }

        public OperationResult NCInteresAutomaticaCreate(int CuotaID, bool InteresDiario, DateTime Fecha, string Concepto, float Interes, bool IsAutomatic, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleNotaCreditosBE.Where(x => x.CuotaID == CuotaID && x.Fecha == Fecha).FirstOrDefault();
                if (row == null)
                {
                    if (Interes > 1)
                    {
                        int ID = (db.clsDetalleNotaCreditosBE.Count() == 0 ? 100000 : db.clsDetalleNotaCreditosBE.Max(x => x.NotaCreditoID));
                        db.clsDetalleNotaCreditosBE.Add(new clsDetalleNotaCreditosBE { NotaCreditoID = ID + 1, Fecha = Fecha, CuotaID = CuotaID, Concepto = Concepto, Interes = Interes, IsAutomatic = IsAutomatic, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                        db.SaveChanges();
                    }
                }
                else
                {
                    if (InteresDiario == true)
                    {
                        row.Interes = row.Interes + Interes;
                    }
                    else
                    {
                        row.Interes = Interes;
                    }
                    row.ModificadoPor = Usuario;
                    row.FechaModificacion = DateTime.Now;
                    db.Entry(row).State = EntityState.Modified;
                    db.SaveChanges();
                }

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }


        public OperationResult NotaCreditoInteresAutomatica(int CuotaID, bool InteresDiario, DateTime Fecha, string Concepto, float Interes, bool IsAutomatic, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                //var row = db.clsDetalleNotaCreditosBE.Where(x => x.CuotaID == CuotaID && x.Fecha == Fecha).FirstOrDefault();
                var row = db.clsDetalleNotaCreditosBE.Where(x => x.CuotaID == CuotaID).FirstOrDefault();
                if (row == null)
                {
                    if (Interes > 1)
                    {
                        int ID = (db.clsDetalleNotaCreditosBE.Count() == 0 ? 100000 : db.clsDetalleNotaCreditosBE.Max(x => x.NotaCreditoID));
                        db.clsDetalleNotaCreditosBE.Add(new clsDetalleNotaCreditosBE { NotaCreditoID = ID + 1, Fecha = Fecha, CuotaID = CuotaID, Concepto = Concepto, Interes = Interes, IsAutomatic = IsAutomatic, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                        db.SaveChanges();
                    }
                }
                else
                {
                    if (InteresDiario == true)
                    {
                        row.Interes = Interes;
                    }
                    else
                    {
                        row.Interes = Interes;
                    }
                    row.ModificadoPor = Usuario;
                    row.FechaModificacion = DateTime.Now;
                    db.Entry(row).State = EntityState.Modified;
                    db.SaveChanges();
                }

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        #endregion

        #region Recibos

        public OperationResult RecibosCreate(int ContratoID, DateTime Fecha, int SucursalID, int ComprobanteID, int FormaPagoID, float SubTotal, float Descuento, float Monto, float Total, float Cambio, string Informacion, string Usuario, bool EstadoID = true)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                DateTime _Fecha;
                bool IncrementNCF = false;
                //DateTime date =   Fecha.Add(new TimeSpan(Fecha.Hour * -1, Fecha.Minute * -1, Fecha.Second * -1));

                if (Fecha.Hour == 0 && Fecha.Minute == 0 && Fecha.Second == 0 && Fecha.Millisecond == 0)
                {
                    _Fecha = Fecha.Add(new TimeSpan(DateTime.Now.Hour, DateTime.Now.Minute, DateTime.Now.Second));
                }
                else
                {
                    _Fecha = Fecha;
                }

                string Ncf = string.Empty;
                if (ComprobanteID > 0)
                {

                    var row = db.clsComprobantesBE.Where(x => x.ComprobanteID == ComprobanteID).FirstOrDefault();
                    if (row != null)
                    {
                        if (row.Secuencia < row.Hasta)
                        {
                            Ncf = row.Prefijo.Substring(0, 3);
                            if (Ncf.StartsWith("E"))
                            {
                                Ncf = Ncf + string.Format("{0:0000000000}", row.Secuencia + 1);
                            }
                            else
                            {
                                Ncf = Ncf + string.Format("{0:00000000}", row.Secuencia + 1);
                            }
                            IncrementNCF = true;
                        }
                        else
                        {
                            IncrementNCF = false;
                        }
                    }
                }

                int ID = 0;

                MySqlConnection cn = new MySqlConnection();
                MySqlDataAdapter da = new MySqlDataAdapter();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                cn.Open();
                MySqlCommand cmd = new MySqlCommand();
                cmd.CommandText = "SELECT IFNULL(Max(ReciboID), 100000)+1 as ReciboID from Recibos;";
                cmd.CommandType = CommandType.Text;
                cmd.Connection = cn;

                MySqlDataReader drPersonas = cmd.ExecuteReader();
                while (drPersonas.Read())
                {
                    ID = int.Parse(drPersonas["ReciboID"].ToString());
                }

                cn.Close();


                string TokenID = $"{ContratoID}-{_Fecha.Month}{_Fecha.Day}{_Fecha.Year}{_Fecha.Hour}{_Fecha.Minute}{_Fecha.Second}-{SucursalID}-{Monto}-{Usuario}";

                db.clsRecibosBE.Add(new clsRecibosBE { ReciboID = ID, Fecha = _Fecha, ContratoID = ContratoID, SucursalID = SucursalID, ComprobanteID = ComprobanteID, Ncf = Ncf, FormaPagoID = FormaPagoID, SubTotal = SubTotal, Descuento = Descuento, Monto = Monto, Total = Total, Cambio = Cambio, TokenID = TokenID, EstadoID = EstadoID, Informacion = Informacion, Contabilizado = false, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };

                if (IncrementNCF)
                {
                    var c = db.clsComprobantesBE.Where(x => x.ComprobanteID == ComprobanteID).FirstOrDefault();
                    c.Secuencia = c.Secuencia + 1;
                    db.Entry(c).State = EntityState.Modified;
                    db.SaveChanges();
                }

                //ContabilizarRecibos(ID, Usuario);

                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult Contabilizar(int TipoEntradaID, int ID, String Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                switch (TipoEntradaID)
                {
                    case 2://Recibos
                        {
                            var row = db.clsRecibosBE.Where(x => x.ReciboID == ID).FirstOrDefault();
                            if (row.Sucursales.Configuraciones.IsAutomaticAccountting == true)
                            {

                                var xml = row.Sucursales.Configuraciones.Contabilizaciones.Where(x => x.ContabilizacionID == 100003).FirstOrDefault().Xml;
                                XDocument doc = XDocument.Parse(xml);
                                XElement Nodo = doc.Root.Element("settings");
                                int Debito = int.Parse(Nodo.Element("Debito").Value);
                                int Capital = int.Parse(Nodo.Element("Capital").Value);
                                int Comision = int.Parse(Nodo.Element("Comision").Value);
                                int Interes = int.Parse(Nodo.Element("Interes").Value);
                                int Mora = int.Parse(Nodo.Element("Mora").Value);
                                int Legal = int.Parse(Nodo.Element("Legal").Value);
                                int Seguro = int.Parse(Nodo.Element("Seguro").Value);
                                int Descuento = int.Parse(Nodo.Element("Descuento").Value);

                                var exist = db.clsDetalleEntradasBE.Where(x => x.Numero == ID && x.TipoEntradaID == TipoEntradaID);
                                OperationResult response = new OperationResult();
                                if (exist.Count() == 0)
                                {
                                    response = EntradasCreate(row.Fecha, 0, row.SucursalID, "ED" + row.Fecha.Day.ToString() + row.Fecha.Month.ToString() + row.Fecha.Year.ToString(), $"RECIBO DE INGRESO #{row.ReciboID.ToString()} - {row.Contratos.Solicitudes.Clientes.Personas.Nombres.ToUpper()} {row.Contratos.Solicitudes.Clientes.Personas.Apellidos.ToUpper()}", row.SubTotal, row.SubTotal, row.Usuario);
                                }
                                else
                                {
                                    response = EntradasUpdate(exist.FirstOrDefault().EntradaID, row.Fecha, 0, row.SucursalID, "ED" + row.Fecha.Day.ToString() + row.Fecha.Month.ToString() + row.Fecha.Year.ToString(), $"RECIBO DE INGRESO #{row.ReciboID.ToString()} - {row.Contratos.Solicitudes.Clientes.Personas.Nombres.ToUpper()} {row.Contratos.Solicitudes.Clientes.Personas.Apellidos.ToUpper()}", row.SubTotal, row.SubTotal, row.Usuario);
                                }

                                try
                                {
                                    if (response.ResponseCode == "00")
                                    {
                                        DetalleEntradasDelete(int.Parse(response.ResponseMessage));

                                        DetalleEntradasCreate(int.Parse(response.ResponseMessage), (int)row.FormaPagos.AuxiliarID, 2, row.ReciboID, row.Monto, 0, row.Usuario);
                                        if (row.Descuento > 0)
                                        {
                                            DetalleEntradasCreate(int.Parse(response.ResponseMessage), Descuento, 2, row.ReciboID, row.Descuento, 0, row.Usuario);
                                        }

                                        if (row.DetalleRecibos.Sum(x => x.Capital) > 0)
                                        {
                                            DetalleEntradasCreate(int.Parse(response.ResponseMessage), (int)row.Contratos.Solicitudes.TipoSolicitudes.AuxiliarID, TipoEntradaID, row.ReciboID, 0, row.DetalleRecibos.Sum(x => x.Capital), row.Usuario);
                                        }
                                        if (row.DetalleRecibos.Sum(x => x.Comision) > 0)
                                        {
                                            DetalleEntradasCreate(int.Parse(response.ResponseMessage), Comision, TipoEntradaID, row.ReciboID, 0, row.DetalleRecibos.Sum(x => x.Comision), row.Usuario);
                                        }
                                        if (row.DetalleRecibos.Sum(x => x.Interes) > 0)
                                        {
                                            DetalleEntradasCreate(int.Parse(response.ResponseMessage), Interes, TipoEntradaID, row.ReciboID, 0, row.DetalleRecibos.Sum(x => x.Interes), row.Usuario);
                                        }
                                        if (row.DetalleRecibos.Sum(x => x.Mora) > 0)
                                        {
                                            DetalleEntradasCreate(int.Parse(response.ResponseMessage), Mora, TipoEntradaID, row.ReciboID, 0, row.DetalleRecibos.Sum(x => x.Mora), row.Usuario);
                                        }
                                        if (row.DetalleRecibos.Sum(x => x.Legal) > 0)
                                        {
                                            DetalleEntradasCreate(int.Parse(response.ResponseMessage), Legal, TipoEntradaID, row.ReciboID, 0, row.DetalleRecibos.Sum(x => x.Legal), row.Usuario);
                                        }

                                        if (row.DetalleRecibos.Sum(x => x.Seguro) > 0)
                                        {
                                            DetalleEntradasCreate(int.Parse(response.ResponseMessage), Seguro, TipoEntradaID, row.ReciboID, 0, row.DetalleRecibos.Sum(x => x.Seguro), row.Usuario);
                                        }

                                        var item = db.clsRecibosBE.Where(x => x.ReciboID == ID).FirstOrDefault();
                                        item.Contabilizado = true;
                                        db.Entry(item).State = EntityState.Modified;
                                        db.SaveChanges();
                                    }
                                }
                                catch { }
                            }
                        }
                        break;

                    case 3://Cheques
                        {
                            var row = db.clsChequesBE.Where(x => x.SolicitudChequeID == ID).FirstOrDefault();
                            if (row.SolicitudCheques.Bancos.Sucursales.Configuraciones.IsAutomaticAccountting == true)
                            {
                                var exist = db.clsDetalleEntradasBE.Where(x => x.Numero == ID && x.TipoEntradaID == TipoEntradaID);
                                OperationResult response = new OperationResult();
                                if (exist.Count() == 0)
                                {
                                    response = EntradasCreate(row.Fecha, 0, row.SolicitudCheques.Bancos.SucursalID, "ED" + row.Fecha.Day.ToString() + row.Fecha.Month.ToString() + row.Fecha.Year.ToString(), "CHEQUE BANCARIO #" + row.SolicitudChequeID.ToString() + ". POR CONCEPTO DE " + row.SolicitudCheques.Concepto + " A " + row.SolicitudCheques.Beneficiario, row.SolicitudCheques.Monto, row.SolicitudCheques.Monto, row.Usuario);
                                }
                                else
                                {
                                    response = EntradasUpdate(exist.FirstOrDefault().EntradaID, row.Fecha, 0, row.SolicitudCheques.Bancos.SucursalID, "ED" + row.Fecha.Day.ToString() + row.Fecha.Month.ToString() + row.Fecha.Year.ToString(), "CHEQUE BANCARIO #" + row.SolicitudChequeID.ToString() + ". POR CONCEPTO DE " + row.SolicitudCheques.Concepto + " A " + row.SolicitudCheques.Beneficiario, row.SolicitudCheques.Monto, row.SolicitudCheques.Monto, row.Usuario);
                                }

                                if (response.ResponseCode == "00")
                                {
                                    DetalleEntradasDelete(int.Parse(response.ResponseMessage));
                                    foreach (var i in row.SolicitudCheques.DetalleSolicitudCheques.ToList())
                                    {
                                        DetalleEntradasCreate(int.Parse(response.ResponseMessage), i.AuxiliarID, TipoEntradaID, i.SolicitudChequeID, i.Debito, i.Credito, i.ModificadoPor);
                                    }

                                    var item = db.clsChequesBE.Where(x => x.SolicitudChequeID == ID).FirstOrDefault();
                                    item.Contabilizado = true;
                                    db.Entry(item).State = EntityState.Modified;
                                    db.SaveChanges();
                                }
                            }
                        }
                        break;

                    case 4://Desembolsos
                        {
                            var row = db.clsDesembolsosBE.Where(x => x.DesembolsoID == ID).FirstOrDefault();
                            if (row.Sucursales.Configuraciones.IsAutomaticAccountting == true)
                            {
                                var exist = db.clsDetalleEntradasBE.Where(x => x.Numero == ID && x.TipoEntradaID == TipoEntradaID);
                                OperationResult response = new OperationResult();
                                if (exist.Count() == 0)
                                {
                                    response = EntradasCreate(row.Fecha, 0, row.SucursalID, "ED" + row.Fecha.Day.ToString() + row.Fecha.Month.ToString() + row.Fecha.Year.ToString(), "DESEMBOLSO #" + row.DesembolsoID.ToString(), row.Monto, row.Monto, row.Usuario);
                                }
                                else
                                {
                                    response = EntradasUpdate(exist.FirstOrDefault().EntradaID, row.Fecha, 0, row.SucursalID, "ED" + row.Fecha.Day.ToString() + row.Fecha.Month.ToString() + row.Fecha.Year.ToString(), "DESEMBOLSO #" + row.DesembolsoID.ToString(), row.Monto, row.Monto, row.Usuario);
                                }

                                if (response.ResponseCode == "00")
                                {
                                    DetalleEntradasDelete(int.Parse(response.ResponseMessage));
                                    foreach (var i in row.DetalleDesembolsos.ToList())
                                    {
                                        DetalleEntradasCreate(int.Parse(response.ResponseMessage), i.AuxiliarID, TipoEntradaID, i.DesembolsoID, i.Debito, i.Credito, i.ModificadoPor);
                                    }

                                    var item = db.clsDesembolsosBE.Where(x => x.DesembolsoID == ID).FirstOrDefault();
                                    item.Contabilizado = true;
                                    db.Entry(item).State = EntityState.Modified;
                                    db.SaveChanges();
                                }
                            }
                        }
                        break;

                    case 5://Facturas
                        {

                            //var row = db.clsFacturasBE.Where(x => x.FacturaID == ID).FirstOrDefault();
                            //if (row.Sucursales.Configuraciones.IsAutomaticAccountting == true)
                            //{
                            //    var xml = row.Sucursales.Configuraciones.Contabilizaciones.Where(x => x.ContabilizacionID == 100002).FirstOrDefault().Xml;
                            //    XDocument doc = XDocument.Parse(xml);
                            //    XElement Nodo = doc.Root.Element("settings");
                            //    int DebitoCO = int.Parse(Nodo.Element("DebitoCO").Value);
                            //    int DebitoCR = int.Parse(Nodo.Element("DebitoCR").Value);
                            //    int Inicial = int.Parse(Nodo.Element("Inicial").Value);
                            //    int CreditoCO = int.Parse(Nodo.Element("CreditoCO").Value);
                            //    int CreditoCR = int.Parse(Nodo.Element("CreditoCR").Value);
                            //    int Descuento = int.Parse(Nodo.Element("Descuento").Value);

                            //    var exist = db.clsDetalleEntradasBE.Where(x => x.Numero == ID && x.TipoEntradaID == TipoEntradaID);
                            //    OperationResult response = new OperationResult();
                            //    if (exist.Count() == 0)
                            //    {
                            //        response = EntradasCreate(row.Fecha, 0, row.SucursalID, "ED" + row.Fecha.Day.ToString() + row.Fecha.Month.ToString() + row.Fecha.Year.ToString(), $"{row.TipoFacturas.Nombre.ToUpper()} #{row.FacturaID} - {row.Clientes.Personas.Nombres.ToUpper()} {row.Clientes.Personas.Apellidos.ToUpper()}", row.Monto, row.Monto, row.Usuario);
                            //    }
                            //    else
                            //    {
                            //        response = EntradasUpdate(exist.FirstOrDefault().EntradaID, row.Fecha, 0, row.SucursalID, "ED" + row.Fecha.Day.ToString() + row.Fecha.Month.ToString() + row.Fecha.Year.ToString(), $"{row.TipoFacturas.Nombre.ToUpper()} #{row.FacturaID} - {row.Clientes.Personas.Nombres.ToUpper()} {row.Clientes.Personas.Apellidos.ToUpper()}", row.Monto, row.Monto, row.Usuario);
                            //    }

                            //    if (response.ResponseCode == "00")
                            //    {
                            //        DetalleEntradasDelete(int.Parse(response.ResponseMessage));
                            //        int Debito = row.TipoFacturaID == 1 ? DebitoCO : DebitoCR;
                            //        int Credito = row.TipoFacturaID == 1 ? CreditoCO : CreditoCR;


                            //        if (row.TipoFacturaID == 1)
                            //        {
                            //            DetalleEntradasCreate(int.Parse(response.ResponseMessage), Debito, TipoEntradaID, row.FacturaID, row.Monto, 0, Usuario);
                            //            if (row.Descuento > 0)
                            //            {
                            //                DetalleEntradasCreate(int.Parse(response.ResponseMessage), Descuento, TipoEntradaID, row.FacturaID, row.Descuento, 0, Usuario);
                            //            }
                            //            DetalleEntradasCreate(int.Parse(response.ResponseMessage), Credito, TipoEntradaID, row.FacturaID, 0, row.SubTotal, Usuario);
                            //        }
                            //        else
                            //        {
                            //            float MontoInicial = row.Monto - row.Solicitudes.Monto;
                            //            float Monto = row.Monto - MontoInicial;

                            //            DetalleEntradasCreate(int.Parse(response.ResponseMessage), Debito, TipoEntradaID, row.FacturaID, Monto, 0, Usuario);
                            //            if (MontoInicial > 0)
                            //            {
                            //                DetalleEntradasCreate(int.Parse(response.ResponseMessage), Inicial, TipoEntradaID, row.FacturaID, MontoInicial, 0, Usuario);
                            //            }


                            //            DetalleEntradasCreate(int.Parse(response.ResponseMessage), Credito, TipoEntradaID, row.FacturaID, 0, row.Monto, Usuario);
                            //        }



                            //        var item = db.clsFacturasBE.Where(x => x.FacturaID == ID).FirstOrDefault();
                            //        item.Contabilizado = true;
                            //        db.Entry(item).State = EntityState.Modified;
                            //        db.SaveChanges();
                            //    }



                            //}
                        }
                        break;

                    case 7://Compras
                        {
                            //var row = db.clsComprasBE.Where(x => x.CompraID == ID).FirstOrDefault();
                            //if (row.Sucursales.Configuraciones.IsAutomaticAccountting == true)
                            //{
                            //    var xml = row.Sucursales.Configuraciones.Contabilizaciones.Where(x => x.ContabilizacionID == 100001).FirstOrDefault().Xml;
                            //    XDocument doc = XDocument.Parse(xml);
                            //    XElement Nodo = doc.Root.Element("settings");
                            //    int DebitoID = int.Parse(Nodo.Element("Debito").Value);
                            //    int CreditoID = int.Parse(Nodo.Element("Credito").Value);
                            //    int Descuento = int.Parse(Nodo.Element("Descuento").Value);
                            //    if (row.TipoCompraID == 2)
                            //    {
                            //        var exist = db.clsDetalleEntradasBE.Where(x => x.Numero == ID && x.TipoEntradaID == TipoEntradaID);
                            //        OperationResult response = new OperationResult();
                            //        if (exist.Count() == 0)
                            //        {
                            //            response = EntradasCreate(row.Fecha, 0, row.SucursalID, "ED" + row.Fecha.Day.ToString() + row.Fecha.Month.ToString() + row.Fecha.Year.ToString(), $"{row.TipoCompras.Nombre.ToUpper()} #{row.Numero} - {row.Suplidores.Suplidor.ToUpper()}", row.Monto, row.Monto, row.Usuario);
                            //        }
                            //        else
                            //        {
                            //            response = EntradasUpdate(exist.FirstOrDefault().EntradaID, row.Fecha, 0, row.SucursalID, "ED" + row.Fecha.Day.ToString() + row.Fecha.Month.ToString() + row.Fecha.Year.ToString(), $"{row.TipoCompras.Nombre.ToUpper()} #{row.Numero} - {row.Suplidores.Suplidor.ToUpper()}", row.Monto, row.Monto, row.Usuario);
                            //        }

                            //        if (response.ResponseCode == "00")
                            //        {
                            //            DetalleEntradasDelete(int.Parse(response.ResponseMessage));

                            //            DetalleEntradasCreate(int.Parse(response.ResponseMessage), DebitoID, TipoEntradaID, row.CompraID, row.Monto, 0, Usuario);
                            //            DetalleEntradasCreate(int.Parse(response.ResponseMessage), CreditoID, TipoEntradaID, row.CompraID, 0, row.Monto, Usuario);

                            //            var item = db.clsComprasBE.Where(x => x.CompraID == ID).FirstOrDefault();
                            //            item.Contabilizado = true;
                            //            db.Entry(item).State = EntityState.Modified;
                            //            db.SaveChanges();
                            //        }
                            //    }


                            //}
                        }
                        break;
                }

                return new OperationResult();
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult RecibosUpdate(int ReciboID, int ContratoID, DateTime Fecha, int SucursalID, int ComprobanteID, int FormaPagoID, float SubTotal, float Descuento, float Monto, float Total, float Cambio, string Informacion, string Usuario)
        {
            OperationResult result;
            try
            {
                DateTime _Fecha = Fecha.Add(new TimeSpan(DateTime.Now.Hour, DateTime.Now.Minute, DateTime.Now.Second));
                db = new DAL.Context();

                var row = db.clsRecibosBE.Where(x => x.ReciboID == ReciboID).FirstOrDefault();
                row.Fecha = _Fecha;
                row.ContratoID = ContratoID;
                //row.SucursalID = SucursalID;
                row.FormaPagoID = FormaPagoID;
                row.SubTotal = SubTotal;
                row.Descuento = Descuento;
                row.Monto = Monto;
                row.Total = Total;
                row.Cambio = Cambio;
                row.Informacion = Informacion;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult RecibosDelete(int ReciboID, string Motivo, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsRecibosBE.Where(x => x.ReciboID == ReciboID).FirstOrDefault();
                row.EstadoID = false;
                row.Motivo = Motivo;
                row.ModificadoPor = Usuario;
                row.FechaModificacion = DateTime.Now;
                row.Contabilizado = false;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };

                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public async Task ValidarRecibosGet()
        {
            try
            {
                db = new DAL.Context();
                var recibos = from r in db.clsRecibosBE
                            join c in db.clsContratosBE on r.ContratoID equals c.ContratoID
                            where r.EstadoID == true
                                  && c.EstadoID == 1
                                  && r.SubTotal > 1
                                  && !db.clsDetalleRecibosBE.Any(dr => dr.ReciboID == r.ReciboID)
                            select r;

                //var query = (from r in db.clsRecibosBE.Where(e => e.EstadoID == true) where !(from d in db.clsDetalleRecibosBE select d.ReciboID).Contains(r.ReciboID) select r).ToList();
                //var recibos = from r in query join c in db.clsContratosBE.Where(e => e.EstadoID == 1) on r.ContratoID equals c.ContratoID select r;

                foreach (var row in recibos.ToList())
                {
                    if (row.Sucursales.EmpresaID != "3F6A-B879-167A-A21A-46D5-EEB3-D0EE-ADDC")
                    {
                        bool recalcular = true;
                        var dr = DetalleRecibosDeleteGetByContratoID(row.ContratoID);
                        var nd = DetalleNotaDebitosDeleteGetByContratoID(row.ContratoID);
                        var nc = DetalleNotaCreditosDeleteGetByContratoID(row.ContratoID);

                        OperationResult response = CuotasCreateAutomatica(row.Contratos, 2, recalcular);
                        if (response.ResponseCode == "00")
                        {
                            if (row.Sucursales.EmpresaID != "3F6A-B879-167A-A21A-46D5-EEB3-D0EE-ADDC")
                            {
                                await ReCalcularRecibosGetByContratoID(row.ContratoID, false);
                            }
                        }
                        Console.WriteLine($"ContratoID: { string.Format("{0:000000}", row.ContratoID)}");
                    }
                }
            }
            catch{}
        }

        private OperationResult CuotasCreateAutomatica(clsContratosBE ContratoBE, int VISTA, bool save)
        {
            try
            {

                List<clsCuotasBE> lstCuotas = new List<clsCuotasBE>();

                double MontoCapital = 0;
                double MontoComision = 0;
                double MontoInteres = 0;
                double ACapital = 0;
                double AComision = 0;
                double AInteres = 0;
                double Cuotas = 0;
                double Cuota = 0;
                double Monto = 0;


                int IdTipoContrato = ContratoBE.TipoContratoID;
                Boolean IsComision = ContratoBE.Comision > 0 ? true : false;
                clsCondicionesBE Condiciones = ContratoBE.Solicitudes.Condiciones;
                double Interes = Convert.ToDouble(ContratoBE.Interes);
                double Comision = Convert.ToDouble(ContratoBE.Comision);
                double Tiempo = Convert.ToDouble(ContratoBE.Solicitudes.Tiempo);


                if (IsComision == true)
                {
                    Monto = Convert.ToDouble(ContratoBE.Solicitudes.Monto);
                }
                else
                {
                    Monto = Convert.ToDouble(ContratoBE.Solicitudes.Monto) + (Convert.ToDouble(ContratoBE.Solicitudes.Monto) * (Convert.ToDouble(ContratoBE.Comision) / 100));
                }

                MontoCapital = (Convert.ToDouble(Monto) / Convert.ToDouble(ContratoBE.Solicitudes.Tiempo));
                if (IsComision == true)
                {
                    MontoComision = (Convert.ToDouble(MontoCapital) * (((Convert.ToDouble(ContratoBE.Comision)) / 100)));
                }
                else
                {
                    MontoComision = 0;
                }

                if (ContratoBE.TipoContratoID == 3 || ContratoBE.TipoContratoID == 5)
                {
                    MontoInteres = ((MontoCapital + MontoComision) * double.Parse(ContratoBE.Interes.ToString()) / 100) * double.Parse(ContratoBE.Solicitudes.Tiempo.ToString()) / Condiciones.Meses; ;

                }
                else
                {
                    MontoInteres = ((MontoCapital + MontoComision) * double.Parse(ContratoBE.Interes.ToString()) / 100) * double.Parse(ContratoBE.Solicitudes.Tiempo.ToString()) / Condiciones.Meses; ;
                }

                Cuota = Math.Round(MontoCapital + MontoComision + MontoInteres);

                //txtMontoPrestamo.Text = string.Format("{0:N2}", Math.Round(Convert.ToDouble(ContratoBE.Solicitudes.Tiempo) * (MontoCapital + MontoComision + MontoInteres)));


                double Factor1 = 0, Factor2 = 0, Factor = 0;
                if (ContratoBE.TipoContratoID == 1)
                {

                    //double Interes = 0; double Tiempo = 0;
                    Interes = Convert.ToDouble(ContratoBE.Interes) / 100;
                    Tiempo = Convert.ToDouble(ContratoBE.Solicitudes.Tiempo) / Condiciones.Meses;
                    Factor1 = Math.Round(((Math.Pow((1 + Interes), Tiempo)) - 1), 6);
                    Factor2 = Math.Round(Interes * Math.Pow((1 + Interes), Tiempo), 6);
                    Factor = Factor1 / Factor2;
                    if (Factor > 0)
                    {
                        //lblCuota.Text = string.Format("{0:N2}", Math.Round(((MontoCapital + MontoComision) * Tiempo) / Factor), 0);
                        //txtMontoPrestamo.Text = string.Format("{0:N2}", Math.Round(((MontoCapital + MontoComision) * Tiempo / Factor) * int.Parse(ContratoBE.Solicitudes.Tiempo), 0));
                        Cuota = Math.Round(((MontoCapital + MontoComision) * Tiempo) / Factor, 0);
                        Cuotas = Math.Round(((MontoCapital + MontoComision) * Tiempo) / Factor, 0);
                    }
                }
                else
                {
                    if (ContratoBE.TipoContratoID == 3 || ContratoBE.TipoContratoID == 5)
                    {
                        double a = 0;
                        if (IsComision == true)
                        {
                            a = Math.Round(MontoComision + MontoInteres, 0);
                        }
                        else
                        {
                            a = Math.Round(MontoInteres, 0);
                        }
                        Cuota = a;
                    }
                }


                int FormaPagoID = 1;
                if ((ContratoBE.Seguro + ContratoBE.Legal) > 0 && ContratoBE.SolicitudCheques.Count() > 0)
                {
                    FormaPagoID = 3;
                }

                System.DateTime Fecha;
                Fecha = ContratoBE.Fecha;
                int dia = Fecha.Day;
                DateTime _fecha = Fecha;
                DateTime _tmp = Fecha;
                int residuo = 0;

                for (int i = 1; i <= Convert.ToInt16(ContratoBE.Solicitudes.Tiempo); i++)
                {

                    //db = new Manager();
                    switch (ContratoBE.Solicitudes.CondicionID)
                    {
                        #region Mensual
                        case 1:
                            {
                                switch (ContratoBE.TipoContratoID)
                                {
                                    case 1:
                                        {
                                            if (IsComision == true)
                                            {
                                                AComision = MontoComision; //(Monto * (Convert.ToDouble(ContratoBE.Comision) / 100) / Condiciones.Meses);
                                            }
                                            else
                                            {
                                                AComision = 0;
                                            }
                                            AInteres = Math.Round(((Monto + AComision) * (Convert.ToDouble(ContratoBE.Interes) / 100)) / Condiciones.Meses);
                                            ACapital = Cuota - AInteres - AComision;
                                            Monto = Monto - ACapital;

                                            var request = CuotasCreate(i, Fecha.AddMonths(i), ContratoBE.ContratoID, (float)ACapital, (float)AComision, (float)AInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            if (i == 1 && save == true)
                                            {
                                                if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                {
                                                    string _concepto = string.Empty;
                                                    if (ContratoBE.Seguro > 0)
                                                    {
                                                        _concepto = "SEGURO DE VIDA";
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                    }

                                                    if (ContratoBE.Legal > 0)
                                                    {
                                                        if (string.IsNullOrEmpty(_concepto))
                                                        {
                                                            _concepto = "GASTOS DE CIERRE ";
                                                        }
                                                        else
                                                        {
                                                            _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                        }
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                    }

                                                    float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                    if (_value > 0 && VISTA == 1)
                                                    {
                                                        var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                        if (row.ResponseCode == "00")
                                                        {
                                                            DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                            Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                    case 3:
                                        {
                                            MontoInteres = (Convert.ToDouble(MontoCapital + MontoComision) * (Convert.ToDouble(ContratoBE.Interes) / 100) * (Convert.ToDouble(ContratoBE.Solicitudes.Tiempo) / Condiciones.Meses));
                                            if (i == Convert.ToInt16(ContratoBE.Solicitudes.Tiempo))
                                            {
                                                CuotasCreate(i, Fecha.AddMonths(i), ContratoBE.ContratoID, (float)Monto, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            }
                                            else
                                            {
                                                if (IsComision == true)
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddMonths(i), ContratoBE.ContratoID, 0, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddMonths(i), ContratoBE.ContratoID, 0, 0, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);

                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }

                                        }
                                        break;
                                    case 5:
                                        {
                                            MontoInteres = (Convert.ToDouble(MontoCapital + MontoComision) * (Convert.ToDouble(ContratoBE.Interes) / 100) * (Convert.ToDouble(ContratoBE.Solicitudes.Tiempo) / Condiciones.Meses));
                                            if (i == Convert.ToInt16(ContratoBE.Solicitudes.Tiempo))
                                            {
                                                CuotasCreate(i, Fecha.AddMonths(i), ContratoBE.ContratoID, (float)Monto, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            }
                                            else
                                            {
                                                if (IsComision == true)
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddMonths(i), ContratoBE.ContratoID, 0, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddMonths(i), ContratoBE.ContratoID, 0, 0, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }

                                        }
                                        break;
                                    default:
                                        {

                                            var request = CuotasCreate(i, Fecha.AddMonths(i), ContratoBE.ContratoID, (float)MontoCapital, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            if (i == 1 && save == true)
                                            {
                                                if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                {
                                                    string _concepto = string.Empty;
                                                    if (ContratoBE.Seguro > 0)
                                                    {
                                                        _concepto = "SEGURO DE VIDA";
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                    }

                                                    if (ContratoBE.Legal > 0)
                                                    {
                                                        if (string.IsNullOrEmpty(_concepto))
                                                        {
                                                            _concepto = "GASTOS DE CIERRE ";
                                                        }
                                                        else
                                                        {
                                                            _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                        }
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                    }

                                                    float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                    if (_value > 0 && VISTA == 1)
                                                    {
                                                        var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                        if (row.ResponseCode == "00")
                                                        {
                                                            DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                            Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                }
                            }
                            break;
                        #endregion

                        #region Quincenal
                        case 2:
                            {
                                if (dia == 1 || dia == 15)
                                {
                                    int DayOfMonth = DateTime.DaysInMonth(_tmp.Year, _tmp.Month);
                                    switch (DayOfMonth)
                                    {
                                        case 28:
                                            {
                                                if (_fecha.Day == 15)
                                                {
                                                    _fecha = new DateTime(_tmp.Year, _tmp.Month, 28);

                                                }
                                                else
                                                {
                                                    _fecha = new DateTime(_tmp.Year, _tmp.Month, 15);
                                                    residuo = -2;
                                                }
                                            }
                                            break;

                                        case 29:
                                            {
                                                if (_fecha.Day == 15)
                                                {
                                                    _fecha = new DateTime(_tmp.Year, _tmp.Month, 29);
                                                }
                                                else
                                                {
                                                    _fecha = new DateTime(_tmp.Year, _tmp.Month, 15);
                                                    residuo = -1;
                                                }
                                            }
                                            break;

                                        case 31:
                                            {
                                                if (_fecha.Day == 15)
                                                {
                                                    _fecha = new DateTime(_tmp.Year, _tmp.Month, 30);
                                                }
                                                else
                                                {
                                                    _fecha = new DateTime(_tmp.Year, _tmp.Month, 15);
                                                }
                                            }
                                            break;

                                        default:
                                            {
                                                if (_fecha.Day == 15)
                                                {
                                                    _fecha = new DateTime(_tmp.Year, _tmp.Month, 30);
                                                }
                                                else
                                                {
                                                    _fecha = new DateTime(_tmp.Year, _tmp.Month, 15);
                                                }
                                            }
                                            break;
                                    }

                                    _tmp = _fecha.AddDays(Condiciones.Dias + residuo);
                                    residuo = 0;
                                }
                                else
                                {
                                    _fecha = Fecha.AddDays(Condiciones.Dias * i);
                                }

                                switch (ContratoBE.TipoContratoID)
                                {
                                    case 1:
                                        {
                                            if (IsComision == true)
                                            {
                                                AComision = MontoComision;
                                            }
                                            else
                                            {
                                                AComision = 0;
                                            }

                                            AInteres = ((Monto + AComision) * (Convert.ToDouble(ContratoBE.Interes) / 100)) / Condiciones.Meses;
                                            ACapital = Cuotas - (AInteres + AComision);

                                            Monto = Monto - ACapital;

                                            //var request =   CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, (float)ACapital, (float)AComision, (float)AInteres, 0, 0, 0,  ContratoBE.Usuario);
                                            var request = CuotasCreate(i, _fecha, ContratoBE.ContratoID, (float)ACapital, (float)AComision, (float)AInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            if (i == 1 && save == true)
                                            {
                                                if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                {
                                                    string _concepto = string.Empty;
                                                    if (ContratoBE.Seguro > 0)
                                                    {
                                                        _concepto = "SEGURO DE VIDA";
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                    }

                                                    if (ContratoBE.Legal > 0)
                                                    {
                                                        if (string.IsNullOrEmpty(_concepto))
                                                        {
                                                            _concepto = "GASTOS DE CIERRE ";
                                                        }
                                                        else
                                                        {
                                                            _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                        }
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                    }

                                                    float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                    if (_value > 0 && VISTA == 1)
                                                    {
                                                        var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                        if (row.ResponseCode == "00")
                                                        {
                                                            DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                            Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                    case 3:
                                        {
                                            MontoInteres = (Convert.ToDouble(MontoCapital + MontoComision) * (Convert.ToDouble(ContratoBE.Interes) / 100) * (Convert.ToDouble(ContratoBE.Solicitudes.Tiempo) / Condiciones.Meses));
                                            if (i == Convert.ToInt16(ContratoBE.Solicitudes.Tiempo))
                                            {
                                                CuotasCreate(i, _fecha, ContratoBE.ContratoID, (float)Monto, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            }
                                            else
                                            {
                                                if (IsComision == true)
                                                {
                                                    var request = CuotasCreate(i, _fecha, ContratoBE.ContratoID, 0, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    var request = CuotasCreate(i, _fecha, ContratoBE.ContratoID, 0, 0, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                    case 5:
                                        {
                                            MontoInteres = (Convert.ToDouble(MontoCapital + MontoComision) * (Convert.ToDouble(ContratoBE.Interes) / 100) * (Convert.ToDouble(ContratoBE.Solicitudes.Tiempo) / Condiciones.Meses));
                                            if (i == Convert.ToInt16(ContratoBE.Solicitudes.Tiempo))
                                            {
                                                CuotasCreate(i, _fecha, ContratoBE.ContratoID, (float)Monto, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            }
                                            else
                                            {
                                                if (IsComision == true)
                                                {
                                                    var request = CuotasCreate(i, _fecha, ContratoBE.ContratoID, 0, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    var request = CuotasCreate(i, _fecha, ContratoBE.ContratoID, 0, 0, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);

                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                    default:
                                        {
                                            var request = CuotasCreate(i, _fecha, ContratoBE.ContratoID, (float)MontoCapital, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            if (i == 1 && save == true)
                                            {
                                                if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                {
                                                    string _concepto = string.Empty;
                                                    if (ContratoBE.Seguro > 0)
                                                    {
                                                        _concepto = "SEGURO DE VIDA";
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                    }

                                                    if (ContratoBE.Legal > 0)
                                                    {
                                                        if (string.IsNullOrEmpty(_concepto))
                                                        {
                                                            _concepto = "GASTOS DE CIERRE ";
                                                        }
                                                        else
                                                        {
                                                            _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                        }
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                    }

                                                    float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                    if (_value > 0 && VISTA == 1)
                                                    {
                                                        var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                        if (row.ResponseCode == "00")
                                                        {
                                                            DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                            Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);

                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                }
                            }
                            break;
                        #endregion

                        #region Semanal
                        case 3:
                            {
                                switch (ContratoBE.TipoContratoID)
                                {
                                    case 1:
                                        {
                                            if (IsComision == true)
                                            {
                                                AComision = MontoComision; //(Monto * (Convert.ToDouble(ContratoBE.Comision) / 100) / Condiciones.Meses);
                                            }
                                            else
                                            {
                                                AComision = 0;
                                            }
                                            AInteres = ((Monto + AComision) * (Convert.ToDouble(ContratoBE.Interes) / 100)) / Condiciones.Meses;
                                            ACapital = Cuotas - AInteres - AComision;
                                            Monto = Monto - ACapital;

                                            var request = CuotasCreate(i, Fecha.AddMonths(i), ContratoBE.ContratoID, (float)ACapital, (float)AComision, (float)AInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            if (i == 1 && save == true)
                                            {
                                                if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                {
                                                    string _concepto = string.Empty;
                                                    if (ContratoBE.Seguro > 0)
                                                    {
                                                        _concepto = "SEGURO DE VIDA";
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                    }

                                                    if (ContratoBE.Legal > 0)
                                                    {
                                                        if (string.IsNullOrEmpty(_concepto))
                                                        {
                                                            _concepto = "GASTOS DE CIERRE ";
                                                        }
                                                        else
                                                        {
                                                            _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                        }
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                    }

                                                    float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                    if (_value > 0 && VISTA == 1)
                                                    {
                                                        var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                        if (row.ResponseCode == "00")
                                                        {
                                                            DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                            Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);

                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                    case 3:
                                        {
                                            MontoInteres = (Convert.ToDouble(MontoCapital + MontoComision) * (Convert.ToDouble(ContratoBE.Interes) / 100) * (Convert.ToDouble(ContratoBE.Solicitudes.Tiempo) / Condiciones.Meses));
                                            if (i == Convert.ToInt16(ContratoBE.Solicitudes.Tiempo))
                                            {
                                                CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, (float)Monto, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            }
                                            else
                                            {
                                                if (IsComision == true)
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, 0, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, 0, 0, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);

                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                    case 5:
                                        {
                                            MontoInteres = (Convert.ToDouble(MontoCapital + MontoComision) * (Convert.ToDouble(ContratoBE.Interes) / 100) * (Convert.ToDouble(ContratoBE.Solicitudes.Tiempo) / Condiciones.Meses));
                                            if (i == Convert.ToInt16(ContratoBE.Solicitudes.Tiempo))
                                            {
                                                CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, (float)Monto, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            }
                                            else
                                            {
                                                if (IsComision == true)
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, 0, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, 0, 0, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                    default:
                                        {
                                            var request = CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, (float)MontoCapital, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            if (i == 1 && save == true)
                                            {
                                                if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                {
                                                    string _concepto = string.Empty;
                                                    if (ContratoBE.Seguro > 0)
                                                    {
                                                        _concepto = "SEGURO DE VIDA";
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                    }

                                                    if (ContratoBE.Legal > 0)
                                                    {
                                                        if (string.IsNullOrEmpty(_concepto))
                                                        {
                                                            _concepto = "GASTOS DE CIERRE ";
                                                        }
                                                        else
                                                        {
                                                            _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                        }
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                    }

                                                    float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                    if (_value > 0 && VISTA == 1)
                                                    {
                                                        var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                        if (row.ResponseCode == "00")
                                                        {
                                                            DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                            Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                        }

                                                    }
                                                }
                                            }
                                        }
                                        break;
                                }
                            }
                            break;
                        #endregion

                        #region Diario
                        case 4:
                            {
                                switch (ContratoBE.TipoContratoID)
                                {
                                    case 1:
                                        {
                                            if (IsComision == true)
                                            {
                                                AComision = MontoComision;
                                            }
                                            else
                                            {
                                                AComision = 0;
                                            }
                                            AInteres = ((Monto + AComision) * (Convert.ToDouble(ContratoBE.Interes) / 100)) / Condiciones.Meses;
                                            ACapital = Cuotas - AInteres - AComision;
                                            Monto = Monto - ACapital;
                                            var request = CuotasCreate(i, Fecha.AddDays(i), ContratoBE.ContratoID, (float)ACapital, (float)AComision, (float)AInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            if (i == 1 && save == true)
                                            {
                                                if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                {
                                                    string _concepto = string.Empty;
                                                    if (ContratoBE.Seguro > 0)
                                                    {
                                                        _concepto = "SEGURO DE VIDA";
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                    }

                                                    if (ContratoBE.Legal > 0)
                                                    {
                                                        if (string.IsNullOrEmpty(_concepto))
                                                        {
                                                            _concepto = "GASTOS DE CIERRE ";
                                                        }
                                                        else
                                                        {
                                                            _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                        }
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                    }

                                                    float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                    if (_value > 0 && VISTA == 1)
                                                    {
                                                        var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                        if (row.ResponseCode == "00")
                                                        {
                                                            DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                            Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                    case 3:
                                        {
                                            if (i == Convert.ToInt16(ContratoBE.Solicitudes.Tiempo))
                                            {
                                                CuotasCreate(i, Fecha.AddDays((Condiciones.Dias * i) + 4), ContratoBE.ContratoID, (float)Monto, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            }
                                            else
                                            {
                                                if (IsComision == true)
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddDays((Condiciones.Dias * i) + 4), ContratoBE.ContratoID, 0, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddDays((Condiciones.Dias * i) + 4), ContratoBE.ContratoID, 0, 0, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);

                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                    case 5:
                                        {
                                            if (i == Convert.ToInt16(ContratoBE.Solicitudes.Tiempo))
                                            {
                                                CuotasCreate(i, Fecha.AddDays((Condiciones.Dias * i) + 4), ContratoBE.ContratoID, (float)Monto, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            }
                                            else
                                            {
                                                if (IsComision == true)
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddDays((Condiciones.Dias * i) + 4), ContratoBE.ContratoID, 0, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddDays((Condiciones.Dias * i) + 4), ContratoBE.ContratoID, 0, 0, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);

                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                    default:
                                        {
                                            var request = CuotasCreate(i, Fecha.AddDays(i), ContratoBE.ContratoID, (float)MontoCapital, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            if (i == 1 && save == true)
                                            {
                                                if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                {
                                                    string _concepto = string.Empty;
                                                    if (ContratoBE.Seguro > 0)
                                                    {
                                                        _concepto = "SEGURO DE VIDA";
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                    }

                                                    if (ContratoBE.Legal > 0)
                                                    {
                                                        if (string.IsNullOrEmpty(_concepto))
                                                        {
                                                            _concepto = "GASTOS DE CIERRE ";
                                                        }
                                                        else
                                                        {
                                                            _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                        }
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                    }

                                                    float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                    if (_value > 0 && VISTA == 1)
                                                    {
                                                        var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                        if (row.ResponseCode == "00")
                                                        {
                                                            DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                            Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                }
                            }
                            break;
                        #endregion

                        #region Default
                        default:
                            {
                                switch (ContratoBE.TipoContratoID)
                                {
                                    case 1:
                                        {
                                            if (IsComision == true)
                                            {
                                                AComision = MontoComision;
                                            }
                                            else
                                            {
                                                AComision = 0;
                                            }
                                            AInteres = ((Monto + AComision) * (Convert.ToDouble(ContratoBE.Interes) / 100)) / Condiciones.Meses;
                                            ACapital = Cuotas - AInteres - AComision;
                                            Monto = Monto - ACapital;
                                            var request = CuotasCreate(i, Fecha.AddMonths(i), ContratoBE.ContratoID, (float)ACapital, (float)AComision, (float)AInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            if (i == 1 && save == true)
                                            {
                                                if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                {
                                                    string _concepto = string.Empty;
                                                    if (ContratoBE.Seguro > 0)
                                                    {
                                                        _concepto = "SEGURO DE VIDA";
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                    }

                                                    if (ContratoBE.Legal > 0)
                                                    {
                                                        if (string.IsNullOrEmpty(_concepto))
                                                        {
                                                            _concepto = "GASTOS DE CIERRE ";
                                                        }
                                                        else
                                                        {
                                                            _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                        }
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                    }

                                                    float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                    if (_value > 0 && VISTA == 1)
                                                    {
                                                        var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                        if (row.ResponseCode == "00")
                                                        {
                                                            DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                            Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                    case 3:
                                        {
                                            if (i == Convert.ToInt16(ContratoBE.Solicitudes.Tiempo))
                                            {
                                                CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, (float)Monto, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            }
                                            else
                                            {
                                                if (IsComision == true)
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, 0, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);

                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, 0, 0, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);

                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                    case 5:
                                        {
                                            if (i == Convert.ToInt16(ContratoBE.Solicitudes.Tiempo))
                                            {
                                                CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, (float)Monto, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            }
                                            else
                                            {
                                                if (IsComision == true)
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, 0, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    var request = CuotasCreate(i, Fecha.AddDays(Condiciones.Dias * i), ContratoBE.ContratoID, 0, 0, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                                    if (i == 1 && save == true)
                                                    {
                                                        if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                        {
                                                            string _concepto = string.Empty;
                                                            if (ContratoBE.Seguro > 0)
                                                            {
                                                                _concepto = "SEGURO DE VIDA";
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                            }

                                                            if (ContratoBE.Legal > 0)
                                                            {
                                                                if (string.IsNullOrEmpty(_concepto))
                                                                {
                                                                    _concepto = "GASTOS DE CIERRE ";
                                                                }
                                                                else
                                                                {
                                                                    _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                                }
                                                                DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                            }

                                                            float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                            if (_value > 0 && VISTA == 1)
                                                            {
                                                                var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                                if (row.ResponseCode == "00")
                                                                {
                                                                    DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                                    Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                    default:
                                        {
                                            var request = CuotasCreate(i, Fecha.AddDays(i), ContratoBE.ContratoID, (float)MontoCapital, (float)MontoComision, (float)MontoInteres, 0, 0, 0, 0, ContratoBE.Usuario);
                                            if (i == 1 && save == true)
                                            {
                                                if (ContratoBE.Solicitudes.Clientes.Sucursales.EmpresaID != "F764-0764-BD11-4648-BC52-13A6-16E4-D436")
                                                {
                                                    string _concepto = string.Empty;
                                                    if (ContratoBE.Seguro > 0)
                                                    {
                                                        _concepto = "SEGURO DE VIDA";
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "SEGURO DE VIDA CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, 0, ContratoBE.Seguro, true, ContratoBE.Usuario);
                                                    }

                                                    if (ContratoBE.Legal > 0)
                                                    {
                                                        if (string.IsNullOrEmpty(_concepto))
                                                        {
                                                            _concepto = "GASTOS DE CIERRE ";
                                                        }
                                                        else
                                                        {
                                                            _concepto = _concepto + " Y GASTOS DE CIERRE ";
                                                        }
                                                        DetalleNotaDebitosCreate(int.Parse(request.ResponseMessage), "GASTOS DE CIERRE CONTRATO #" + string.Format("{0:000000}", ContratoBE.ContratoID), 0, 0, 0, 0, ContratoBE.Legal, 0, true, ContratoBE.Usuario);
                                                    }

                                                    float _value = (ContratoBE.Legal + ContratoBE.Seguro);
                                                    if (_value > 0 && VISTA == 1)
                                                    {
                                                        var row = RecibosCreate(ContratoBE.ContratoID, DateTime.Now, ContratoBE.Solicitudes.Clientes.SucursalID, 0, FormaPagoID, _value, 0, _value, 0, 0, "", ContratoBE.Usuario);
                                                        if (row.ResponseCode == "00")
                                                        {
                                                            DetalleRecibosCreate(int.Parse(request.ResponseMessage), int.Parse(row.ResponseMessage), 1, _concepto, 0, 0, 0, 0, ContratoBE.Legal, ContratoBE.Seguro, _value, ContratoBE.Usuario);
                                                            Contabilizar(2, int.Parse(row.ResponseMessage), ContratoBE.Usuario);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        break;
                                }
                            }
                            break;
                            #endregion
                    }
                }

                //CuotasGroupCreate(lstCuotas);

                //if (ContratoBE.ContratoID > 0)
                //{
                //    ContratosGet();
                //}

                return new OperationResult { ResponseCode = "00", ResponseMessage = "" };

            }
            catch (Exception ex)
            {
                return new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
            }
        }


        public async Task ReCalcularRecibosGetByContratoID(int ContratoID, bool delete = true)
        {
            db = new DAL.Context();

            if (delete)
            {
                var u = CuotasUpdateGetAll(ContratoID, false);
                var dr = DetalleRecibosDeleteGetByContratoID(ContratoID);
                var nd = DetalleNotaDebitosDeleteGetByContratoID(ContratoID);
                var nc = DetalleNotaCreditosDeleteGetByContratoID(ContratoID);
            }

            foreach (var item in db.clsRecibosBE.Where(x => x.ContratoID == ContratoID).ToList())
            {
                await CalcularInteres(item.Fecha, ContratoID);
                await CalcularMoras(item.Fecha, ContratoID);
                var detalle = await PagosAutomaticos(ContratoID, item.SubTotal, item.Usuario);

                DetalleRecibosDeleteGetByReciboID(item.ReciboID);
                OperationResult result = new OperationResult();
                foreach (clsDetalleRecibosBE row in detalle.OrderBy(x => x.Numero))
                {
                    result = DetalleRecibosCreate(row.CuotaID, item.ReciboID, row.Numero, row.Concepto, row.Capital, row.Comision, row.Interes, row.Mora, row.Legal, row.Seguro, row.SubTotal, item.Usuario);
                }

                if (result.ResponseCode == "00")
                {
                    Contabilizar(2, item.ReciboID, item.Usuario);
                    clsCuotasView Cuotas = new clsCuotasView();
                    Cuotas.SetDataSource(ContratoID, item.ReciboID);
                    float Minimo = ContratosGetByContratoID(ContratoID).Solicitudes.Clientes.Sucursales.Configuraciones.MinimumAmount;
                    var R = Cuotas.GetGroup();
                    var balance = (Cuotas.BalanceGetByReciboID() < Minimo ? 0 : Cuotas.BalanceGetByReciboID());

                    if (balance <= Minimo)
                    {
                        ContratosDeleteGetByContratoID(ContratoID, 2, "SALDO A CONTRATO #" + ContratoID.ToString(), item.Usuario);
                    }
                }

            }


        }

        public Dictionary<int, string> CheckDuplicate(DateTime hasta)
        {
            try
            {
                db = new DAL.Context();
                DateTime Desde = hasta.AddDays(-7);
                DateTime Hasta = hasta.AddDays(1);
                DataSet ds = new DataSet();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT max(ReciboID) as ReciboID, Fecha, ContratoID, Monto, count(TokenID) FROM recibos where fecha between @Desde and @Hasta and estadoid=1 group by Fecha, ContratoID, Monto HAVING (COUNT(TokenID) > 1);";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", Hasta));

                Dictionary<int, string> lista = new Dictionary<int, string>();
                int ReciboID = 0;
                string value = string.Empty;
                MySqlDataReader drPersonas = cm.ExecuteReader();
                int x = 1;
                while (drPersonas.Read())
                {
                    ReciboID = int.Parse(drPersonas["ReciboID"].ToString());
                    RecibosDelete(ReciboID, "RECIBO DUPLICADO POR ERROR EN LA CONEXION A INTERNET", Environment.MachineName);
                    value = value + $"<li>{x}) - {ReciboID.ToString()}</li>";
                    x++;
                    int ContratoID = int.Parse(drPersonas["ContratoID"].ToString());
                    ContratosCheckStatus(ContratoID);
                }

                lista.Add(ReciboID, value);

                return lista;
            }
            catch
            {
                return new Dictionary<int, string>();
            }
        }

        public List<Recibos> RecibosGet(DateTime Desde, DateTime Hasta, string Search, string Documento)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                List<Recibos> result = new List<Recibos>();
                List<Recibos> BE = new List<Recibos>();

                var row = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();

                if (row.Roles.ViewAllReceipt == true)
                {
                    BE = (from R in db.clsRecibosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta) join C in db.clsContratosBE on R.ContratoID equals C.ContratoID join S in db.clsSolicitudesBE on C.SolicitudID equals S.SolicitudID join CI in db.clsClientesBE on S.ClienteID equals CI.ClienteID join P in db.clsPersonasBE on CI.Documento equals P.Documento join F in db.clsFormaPagosBE on R.FormaPagoID equals F.FormaPagoID select new Recibos { ReciboID = R.ReciboID, ContratoID = C.ContratoID, Fecha = R.Fecha, Completo = P.Nombres + " " + P.Apellidos, Nombre = F.Nombre, Monto = R.Monto, EstadoID = R.EstadoID, Contabilizado = R.Contabilizado, SucursalID = R.SucursalID, ComprobanteID = R.ComprobanteID, Descuento = R.Descuento, FormaPagoID = F.FormaPagoID, Informacion = R.Informacion, Ncf = R.Ncf, SubTotal = R.SubTotal, Documento = P.Documento }).ToList();
                }
                else
                {
                    BE = (from R in db.clsRecibosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.SucursalID == row.SucursalID) join C in db.clsContratosBE on R.ContratoID equals C.ContratoID join S in db.clsSolicitudesBE on C.SolicitudID equals S.SolicitudID join CI in db.clsClientesBE on S.ClienteID equals CI.ClienteID join P in db.clsPersonasBE on CI.Documento equals P.Documento join F in db.clsFormaPagosBE on R.FormaPagoID equals F.FormaPagoID select new Recibos { ReciboID = R.ReciboID, ContratoID = C.ContratoID, Fecha = R.Fecha, Completo = P.Nombres + " " + P.Apellidos, Nombre = F.Nombre, Monto = R.Monto, EstadoID = R.EstadoID, Contabilizado = R.Contabilizado, SucursalID = R.SucursalID, ComprobanteID = R.ComprobanteID, Descuento = R.Descuento, FormaPagoID = F.FormaPagoID, Informacion = R.Informacion, Ncf = R.Ncf, SubTotal = R.SubTotal, Documento = P.Documento }).ToList();
                }

                if (!string.IsNullOrEmpty(Search))
                {
                    Search = Search.ToUpper();
                    result = BE.Where(x => x.ReciboID.ToString().Contains(Search) || x.Completo.ToUpper().Contains(Search) || x.Monto.ToString().Contains(Search) || x.Nombre.ToUpper().Contains(Search) || x.ContratoID.ToString().Contains(Search) || x.Documento.Contains(Search)).ToList();
                }
                else
                {
                    result = BE.ToList();
                }

                return result.OrderBy(x => x.ReciboID).ToList();

            }
            catch
            {
                return new List<Recibos>();
            }
        }

        public List<Recibos> ContratosGroupByFormaPago(DateTime fecha, string documento)
        {
            db = new DAL.Context();
            DateTime _fecha = new DateTime(fecha.Year, fecha.Month, fecha.Day);
            DateTime _Desde = _fecha.Add(new TimeSpan(0, 0, 0));
            DateTime _Hasta = _fecha.Add(new TimeSpan(23, 59, 59));

            if (string.IsNullOrEmpty(documento) || documento == "-1")
            {
                var bancos = (from C in db.clsContratosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID <= 2)
                              join SC in db.clsSolicitudChequesBE on C.ContratoID equals SC.ContratoID
                              join B in db.clsBancosBE on SC.BancoID equals B.BancoID
                              group C by new { B.Banco } into gr
                              select new Recibos { FormaPagoID = 2, Nombre = gr.Key.Banco, Monto = gr.Sum(x => x.SolicitudCheques.FirstOrDefault().Monto - (x.SolicitudCheques.FirstOrDefault().Monto * (x.Legal / 100))) }).ToList();


                var tmp = (from C in db.clsContratosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID <= 2) select C).ToList();
                var except = (from C in db.clsContratosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID <= 2)
                              join SC in db.clsSolicitudChequesBE on C.ContratoID equals SC.ContratoID
                              join B in db.clsBancosBE on SC.BancoID equals B.BancoID
                              select C).ToList();

                var caja = tmp.Where(x => !except.Contains(x)).ToList();

                if (caja.Count() > 0)
                {
                    bancos.Add(new Recibos { FormaPagoID = 1, Nombre = "CAJA GENERAL", Monto = caja.Sum(x => (float)x.Solicitudes.Monto - ((float)x.Solicitudes.Monto * (x.Legal / 100))) });
                }

                return bancos;
            }
            else
            {
                var bancos = (from C in db.clsContratosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID <= 2 && x.Usuario == documento)
                              join SC in db.clsSolicitudChequesBE on C.ContratoID equals SC.ContratoID
                              join B in db.clsBancosBE on SC.BancoID equals B.BancoID
                              group C by new { B.Banco } into gr
                              select new Recibos { FormaPagoID = 2, Nombre = gr.Key.Banco, Monto = gr.Sum(x => x.SolicitudCheques.FirstOrDefault().Monto - (x.SolicitudCheques.FirstOrDefault().Monto * (x.Legal / 100))) }).ToList();


                var tmp = (from C in db.clsContratosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID <= 2 && x.Usuario == documento) select C).ToList();
                var except = (from C in db.clsContratosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID <= 2 && x.Usuario == documento)
                              join SC in db.clsSolicitudChequesBE on C.ContratoID equals SC.ContratoID
                              join B in db.clsBancosBE on SC.BancoID equals B.BancoID
                              select C).ToList();

                var caja = tmp.Where(x => !except.Contains(x)).ToList();

                if (caja.Count() > 0)
                {
                    bancos.Add(new Recibos { FormaPagoID = 1, Nombre = "CAJA GENERAL", Monto = caja.Sum(x => (float)x.Solicitudes.Monto - ((float)x.Solicitudes.Monto * (x.Legal / 100))) });
                }

                return bancos;
            }
        }

        public List<Recibos> RecibosGroupByFormaPago(DateTime fecha, string documento)
        {
            db = new DAL.Context();
            DateTime _fecha = new DateTime(fecha.Year, fecha.Month, fecha.Day);
            DateTime _Desde = _fecha.Add(new TimeSpan(0, 0, 0));
            DateTime _Hasta = _fecha.Add(new TimeSpan(23, 59, 59));

            if (string.IsNullOrEmpty(documento) || documento == "-1")
            {
                var BE = (from R in db.clsRecibosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID == true)
                          join F in db.clsFormaPagosBE on R.FormaPagoID equals F.FormaPagoID
                          group R by new { R.FormaPagoID, R.FormaPagos.Nombre } into gr
                          select new Recibos { FormaPagoID = gr.Key.FormaPagoID, Nombre = gr.Key.Nombre, Monto = gr.Sum(x => x.Monto) }).ToList();
                return BE;
            }
            else
            {
                var BE = (from R in db.clsRecibosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID == true && x.Usuario == documento)
                          join F in db.clsFormaPagosBE on R.FormaPagoID equals F.FormaPagoID
                          group R by new { R.FormaPagoID, R.FormaPagos.Nombre } into gr
                          select new Recibos { FormaPagoID = gr.Key.FormaPagoID, Nombre = gr.Key.Nombre, Monto = gr.Sum(x => x.Monto) }).ToList();
                return BE;
            }
        }

        public List<Recibos> RentasGroupByFormaPago(DateTime fecha, string documento)
        {
            db = new DAL.Context();
            DateTime _fecha = new DateTime(fecha.Year, fecha.Month, fecha.Day);
            DateTime _Desde = _fecha.Add(new TimeSpan(0, 0, 0));
            DateTime _Hasta = _fecha.Add(new TimeSpan(23, 59, 59));

            if (string.IsNullOrEmpty(documento) || documento == "-1")
            {
                var BE = (from R in db.clsPagoRentasBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID == true)
                          join F in db.clsFormaPagosBE on R.FormaPagoID equals F.FormaPagoID
                          group R by new { R.FormaPagoID, R.FormaPagos.Nombre } into gr
                          select new Recibos { FormaPagoID = gr.Key.FormaPagoID, Nombre = gr.Key.Nombre, Monto = gr.Sum(x => x.Monto) }).ToList();
                return BE;
            }
            else
            {
                var BE = (from R in db.clsPagoRentasBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID == true && x.Usuario == documento)
                          join F in db.clsFormaPagosBE on R.FormaPagoID equals F.FormaPagoID
                          group R by new { R.FormaPagoID, R.FormaPagos.Nombre } into gr
                          select new Recibos { FormaPagoID = gr.Key.FormaPagoID, Nombre = gr.Key.Nombre, Monto = gr.Sum(x => x.Monto) }).ToList();
                return BE;
            }
        }

        public List<clsDetalleRecibosBE> DetalleRecibosGroupByFecha(DateTime fecha, string documento)
        {
            try
            {
                db = new DAL.Context();
                DateTime _fecha = new DateTime(fecha.Year, fecha.Month, fecha.Day);
                DateTime _Desde = _fecha.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = _fecha.Add(new TimeSpan(23, 59, 59));
                List<clsDetalleRecibosBE> detalleRecibos = new List<clsDetalleRecibosBE>();
                List<clsRecibosBE> recibos = new List<clsRecibosBE>();

                if (string.IsNullOrEmpty(documento) || documento == "-1")
                {
                    detalleRecibos = (from R in db.clsRecibosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID == true)
                                      join DR in db.clsDetalleRecibosBE on R.ReciboID equals DR.ReciboID
                                      select DR).ToList();
                    recibos = (from R in db.clsRecibosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID == true) select R).ToList();
                }
                else
                {
                    detalleRecibos = (from R in db.clsRecibosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID == true && x.Usuario == documento)
                                      join DR in db.clsDetalleRecibosBE on R.ReciboID equals DR.ReciboID
                                      select DR).ToList();
                    recibos = (from R in db.clsRecibosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.EstadoID == true && x.Usuario == documento) select R).ToList();
                }

                List<clsDetalleRecibosBE> result = new List<clsDetalleRecibosBE>();
                result.Add(new clsDetalleRecibosBE { Concepto = "Capital", SubTotal = detalleRecibos.Sum(x => x.Capital) });
                result.Add(new clsDetalleRecibosBE { Concepto = "Comision", SubTotal = detalleRecibos.Sum(x => x.Comision) });
                result.Add(new clsDetalleRecibosBE { Concepto = "Interes", SubTotal = detalleRecibos.Sum(x => x.Interes) });
                result.Add(new clsDetalleRecibosBE { Concepto = "Mora", SubTotal = detalleRecibos.Sum(x => x.Mora) });
                result.Add(new clsDetalleRecibosBE { Concepto = "Legal", SubTotal = detalleRecibos.Sum(x => x.Legal) });
                result.Add(new clsDetalleRecibosBE { Concepto = "Seguro", SubTotal = detalleRecibos.Sum(x => x.Seguro) });
                result.Add(new clsDetalleRecibosBE { Concepto = "Descuento", SubTotal = recibos.Sum(x => x.Descuento) == 0 ? 0 : recibos.Sum(x => x.Descuento) * -1 });

                return result;
            }
            catch
            {
                return new List<clsDetalleRecibosBE>();
            }

        }

        public clsRecibosBE RecibosGetByReciboID(int ReciboID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsRecibosBE.Where(x => x.ReciboID == ReciboID).FirstOrDefault();
            }
            catch
            {
                return new clsRecibosBE();
            }
        }

        public bool RecibosGetByTokenID0(int ContratoID, DateTime Fecha, float Monto, string TokenID, string Usuario)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsRecibosBE.Where(x => x.TokenID == TokenID && x.EstadoID == true);
                if (row.Count() == 0)
                {
                    return false;
                }
                return true;
            }
            catch (Exception ex)
            {
                return false;
            }
        }


        public bool RecibosGetByTokenID(string TokenID)
        {
            try
            {
                db = new DAL.Context();
                bool result = false;
                DataSet ds = new DataSet();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT count(ReciboID) as ReciboID  FROM recibos where estadoid = 1 and TokenID = @TokenID;";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@TokenID", TokenID));

                MySqlDataReader drPersonas = cm.ExecuteReader();
                while (drPersonas.Read())
                {
                    int ReciboID = int.Parse(drPersonas["ReciboID"].ToString());
                    if (ReciboID == 0)
                    {
                        result = false;
                    }
                    else
                    {
                        result = true;
                    }
                    cn.Close();
                    return result;
                }
                cn.Close();
                return result;
            }
            catch (Exception ex)
            { return false; }
        }

        public DataTable EntityToDataTable<T>(IEnumerable<T> varlist, String Name)
        {
            DataTable dtReturn = new DataTable(Name);
            PropertyInfo[] oProps = null;
            if (varlist == null) return dtReturn;
            foreach (T rec in varlist)
            {
                if (oProps == null)
                {
                    oProps = ((Type)rec.GetType()).GetProperties();
                    foreach (PropertyInfo pi in oProps)
                    {
                        Type colType = pi.PropertyType;
                        if ((colType.IsGenericType) && (colType.GetGenericTypeDefinition() == typeof(Nullable<>)))
                        {
                            colType = colType.GetGenericArguments()[0];
                        }

                        dtReturn.Columns.Add(new DataColumn(pi.Name, colType));
                    }
                }

                DataRow dr = dtReturn.NewRow();
                foreach (PropertyInfo pi in oProps)
                {
                    dr[pi.Name] = pi.GetValue(rec, null) == null ? DBNull.Value : pi.GetValue
                    (rec, null);
                }

                dtReturn.Rows.Add(dr);
            }

            return dtReturn;
        }

        public DataSet PrintDesembolsosGetByDesembolsoID(int DesembolsoID)
        {
            try
            {
                db = new DAL.Context();
                DataSet ds = new DataSet();

                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //Desembolsos
                cn.Open();
                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT Desembolsos.DesembolsoID, Desembolsos.Fecha, Desembolsos.Beneficiario, Desembolsos.Concepto, Desembolsos.Monto, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal FROM Desembolsos INNER JOIN Sucursales ON Desembolsos.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID WHERE (Desembolsos.DesembolsoID = @DesembolsoID)";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@DesembolsoID", DesembolsoID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Desembolsos");
                cn.Close();

                //DetalleDesembolsos
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT DetalleDesembolsos.DesembolsoID, Auxiliares.Codigo, Auxiliares.Auxiliar, DetalleDesembolsos.Debito, DetalleDesembolsos.Credito FROM DetalleDesembolsos INNER JOIN Auxiliares ON DetalleDesembolsos.AuxiliarID = Auxiliares.AuxiliarID WHERE (DetalleDesembolsos.DesembolsoID = @DesembolsoID)";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@DesembolsoID", DesembolsoID));
                da.SelectCommand = cm;
                da.Fill(ds, "DetalleDesembolsos");
                cn.Close();

                DataTable Cuentas = new DataTable("Cuentas");
                Cuentas.Columns.Add("BarCode", typeof(byte[]));
                DataRow dataRow = Cuentas.NewRow();
                dataRow["BarCode"] = ImageFromText(DesembolsoID.ToString());
                Cuentas.Rows.Add(dataRow);

                ds.Tables.Add(Cuentas);
                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }

        public DataSet PrintEntradasGetByEntradaID(int EntradaID)
        {
            try
            {
                db = new DAL.Context();
                DataSet ds = new DataSet();

                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //Entradas
                cn.Open();
                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT Entradas.EntradaID, Entradas.Fecha, Entradas.Referencia, Entradas.Concepto, Sucursales.Sucursal, TipoMovimientos.Movimiento, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Empresas.Siglas FROM Entradas INNER JOIN Sucursales ON Entradas.SucursalID = Sucursales.SucursalID INNER JOIN TipoMovimientos ON Entradas.TipoMovimientoID = TipoMovimientos.TipoMovimientoID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@EntradaID", EntradaID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Entradas");
                cn.Close();

                //DetalleEntradas
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT DetalleEntradas.EntradaID, Auxiliares.Codigo, Auxiliares.Auxiliar, TipoEntradas.TipoEntrada as TipoDocumento, DetalleEntradas.Numero, DetalleEntradas.Debito, DetalleEntradas.Credito FROM DetalleEntradas INNER JOIN Auxiliares ON DetalleEntradas.AuxiliarID = Auxiliares.AuxiliarID INNER JOIN TipoEntradas ON DetalleEntradas.TipoEntradaID = TipoEntradas.TipoEntradaID Where DetalleEntradas.EntradaID = @EntradaID";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@EntradaID", EntradaID));
                da.SelectCommand = cm;
                da.Fill(ds, "DetalleEntradas");
                cn.Close();

                DataTable Cuentas = new DataTable("Cuentas");
                Cuentas.Columns.Add("BarCode", typeof(byte[]));
                DataRow dataRow = Cuentas.NewRow();
                dataRow["BarCode"] = ImageFromText(EntradaID.ToString());
                Cuentas.Rows.Add(dataRow);

                ds.Tables.Add(Cuentas);
                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }

        public DataSet PrintRecibosGetByReciboID(int ReciboID)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsRecibosBE.Where(x => x.ReciboID == ReciboID);
                DataSet ds = new DataSet();

                clsCuotasView Cuotas = new clsCuotasView();
                Cuotas.SetDataSource(row.FirstOrDefault().ContratoID, row.FirstOrDefault().ReciboID);
                var result = Cuotas.GetGroup();
                float balance, atraso;

                if (row.FirstOrDefault().Contratos.TipoContratoID == 2)
                {
                    switch (row.FirstOrDefault().Sucursales.EmpresaID)
                    {
                        case "7E11-E835-29E0-5F8F-CB6E-A471-430C-2008":
                            {
                                balance = (Cuotas.BalanceCapitalAtrasosGetByReciboID(row.FirstOrDefault().Fecha) < 0 ? 0 : Cuotas.BalanceCapitalAtrasosGetByReciboID(row.FirstOrDefault().Fecha));
                                atraso = Cuotas.AtrasoGet(row.FirstOrDefault().Fecha) < 0 ? 0 : Cuotas.AtrasoGet(row.FirstOrDefault().Fecha);
                            }
                            break;
                        default:
                            {
                                balance = (Cuotas.BalanceGetByReciboID() < 0 ? 0 : Cuotas.BalanceGetByReciboID());
                                atraso = Cuotas.AtrasoGet(row.FirstOrDefault().Fecha) < 0 ? 0 : Cuotas.AtrasoGet(row.FirstOrDefault().Fecha);
                            }
                            break;
                    };
                }
                else
                {
                    balance = (Cuotas.BalanceCapitalAtrasosGetByReciboID(row.FirstOrDefault().Fecha) < 0 ? 0 : Cuotas.BalanceCapitalAtrasosGetByReciboID(row.FirstOrDefault().Fecha));
                    atraso = Cuotas.AtrasoGet(row.FirstOrDefault().Fecha) < 0 ? 0 : Cuotas.AtrasoGet(row.FirstOrDefault().Fecha);
                }


                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //Recibos
                cn.Open();
                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT Recibos.ReciboID, Recibos.Fecha, Recibos.TokenID, Recibos.ContratoID, Empresas.Empresa, Sucursales.Direccion AS DireccionEmpresa, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal, Empresas.Siglas, Empresas.Logo, Personas.Nombres, Personas.Apellidos, Personas.Direccion, FormaPagos.Nombre, Comprobantes.Comprobante, Recibos.Ncf, Recibos.SubTotal, Recibos.Descuento, Recibos.Monto, Recibos.Informacion,Solicitudes.Tiempo, (SELECT Nombres FROM Personas AS P WHERE (Documento = Recibos.Usuario)) AS Usuario, Ucase(Rutas.Ruta) as Ruta, Ucase(Zonas.Zona) as Zona, Recibos.Total, Recibos.Cambio FROM Recibos INNER JOIN Sucursales ON Recibos.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN Contratos ON Recibos.ContratoID = Contratos.ContratoID INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN FormaPagos ON Recibos.FormaPagoID = FormaPagos.FormaPagoID INNER JOIN Comprobantes ON Recibos.ComprobanteID = Comprobantes.ComprobanteID INNER JOIN Zonas on Contratos.ZonaID = Zonas.ZonaID INNER JOIN Rutas on Zonas.RutaID = Rutas.RutaID Where Recibos.ReciboID = @ReciboID";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ReciboID", ReciboID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Recibos");
                cn.Close();

                //DetalleRecibos
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT * from DetalleRecibos Where DetalleRecibos.ReciboID = @ReciboID Order by CuotaID Asc";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ReciboID", ReciboID));
                da.SelectCommand = cm;
                da.Fill(ds, "DetalleRecibos");
                cn.Close();

                DataTable Cuentas = new DataTable("Cuentas");
                Cuentas.Columns.Add("Balance", typeof(float));
                Cuentas.Columns.Add("Atraso", typeof(float));
                Cuentas.Columns.Add("BarCode", typeof(byte[]));
                Cuentas.Columns.Add("QrCode", typeof(byte[]));
                DataRow dataRow = Cuentas.NewRow();
                dataRow["Balance"] = balance;
                dataRow["Atraso"] = atraso;
                dataRow["BarCode"] = ImageFromText(ReciboID.ToString());
                dataRow["QrCode"] = TextToQrCode(ds.Tables["Recibos"].Rows[0]["TokenID"].ToString());
                Cuentas.Rows.Add(dataRow);

                ds.Tables.Add(Cuentas);
                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }

        public DataSet PrintDetalleNotasGetByFecha(DateTime Desde, DateTime Hasta, string Usuario, bool IsDebit)
        {
            try
            {
                db = new DAL.Context();
                DataSet ds = new DataSet();

                DataTable empresas = new DataTable("Empresas");
                empresas.Columns.Add("Empresa", typeof(string));
                empresas.Columns.Add("Direccion", typeof(string));
                empresas.Columns.Add("Telefonos", typeof(string));
                empresas.Columns.Add("Rnc", typeof(string));
                empresas.Columns.Add("Sucursal", typeof(string));
                empresas.Columns.Add("Desde", typeof(DateTime));
                empresas.Columns.Add("Hasta", typeof(DateTime));
                empresas.Columns.Add("Cajero", typeof(string));

                DataTable notas = new DataTable("DetalleNotas");
                notas.Columns.Add("ID", typeof(int));
                notas.Columns.Add("TipoNota", typeof(string));
                notas.Columns.Add("ContratoID", typeof(int));
                notas.Columns.Add("Fecha", typeof(DateTime));
                notas.Columns.Add("Numero", typeof(int));
                notas.Columns.Add("Concepto", typeof(string));
                notas.Columns.Add("Capital", typeof(float));
                notas.Columns.Add("Comision", typeof(float));
                notas.Columns.Add("Interes", typeof(float));
                notas.Columns.Add("Mora", typeof(float));
                notas.Columns.Add("Legal", typeof(float));
                notas.Columns.Add("Seguro", typeof(float));
                notas.Columns.Add("Monto", typeof(float));
                notas.Columns.Add("Cliente", typeof(string));

                var empresa = db.clsUsuariosBE.Where(x => x.Documento == Usuario).FirstOrDefault();
                DataRow dr = empresas.NewRow();
                dr["Empresa"] = empresa.Sucursales.Empresas.Empresa;
                dr["Direccion"] = empresa.Sucursales.Direccion;
                dr["Telefonos"] = empresa.Sucursales.Telefonos;
                dr["Rnc"] = empresa.Sucursales.Empresas.Rnc;
                dr["Sucursal"] = empresa.Sucursales.Sucursal;
                dr["Desde"] = Desde;
                dr["Hasta"] = Hasta;
                dr["Cajero"] =  empresa.Personas.Nombres + " " + empresa.Personas.Apellidos;
                empresas.Rows.Add(dr);
                ds.Tables.Add(empresas);

                if (IsDebit)
                {
                    foreach (var row in db.clsDetalleNotaDebitosBE.Where(x => x.Fecha >= Desde && x.Fecha <= Hasta && x.Usuario == Usuario && x.IsAutomatic == false).ToList())
                    {
                        DataRow dataRow = notas.NewRow();
                        dataRow["ID"] = row.NotaDebitoID;
                        dataRow["TipoNota"] = "ND";
                        dataRow["ContratoID"] = row.Cuotas.ContratoID;
                        dataRow["Fecha"] = row.Fecha;
                        dataRow["Numero"] = row.Cuotas.Numero;
                        dataRow["Concepto"] = row.Concepto;
                        dataRow["Capital"] = row.Capital;
                        dataRow["Comision"] = row.Comision;
                        dataRow["Interes"] = row.Interes;
                        dataRow["Mora"] = row.Mora;
                        dataRow["Legal"] = row.Legal;
                        dataRow["Seguro"] = row.Seguro;
                        dataRow["Monto"] = row.Capital + row.Comision + row.Interes + row.Mora + row.Legal + row.Seguro;
                        dataRow["Cliente"] = row.Cuotas.Contratos.Solicitudes.Clientes.Personas.Nombres + " " + row.Cuotas.Contratos.Solicitudes.Clientes.Personas.Apellidos;
                        notas.Rows.Add(dataRow);
                    }
                }
                else
                {
                    foreach (var row in db.clsDetalleNotaCreditosBE.Where(x => x.Fecha >= Desde && x.Fecha <= Hasta && x.Usuario == Usuario && x.IsAutomatic == false).ToList())
                    {
                        DataRow dataRow = notas.NewRow();
                        dataRow["ID"] = row.NotaCreditoID;
                        dataRow["TipoNota"] = "NC";
                        dataRow["ContratoID"] = row.Cuotas.ContratoID;
                        dataRow["Fecha"] = row.Fecha;
                        dataRow["Numero"] = row.Cuotas.Numero;
                        dataRow["Concepto"] = row.Concepto;
                        dataRow["Capital"] = row.Capital;
                        dataRow["Comision"] = row.Comision;
                        dataRow["Interes"] = row.Interes;
                        dataRow["Mora"] = row.Mora;
                        dataRow["Legal"] = row.Legal;
                        dataRow["Seguro"] = row.Seguro;
                        dataRow["Monto"] = row.Capital + row.Comision + row.Interes + row.Mora + row.Legal + row.Seguro;
                        dataRow["Cliente"] = row.Cuotas.Contratos.Solicitudes.Clientes.Personas.Nombres + " " + row.Cuotas.Contratos.Solicitudes.Clientes.Personas.Apellidos;
                        notas.Rows.Add(dataRow);
                    }
                }
                ds.Tables.Add(notas);

                return ds;

            }
            catch(Exception ex)
            { return new DataSet(); }
        }
        
        public byte[] TextToQrCode(string QrCode)
        {
            QrEncoder encoder = new QrEncoder(ErrorCorrectionLevel.M);
            QrCode qrCode;
            encoder.TryEncode(QrCode, out qrCode);
            WriteableBitmapRenderer wRenderer = new WriteableBitmapRenderer(new FixedModuleSize(2, QuietZoneModules.Two), Colors.Black, Colors.White);
            WriteableBitmap wBitmap = new WriteableBitmap(66, 66, 96, 96, PixelFormats.Gray8, null);
            wRenderer.Draw(wBitmap, qrCode.Matrix);

            byte[] data;
            JpegBitmapEncoder code = new JpegBitmapEncoder();
            code.Frames.Add(BitmapFrame.Create(wBitmap));
            using (MemoryStream ms = new MemoryStream())
            {
                code.Save(ms);
                data = ms.ToArray();
            }
            return data;
        }

        public static byte[] ImageFromText(string ID)
        {
            string barCode = ID.ToString();
            using (Bitmap bitMap = new Bitmap(barCode.Length * 30, 60))
            {
                using (Graphics graphics = Graphics.FromImage(bitMap))
                {
                    var myFonts = new System.Drawing.Text.PrivateFontCollection();
                    myFonts.AddFontFile(@".\Font\IDAutomationHC39M.TTF");
                    var oFont = new System.Drawing.Font(myFonts.Families[0], 16);

                    //Font oFont = new Font("/Payment.Point;component/Font/#IDAutomationHC39M", 16);
                    PointF point = new PointF(2f, 2f);
                    SolidBrush blackBrush = new SolidBrush(System.Drawing.Color.Black);
                    SolidBrush whiteBrush = new SolidBrush(System.Drawing.Color.White);
                    graphics.FillRectangle(whiteBrush, 0, 0, bitMap.Width, bitMap.Height);
                    graphics.DrawString("*" + barCode + "*", oFont, blackBrush, point);
                }
                using (MemoryStream ms = new MemoryStream())
                {
                    bitMap.Save(ms, System.Drawing.Imaging.ImageFormat.Png);
                    byte[] byteImage = ms.ToArray();
                    Convert.ToBase64String(byteImage);
                    return byteImage;
                }
            }
        }



        #endregion

        #region Detalle Recibos

        public List<clsDetalleRecibosBE> DetalleRecibosGetByContratoID(int ContratoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetalleRecibosBE.Where(x => x.Recibos.ContratoID == ContratoID).ToList();
            }
            catch
            {
                return new List<clsDetalleRecibosBE>();
            }
        }

        public List<clsDetalleRecibosBE> DetalleRecibosGet()
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetalleRecibosBE.ToList();
            }
            catch
            {
                return new List<clsDetalleRecibosBE>();
            }
        }

        public OperationResult DetalleRecibosCreate(int CuotaID, int ReciboID, int Numero, string Concepto, float Capital, float Comision, float Interes, float Mora, float Legal, float Seguro, float SubTotal, string Usuario)
        {
            OperationResult result;
            try
            {
                int ID = 0;
                MySqlConnection cn = new MySqlConnection();
                MySqlDataAdapter da = new MySqlDataAdapter();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                cn.Open();
                MySqlCommand cmd = new MySqlCommand();
                cmd.CommandText = "SELECT IFNULL(Max(DetalleReciboID), 100000) +1 as DetalleReciboID from DetalleRecibos;";
                cmd.CommandType = CommandType.Text;
                cmd.Connection = cn;

                MySqlDataReader drPersonas = cmd.ExecuteReader();
                while (drPersonas.Read())
                {
                    ID = int.Parse(drPersonas["DetalleReciboID"].ToString());
                }

                cn.Close();

                cn.Open();
                // Create the InsertCommand.
                cmd = new MySqlCommand("INSERT INTO DetalleRecibos (ReciboID, DetalleReciboID, CuotaID, Numero, Concepto, Capital, Comision, Interes, Mora, Legal, Seguro, SubTotal, Usuario, ModificadoPor,  FechaModificacion) VALUES (@ReciboID, @DetalleReciboID, @CuotaID, @Numero, @Concepto, @Capital, @Comision, @Interes, @Mora, @Legal, @Seguro, @SubTotal, @Usuario, @Usuario, SYSDATE());", cn);
                cmd.Parameters.Add(new MySqlParameter("@ReciboID", ReciboID));
                cmd.Parameters.Add(new MySqlParameter("@DetalleReciboID", ID));
                cmd.Parameters.Add(new MySqlParameter("@CuotaID", CuotaID));
                cmd.Parameters.Add(new MySqlParameter("@Numero", Numero));
                cmd.Parameters.Add(new MySqlParameter("@Concepto", Concepto));
                cmd.Parameters.Add(new MySqlParameter("@Capital", Capital));
                cmd.Parameters.Add(new MySqlParameter("@Comision", Comision));
                cmd.Parameters.Add(new MySqlParameter("@Interes", Interes));
                cmd.Parameters.Add(new MySqlParameter("@Mora", Mora));
                cmd.Parameters.Add(new MySqlParameter("@Legal", Legal));
                cmd.Parameters.Add(new MySqlParameter("@Seguro", Seguro));
                cmd.Parameters.Add(new MySqlParameter("@SubTotal", SubTotal));
                cmd.Parameters.Add(new MySqlParameter("@Usuario", Usuario));

                da.InsertCommand = cmd;
                cmd.ExecuteNonQuery();
                cn.Close();

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult DetalleRecibosDeleteGetByReciboID(int ReciboID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleRecibosBE.Where(x => x.ReciboID == ReciboID);
                db.clsDetalleRecibosBE.RemoveRange(row);
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DetalleRecibosDeleteGetByContratoID(int ContratoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleRecibosBE.Where(x => x.Recibos.ContratoID == ContratoID);
                db.clsDetalleRecibosBE.RemoveRange(row);
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        #endregion

        #region Certificados

        public OperationResult CertificadosCreate(DateTime Fecha, DateTime Vence, string Documento, int SucursalID, int TipoCertificadoID, int MonedaID, int Tiempo, float Interes, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = (db.clsCertificadosBE.Count() == 0 ? 100000 : db.clsCertificadosBE.Max(x => x.CertificadoID));
                db.clsCertificadosBE.Add(new clsCertificadosBE { CertificadoID = ID + 1, Fecha = Fecha, Vence = Vence, Documento = Documento, SucursalID = SucursalID, TipoCertificadoID = TipoCertificadoID, MonedaID = MonedaID, Tiempo = Tiempo, Interes = Interes, Monto = Monto, EstadoID = true, Motivo = string.Empty, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = (ID + 1).ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult CertificadosUpdate(int CertificadoID, DateTime Fecha, DateTime Vence, string Documento, int SucursalID, int TipoCertificadoID, int MonedaID, int Tiempo, float Interes, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCertificadosBE.Where(x => x.CertificadoID == CertificadoID).FirstOrDefault();
                var hasRow = db.clsDetalleCertificadosBE.Where(x => x.CertificadoID == CertificadoID);
                if (hasRow.Count() == 0)
                {
                    row.Fecha = Fecha;
                    row.Vence = Vence;
                    row.Documento = Documento;
                    row.SucursalID = SucursalID;
                    row.TipoCertificadoID = TipoCertificadoID;
                    row.MonedaID = MonedaID;
                    row.Tiempo = Tiempo;
                    row.Interes = Interes;
                    row.Monto = Monto;

                    row.FechaModificacion = DateTime.Now;
                    row.ModificadoPor = Usuario;

                    db.Entry(row).State = EntityState.Modified;
                    db.SaveChanges();
                }
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsCertificadosBE> CertificadosGet(string Search, bool EstadoID)
        {
            try
            {
                db = new DAL.Context();
                List<clsCertificadosBE> BE = new List<clsCertificadosBE>();
                if (!string.IsNullOrEmpty(Search))
                {
                    BE = db.clsCertificadosBE.Where(x => x.CertificadoID.ToString().Contains(Search) || x.Fecha.ToString().Contains(Search) || x.Personas.Nombres.Contains(Search) || x.Personas.Apellidos.Contains(Search) || x.Tiempo.ToString().Contains(Search) || x.Monto.ToString().Contains(Search)).ToList();
                }
                else
                {
                    BE = db.clsCertificadosBE.Where(x => x.EstadoID == EstadoID).ToList();
                }
                return BE.Where(x => x.EstadoID == EstadoID).ToList();
            }
            catch
            {
                return new List<clsCertificadosBE>();
            }
        }

        public clsCertificadosBE CertificadosGetByCertificadoID(int CertificadoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsCertificadosBE.Where(x => x.CertificadoID == CertificadoID).FirstOrDefault();
            }
            catch
            {
                return new clsCertificadosBE();
            }
        }

        public OperationResult CertificadosDeleteGetByCertificadoID(int CertificadoID, string Motivo, string Usuario)
        {
            OperationResult result;
            try
            {

                db = new DAL.Context();
                var row = db.clsCertificadosBE.Where(x => x.CertificadoID == CertificadoID).FirstOrDefault();
                row.Motivo = Motivo;
                row.EstadoID = false;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        #endregion

        #region Detalle Certificados

        public List<clsDetalleCertificadosBE> DetalleCertificadosGetByCertificadoID(int CertificadoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetalleCertificadosBE.Where(x => x.CertificadoID == CertificadoID).ToList();
            }
            catch
            {
                return new List<clsDetalleCertificadosBE>();
            }
        }

        public List<clsDetalleCertificadosBE> DetalleCertificadosGet()
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetalleCertificadosBE.ToList();
            }
            catch
            {
                return new List<clsDetalleCertificadosBE>();
            }
        }

        public OperationResult DetalleCertificadosCreate(int CertificadoID, DateTime Fecha, string Descripcion, float Interes, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();

                //var row = db.clsDetalleCertificadosBE.Where(x => x.CertificadoID == CertificadoID && x.Fecha == Fecha).LastOrDefault();
                var row = db.clsDetalleCertificadosBE.Where(x => x.CertificadoID == CertificadoID && x.Fecha == Fecha).FirstOrDefault();
                if (row == null)
                {
                    db.clsDetalleCertificadosBE.Add(new clsDetalleCertificadosBE { Fecha = Fecha, CertificadoID = CertificadoID, Descripcion = Descripcion, Interes = Interes, Monto = Monto, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                }
                else
                {
                    row.Interes = Interes;
                    row.Monto = Monto;
                    row.ModificadoPor = Usuario;
                    row.FechaModificacion = DateTime.Now;
                    db.Entry(row).State = EntityState.Modified;
                    db.SaveChanges();
                }
                return new OperationResult { ResponseCode = "00", ResponseMessage = "" };


            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult DetalleCertificadosDeleteGetByCertificadoID(int CertificadoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleCertificadosBE.Where(x => x.CertificadoID == CertificadoID);
                db.clsDetalleCertificadosBE.RemoveRange(row);
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        #endregion

        #endregion

        #region Mantenimientos

        #region Geolocalizaciones

        public OperationResult GeolocalizacionesCreate(string Documento, double Latitude, double Longitude, int TipoGeolocalizacionID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsGeolocalizacionesBE.Count() == 0 ? 100000 : db.clsGeolocalizacionesBE.Max(x => x.GeolocalizacionID)) + 1;
                db.clsGeolocalizacionesBE.Add(new clsGeolocalizacionesBE { GeolocalizacionID = ID, Fecha = DateTime.Now, Documento = Documento, Latitude = Latitude, Longitude = Longitude, TipoGeolocalizacionID = TipoGeolocalizacionID,  Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult GeolocalizacionesUpdate(int GeolocalizacionID, string Documento, double Latitude, double Longitude, int TipoGeolocalizacionID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGeolocalizacionesBE.Where(x => x.GeolocalizacionID == GeolocalizacionID).FirstOrDefault();
                row.Documento = Documento;
                row.Latitude = Latitude;
                row.Longitude = Longitude;
                row.TipoGeolocalizacionID = TipoGeolocalizacionID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult GeolocalizacionesDelete(int GeolocalizacionID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGeolocalizacionesBE.Where(x => x.GeolocalizacionID == GeolocalizacionID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public clsGeolocalizacionesBE GeolocalizacionesGetByGeolocalizacionID(int GeolocalizacionID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsGeolocalizacionesBE.Where(x => x.GeolocalizacionID == GeolocalizacionID).FirstOrDefault();
            }
            catch
            {
                return new clsGeolocalizacionesBE();
            }
        }

        public List<clsGeolocalizacionesBE> GeolocalizacionesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                return db.clsGeolocalizacionesBE.ToList();
            }
            catch
            {
                return new List<clsGeolocalizacionesBE>();
            }
        }

        #endregion

        #region Turnos

        public OperationResult TurnosCreate(string Documento, int CajaID, float Monto, string Comentario, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsTurnosBE.Count() == 0 ? 100000 : db.clsTurnosBE.Max(x => x.TurnoID)) + 1;
                db.clsTurnosBE.Add(new clsTurnosBE { TurnoID = ID, Fecha = DateTime.Now, Documento = Documento, CajaID = CajaID, Monto = Monto, Comentario = Comentario, EstadoID = true, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TurnosUpdate(int TurnoID, string Documento, int CajaID, float Monto, string Comentario, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTurnosBE.Where(x => x.TurnoID == TurnoID).FirstOrDefault();
                row.Documento = Documento;
                row.CajaID = CajaID;
                row.Monto = Monto;
                row.Comentario = Comentario;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TurnosDelete(int TurnoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTurnosBE.Where(x => x.TurnoID == TurnoID).FirstOrDefault();
                row.EstadoID = false;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsTurnosBE> TurnosGet(string Search, int EstadoID)
        {
            try
            {
                db = new DAL.Context();
                Search = Search.ToUpper();
                bool _EstadoID = EstadoID == 1 ? true : false;

                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTurnosBE.Where(x=>x.EstadoID == _EstadoID && (x.Cajas.Caja.ToUpper().Contains(Search) || x.TurnoID.ToString().Contains(Search) || x.Documento.Contains(Search) || x.Usuarios.Personas.Nombres.ToUpper().Contains(Search) || x.Usuarios.Personas.Apellidos.ToUpper().Contains(Search) || x.Usuarios.Personas.Direccion.ToUpper().Contains(Search) || x.Usuarios.Personas.Correo.ToUpper().Contains(Search) || x.Usuarios.Personas.Telefono.ToUpper().Contains(Search) || x.Usuarios.Personas.Celular.ToUpper().Contains(Search))).ToList();
                }
                else
                {
                    return db.clsTurnosBE.Where(x => x.EstadoID == _EstadoID).ToList();
                }
            }
            catch
            {
                return new List<clsTurnosBE>();
            }
        }

        public bool IsOpenBox(string documento)
        {
            try
            {
                db = new DAL.Context();
                DateTime fecha = DateTime.Today;
                DateTime _fecha = new DateTime(fecha.Year, fecha.Month, fecha.Day);
                DateTime _Desde = _fecha.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = _fecha.Add(new TimeSpan(23, 59, 59));
                var box = db.clsTurnosBE.Where(x => x.Documento == documento && x.EstadoID == true && x.Fecha >= _Desde && x.Fecha <= _Hasta).ToList();

                if (box.Count() == 0)
                {
                    return false;
                }
                else
                {
                    return true;
                }
            }
            catch { return false; }

        }

        #endregion

        #region Cajas

        public OperationResult CajasCreate(string Caja, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsCajasBE.Count() == 0 ? 100000 : db.clsCajasBE.Max(x => x.CajaID)) + 1;
                db.clsCajasBE.Add(new clsCajasBE { CajaID = ID, Fecha = DateTime.Now, Caja = Caja, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult CajasUpdate(int CajaID, string Caja, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCajasBE.Where(x => x.CajaID == CajaID).FirstOrDefault();
                row.Caja = Caja;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult CajasDelete(int CajaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCajasBE.Where(x => x.CajaID == CajaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public clsCajasBE CajasGetByCajaID(int CajaID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsCajasBE.Where(x=>x.CajaID == CajaID).FirstOrDefault();
            }
            catch
            {
                return new clsCajasBE();
            }
        }
        public List<clsCajasBE> CajasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsCajasBE.Where(x => x.Caja.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsCajasBE.ToList();
                }
            }
            catch
            {
                return new List<clsCajasBE>();
            }
        }

        public List<clsCajasBE> CajasGetNotOpen()
        {
            try
            {
                db = new DAL.Context();

                var rows = from T in db.clsTurnosBE.Where(x => x.EstadoID == true) join C in db.clsCajasBE on T.CajaID equals C.CajaID select C; 
               return db.clsCajasBE.Where(x => !rows.Contains(x)).ToList();
            }
            catch
            {
                return new List<clsCajasBE>();
            }
        }


        public List<clsTurnosBE> OpenBoxGetByFecha0(DateTime fecha)
        {
            try
            {
                db = new DAL.Context();
                DateTime _fecha = new DateTime(fecha.Year, fecha.Month, fecha.Day);
                DateTime _Desde = _fecha.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = _fecha.Add(new TimeSpan(23, 59, 59));


                var rows = (from T in db.clsTurnosBE.Where(x => x.EstadoID == true && x.Fecha >= _Desde && x.Fecha <= _Hasta)
                            join C in db.clsCajasBE on T.CajaID equals C.CajaID
                            join U in db.clsUsuariosBE on T.Documento equals U.Documento
                            select T).ToList();

                return rows;

                //return Personas.ToList();
            }
            catch (Exception ex)
            {
                return new List<clsTurnosBE>();
            }
        }

        public List<clsPersonasBE> OpenBoxGetByFecha(DateTime fecha)
        {
            try
            {
                db = new DAL.Context();
                DateTime _fecha = new DateTime(fecha.Year, fecha.Month, fecha.Day);
                DateTime _Desde = _fecha.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = _fecha.Add(new TimeSpan(23, 59, 59));


                var rows = (from T in db.clsTurnosBE.Where(x => x.EstadoID == true && x.Fecha >= _Desde && x.Fecha <= _Hasta)
                            join C in db.clsCajasBE on T.CajaID equals C.CajaID
                            join U in db.clsUsuariosBE on T.Documento equals U.Documento
                            select T).ToList();

                List<clsPersonasBE> Personas = new List<clsPersonasBE>();
                foreach(var p in rows)
                {
                    Personas.Add(new clsPersonasBE {Documento = p.Documento, Nombres =p.Cajas.Caja + " - " + p.Usuarios.Personas.Nombres.ToUpper() + " " + p.Usuarios.Personas.Apellidos.ToUpper(), Usuarios = new clsUsuariosBE { Documento = p.Documento, SucursalID = p.Usuarios.SucursalID, Turnos = rows,} });
                }
                
                return Personas.ToList();
            }
            catch(Exception ex)
            {
                return new List<clsPersonasBE>();
            }
        }

        public clsTurnosBE OpenBoxGetByDocumento(string documento)
        {
            try
            {
                db = new DAL.Context();


                var rows = (from T in db.clsTurnosBE.Where(x => x.EstadoID == true && x.Documento == documento)
                            join C in db.clsCajasBE on T.CajaID equals C.CajaID
                            join U in db.clsUsuariosBE on T.Documento equals U.Documento
                            select T).FirstOrDefault();

                return rows;
            }
            catch (Exception ex)
            {
                return new clsTurnosBE();
            }
        }

        public clsTurnosBE OpenBoxGetByDocumento(string documento, DateTime fecha)
        {
            try
            {
                db = new DAL.Context();
                DateTime _fecha = new DateTime(fecha.Year, fecha.Month, fecha.Day);
                DateTime _Desde = _fecha.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = _fecha.Add(new TimeSpan(23, 59, 59));

                var rows = (from T in db.clsTurnosBE.Where(x => x.Fecha >= _Desde && x.Fecha <=_Hasta && x.EstadoID == true && x.Documento == documento)
                            join C in db.clsCajasBE on T.CajaID equals C.CajaID
                            join U in db.clsUsuariosBE on T.Documento equals U.Documento
                            select T).FirstOrDefault();

                return rows;
            }
            catch (Exception ex)
            {
                return new clsTurnosBE();
            }
        }

        #endregion

        #region Arqueos

        public OperationResult ArqueosCreate(int TurnoID, float Monto, float Total, string Observacion, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsArqueosBE.Count() == 0 ? 100000 : db.clsArqueosBE.Max(x => x.ArqueoID)) + 1;
                db.clsArqueosBE.Add(new clsArqueosBE { ArqueoID = ID, Fecha = DateTime.Now, TurnoID = TurnoID, Monto = Monto, Total = Total, Observacion = Observacion, EstadoID = true, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ArqueosUpdate(int ArqueoID, int TurnoID, float Monto, float Total, string Observacion, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsArqueosBE.Where(x => x.ArqueoID == ArqueoID).FirstOrDefault();
                row.TurnoID = TurnoID;
                row.Monto = Monto;
                row.Total = Total;
                row.Observacion = Observacion;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ArqueosDelete(int ArqueoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsArqueosBE.Where(x => x.ArqueoID == ArqueoID).FirstOrDefault();
                row.EstadoID = false;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsArqueosBE> ArqueosGet(string Search, DateTime Desde, DateTime Hasta)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = new DateTime(Desde.Year, Desde.Month, Desde.Day);
                DateTime _Hasta = new DateTime(Hasta.Year, Hasta.Month, Hasta.Day).Add(new TimeSpan(23, 59, 59));
                List<clsArqueosBE> BE = new List<clsArqueosBE>();
                BE = db.clsArqueosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta).ToList();

                if (!string.IsNullOrEmpty(Search))
                {
                    return BE.Where(x => x.Fecha >= _Desde && x.Fecha<=_Hasta && (x.Observacion.Contains(Search) || x.Monto.ToString().Contains(Search) || x.Total.ToString().Contains(Search) || x.Turnos.Documento.ToString().Contains(Search) || x.Turnos.Usuarios.Personas.Nombres.ToString().Contains(Search) || x.Turnos.Usuarios.Personas.Apellidos.ToString().Contains(Search) || x.Turnos.Usuarios.Personas.Direccion.ToString().Contains(Search))).ToList();
                }
                else
                {
                    return BE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta).ToList();
                }
            }
            catch
            {
                return new List<clsArqueosBE>();
            }
        }

        public List<clsArqueosBE> ArqueosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsArqueosBE.Where(x => x.Observacion.Contains(Search) || x.Monto.ToString().Contains(Search) || x.Total.ToString().Contains(Search) || x.Turnos.Documento.ToString().Contains(Search) || x.Turnos.Usuarios.Personas.Nombres.ToString().Contains(Search) || x.Turnos.Usuarios.Personas.Apellidos.ToString().Contains(Search) || x.Turnos.Usuarios.Personas.Direccion.ToString().Contains(Search)).ToList();
                }
                else
                {
                    return db.clsArqueosBE.ToList();
                }
            }
            catch
            {
                return new List<clsArqueosBE>();
            }
        }
        #endregion

        #region Detalle Arqueos

        public List<clsDetalleArqueosBE> DetalleArqueosGetByArqueoID(int ArqueoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetalleArqueosBE.Where(x => x.Arqueos.ArqueoID == ArqueoID).ToList();
            }
            catch
            {
                return new List<clsDetalleArqueosBE>();
            }
        }

        public List<clsDetalleArqueosBE> DetalleArqueosGet()
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetalleArqueosBE.ToList();
            }
            catch
            {
                return new List<clsDetalleArqueosBE>();
            }
        }

        public OperationResult DetalleArqueosCreate(int ArqueoID, int DenominacionID, int Cantidad, float SubTotal, string Usuario)
        {
            OperationResult result;
            try
            {
                int ID = 0;
                MySqlConnection cn = new MySqlConnection();
                MySqlDataAdapter da = new MySqlDataAdapter();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                cn.Open();
                MySqlCommand cmd = new MySqlCommand();
                cmd.CommandText = "SELECT IFNULL(Max(DetalleArqueoID), 100000) +1 as DetalleArqueoID from DetalleArqueos;";
                cmd.CommandType = CommandType.Text;
                cmd.Connection = cn;

                MySqlDataReader drPersonas = cmd.ExecuteReader();
                while (drPersonas.Read())
                {
                    ID = int.Parse(drPersonas["DetalleArqueoID"].ToString());
                }

                cn.Close();

                cn.Open();
                // Create the InsertCommand.
                cmd = new MySqlCommand("INSERT INTO DetalleArqueos (DetalleArqueoID, ArqueoID, Fecha, DenominacionID, Cantidad, SubTotal, Usuario, ModificadoPor,  FechaModificacion) VALUES (@DetalleArqueoID, @ArqueoID, SYSDATE(), @DenominacionID, @Cantidad, @SubTotal, @Usuario, @Usuario, SYSDATE());", cn);
       
                cmd.Parameters.Add(new MySqlParameter("@DetalleArqueoID", ID));
                cmd.Parameters.Add(new MySqlParameter("@ArqueoID", ArqueoID));
                cmd.Parameters.Add(new MySqlParameter("@DenominacionID", DenominacionID));
                cmd.Parameters.Add(new MySqlParameter("@Cantidad", Cantidad));
                cmd.Parameters.Add(new MySqlParameter("@SubTotal", SubTotal));
                cmd.Parameters.Add(new MySqlParameter("@Usuario", Usuario));

                da.InsertCommand = cmd;
                cmd.ExecuteNonQuery();
                cn.Close();

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult DetalleArqueosDeleteGetByDetalleArqueoID(int DetalleArqueoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleArqueosBE.Where(x => x.DetalleArqueoID == DetalleArqueoID);
                db.clsDetalleArqueosBE.RemoveRange(row);
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DetalleArqueosDeleteGetByArqueoID(int ArqueoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleArqueosBE.Where(x => x.Arqueos.ArqueoID == ArqueoID);
                db.clsDetalleArqueosBE.RemoveRange(row);
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        #endregion

        #region Parentescos

        public OperationResult ParentescosCreate(string Parentesco, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsParentescosBE.Count() == 0 ? 100000 : db.clsParentescosBE.Max(x => x.ParentescoID)) + 1;
                db.clsParentescosBE.Add(new clsParentescosBE { ParentescoID = ID, Fecha = DateTime.Now, Parentesco = Parentesco, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ParentescosUpdate(int ParentescoID, string Parentesco, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsParentescosBE.Where(x => x.ParentescoID == ParentescoID).FirstOrDefault();
                row.Parentesco = Parentesco;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ParentescosDelete(int ParentescoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsParentescosBE.Where(x => x.ParentescoID == ParentescoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsParentescosBE> ParentescosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsParentescosBE.Where(x => x.Parentesco.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsParentescosBE.ToList();
                }
            }
            catch
            {
                return new List<clsParentescosBE>();
            }
        }

        #endregion

        #region Jornadas

        public OperationResult JornadasCreate(string Jornada, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsJornadasBE.Count() == 0 ? 100000 : db.clsJornadasBE.Max(x => x.JornadaID)) + 1;
                db.clsJornadasBE.Add(new clsJornadasBE { JornadaID = ID, Fecha = DateTime.Now, Jornada = Jornada, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult JornadasUpdate(int JornadaID, string Jornada, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsJornadasBE.Where(x => x.JornadaID == JornadaID).FirstOrDefault();
                row.Jornada = Jornada;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult JornadasDelete(int PreguntaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsJornadasBE.Where(x => x.JornadaID == PreguntaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public clsJornadasBE JornadasGetByJornadaID(int JornadaID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsJornadasBE.Where(x => x.JornadaID == JornadaID).FirstOrDefault();
            }
            catch
            {
                return new clsJornadasBE();
            }
        }

        public List<clsJornadasBE> JornadasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsJornadasBE.Where(x => x.Jornada.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsJornadasBE.ToList();
                }
            }
            catch
            {
                return new List<clsJornadasBE>();
            }
        }

        public clsJornadasBE JornadasGetByDispositivoID(string DispositivoID)
        {
            try
            {
                db = new DAL.Context();
                var result = db.clsDispositivosBE.Where(x => x.DispositivoID == DispositivoID && x.EstadoID == true).FirstOrDefault();
                //return result.Jornadas;
                return new clsJornadasBE();
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                return new clsJornadasBE();
            }
        }

        #endregion

        #region Paises

        public OperationResult PaisesCreate(string Pais, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsPaisesBE.Count() == 0 ? 100000 : db.clsPaisesBE.Max(x => x.PaisID)) + 1;
                db.clsPaisesBE.Add(new clsPaisesBE { PaisID = ID, Fecha = DateTime.Now, Pais = Pais, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PaisesUpdate(int PaisID, string Pais, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsPaisesBE.Where(x => x.PaisID == PaisID).FirstOrDefault();
                row.Pais = Pais;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PaisesDelete(int PaisID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsPaisesBE.Where(x => x.PaisID == PaisID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsPaisesBE> PaisesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsPaisesBE.Where(x => x.Pais.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsPaisesBE.ToList();
                }
            }
            catch
            {
                return new List<clsPaisesBE>();
            }
        }

        #endregion

        #region Provincias

        public OperationResult ProvinciasCreate(string Provincia, int PaisID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsProvinciasBE.Count() == 0 ? 100000 : db.clsProvinciasBE.Max(x => x.ProvinciaID)) + 1;
                db.clsProvinciasBE.Add(new clsProvinciasBE { ProvinciaID = ID, Fecha = DateTime.Now, Provincia = Provincia, PaisID = PaisID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ProvinciasUpdate(int ProvinciaID, string Provincia, int PaisID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsProvinciasBE.Where(x => x.ProvinciaID == ProvinciaID).FirstOrDefault();
                row.Provincia = Provincia;
                row.PaisID = PaisID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ProvinciasDelete(int ProvinciaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsProvinciasBE.Where(x => x.ProvinciaID == ProvinciaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsProvinciasBE> ProvinciasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsProvinciasBE.Where(x => x.Provincia.Contains(Search) || x.Paises.Pais.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsProvinciasBE.ToList();
                }
            }
            catch
            {
                return new List<clsProvinciasBE>();
            }
        }

        #endregion

        #region Ciudades

        public OperationResult CiudadesCreate(string Ciudad, int ProvinciaID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsCiudadesBE.Count() == 0 ? 100000 : db.clsCiudadesBE.Max(x => x.CiudadID)) + 1;
                db.clsCiudadesBE.Add(new clsCiudadesBE { CiudadID = ID, Fecha = DateTime.Now, Ciudad = Ciudad, ProvinciaID = ProvinciaID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult CiudadesUpdate(int CiudadID, string Ciudad, int ProvinciaID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCiudadesBE.Where(x => x.CiudadID == CiudadID).FirstOrDefault();
                row.Ciudad = Ciudad;
                row.ProvinciaID = ProvinciaID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult CiudadesDelete(int CiudadID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCiudadesBE.Where(x => x.CiudadID == CiudadID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsCiudadesBE> CiudadesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsCiudadesBE.Where(x => x.Ciudad.Contains(Search) || x.Provincias.Provincia.Contains(Search)).OrderBy(x => x.Ciudad).ToList();
                }
                else
                {
                    return db.clsCiudadesBE.OrderBy(x => x.Ciudad).ToList();
                }
            }
            catch
            {
                return new List<clsCiudadesBE>();
            }
        }

        #endregion

        #region Preguntas

        public OperationResult PreguntasCreate(string Pregunta, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsPreguntasBE.Count() == 0 ? 100000 : db.clsPreguntasBE.Max(x => x.PreguntaID)) + 1;
                db.clsPreguntasBE.Add(new clsPreguntasBE { PreguntaID = ID, Fecha = DateTime.Now, Pregunta = Pregunta, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PreguntasUpdate(int PreguntaID, string Pregunta, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsPreguntasBE.Where(x => x.PreguntaID == PreguntaID).FirstOrDefault();
                row.Pregunta = Pregunta;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PreguntasDelete(int PreguntaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsPreguntasBE.Where(x => x.PreguntaID == PreguntaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsPreguntasBE> PreguntasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsPreguntasBE.Where(x => x.Pregunta.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsPreguntasBE.ToList();
                }
            }
            catch
            {
                return new List<clsPreguntasBE>();
            }
        }

        #endregion

        #region Graficos

        public OperationResult GraficosCreate(string Grafico, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsGraficosBE.Count() == 0 ? 100000 : db.clsGraficosBE.Max(x => x.GraficoID)) + 1;
                db.clsGraficosBE.Add(new clsGraficosBE { GraficoID = ID, Fecha = DateTime.Now, Grafico = Grafico, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult GraficosUpdate(int GraficoID, string Grafico, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGraficosBE.Where(x => x.GraficoID == GraficoID).FirstOrDefault();
                row.Grafico = Grafico;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult GraficosDelete(int GraficoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGraficosBE.Where(x => x.GraficoID == GraficoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsGraficosBE> GraficosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsGraficosBE.Where(x => x.Grafico.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsGraficosBE.ToList();
                }
            }
            catch
            {
                return new List<clsGraficosBE>();
            }
        }

        #endregion

        #region Lenguajes

        public OperationResult LenguajesCreate(string Lenguaje, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsLenguajesBE.Count() == 0 ? 100000 : db.clsLenguajesBE.Max(x => x.LenguajeID)) + 1;
                db.clsLenguajesBE.Add(new clsLenguajesBE { LenguajeID = ID, Fecha = DateTime.Now, Lenguaje = Lenguaje, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult LenguajesUpdate(int LenguajeID, string Lenguaje, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsLenguajesBE.Where(x => x.LenguajeID == LenguajeID).FirstOrDefault();
                row.Lenguaje = Lenguaje;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult LenguajesDelete(int LenguajeID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsLenguajesBE.Where(x => x.LenguajeID == LenguajeID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsLenguajesBE> LenguajesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsLenguajesBE.Where(x => x.Lenguaje.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsLenguajesBE.ToList();
                }
            }
            catch
            {
                return new List<clsLenguajesBE>();
            }
        }

        #endregion

        #region Roles

        public OperationResult RolesCreate(string Rol, string Descripcion, bool IsAdmin, bool CanQuery, bool ViewAllApplication, bool ViewAllContract, bool ViewAllReceipt, bool ViewAllBank, bool ViewAllCheck, bool ViewAllApplicationCheck, bool ViewAllAccountting, bool ViewAllExpenditure, int GraficoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsRolesBE.Count() == 0 ? 100000 : db.clsRolesBE.Max(x => x.RolID)) + 1;
                db.clsRolesBE.Add(new clsRolesBE { RolID = ID, Fecha = DateTime.Now, Rol = Rol, Descripcion = Descripcion, ViewAllAccountting = ViewAllAccountting, ViewAllApplicationCheck = ViewAllApplicationCheck, CanQuery = CanQuery, IsAdmin = IsAdmin, ViewAllApplication = ViewAllApplication, ViewAllBank = ViewAllBank, ViewAllCheck = ViewAllCheck, ViewAllContract = ViewAllContract, ViewAllExpenditure = ViewAllExpenditure, ViewAllReceipt = ViewAllReceipt, GraficoID = GraficoID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult RolesUpdate(int RolID, string Rol, string Descripcion, bool IsAdmin, bool CanQuery, bool ViewAllApplication, bool ViewAllContract, bool ViewAllReceipt, bool ViewAllBank, bool ViewAllCheck, bool ViewAllApplicationCheck, bool ViewAllAccountting, bool ViewAllExpenditure, int GraficoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsRolesBE.Where(x => x.RolID == RolID).FirstOrDefault();
                row.Rol = Rol;
                row.Rol = Rol;
                row.Descripcion = Descripcion;
                row.ViewAllAccountting = ViewAllAccountting;
                row.ViewAllApplicationCheck = ViewAllApplicationCheck;
                row.CanQuery = CanQuery;
                row.IsAdmin = IsAdmin;
                row.ViewAllApplication = ViewAllApplication;
                row.ViewAllBank = ViewAllBank;
                row.ViewAllCheck = ViewAllCheck;
                row.ViewAllContract = ViewAllContract;
                row.ViewAllExpenditure = ViewAllExpenditure;
                row.ViewAllReceipt = ViewAllReceipt;
                row.GraficoID = GraficoID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult RolesDelete(int RolID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsRolesBE.Where(x => x.RolID == RolID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsRolesBE> RolesGetAll(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsRolesBE.Where(x => x.RolID >= 0 && x.Rol.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsRolesBE.Where(x => x.RolID >= 0).Include(x => x.PermisosRoles).ToList();
                }
            }
            catch
            {
                return new List<clsRolesBE>();
            }
        }

        public List<clsRolesBE> RolesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsRolesBE.Where(x => x.RolID > 0 && x.Rol.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsRolesBE.Where(x => x.RolID > 0).Include(x => x.PermisosRoles).ToList();
                }
            }
            catch
            {
                return new List<clsRolesBE>();
            }
        }

        public List<clsPermisosRolesBE> PermisosRolesGetByRolID(int RolID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsPermisosRolesBE.Where(x => x.RolID == RolID && x.Permisos.Visible == true).ToList();
            }
            catch
            {
                return new List<clsPermisosRolesBE>();
            }
        }

        public List<clsPermisosBE> PermisosGetNotInRolID(int RolID)
        {
            try
            {
                db = new DAL.Context();
                var rows = from R in db.clsPermisosRolesBE.Where(x => x.RolID == RolID) join P in db.clsPermisosBE.Where(x => x.Visible == true) on R.PermisoID equals P.PermisoID select P;
                return db.clsPermisosBE.Where(x => !rows.Contains(x)).ToList();
            }
            catch
            {
                return new List<clsPermisosBE>();
            }
        }

        public OperationResult PermisosRolesCreate(int RolID, int PermisoID, bool Agregar, bool Editar, bool Eliminar, bool Imprimir, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                db.clsPermisosRolesBE.Add(new clsPermisosRolesBE { RolID = RolID, PermisoID = PermisoID, Agregar = Agregar, Modificar = Editar, Eliminar = Eliminar, Imprimir = Imprimir, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public OperationResult PermisosRolesUpdate(int RolID, int PermisoID, bool Agregar, bool Editar, bool Eliminar, bool Imprimir, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsPermisosRolesBE.Where(x => x.RolID == RolID && x.PermisoID == PermisoID).FirstOrDefault();
                row.Agregar = Agregar;
                row.Modificar = Editar;
                row.Eliminar = Eliminar;
                row.Imprimir = Imprimir;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PermisosRolesDelete(int RolID, int PermisoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsPermisosRolesBE.Where(x => x.RolID == RolID && x.PermisoID == PermisoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        #endregion

        #region Ocupaciones

        public OperationResult OcupacionesCreate(string Ocupacion, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsOcupacionesBE.Count() == 0 ? 100000 : db.clsOcupacionesBE.Max(x => x.OcupacionID)) + 1;
                db.clsOcupacionesBE.Add(new clsOcupacionesBE { OcupacionID = ID, Fecha = DateTime.Now, Ocupacion = Ocupacion, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult OcupacionesUpdate(int OcupacionID, string Ocupacion, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsOcupacionesBE.Where(x => x.OcupacionID == OcupacionID).FirstOrDefault();
                row.Ocupacion = Ocupacion;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult OcupacionesDelete(int OcupacionID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsOcupacionesBE.Where(x => x.OcupacionID == OcupacionID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsOcupacionesBE> OcupacionesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsOcupacionesBE.Where(x => x.Ocupacion.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsOcupacionesBE.ToList();
                }
            }
            catch
            {
                return new List<clsOcupacionesBE>();
            }
        }

        #endregion

        #region Instituciones

        public OperationResult InstitucionesCreate(string Institucion, string Direccion, string Telefono, string Documento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsInstitucionesBE.Count() == 0 ? 100000 : db.clsInstitucionesBE.Max(x => x.InstitucionID)) + 1;
                db.clsInstitucionesBE.Add(new clsInstitucionesBE { InstitucionID = ID, Fecha = DateTime.Now, Institucion = Institucion, Direccion = Direccion, Telefono = Telefono, Documento = Documento, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult InstitucionesUpdate(int InstitucionID, string Institucion, string Direccion, string Telefono, string Documento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsInstitucionesBE.Where(x => x.InstitucionID == InstitucionID).FirstOrDefault();
                row.Institucion = Institucion;
                row.Direccion = Direccion;
                row.Telefono = Telefono;
                row.Documento = Documento;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult InstitucionesDelete(int InstitucionID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsInstitucionesBE.Where(x => x.InstitucionID == InstitucionID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsInstitucionesBE> InstitucionesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsInstitucionesBE.Where(x => x.Institucion.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsInstitucionesBE.ToList();
                }
            }
            catch
            {
                return new List<clsInstitucionesBE>();
            }
        }

        public clsInstitucionesBE InstitucionesGetByInstitucionID(int InstitucionID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsInstitucionesBE.Where(x => x.InstitucionID == InstitucionID).FirstOrDefault();
            }
            catch
            {
                return new clsInstitucionesBE();
            }
        }

        #endregion

        #region Sms

        public OperationResult EnviarSMS(string Url = "", string EmpresaID = "", string LicenciaID = "", string Telefono = "", string Mensaje = "", int OperadorID = 1)
        {
            OperationResult result = new OperationResult();
            try
            {
                return Task.Run(async () =>
                {
                    result = await getEnviarSMS(Url, EmpresaID, LicenciaID, Telefono, Mensaje, OperadorID);
                    return result;
                }).Result;
            }
            catch (Exception ex)
            {
                return result;
            }
        }

        private async Task<OperationResult> getEnviarSMS(string url, string EmpresaID, string LicenciaID, string Telefono, string Mensaje, int OperadorID = 1)
        {
            try
            {
                var client = new HttpClient();
                string message = HttpUtility.UrlEncode(Mensaje, Encoding.UTF8);
                client.DefaultRequestHeaders.Accept.Clear();
                client.DefaultRequestHeaders.Add("Appkey", EmpresaID);
                client.DefaultRequestHeaders.Add("MessageHash", Common.Security.GetHash(EmpresaID + internalKey, Common.HashType.MD5));
                client.DefaultRequestHeaders.Add("LicenciaID", LicenciaID);
                client.DefaultRequestHeaders.Add("Build", "0");
                client.DefaultRequestHeaders.TryAddWithoutValidation("Content-Type", "application/json;charset=\"UTF-8\"");

                client.Timeout = new TimeSpan(0, 10, 0);
                client.BaseAddress = new Uri(url);
                var response = await client.GetAsync($"/api/i-bank/EnviarSMS?Telefono={Telefono}&Mensaje={message}&OperadorID={OperadorID}");
                if (!response.IsSuccessStatusCode)
                {
                    return new OperationResult();
                }

                var result = await response.Content.ReadAsStringAsync();
                return JsonConvert.DeserializeObject<OperationResult>(result);
            }
            catch
            {
                return new OperationResult();
            }
        }

        public OperationResult SmsCreate(string Celular, string Mensaje, int ContratoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsSmsBE.Count() == 0 ? 100000 : db.clsSmsBE.Max(x => x.smsID)) + 1;
                db.clsSmsBE.Add(new clsSmsBE { smsID = ID, Fecha = DateTime.Now, Celular = Celular, Mensaje = Mensaje, ContratoID = ContratoID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult SmsUpdate(int smsID, string Celular, string Mensaje, int ContratoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsSmsBE.Where(x => x.smsID == smsID).FirstOrDefault();
                row.Celular = Celular;
                row.Mensaje = Mensaje;
                row.ContratoID = ContratoID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult SmsDelete(int smsID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsSmsBE.Where(x => x.smsID == smsID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsSmsBE> SmsGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsSmsBE.Where(x => x.Mensaje.Contains(Search)).OrderBy(x => x.Mensaje).ToList();
                }
                else
                {
                    return db.clsSmsBE.OrderBy(x => x.Mensaje).ToList();
                }
            }
            catch
            {
                return new List<clsSmsBE>();
            }
        }

        public List<clsSmsBE> SmsGetByContratoID(int ContratoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsSmsBE.Where(x => x.ContratoID == ContratoID).OrderBy(x => x.smsID).ToList();

            }
            catch
            {
                return new List<clsSmsBE>();
            }
        }

        public bool CanSendSmS(string EmpresaID)
        {
            try {
                db = new DAL.Context();

                var row = db.clsEmpresasBE.Where(x => x.EmpresaID == EmpresaID);
                var rowXML = Common.Generic.Decoding(row.FirstOrDefault().Payment == null ? "" : row.FirstOrDefault().Payment);
                DateTime Hasta = DateTime.Now;
                if (!string.IsNullOrEmpty(rowXML))
                {
                    String xml = rowXML;
                    XDocument doc = XDocument.Parse(xml);
                    XElement Nodo = doc.Root.Element("Payment");
                    Hasta = Convert.ToDateTime(Nodo.Element("Fecha").Value).AddDays(-1);
                }

                DateTime Desde = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);

                int PaqueteID = 0;
                if (row.Count() > 0)
                {
                    PaqueteID  = row.FirstOrDefault().PaqueteID;
                    int Total = db.clsPaquetesBE.Where(x => x.PaqueteID == PaqueteID).FirstOrDefault().Hasta;
                    int Enviados = db.clsSmsBE.Where(x => x.Fecha >= Desde && x.Fecha <= Hasta).Count();

                    if(Enviados < Total)
                    {
                        return true;
                    }
                    else
                    {
                        return false;
                    }

                }
                return false;
            } 
            catch
            { 
                return false; 
            }
        }

        #endregion

        #region Llamadas

        public OperationResult LlamadasCreate(DateTime Fecha, string HableCon, string Mensaje, int ContratoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsLlamadasBE.Count() == 0 ? 100000 : db.clsLlamadasBE.Max(x => x.LlamadaID)) + 1;
                db.clsLlamadasBE.Add(new clsLlamadasBE { LlamadaID = ID, Fecha = Fecha, HableCon = HableCon, Mensaje = Mensaje, ContratoID = ContratoID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult LlamadasUpdate(int LlamadaID, DateTime Fecha, string HableCon, string Mensaje, int ContratoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsLlamadasBE.Where(x => x.LlamadaID == LlamadaID).FirstOrDefault();
                row.HableCon = HableCon;
                row.Fecha = Fecha;
                row.Mensaje = Mensaje;
                row.ContratoID = ContratoID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult LlamadasDelete(int LlamadaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsLlamadasBE.Where(x => x.LlamadaID == LlamadaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsLlamadasBE> LlamadasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsLlamadasBE.Where(x => x.Mensaje.Contains(Search)).OrderBy(x => x.Mensaje).ToList();
                }
                else
                {
                    return db.clsLlamadasBE.OrderBy(x => x.Mensaje).ToList();
                }
            }
            catch
            {
                return new List<clsLlamadasBE>();
            }
        }

        public List<clsLlamadasBE> LlamadasGetByContratoID(int ContratoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsLlamadasBE.Where(x => x.ContratoID == ContratoID).OrderBy(x => x.LlamadaID).ToList();

            }
            catch
            {
                return new List<clsLlamadasBE>();
            }
        }

        #endregion

        #region Operadores

        public OperationResult OperadoresCreate(string Operador, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsOperadoresBE.Count() == 0 ? 100000 : db.clsOperadoresBE.Max(x => x.OperadorID)) + 1;
                db.clsOperadoresBE.Add(new clsOperadoresBE { OperadorID = ID, Fecha = DateTime.Now, Operador = Operador, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult OperadoresUpdate(int OperadorID, string Operador, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsOperadoresBE.Where(x => x.OperadorID == OperadorID).FirstOrDefault();
                row.Operador = Operador;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult OperadoresDelete(int OperadorID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsOperadoresBE.Where(x => x.OperadorID == OperadorID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsOperadoresBE> OperadoresGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsOperadoresBE.Where(x => x.Operador.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsOperadoresBE.ToList();
                }
            }
            catch
            {
                return new List<clsOperadoresBE>();
            }
        }

        #endregion

        #region Horarios

        public OperationResult HorariosCreate(string Horario, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsHorariosBE.Count() == 0 ? 100000 : db.clsHorariosBE.Max(x => x.HorarioID)) + 1;
                db.clsHorariosBE.Add(new clsHorariosBE { HorarioID = ID, Fecha = DateTime.Now, Horario = Horario, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult HorariosUpdate(int HorarioID, string Horario, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsHorariosBE.Where(x => x.HorarioID == HorarioID).FirstOrDefault();
                row.Horario = Horario;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult HorariosDelete(int HorarioID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsHorariosBE.Where(x => x.HorarioID == HorarioID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsHorariosBE> HorariosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsHorariosBE.Where(x => x.Horario.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsHorariosBE.ToList();
                }
            }
            catch
            {
                return new List<clsHorariosBE>();
            }
        }

        #endregion

        #region Ingresos

        public OperationResult IngresosCreate(string Ingreso, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsIngresosBE.Count() == 0 ? 100000 : db.clsIngresosBE.Max(x => x.IngresoID)) + 1;
                db.clsIngresosBE.Add(new clsIngresosBE { IngresoID = ID, Fecha = DateTime.Now, Ingreso = Ingreso, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult IngresosUpdate(int IngresoID, string Ingreso, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsIngresosBE.Where(x => x.IngresoID == IngresoID).FirstOrDefault();
                row.Ingreso = Ingreso;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult IngresosDelete(int IngresoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsIngresosBE.Where(x => x.IngresoID == IngresoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsIngresosBE> IngresosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsIngresosBE.Where(x => x.Ingreso.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsIngresosBE.ToList();
                }
            }
            catch
            {
                return new List<clsIngresosBE>();
            }
        }

        #endregion

        #region Tipo Solicitudes

        public OperationResult TipoSolicitudesCreate(string TipoSolicitud, int AuxiliarID, bool IsDefault, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeDefault(Usuario);
                }
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsTipoSolicitudesBE.Count() == 0 ? 100000 : db.clsTipoSolicitudesBE.Max(x => x.TipoSolicitudID)) + 1;
                db.clsTipoSolicitudesBE.Add(new clsTipoSolicitudesBE { TipoSolicitudID = ID, Fecha = DateTime.Now, TipoSolicitud = TipoSolicitud, AuxiliarID = AuxiliarID, IsDefault = IsDefault, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        private bool ChangeDefault(string Usuario)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoSolicitudesBE.Where(x => x.IsDefault == true).FirstOrDefault();
                row.IsDefault = false;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                return true;
            }
            catch { return false; }
        }
        public OperationResult TipoSolicitudesUpdate(int TipoSolicitudID, string TipoSolicitud, int AuxiliarID, bool IsDefault, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeDefault(Usuario);
                }
                db = new DAL.Context();
                var row = db.clsTipoSolicitudesBE.Where(x => x.TipoSolicitudID == TipoSolicitudID).FirstOrDefault();
                row.TipoSolicitud = TipoSolicitud;
                row.AuxiliarID = AuxiliarID;
                row.IsDefault = IsDefault;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TipoSolicitudesDelete(int TipoSolicitudID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoSolicitudesBE.Where(x => x.TipoSolicitudID == TipoSolicitudID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsTipoSolicitudesBE> TipoSolicitudesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoSolicitudesBE.Where(x => x.TipoSolicitud.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsTipoSolicitudesBE.ToList();
                }
            }
            catch
            {
                return new List<clsTipoSolicitudesBE>();
            }
        }

        #endregion

        #region Servidores

        public List<clsServidoresBE> ServidoresGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsServidoresBE.Where(x => x.Smtp.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsServidoresBE.ToList();
                }
            }
            catch
            {
                return new List<clsServidoresBE>();
            }
        }

        #endregion

        #region Correos

        public OperationResult CorreosCreate(string EmpresaID, string Correo, string Contraseña, int ServidorID, bool IsDefault, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeCorreoDefault(Usuario);
                }
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsCorreosBE.Count() == 0 ? 100000 : db.clsCorreosBE.Max(x => x.CorreoID)) + 1;
                db.clsCorreosBE.Add(new clsCorreosBE { CorreoID = ID, Fecha = DateTime.Now, EmpresaID = EmpresaID, Correo = Correo, Contraseña = Common.clsMisc.Encryption(Contraseña), ServidorID = ServidorID, IsDefault = IsDefault, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        private bool ChangeCorreoDefault(string Usuario)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsCorreosBE.Where(x => x.IsDefault == true).FirstOrDefault();
                row.IsDefault = false;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                return true;
            }
            catch { return false; }
        }
        public OperationResult CorreosUpdate(int CorreoID, string EmpresaID, string Correo, string Contraseña, int ServidorID, bool IsDefault, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeCorreoDefault(Usuario);
                }
                db = new DAL.Context();
                var row = db.clsCorreosBE.Where(x => x.CorreoID == CorreoID).FirstOrDefault();
                row.Correo = Correo;
                row.EmpresaID = EmpresaID;
                row.Contraseña = Common.clsMisc.Encryption(Contraseña);
                row.ServidorID = ServidorID;
                row.IsDefault = IsDefault;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult CorreosDelete(int CorreoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCorreosBE.Where(x => x.CorreoID == CorreoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsCorreosBE> CorreosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsCorreosBE.Where(x => x.Correo.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsCorreosBE.ToList();
                }
            }
            catch
            {
                return new List<clsCorreosBE>();
            }
        }

        #endregion

        #region Tipo de Tareas

        public List<clsTipoTareasBE> TipoTareasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoTareasBE.Where(x => x.Descripcion.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsTipoTareasBE.ToList();
                }
            }
            catch
            {
                return new List<clsTipoTareasBE>();
            }
        }

        public List<clsTipoTareasBE> TipoTareasGetNotTask(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoTareasBE.Where(x => x.Descripcion.Contains(Search)).ToList();
                }
                else
                {
                    var a = from tt in db.clsTipoTareasBE join t in db.clsTareasBE on tt.TipoTareaID equals t.TipoTareaID select tt;
                    var result = db.clsTipoTareasBE.Where(x => !a.Contains(x)).ToList();
                    return result;
                }
            }
            catch (Exception ex)
            {
                return new List<clsTipoTareasBE>();
            }
        }

        #endregion

        #region Tareas

        public OperationResult TareasCreate(string EmpresaID, int TipoTareaID, int Dia, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsTareasBE.Count() == 0 ? 100000 : db.clsTareasBE.Max(x => x.TareaID)) + 1;
                db.clsTareasBE.Add(new clsTareasBE { TareaID = ID, Fecha = DateTime.Now, EmpresaID = EmpresaID, TipoTareaID = TipoTareaID, Dia = Dia, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public OperationResult TareasUpdate(int TareaID, string EmpresaID, int TipoTareaID, int Dia, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTareasBE.Where(x => x.TareaID == TareaID).FirstOrDefault();
                row.Dia = Dia;
                row.EmpresaID = EmpresaID;
                row.TipoTareaID = TipoTareaID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TareasDelete(int TareaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTareasBE.Where(x => x.TareaID == TareaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsTareasBE> TareasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTareasBE.Where(x => x.Dia.ToString().Contains(Search) || x.TipoTareas.Descripcion.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsTareasBE.ToList();
                }
            }
            catch (Exception ex)
            {
                return new List<clsTareasBE>();
            }
        }

        #endregion

        #region Tipo de Cartas

        public List<clsTipoCartasBE> TipoCartasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoCartasBE.Where(x => x.TipoCarta.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsTipoCartasBE.ToList();
                }
            }
            catch
            {
                return new List<clsTipoCartasBE>();
            }
        }

        public List<clsTipoCartasBE> TipoCartasGetNotTask(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoCartasBE.Where(x => x.TipoCarta.Contains(Search)).ToList();
                }
                else
                {
                    var a = from tt in db.clsTipoCartasBE join t in db.clsCartasBE on tt.TipoCartaID equals t.TipoCartaID select tt;
                    var result = db.clsTipoCartasBE.Where(x => !a.Contains(x)).ToList();
                    return result;
                }
            }
            catch
            {
                return new List<clsTipoCartasBE>();
            }
        }

        #endregion

        #region Cartas

        public OperationResult CartasCreate(string EmpresaID, int TipoCartaID, int Desde, int Hasta, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsCartasBE.Count() == 0 ? 100000 : db.clsCartasBE.Max(x => x.CartaID)) + 1;
                db.clsCartasBE.Add(new clsCartasBE { CartaID = ID, Fecha = DateTime.Now, EmpresaID = EmpresaID, TipoCartaID = TipoCartaID, Desde = Desde, Hasta = Hasta, Monto = Monto, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public OperationResult CartasUpdate(int CartaID, string EmpresaID, int TipoCartaID, int Desde, int Hasta, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCartasBE.Where(x => x.CartaID == CartaID).FirstOrDefault();
                row.Desde = Desde;
                row.Hasta = Hasta;
                row.Monto = Monto;
                row.EmpresaID = EmpresaID;
                row.TipoCartaID = TipoCartaID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult CartasDelete(int CartaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCartasBE.Where(x => x.CartaID == CartaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsCartasBE> CartasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                List<clsCartasBE> result = new List<clsCartasBE>();
                if (!string.IsNullOrEmpty(Search))
                {
                    result = db.clsCartasBE.Where(x => x.Desde.ToString().Contains(Search) || x.Hasta.ToString().Contains(Search) || x.TipoCartas.TipoCarta.Contains(Search)).ToList();
                }
                else
                {
                    result = db.clsCartasBE.ToList();
                }
                return result;
            }
            catch
            {
                return new List<clsCartasBE>();
            }
        }

        #endregion

        #region HistorialCartas

        public OperationResult HistorialCartasCreate(int CartaID, int CuotaID, float Monto, float Atraso, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsHistorialCartasBE.Count() == 0 ? 100000 : db.clsHistorialCartasBE.Max(x => x.HistorialCartaID)) + 1;
                db.clsHistorialCartasBE.Add(new clsHistorialCartasBE { HistorialCartaID = ID, Fecha = DateTime.Now, CuotaID = CuotaID, CartaID = CartaID, Monto = Monto, Atraso = Atraso, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult HistorialCartasUpdate(int HistorialCartaID, int CartaID, int CuotaID, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsHistorialCartasBE.Where(x => x.HistorialCartaID == HistorialCartaID).FirstOrDefault();
                row.CuotaID = CuotaID;
                row.CartaID = CartaID;
                row.Monto = Monto;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult HistorialCartasDelete(int HistorialCartaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsHistorialCartasBE.Where(x => x.HistorialCartaID == HistorialCartaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsHistorialCartasBE> HistorialCartasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsHistorialCartasBE.Where(x => x.Cartas.TipoCartas.TipoCarta.Contains(Search)).OrderBy(x => x.Cartas.TipoCartas.TipoCarta).ToList();
                }
                else
                {
                    return db.clsHistorialCartasBE.OrderBy(x => x.Cartas.TipoCartas.TipoCarta).ToList();
                }
            }
            catch
            {
                return new List<clsHistorialCartasBE>();
            }
        }

        public List<clsHistorialCartasBE> HistorialCartasGetByContratoID(int ContratoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsHistorialCartasBE.Where(x => x.Cuotas.ContratoID == ContratoID).OrderBy(x => x.Cuotas.Numero).ToList();
            }
            catch
            {
                return new List<clsHistorialCartasBE>();
            }
        }

        #endregion

        #region Condiciones

        public OperationResult CondicionesCreate(string Condicion, int Meses, int Dias, bool IsDefault, bool SendSMS, int Tiempo, float Interes, float Comision, bool IsLegal, float Legal, bool IsSeguro, float Seguro, bool MoraAutomatica, float Mora, int DiaGracia, bool ShowComision, bool DataCredito, bool LetterDelay, bool IsGenerateRequest, int BancoID, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    CondicionesDefault(Usuario);
                }
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsCondicionesBE.Count() == 0 ? 100000 : db.clsCondicionesBE.Max(x => x.CondicionID)) + 1;
                db.clsCondicionesBE.Add(new clsCondicionesBE { CondicionID = ID, Fecha = DateTime.Now, Condicion = Condicion, Meses = Meses, Dias = Dias, IsDefault = IsDefault, Comision = Comision, DataCredito = DataCredito, DiasGracia = DiaGracia, Interes = Interes, Tiempo = Tiempo, IsLegal = IsLegal, IsSeguro = IsSeguro, Legal = Legal, Mora = Mora, MoraAutomatica = MoraAutomatica, Seguro = Seguro, SendSMS = SendSMS, ShowComision = ShowComision, LetterDelay = LetterDelay, IsGenerateRequest = IsGenerateRequest, BancoID = BancoID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        private bool CondicionesDefault(string Usuario)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsCondicionesBE.Where(x => x.IsDefault == true).FirstOrDefault();
                row.IsDefault = false;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                return true;
            }
            catch { return false; }
        }
        public OperationResult CondicionesUpdate(int CondicionID, string Condicion, int Meses, int Dias, bool IsDefault, bool SendSMS, int Tiempo, float Interes, float Comision, bool IsLegal, float Legal, bool IsSeguro, float Seguro, bool MoraAutomatica, float Mora, int DiaGracia, bool ShowComision, bool DataCredito, bool LetterDelay, bool IsGenerateRequest, int BancoID, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    CondicionesDefault(Usuario);
                }
                db = new DAL.Context();
                var row = db.clsCondicionesBE.Where(x => x.CondicionID == CondicionID).FirstOrDefault();
                row.Condicion = Condicion;
                row.Meses = Meses;
                row.Dias = Dias;
                row.IsDefault = IsDefault;
                row.Comision = Comision;
                row.DataCredito = DataCredito;
                row.DiasGracia = DiaGracia;
                row.Interes = Interes;
                row.Tiempo = Tiempo;
                row.IsLegal = IsLegal;
                row.IsSeguro = IsSeguro;
                row.Legal = Legal;
                row.Mora = Mora;
                row.MoraAutomatica = MoraAutomatica;
                row.Seguro = Seguro;
                row.SendSMS = SendSMS;
                row.ShowComision = ShowComision;
                row.LetterDelay = LetterDelay;
                row.IsGenerateRequest = IsGenerateRequest;
                row.BancoID = BancoID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult CondicionesDelete(int CondicionID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCondicionesBE.Where(x => x.CondicionID == CondicionID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsCondicionesBE> CondicionesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsCondicionesBE.Where(x => x.Condicion.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsCondicionesBE.ToList();
                }
            }
            catch
            {
                return new List<clsCondicionesBE>();
            }
        }

        #endregion

        #region Estado Solicitudes

        public List<clsEstadoSolicitudesBE> EstadoSolicitudesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsEstadoSolicitudesBE.Where(x => x.Estado.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsEstadoSolicitudesBE.ToList();
                }
            }
            catch
            {
                return new List<clsEstadoSolicitudesBE>();
            }
        }

        #endregion

        #region Objetivos

        public List<clsObjetivosBE> ObjetivosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsObjetivosBE.Where(x => x.Objetivo.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsObjetivosBE.ToList();
                }
            }
            catch
            {
                return new List<clsObjetivosBE>();
            }
        }

        #endregion

        #region Estado Solicitud de Cheques

        public List<clsEstadoSolictudChequesBE> EstadoSolicitudChequesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsEstadoSolictudChequesBE.Where(x => x.Estado.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsEstadoSolictudChequesBE.ToList();
                }
            }
            catch
            {
                return new List<clsEstadoSolictudChequesBE>();
            }
        }

        #endregion

        #region Tipo de Impresiones

        public List<clsTipoImpresionesBE> TipoImpresionesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoImpresionesBE.Where(x => x.Descripcion.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsTipoImpresionesBE.ToList();
                }
            }
            catch
            {
                return new List<clsTipoImpresionesBE>();
            }
        }

        public List<clsTipoImpresionesBE> TipoImpresionesGetNotTask(string Search, string DispositivoID = "")
        {
            try
            {
                db = new DAL.Context();

                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoImpresionesBE.Where(x => x.Descripcion.ToUpper().Contains(Search.ToUpper())).ToList();
                }
                else
                {
                    if (!string.IsNullOrEmpty(DispositivoID))
                    {
                        var a = from tt in db.clsTipoImpresionesBE join t in db.clsImpresionesBE.Where(x => x.DispositivoID == DispositivoID) on tt.TipoImpresionID equals t.TipoImpresionID select tt;
                        var result = db.clsTipoImpresionesBE.Where(x => !a.Contains(x)).ToList();
                        return result;
                    }
                    else
                    {
                        var a = from tt in db.clsTipoImpresionesBE join t in db.clsImpresionesBE on tt.TipoImpresionID equals t.TipoImpresionID select tt;
                        var result = db.clsTipoImpresionesBE.Where(x => !a.Contains(x)).ToList();
                        return result;
                    }
                }

            }
            catch (Exception ex)
            {
                return new List<clsTipoImpresionesBE>();
            }
        }

        #endregion

        #region Impresiones

        public OperationResult ImpresionesCreate(int SucursalID, int TipoImpresionID, string DispositivoID, string Papel, string Local, string Red, int Copias, float Ancho, float Alto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsImpresionesBE.Count() == 0 ? 100000 : db.clsImpresionesBE.Max(x => x.ImpresionID)) + 1;
                db.clsImpresionesBE.Add(new clsImpresionesBE { ImpresionID = ID, Fecha = DateTime.Now, SucursalID = SucursalID, DispositivoID = DispositivoID, Copias = Copias, TipoImpresionID = TipoImpresionID, Papel = Papel, Local = Local, Red = Red, Ancho = Ancho, Alto = Alto, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public OperationResult ImpresionesUpdate(int ImpresionID, int SucursalID, int TipoImpresionID, string DispositivoID, string Papel, string Local, string Red, int Copias, float Ancho, float Alto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsImpresionesBE.Where(x => x.ImpresionID == ImpresionID).FirstOrDefault();
                row.SucursalID = SucursalID;
                row.TipoImpresionID = TipoImpresionID;
                row.DispositivoID = DispositivoID;
                row.Local = Local;
                row.Red = Red;
                row.Papel = Papel;
                row.Copias = Copias;
                row.Alto = Alto;
                row.Ancho = Ancho;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ImpresionesDelete(int ImpresionID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsImpresionesBE.Where(x => x.ImpresionID == ImpresionID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsImpresionesBE> ImpresionesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsImpresionesBE.Where(x => x.Red.ToString().Contains(Search) || x.Local.ToString().Contains(Search) || x.Papel.ToString().Contains(Search) || x.TipoImpresiones.Descripcion.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsImpresionesBE.ToList();
                }
            }
            catch
            {
                return new List<clsImpresionesBE>();
            }
        }

        #endregion

        #region Cheques

        public OperationResult ChequesCreate(int SolicitudChequeID, DateTime Fecha, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();

                var row = db.clsSolicitudChequesBE.Where(x => x.SolicitudChequeID == SolicitudChequeID).FirstOrDefault();
                int ID = 0;

                ID = (db.clsChequesBE.Where(x => x.SolicitudCheques.BancoID == row.BancoID).Count() == 0 ? 100000 : db.clsChequesBE.Where(x => x.SolicitudCheques.BancoID == row.BancoID).Max(x => x.Numero)) + 1;
                db.clsChequesBE.Add(new clsChequesBE { SolicitudChequeID = SolicitudChequeID, Fecha = Fecha, Numero = ID, EstadoID = true, Contabilizado = false, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ChequesUpdate(int SolicitudChequeID, DateTime Fecha, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsChequesBE.Where(x => x.SolicitudChequeID == SolicitudChequeID).FirstOrDefault();
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ChequesDelete(int SolicitudChequeID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsChequesBE.Where(x => x.SolicitudChequeID == SolicitudChequeID).FirstOrDefault();
                row.EstadoID = false;
                row.Contabilizado = false;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsChequesBE> ChequesGet(DateTime Desde, DateTime Hasta, string Search, string Documento)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                List<clsChequesBE> result = new List<clsChequesBE>();
                List<clsChequesBE> BE = new List<clsChequesBE>();
                var row = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();

                if (row.Roles.ViewAllCheck == true)
                {
                    BE = db.clsChequesBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta).ToList();
                }
                else
                {
                    BE = db.clsChequesBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.SolicitudCheques.Bancos.SucursalID == row.SucursalID).ToList();
                }

                if (!string.IsNullOrEmpty(Search))
                {
                    Search = Search.ToUpper();
                    result = BE.Where(x => x.SolicitudChequeID.ToString().Contains(Search) || x.SolicitudCheques.Beneficiario.ToUpper().Contains(Search) || x.SolicitudCheques.Monto.ToString().Contains(Search) || x.Numero.ToString().Contains(Search) || x.SolicitudCheques.Bancos.Banco.Contains(Search)).ToList();
                }
                else
                {
                    result = BE.ToList();
                }

                return result.OrderBy(x => x.Numero).ToList();

            }
            catch
            {
                return new List<clsChequesBE>();
            }
        }

        public clsChequesBE ChequesGetBySolicitudChequeID(int SolicitudChequeID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsChequesBE.Where(x => x.SolicitudChequeID == SolicitudChequeID).FirstOrDefault();
            }
            catch
            {
                return new clsChequesBE();
            }
        }

        //public DataSet PrintChequesGetByChequeID(int ChequeID)
        //{
        //    try
        //    {
        //        db = new DAL.Context();
        //        var row = db.clsChequesBE.Where(x => x.ChequeID == ChequeID);
        //        DataSet ds = new DataSet();

        //        clsCuotasView Cuotas = new clsCuotasView();
        //        Cuotas.SetDataSource(row.FirstOrDefault().ContratoID, row.FirstOrDefault().ChequeID);
        //        var result = Cuotas.GetGroup();
        //        float balance;

        //        if (row.FirstOrDefault().Contratos.TipoContratoID == 2)
        //        {
        //            balance = (Cuotas.BalanceGetByChequeID() < 0 ? 0 : Cuotas.BalanceGetByChequeID());
        //        }
        //        else
        //        {
        //            balance = (Cuotas.BalanceCapitalGetByChequeID() < 0 ? 0 : Cuotas.BalanceCapitalGetByChequeID());
        //        }
        //        //var Cheques = from R in row select new Entity.Cheques { ChequeID = R.ChequeID, Fecha = R.Fecha, ComprobanteID = R.ComprobanteID, Ncf = R.Ncf, ContratoID = R.ContratoID, FormaPagoID = R.FormaPagoID, EstadoID = R.EstadoID, Informacion = R.Informacion, Contabilizado = R.Contabilizado, SucursalID = R.SucursalID, SubTotal = R.SubTotal, Descuento = R.Descuento, Monto = R.Monto, Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };
        //        //var DetalleCheques = from DR in db.clsDetalleChequesBE.Where(x => x.ChequeID == ChequeID) select new DetalleCheques { ChequeID =DR.ChequeID, DetalleChequeID = DR.DetalleChequeID, CuotaID = DR.CuotaID,Numero = DR.Numero, Concepto = DR.Concepto, Capital = DR.Capital, Comision = DR.Comision, Interes = DR.Interes, Mora = DR.Mora, Legal = DR.Legal, SubTotal = DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal, Usuario = DR.Usuario, ModificadoPor = DR.ModificadoPor, FechaModificacion = DR.FechaModificacion };
        //        //var FormaPagos = from R in row select new FormaPagos { FormaPagoID = R.FormaPagos.FormaPagoID, Fecha = R.FormaPagos.Fecha, IsDefault = R.FormaPagos.IsDefault, Nombre = R.FormaPagos.Nombre,  Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };
        //        //var Sucursales = from R in row select new Sucursales { SucursalID = R.Sucursales.SucursalID, Fecha = R.Sucursales.Fecha, Sucursal = R.Sucursales.Sucursal, CiudadID = R.Sucursales.CiudadID, Documento = R.Sucursales.Documento, EmpresaID = R.Sucursales.EmpresaID, NotarioPublicoID = R.Sucursales.NotarioPublicoID,  Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };
        //        //var Empresas = from R in row select new Empresas { Empresa = R.Sucursales.Empresas.Empresa, EmpresaID = R.Sucursales.EmpresaID, Fecha = R.Sucursales.Empresas.Fecha, Direccion = R.Sucursales.Sucursales.Direccion, Telefonos = R.Sucursales.Telefonos, Rnc = R.Sucursales.Empresas.Rnc, Siglas = R.Sucursales.Empresas.Siglas, Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };
        //        //var Solicitudes = from R in row select new Solicitudes { SolicitudID = R.Contratos.Solicitudes.SolicitudID, Fecha = R.Contratos.Solicitudes.Fecha, ClienteID = R.Contratos.Solicitudes.ClienteID, CondicionID = R.Contratos.Solicitudes.CondicionID, EstadoID = R.Contratos.Solicitudes.EstadoID, Monto = R.Contratos.Solicitudes.Monto, Tiempo = R.Contratos.Solicitudes.Tiempo, TipoSolicitudID = R.Contratos.Solicitudes.TipoSolicitudID, Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };
        //        //var Personas = from R in row select new Personas { Documento = R.Contratos.Solicitudes.Clientes.Personas.Documento, Fecha = R.Contratos.Solicitudes.Clientes.Personas.Fecha, FechaNacimiento = R.Contratos.Solicitudes.Clientes.Personas.FechaNacimiento, Nombres = R.Contratos.Solicitudes.Clientes.Personas.Nombres, Apellidos = R.Contratos.Solicitudes.Clientes.Personas.Apellidos, Apodo = R.Contratos.Solicitudes.Clientes.Personas.Apodo, Fotografia = R.Contratos.Solicitudes.Clientes.Personas.Fotografia, CiudadID = R.Contratos.Solicitudes.Clientes.Personas.CiudadID, Direccion = R.Contratos.Solicitudes.Clientes.Personas.Direccion, Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };
        //        //var Comprobantes = from R in row select new Comprobantes { ComprobanteID = R.Comprobantes.ComprobanteID, Fecha = R.Comprobantes.Fecha, IsDefault = R.FormaPagos.IsDefault, Comprobante = R.Comprobantes.Comprobante, Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };


        //        MySqlDataAdapter da = new MySqlDataAdapter();
        //        MySqlConnection cn = new MySqlConnection();
        //        cn.ConnectionString = db.Database.Connection.ConnectionString;

        //        //Cheques
        //        cn.Open();
        //        MySqlCommand cm = new MySqlCommand();
        //        cm.CommandText = "SELECT Cheques.ChequeID, Cheques.Fecha, Cheques.ContratoID, Empresas.Empresa, Sucursales.Direccion AS DireccionEmpresa, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal, Personas.Nombres, Personas.Apellidos, Personas.Direccion, FormaPagos.Nombre, Comprobantes.Comprobante, Cheques.Ncf, Cheques.SubTotal, Cheques.Descuento, Cheques.Monto, Cheques.Informacion,Solicitudes.Tiempo, (SELECT Nombres FROM Personas AS P WHERE (Documento = Cheques.Usuario)) AS Usuario FROM Cheques INNER JOIN Sucursales ON Cheques.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN Contratos ON Cheques.ContratoID = Contratos.ContratoID INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN FormaPagos ON Cheques.FormaPagoID = FormaPagos.FormaPagoID INNER JOIN Comprobantes ON Cheques.ComprobanteID = Comprobantes.ComprobanteID Where Cheques.ChequeID = @ChequeID";
        //        cm.CommandType = CommandType.Text;
        //        cm.Connection = cn;
        //        cm.Parameters.Add(new MySqlParameter("@ChequeID", ChequeID));
        //        da.SelectCommand = cm;
        //        ds = new DataSet();
        //        da.Fill(ds, "Cheques");
        //        cn.Close();

        //        //DetalleCheques
        //        da = new MySqlDataAdapter();
        //        cn.Open();
        //        cm = new MySqlCommand();
        //        cm.CommandText = "SELECT * from DetalleCheques Where DetalleCheques.ChequeID = @ChequeID";
        //        cm.CommandType = CommandType.Text;
        //        cm.Connection = cn;
        //        cm.Parameters.Add(new MySqlParameter("@ChequeID", ChequeID));
        //        da.SelectCommand = cm;
        //        da.Fill(ds, "DetalleCheques");
        //        cn.Close();

        //        DataTable Cuentas = new DataTable("Cuentas");
        //        Cuentas.Columns.Add("Balance", typeof(float));
        //        Cuentas.Columns.Add("BarCode", typeof(byte[]));
        //        DataRow dataRow = Cuentas.NewRow();
        //        dataRow["Balance"] = balance;
        //        dataRow["BarCode"] = ImageFromText(ChequeID.ToString());
        //        Cuentas.Rows.Add(dataRow);

        //        //ds.Tables.Add(EntityToDataTable(Cheques, "Cheques"));
        //        //ds.Tables.Add(EntityToDataTable(DetalleCheques, "DetalleCheques"));
        //        //ds.Tables.Add(EntityToDataTable(FormaPagos, "FormaPagos"));
        //        //ds.Tables.Add(EntityToDataTable(Sucursales, "Sucursales"));
        //        //ds.Tables.Add(EntityToDataTable(Empresas, "Empresas"));
        //        //ds.Tables.Add(EntityToDataTable(Solicitudes, "Solicitudes"));
        //        //ds.Tables.Add(EntityToDataTable(Personas, "Personas"));
        //        //ds.Tables.Add(EntityToDataTable(Comprobantes, "Comprobantes"));
        //        ds.Tables.Add(Cuentas);
        //        return ds;
        //    }
        //    catch
        //    {
        //        return new DataSet();
        //    }
        //}



        #endregion

        #region Estado Contratos

        public List<clsEstadoContratosBE> EstadoContratosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsEstadoContratosBE.Where(x => x.Estado.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsEstadoContratosBE.ToList();
                }
            }
            catch
            {
                return new List<clsEstadoContratosBE>();
            }
        }

        #endregion

        #region Procesadores de Pago

        public List<clsProcesadoresBE> ProcesadoresGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsProcesadorBE.Where(x => x.Procesador.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsProcesadorBE.ToList();
                }
            }
            catch
            {
                return new List<clsProcesadoresBE>();
            }
        }

        public List<clsProcesadoresBE> ProcesadoressGetNotExist(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsProcesadorBE.Where(x => x.Procesador.Contains(Search)).ToList();
                }
                else
                {
                    var a = from tt in db.clsProcesadorBE join t in db.clsPasarelasBE on tt.ProcesadorID equals t.ProcesadorID select tt;
                    var result = db.clsProcesadorBE.Where(x => !a.Contains(x)).ToList();
                    return result;
                }
            }
            catch
            {
                return new List<clsProcesadoresBE>();
            }
        }

        #endregion

        #region Pasarelas de Pago

        public OperationResult PasarelasCreate(string EmpresaID, int ProcesadorID, string MerchantID, string KeyID, string SecureKey, bool IsDefault, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsPasarelasBE.Count() == 0 ? 100000 : db.clsPasarelasBE.Max(x => x.PasarelaID)) + 1;
                db.clsPasarelasBE.Add(new clsPasarelasBE { PasarelaID = ID, Fecha = DateTime.Now, EmpresaID = EmpresaID, ProcesadorID = ProcesadorID, KeyID = KeyID, MerchantID = MerchantID, SecretKey = SecureKey, IsDefault = IsDefault, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PasarelasUpdate(int PasarelaID, string EmpresaID, int ProcesadorID, string MerchantID, string KeyID, string SecureKey, bool IsDefault, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsPasarelasBE.Where(x => x.PasarelaID == PasarelaID).FirstOrDefault();
                row.EmpresaID = EmpresaID;
                row.ProcesadorID = ProcesadorID;
                row.MerchantID = MerchantID;
                row.KeyID = KeyID;
                row.SecretKey = SecureKey;
                row.IsDefault = IsDefault;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PasarelasDelete(int PasarelaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsPasarelasBE.Where(x => x.PasarelaID == PasarelaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsPasarelasBE> PasarelasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    Search = Search.ToUpper();
                    return db.clsPasarelasBE.Where(x => x.Procesadores.Procesador.ToUpper().Contains(Search)).OrderBy(x => x.PasarelaID).ToList();
                }
                else
                {
                    return db.clsPasarelasBE.ToList();
                }
            }
            catch
            {
                return new List<clsPasarelasBE>();
            }
        }

        public clsPasarelasBE PasarelasGetByEmpresaID(string EmpresaID)
        {
            try
            {
                db = new DAL.Context();
                var result = db.clsPasarelasBE.Where(x => x.EmpresaID == EmpresaID && x.IsDefault == true).FirstOrDefault();
                return result;
            }
            catch
            {
                return new clsPasarelasBE();
            }
        }

        public clsPasarelasBE PasarelasGetByPasarelaID(int PasarelaID)
        {
            try
            {
                db = new DAL.Context();
                var result = db.clsPasarelasBE.Where(x => x.PasarelaID == PasarelaID).FirstOrDefault();
                return result;
            }
            catch
            {
                return new clsPasarelasBE();
            }
        }


        public Model.Response.Root ProcesarPagosGetByMerchantID(string EmpresaID = "", string JsonObj = "", string LicenciaID = "")
        {
            try
            {
                db = new DAL.Context();
                return Task.Run(async () =>
                {
                    var row = await getProcesarPagosGetByMerchantID(EmpresaID, JsonObj, LicenciaID);
                    return row;
                }).Result;
            }
            catch
            {
                return new Model.Response.Root();
            }
        }


        private async Task<Model.Response.Root> getProcesarPagosGetByMerchantID(string EmpresaID, string JsonObj, string LicenciaID)
        {
            try
            {
                var client = new HttpClient();
                db = new DAL.Context();
                client.DefaultRequestHeaders.Accept.Clear();
                client.DefaultRequestHeaders.Add("Appkey", EmpresaID);
                client.DefaultRequestHeaders.Add("MessageHash", Common.Security.GetHash(EmpresaID + internalKey, Common.HashType.MD5));
                client.DefaultRequestHeaders.Add("LicenciaID", LicenciaID);
                client.DefaultRequestHeaders.Add("Build", "0");

                client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
                var url = $"http://{db.Database.Connection.DataSource}/";
                client.Timeout = new TimeSpan(0, 10, 0);
                client.BaseAddress = new Uri(url);
                var response = await client.GetAsync($"/api/i-Bank/ProcesarPagosGetByMerchantID?EmpresaID={EmpresaID}&JsonObj={JsonObj}");
                if (!response.IsSuccessStatusCode)
                {
                    return new Model.Response.Root();
                }

                var result = await response.Content.ReadAsStringAsync();
                return JsonConvert.DeserializeObject<Model.Response.Root>(result);
            }
            catch
            {
                return new Model.Response.Root();
            }
        }


        #endregion

        #region Sexos

        public List<clsSexosBE> SexosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsSexosBE.Where(x => x.Sexo.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsSexosBE.ToList();
                }
            }
            catch
            {
                return new List<clsSexosBE>();
            }
        }

        #endregion

        #region Denominaciones

        public List<clsDenominacionesBE> DenominacionesGet()
        {
            try
            {
                db = new DAL.Context();
                return db.clsDenominacionesBE.ToList();
            }
            catch
            {
                return new List<clsDenominacionesBE>();
            }
        }

        #endregion

        #region TipoEmpresas

        public List<clsTipoEmpresasBE> TipoEmpresasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoEmpresasBE.Where(x => x.TipoEmpresa.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsTipoEmpresasBE.ToList();
                }
            }
            catch
            {
                return new List<clsTipoEmpresasBE>();
            }
        }

        #endregion

        #region Estados Civiles

        public List<clsEstadosCivilesBE> EstadosCivilesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsEstadosCivilesBE.Where(x => x.EstadoCivil.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsEstadosCivilesBE.ToList();
                }
            }
            catch
            {
                return new List<clsEstadosCivilesBE>();
            }
        }

        #endregion

        #region Tipo Contratos

        public OperationResult TipoContratosCreate(string TipoContrato, bool IsDefault, bool ContinueOnTime, bool InteresDiario, bool MoraDiaria, bool CanMinimumPay, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeContractDefault(Usuario);
                }
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsTipoContratosBE.Count() == 0 ? 100000 : db.clsTipoContratosBE.Max(x => x.TipoContratoID)) + 1;
                db.clsTipoContratosBE.Add(new clsTipoContratosBE { TipoContratoID = ID, Fecha = DateTime.Now, TipoContrato = TipoContrato, IsDefault = IsDefault, ContinueOnTime = ContinueOnTime, InteresDiario = InteresDiario, MoraDiaria = MoraDiaria, CanMinimumPay = CanMinimumPay, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        private bool ChangeContractDefault(string Usuario)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoContratosBE.Where(x => x.IsDefault == true).FirstOrDefault();
                row.IsDefault = false;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                return true;
            }
            catch { return false; }
        }
        public OperationResult TipoContratosUpdate(int TipoContratoID, string TipoContrato, bool IsDefault, bool ContinueOnTime, bool InteresDiario, bool MoraDiaria, bool CanMinimumPay, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeContractDefault(Usuario);
                }
                db = new DAL.Context();
                var row = db.clsTipoContratosBE.Where(x => x.TipoContratoID == TipoContratoID).FirstOrDefault();
                row.TipoContrato = TipoContrato;
                row.IsDefault = IsDefault;
                row.ContinueOnTime = ContinueOnTime;
                row.InteresDiario = InteresDiario;
                row.MoraDiaria = MoraDiaria;
                row.CanMinimumPay = CanMinimumPay;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TipoContratosDelete(int TipoContratoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoContratosBE.Where(x => x.TipoContratoID == TipoContratoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsTipoContratosBE> TipoContratosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoContratosBE.Where(x => x.TipoContrato.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsTipoContratosBE.ToList();
                }
            }
            catch
            {
                return new List<clsTipoContratosBE>();
            }
        }

        #endregion

        #region Tipo Referencias

        public OperationResult TipoReferenciasCreate(string TipoReferencia, bool IsDefault, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    TipoReferenciasDefault(Usuario);
                }
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsTipoReferenciasBE.Count() == 0 ? 100000 : db.clsTipoReferenciasBE.Max(x => x.TipoReferenciaID)) + 1;
                db.clsTipoReferenciasBE.Add(new clsTipoReferenciasBE { TipoReferenciaID = ID, Fecha = DateTime.Now, TipoReferencia = TipoReferencia, IsDefault = IsDefault, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        private bool TipoReferenciasDefault(string Usuario)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoReferenciasBE.Where(x => x.IsDefault == true).FirstOrDefault();
                row.IsDefault = false;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                return true;
            }
            catch { return false; }
        }
        public OperationResult TipoReferenciasUpdate(int TipoReferenciaID, string TipoReferencia, bool IsDefault, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeContractDefault(Usuario);
                }
                db = new DAL.Context();
                var row = db.clsTipoReferenciasBE.Where(x => x.TipoReferenciaID == TipoReferenciaID).FirstOrDefault();
                row.TipoReferencia = TipoReferencia;
                row.IsDefault = IsDefault;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TipoReferenciasDelete(int TipoReferenciaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoReferenciasBE.Where(x => x.TipoReferenciaID == TipoReferenciaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsTipoReferenciasBE> TipoReferenciasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoReferenciasBE.Where(x => x.TipoReferencia.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsTipoReferenciasBE.ToList();
                }
            }
            catch
            {
                return new List<clsTipoReferenciasBE>();
            }
        }

        #endregion

        #region Dependientes

        public OperationResult DependientesCreate(int ParentescoID, string Documento, DateTime FechaNacimiento, string Dependiente, String Telefono, string Usuario)
        {
            OperationResult result;
            try
            {
                int ID = 0;
                db = new DAL.Context();
                ID = (db.clsDependientesBE.Count() == 0 ? 100000 : db.clsDependientesBE.Max(x => x.DependienteID)) + 1;
                db.clsDependientesBE.Add(new clsDependientesBE { ParentescoID = ParentescoID, DependienteID = ID, Fecha = DateTime.Now, FechaNacimiento = FechaNacimiento, Documento = Documento, Dependiente = Dependiente, Telefono = Telefono, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DependientesUpdate(int DependienteID, int ParentescoID, string Documento, DateTime FechaNacimiento, string Dependiente, String Telefono, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDependientesBE.Where(x => x.DependienteID == DependienteID).FirstOrDefault();
                row.ParentescoID = ParentescoID;
                row.Dependiente = Dependiente;
                row.FechaNacimiento = FechaNacimiento;
                row.Telefono = Telefono;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DependientesDeleteGetByDocumento(string Documento)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDependientesBE.Where(x => x.Documento == Documento);
                db.clsDependientesBE.RemoveRange(row);
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DependientesDelete(int DependenciaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDependientesBE.Where(x => x.DependienteID == DependenciaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsDependientesBE> DependientesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsDependientesBE.Where(x => x.Dependiente.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsDependientesBE.ToList();
                }
            }
            catch
            {
                return new List<clsDependientesBE>();
            }
        }

        #endregion

        #region Formas de Pagos

        public OperationResult FormaPagosCreate(string FormaPago, bool IsDefault, int AuxiliarID, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeFormaPagosDefault(Usuario);
                }
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsFormaPagosBE.Count() == 0 ? 100000 : db.clsFormaPagosBE.Max(x => x.FormaPagoID)) + 1;
                db.clsFormaPagosBE.Add(new clsFormaPagosBE { FormaPagoID = ID, Fecha = DateTime.Now, Nombre = FormaPago, IsDefault = IsDefault, AuxiliarID = AuxiliarID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        private bool ChangeFormaPagosDefault(string Usuario)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsFormaPagosBE.Where(x => x.IsDefault == true).FirstOrDefault();
                row.IsDefault = false;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                return true;
            }
            catch { return false; }
        }

        public OperationResult FormaPagosUpdate(int FormaPagoID, string FormaPago, bool IsDefault, int AuxiliarID, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeFormaPagosDefault(Usuario);
                }
                db = new DAL.Context();
                var row = db.clsFormaPagosBE.Where(x => x.FormaPagoID == FormaPagoID).FirstOrDefault();
                row.Nombre = FormaPago;
                row.IsDefault = IsDefault;
                row.AuxiliarID = AuxiliarID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult FormaPagosDelete(int FormaPagoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsFormaPagosBE.Where(x => x.FormaPagoID == FormaPagoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsFormaPagosBE> FormaPagosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsFormaPagosBE.Where(x => x.Nombre.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsFormaPagosBE.ToList();
                }
            }
            catch
            {
                return new List<clsFormaPagosBE>();
            }
        }

        public clsFormaPagosBE FormaPagosGetByAuxiliarID(int AuxiliarID)
        {
            try
            {
                db = new DAL.Context();
                var result = db.clsFormaPagosBE.Where(x => x.AuxiliarID == AuxiliarID).FirstOrDefault();
                return result;
            }
            catch
            {
                return new clsFormaPagosBE();
            }
        }

        #endregion

        #region Comprobantes

        public OperationResult ComprobantesCreate(string Comprobante, int Desde, int Hasta, string Prefijo, int Secuencia, bool IsDefault, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeComprobantesDefault(Usuario);
                }

                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsComprobantesBE.Count() == 0 ? 100000 : db.clsComprobantesBE.Max(x => x.ComprobanteID)) + 1;
                db.clsComprobantesBE.Add(new clsComprobantesBE { ComprobanteID = ID, Fecha = DateTime.Now, Comprobante = Comprobante, Desde = Desde, Hasta = Hasta, Prefijo = Prefijo, Secuencia = Secuencia, IsDefault = IsDefault, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ComprobantesUpdate(int ComprobanteID, string Comprobante, int Desde, int Hasta, string Prefijo, int Secuencia, bool IsDefault, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeComprobantesDefault(Usuario);
                }

                db = new DAL.Context();
                var row = db.clsComprobantesBE.Where(x => x.ComprobanteID == ComprobanteID).FirstOrDefault();
                row.Comprobante = Comprobante;
                row.Desde = Desde;
                row.Hasta = Hasta;
                row.Prefijo = Prefijo;
                row.Secuencia = Secuencia;
                row.IsDefault = IsDefault;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        private bool ChangeComprobantesDefault(string Usuario)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsComprobantesBE.Where(x => x.IsDefault == true).FirstOrDefault();
                row.IsDefault = false;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                return true;
            }
            catch { return false; }
        }

        public OperationResult ComprobantesDelete(int ComprobanteID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsComprobantesBE.Where(x => x.ComprobanteID == ComprobanteID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsComprobantesBE> ComprobantesGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsComprobantesBE.Where(x => x.Comprobante.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsComprobantesBE.ToList();
                }
            }
            catch
            {
                return new List<clsComprobantesBE>();
            }
        }

        #endregion

        #region Colores

        public OperationResult ColoresCreate(string Color, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsColoresBE.Count() == 0 ? 100000 : db.clsColoresBE.Max(x => x.ColorID)) + 1;
                db.clsColoresBE.Add(new clsColoresBE { ColorID = ID, Fecha = DateTime.Now, Color = Color, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ColoresUpdate(int ColorID, string Color, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsColoresBE.Where(x => x.ColorID == ColorID).FirstOrDefault();
                row.Color = Color;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ColoresDelete(int ColorID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsColoresBE.Where(x => x.ColorID == ColorID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsColoresBE> ColoresGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsColoresBE.Where(x => x.Color.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsColoresBE.ToList();
                }
            }
            catch
            {
                return new List<clsColoresBE>();
            }
        }

        #endregion

        #region Rutas

        public OperationResult RutasCreate(string Ruta, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsRutasBE.Count() == 0 ? 100000 : db.clsRutasBE.Max(x => x.RutaID)) + 1;
                db.clsRutasBE.Add(new clsRutasBE { RutaID = ID, Fecha = DateTime.Now, Ruta = Ruta, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult RutasUpdate(int RutaID, string Ruta, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsRutasBE.Where(x => x.RutaID == RutaID).FirstOrDefault();
                row.Ruta = Ruta;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult RutasDelete(int RutaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsRutasBE.Where(x => x.RutaID == RutaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsRutasBE> RutasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsRutasBE.Where(x => x.Ruta.Contains(Search)).OrderBy(x => x.Ruta).ToList();
                }
                else
                {
                    return db.clsRutasBE.ToList();
                }
            }
            catch(Exception ex)
            {
                return new List<clsRutasBE>();
            }
        }

        public List<clsRutasBE> RutasGetByOficialID(int OficialID)
        {
            try
            {
                db = new DAL.Context();
                var result = (from C in db.clsContratosBE join Z in db.clsZonasBE on C.ZonaID equals Z.RutaID join R in db.clsRutasBE on Z.RutaID equals R.RutaID where C.OficialID == OficialID select R).Distinct();
                return result.OrderBy(x => x.Ruta).ToList();
            }
            catch
            {
                return new List<clsRutasBE>();
            }
        }

        #endregion

        #region Zonas

        public OperationResult ZonasCreate(string Zona, int RutaID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsZonasBE.Count() == 0 ? 100000 : db.clsZonasBE.Max(x => x.ZonaID)) + 1;
                db.clsZonasBE.Add(new clsZonasBE { ZonaID = ID, Fecha = DateTime.Now, Zona = Zona, RutaID = RutaID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ZonasUpdate(int ZonaID, string Zona, int RutaID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsZonasBE.Where(x => x.ZonaID == ZonaID).FirstOrDefault();
                row.Zona = Zona;
                row.RutaID = RutaID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ZonasDelete(int ZonaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsZonasBE.Where(x => x.ZonaID == ZonaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsZonasBE> ZonasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsZonasBE.Where(x => x.Zona.ToUpper().Contains(Search.ToUpper()) && x.Rutas.Ruta.ToUpper().Contains(Search.ToUpper())).OrderBy(x => x.Zona).ToList();
                }
                else
                {
                    return db.clsZonasBE.ToList();
                }
            }
            catch
            {
                return new List<clsZonasBE>();
            }
        }

        public List<clsZonasBE> ZonasGetByRutaID(int RutaID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsZonasBE.Where(x => x.RutaID == RutaID).ToList();
            }
            catch
            {
                return new List<clsZonasBE>();
            }
        }

        #endregion

        #region Marcas

        public OperationResult MarcasCreate(string Marca, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsMarcasBE.Count() == 0 ? 100000 : db.clsMarcasBE.Max(x => x.MarcaID)) + 1;
                db.clsMarcasBE.Add(new clsMarcasBE { MarcaID = ID, Fecha = DateTime.Now, Marca = Marca, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult MarcasUpdate(int MarcaID, string Marca, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsMarcasBE.Where(x => x.MarcaID == MarcaID).FirstOrDefault();
                row.Marca = Marca;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult MarcasDelete(int MarcaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsMarcasBE.Where(x => x.MarcaID == MarcaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsMarcasBE> MarcasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsMarcasBE.Where(x => x.Marca.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsMarcasBE.ToList();
                }
            }
            catch
            {
                return new List<clsMarcasBE>();
            }
        }

        #endregion

        #region Modelos

        public OperationResult ModelosCreate(string Modelo, int MarcaID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsModelosBE.Count() == 0 ? 100000 : db.clsModelosBE.Max(x => x.ModeloID)) + 1;
                db.clsModelosBE.Add(new clsModelosBE { ModeloID = ID, Fecha = DateTime.Now, Modelo = Modelo, MarcaID = MarcaID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ModelosUpdate(int ModeloID, string Modelo, int MarcaID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsModelosBE.Where(x => x.ModeloID == ModeloID).FirstOrDefault();
                row.Modelo = Modelo;
                row.MarcaID = MarcaID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ModelosDelete(int ModeloID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsModelosBE.Where(x => x.ModeloID == ModeloID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsModelosBE> ModelosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsModelosBE.Where(x => x.Modelo.Contains(Search) || x.Marcas.Marca.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsModelosBE.ToList();
                }
            }
            catch
            {
                return new List<clsModelosBE>();
            }
        }

        #endregion

        #region TipoVehiculos

        public OperationResult TipoVehiculosCreate(string TipoVehiculo, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsTipoVehiculosBE.Count() == 0 ? 100000 : db.clsTipoVehiculosBE.Max(x => x.TipoVehiculoID)) + 1;
                db.clsTipoVehiculosBE.Add(new clsTipoVehiculosBE { TipoVehiculoID = ID, Fecha = DateTime.Now, TipoVehiculo = TipoVehiculo, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TipoVehiculosUpdate(int TipoVehiculoID, string TipoVehiculo, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoVehiculosBE.Where(x => x.TipoVehiculoID == TipoVehiculoID).FirstOrDefault();
                row.TipoVehiculo = TipoVehiculo;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TipoVehiculosDelete(int TipoVehiculoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoVehiculosBE.Where(x => x.TipoVehiculoID == TipoVehiculoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsTipoVehiculosBE> TipoVehiculosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoVehiculosBE.Where(x => x.TipoVehiculo.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsTipoVehiculosBE.ToList();
                }
            }
            catch
            {
                return new List<clsTipoVehiculosBE>();
            }
        }

        #endregion

        #region Garantia Vehiculos

        public OperationResult GarantiaVehiculosCreate(int SolicitudID, int TipoVehiculoID, int ModeloID, int ColorID, string Chasis, string Placa, string Registro, DateTime FechaExpedicion, int Ano, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaVehiculosBE.Where(x => x.SolicitudID == SolicitudID);
                if (row.Count() == 0)
                {
                    db.clsGarantiaVehiculosBE.Add(new clsGarantiaVehiculosBE { SolicitudID = SolicitudID, Fecha = DateTime.Now, TipoVehiculoID = TipoVehiculoID, ModeloID = ModeloID, ColorID = ColorID, Chasis = Chasis, Placa = Placa, Registro = Registro, FechaExpedicion = FechaExpedicion, Ano = Ano, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                    result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                }
                else
                {
                    result = GarantiaVehiculosUpdate(SolicitudID, TipoVehiculoID, ModeloID, ColorID, Chasis, Placa, Registro, FechaExpedicion, Ano, Usuario);
                }
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult GarantiaVehiculosUpdate(int SolicitudID, int TipoVehiculoID, int ModeloID, int ColorID, string Chasis, string Placa, string Registro, DateTime FechaExpedicion, int Ano, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaVehiculosBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();
                row.TipoVehiculoID = TipoVehiculoID;
                row.ModeloID = ModeloID;
                row.ColorID = ColorID;
                row.Chasis = Chasis;
                row.Placa = Placa;
                row.Registro = Registro;
                row.FechaExpedicion = FechaExpedicion;
                row.Ano = Ano;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult GarantiaVehiculosDelete(int SolicitudID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaVehiculosBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsGarantiaVehiculosBE> GarantiaVehiculosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsGarantiaVehiculosBE.Where(x => x.Colores.Color.Contains(Search) || x.Modelos.Modelo.Contains(Search) || x.TipoVehiculos.TipoVehiculo.Contains(Search) || x.Chasis.Contains(Search) || x.Placa.Contains(Search) || x.Registro.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsGarantiaVehiculosBE.ToList();
                }
            }
            catch
            {
                return new List<clsGarantiaVehiculosBE>();
            }
        }

        #endregion

        #region Garantia Personal

        public OperationResult GarantiaPersonalCreate(int SolicitudID, string Documento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaPersonalBE.Where(x => x.SolicitudID == SolicitudID);
                if (row.Count() == 0)
                {
                    var g = db.clsGarantesBE.Where(x => x.Documento == Documento);
                    if (g.Count() == 0)
                    {
                        db.clsGarantesBE.Add(new clsGarantesBE { Documento = Documento, Fecha = DateTime.Now, Estado = true, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                        db.SaveChanges();
                    }
                    db.clsGarantiaPersonalBE.Add(new clsGarantiaPersonalBE { SolicitudID = SolicitudID, Fecha = DateTime.Now, Documento = Documento, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                    result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                }
                else
                {
                    result = GarantiaPersonalUpdate(SolicitudID, Documento, Usuario);
                }
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public OperationResult GarantiaPersonalUpdate(int SolicitudID, string Documento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaPersonalBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();
                row.Documento = Documento;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult GarantiaPersonalDelete(int SolicitudID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaPersonalBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsGarantiaPersonalBE> GarantiaPersonalGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsGarantiaPersonalBE.Where(x => x.Garantes.Personas.Nombres.Contains(Search) || x.Garantes.Personas.Apellidos.Contains(Search) || x.Documento.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsGarantiaPersonalBE.ToList();
                }
            }
            catch
            {
                return new List<clsGarantiaPersonalBE>();
            }
        }

        #endregion

        #region Garantia Hipotecaria

        public OperationResult GarantiaHipotecariaCreate(int SolicitudID, string Descripcion, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaHipotecariaBE.Where(x => x.SolicitudID == SolicitudID);
                if (row.Count() == 0)
                {
                    db.clsGarantiaHipotecariaBE.Add(new clsGarantiaHipotecariaBE { SolicitudID = SolicitudID, Fecha = DateTime.Now, Descripcion = Descripcion, Monto = Monto, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                    result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                }
                else
                {
                    result = GarantiaHipotecariaUpdate(SolicitudID, Descripcion, Monto, Usuario);
                }
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public OperationResult GarantiaHipotecariaUpdate(int SolicitudID, string Descripcion, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaHipotecariaBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();
                row.Descripcion = Descripcion;
                row.Monto = Monto;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult GarantiaHipotecariaDelete(int SolicitudID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaHipotecariaBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsGarantiaHipotecariaBE> GarantiaHipotecariaGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsGarantiaHipotecariaBE.Where(x => x.Descripcion.Contains(Search) || x.Monto.ToString().Contains(Search)).ToList();
                }
                else
                {
                    return db.clsGarantiaHipotecariaBE.ToList();
                }
            }
            catch
            {
                return new List<clsGarantiaHipotecariaBE>();
            }
        }

        #endregion

        #region Garantia Tarjetas

        public OperationResult GarantiaTarjetasCreate(int SolicitudID, string Holder, string Numero, int Mes, int Ano, int Cvv, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaTarjetasBE.Where(x => x.SolicitudID == SolicitudID);
                if (row.Count() == 0)
                {
                    db.clsGarantiaTarjetasBE.Add(new clsGarantiaTarjetasBE { SolicitudID = SolicitudID, Fecha = DateTime.Now, Holder = Holder, Numero = Numero, Mes = Mes, Ano = Ano, Cvv = Cvv, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                    result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                }
                else
                {
                    result = GarantiaTarjetasUpdate(SolicitudID, Holder, Numero, Mes, Ano, Cvv, Usuario);
                }
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public OperationResult GarantiaTarjetasUpdate(int SolicitudID, string Holder, string Numero, int Mes, int Ano, int Cvv, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaTarjetasBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();
                row.Holder = Holder;
                row.Numero = Numero;
                row.Mes = Mes;
                row.Ano = Ano;
                row.Cvv = Cvv;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult GarantiaTarjetasDelete(int SolicitudID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaTarjetasBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsGarantiaTarjetasBE> GarantiaTarjetaGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsGarantiaTarjetasBE.Where(x => x.Holder.ToUpper().Contains(Search.ToUpper()) || x.Numero.ToString().Contains(Search)).ToList();
                }
                else
                {
                    return db.clsGarantiaTarjetasBE.ToList();
                }
            }
            catch
            {
                return new List<clsGarantiaTarjetasBE>();
            }
        }

        #endregion

        #region Garantia Comercial

        public OperationResult GarantiaComercialesCreate(int SolicitudID, string Rnc, string Comercio, string Direccion, string Telefono, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaComercialesBE.Where(x => x.SolicitudID == SolicitudID);
                if (row.Count() == 0)
                {
                    var g = db.clsComerciosBE.Where(x => x.Rnc == Rnc);
                    if (g.Count() == 0)
                    {
                        ComerciosCreate(Rnc, Comercio, Direccion, Telefono, Usuario);
                    }
                    else
                    {
                        ComerciosUpdate(Rnc, Comercio, Direccion, Telefono, Usuario);
                    }
                    db.clsGarantiaComercialesBE.Add(new clsGarantiaComercialesBE { SolicitudID = SolicitudID, Fecha = DateTime.Now, Rnc = Rnc, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                    result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                }
                else
                {
                    result = GarantiaComercialesUpdate(SolicitudID, Rnc, Usuario);
                    ComerciosUpdate(Rnc, Comercio, Direccion, Telefono, Usuario);
                }
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public OperationResult GarantiaComercialesUpdate(int SolicitudID, string Rnc, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaComercialesBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();
                row.Rnc = Rnc;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult GarantiaComercialesDelete(int SolicitudID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaComercialesBE.Where(x => x.SolicitudID == SolicitudID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }



        #endregion

        #region Comercios

        public OperationResult ComerciosCreate(string Rnc, string Comercio, string Direccion, string Telefono, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                db.clsComerciosBE.Add(new clsComerciosBE { Rnc = Rnc, Fecha = DateTime.Now, Comercio = Comercio, Direccion = Direccion, Telefono = Telefono, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ComerciosUpdate(string Rnc, string Comercio, string Direccion, string Telefono, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsComerciosBE.Where(x => x.Rnc == Rnc).FirstOrDefault();
                row.Comercio = Comercio;
                row.Direccion = Direccion;
                row.Telefono = Telefono;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ComerciosDelete(string Rnc)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsComerciosBE.Where(x => x.Rnc == Rnc).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsComerciosBE> ComerciosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsComerciosBE.Where(x => x.Comercio.Contains(Search)).OrderBy(x => x.Comercio).ToList();
                }
                else
                {
                    return db.clsComerciosBE.ToList();
                }
            }
            catch (Exception ex)
            {
                return new List<clsComerciosBE>();
            }
        }

        public clsComerciosBE ComerciosGetByRnc(string Rnc)
        {
            try
            {
                db = new DAL.Context();
                string _rnc = Rnc.Replace("-", "");
                var result  = db.clsComerciosBE.Where(x => x.Rnc.Replace("-", "") == _rnc);
                if (result.Count() == 0)
                {
                    DGII.Manager dgii = new DGII.Manager();
                    var response = dgii.ConsultarRnc(_rnc);
                    if (response.Success)
                    {
                        return new clsComerciosBE { Rnc = response.Rnc, Comercio = response.Empresa, Direccion = response.Direccion };
                    }
                    else
                    {
                        return new clsComerciosBE();
                    }
                }

                return result.FirstOrDefault();
            }
            catch (Exception ex)
            {
                return new clsComerciosBE();
            }
        }


        #endregion

        #region Monedas

        public List<clsMonedasBE> MonedasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsMonedasBE.Where(x => x.Moneda.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsMonedasBE.ToList();
                }
            }
            catch
            {
                return new List<clsMonedasBE>();
            }
        }

        public List<clsMonedasBE> MonedasGetNotTask(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsMonedasBE.Where(x => x.Moneda.Contains(Search)).ToList();
                }
                else
                {
                    var a = from tt in db.clsMonedasBE join t in db.clsMonedasBE on tt.MonedaID equals t.MonedaID select tt;
                    var result = db.clsMonedasBE.Except(a).ToList();
                    return result;
                }
            }
            catch
            {
                return new List<clsMonedasBE>();
            }
        }

        #endregion

        #region Tipo Certificados

        public OperationResult TipoCertificadosCreate(string TipoCertificado, string Usuario)
        {
            OperationResult result;
            try
            {

                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsTipoCertificadosBE.Count() == 0 ? 100000 : db.clsTipoCertificadosBE.Max(x => x.TipoCertificadoID)) + 1;
                db.clsTipoCertificadosBE.Add(new clsTipoCertificadosBE { TipoCertificadoID = ID, Fecha = DateTime.Now, TipoCertificado = TipoCertificado, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public OperationResult TipoCertificadosUpdate(int TipoCertificadoID, string TipoCertificado, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoCertificadosBE.Where(x => x.TipoCertificadoID == TipoCertificadoID).FirstOrDefault();
                row.TipoCertificado = TipoCertificado;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TipoCertificadosDelete(int TipoCertificadoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoCertificadosBE.Where(x => x.TipoCertificadoID == TipoCertificadoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsTipoCertificadosBE> TipoCertificadosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoCertificadosBE.Where(x => x.TipoCertificado.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsTipoCertificadosBE.ToList();
                }
            }
            catch
            {
                return new List<clsTipoCertificadosBE>();
            }
        }

        #endregion

        #region Puestos

        public OperationResult PuestosCreate(string Puesto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsPuestosBE.Count() == 0 ? 100000 : db.clsPuestosBE.Max(x => x.PuestoID)) + 1;
                db.clsPuestosBE.Add(new clsPuestosBE { PuestoID = ID, Fecha = DateTime.Now, Puesto = Puesto, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PuestosUpdate(int PuestoID, string Puesto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsPuestosBE.Where(x => x.PuestoID == PuestoID).FirstOrDefault();
                row.Puesto = Puesto;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PuestosDelete(int PuestoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsPuestosBE.Where(x => x.PuestoID == PuestoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsPuestosBE> PuestosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsPuestosBE.Where(x => x.Puesto.Contains(Search)).OrderBy(x => x.Puesto).ToList();
                }
                else
                {
                    return db.clsPuestosBE.ToList();
                }
            }
            catch
            {
                return new List<clsPuestosBE>();
            }
        }

        #endregion

        #endregion

        #region Contabilidad

        #region Grupos

        public OperationResult GruposCreate(string Grupo, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsGruposBE.Count() == 0 ? 100000 : db.clsGruposBE.Max(x => x.GrupoID)) + 1;
                db.clsGruposBE.Add(new clsGruposBE { GrupoID = ID, Fecha = DateTime.Now, Grupo = Grupo, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult GruposUpdate(int GrupoID, string Grupo, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGruposBE.Where(x => x.GrupoID == GrupoID).FirstOrDefault();
                row.Grupo = Grupo;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult GruposDelete(int GrupoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGruposBE.Where(x => x.GrupoID == GrupoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsGruposBE> GruposGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsGruposBE.Where(x => x.Grupo.Contains(Search)).OrderBy(x => x.Grupo).ToList();
                }
                else
                {
                    return db.clsGruposBE.ToList();
                }
            }
            catch
            {
                return new List<clsGruposBE>();
            }
        }

        #endregion

        #region SubGrupos

        public OperationResult SubGruposCreate(string Codigo, string SubGrupo, int GrupoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsSubGruposBE.Count() == 0 ? 100000 : db.clsSubGruposBE.Max(x => x.SubGrupoID)) + 1;
                db.clsSubGruposBE.Add(new clsSubGruposBE { SubGrupoID = ID, Fecha = DateTime.Now, Codigo = Codigo, SubGrupo = SubGrupo, GrupoID = GrupoID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult SubGruposUpdate(int SubGrupoID, string Codigo, string SubGrupo, int GrupoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsSubGruposBE.Where(x => x.SubGrupoID == SubGrupoID).FirstOrDefault();
                row.Codigo = Codigo;
                row.SubGrupo = SubGrupo;
                row.GrupoID = GrupoID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult SubGruposDelete(int SubGrupoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsSubGruposBE.Where(x => x.SubGrupoID == SubGrupoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsSubGruposBE> SubGruposGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsSubGruposBE.Where(x => x.SubGrupo.Contains(Search) || x.Codigo.Contains(Search) || x.Grupos.Grupo.Contains(Search)).OrderBy(x => x.SubGrupo).ToList();
                }
                else
                {
                    return db.clsSubGruposBE.ToList();
                }
            }
            catch
            {
                return new List<clsSubGruposBE>();
            }
        }

        public List<clsSubGruposBE> SubGruposGetByGrupoID(int GrupoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsSubGruposBE.Where(x => x.GrupoID == GrupoID).ToList();
            }
            catch
            {
                return new List<clsSubGruposBE>();
            }
        }

        #endregion

        #region CuentasControl

        public OperationResult CuentaControlCreate(string Codigo, string CuentaControl, int SubGrupoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsCuentaControlBE.Count() == 0 ? 100000 : db.clsCuentaControlBE.Max(x => x.CuentaControlID)) + 1;
                db.clsCuentaControlBE.Add(new clsCuentaControlBE { CuentaControlID = ID, Fecha = DateTime.Now, Codigo = Codigo, Nombre = CuentaControl, SubGrupoID = SubGrupoID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult CuentaControlUpdate(int CuentaControlID, string Codigo, string CuentaControl, int SubGrupoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCuentaControlBE.Where(x => x.CuentaControlID == CuentaControlID).FirstOrDefault();
                row.Codigo = Codigo;
                row.Nombre = CuentaControl;
                row.SubGrupoID = SubGrupoID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult CuentaControlDelete(int CuentaControlID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsCuentaControlBE.Where(x => x.CuentaControlID == CuentaControlID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsCuentaControlBE> CuentaControlGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsCuentaControlBE.Where(x => x.Nombre.Contains(Search) || x.Codigo.Contains(Search) || x.SubGrupos.SubGrupo.Contains(Search)).OrderBy(x => x.Nombre).ToList();
                }
                else
                {
                    return db.clsCuentaControlBE.ToList();
                }
            }
            catch
            {
                return new List<clsCuentaControlBE>();
            }
        }

        public List<clsCuentaControlBE> CuentaControlGetBySubGrupoID(int SubGrupoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsCuentaControlBE.Where(x => x.SubGrupoID == SubGrupoID).ToList();
            }
            catch
            {
                return new List<clsCuentaControlBE>();
            }
        }

        #endregion

        #region SubCuentaControl

        public OperationResult SubCuentaControlCreate(string Codigo, string SubCuentaControl, int CuentaControlID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsSubCuentaControlBE.Count() == 0 ? 100000 : db.clsSubCuentaControlBE.Max(x => x.SubCuentaControlID)) + 1;
                db.clsSubCuentaControlBE.Add(new clsSubCuentaControlBE { SubCuentaControlID = ID, Fecha = DateTime.Now, Codigo = Codigo, Nombre = SubCuentaControl, CuentaControlID = CuentaControlID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult SubCuentaControlUpdate(int SubCuentaControlID, string Codigo, string SubCuentaControl, int CuentaControlID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsSubCuentaControlBE.Where(x => x.SubCuentaControlID == SubCuentaControlID).FirstOrDefault();
                row.Codigo = Codigo;
                row.Nombre = SubCuentaControl;
                row.CuentaControlID = CuentaControlID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult SubCuentaControlDelete(int SubCuentaControlID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsSubCuentaControlBE.Where(x => x.SubCuentaControlID == SubCuentaControlID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsSubCuentaControlBE> SubCuentaControlGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsSubCuentaControlBE.Where(x => x.Nombre.Contains(Search) || x.Codigo.Contains(Search) || x.CuentaControl.Nombre.Contains(Search)).OrderBy(x => x.Nombre).ToList();
                }
                else
                {
                    return db.clsSubCuentaControlBE.ToList();
                }
            }
            catch
            {
                return new List<clsSubCuentaControlBE>();
            }
        }

        public List<clsSubCuentaControlBE> SubCuentaControlGetByCuentaControlID(int CuentaControlID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsSubCuentaControlBE.Where(x => x.CuentaControlID == CuentaControlID).ToList();
            }
            catch
            {
                return new List<clsSubCuentaControlBE>();
            }
        }

        #endregion

        #region Auxiliares

        public OperationResult AuxiliaresCreate(string Codigo, string Auxiliar, int SubCuentaControlID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsAuxiliaresBE.Count() == 0 ? 100000 : db.clsAuxiliaresBE.Max(x => x.AuxiliarID)) + 1;
                db.clsAuxiliaresBE.Add(new clsAuxiliaresBE { AuxiliarID = ID, Fecha = DateTime.Now, Codigo = Codigo, Auxiliar = Auxiliar, SubCuentaControlID = SubCuentaControlID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult AuxiliaresUpdate(int AuxiliarID, string Codigo, string Auxiliar, int SubCuentaControlID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsAuxiliaresBE.Where(x => x.AuxiliarID == AuxiliarID).FirstOrDefault();
                row.Codigo = Codigo;
                row.Auxiliar = Auxiliar;
                row.SubCuentaControlID = SubCuentaControlID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult AuxiliaresDelete(int AuxiliarID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsAuxiliaresBE.Where(x => x.AuxiliarID == AuxiliarID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsAuxiliaresBE> AuxiliaresGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    Search = Search.ToUpper();
                    return db.clsAuxiliaresBE.Where(x => x.Auxiliar.ToUpper().Contains(Search) || x.Codigo.ToUpper().Contains(Search) || x.SubCuentaControl.Codigo.ToUpper().Contains(Search) || x.SubCuentaControl.Nombre.ToUpper().Contains(Search) || x.SubCuentaControl.CuentaControl.Codigo.ToUpper().Contains(Search) || x.SubCuentaControl.CuentaControl.Nombre.ToUpper().Contains(Search)).ToList();
                }
                else
                {
                    return db.clsAuxiliaresBE.ToList();
                }
            }
            catch
            {
                return new List<clsAuxiliaresBE>();
            }
        }

        public List<clsAuxiliaresBE> AuxiliaresGetBySubCuentaControlID(int SubCuentaControlID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsAuxiliaresBE.Where(x => x.SubCuentaControlID == SubCuentaControlID).OrderBy(x => x.Auxiliar).ToList();
            }
            catch
            {
                return new List<clsAuxiliaresBE>();
            }
        }

        public clsAuxiliaresBE AuxiliaresGetByAuxilarID(int AuxiliarID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsAuxiliaresBE.Where(x => x.AuxiliarID == AuxiliarID).FirstOrDefault();
            }
            catch
            {
                return new clsAuxiliaresBE();
            }
        }

        #endregion

        #region Tipo Movimientos

        public OperationResult TipoMovimientosCreate(string TipoMovimiento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsTipoMovimientosBE.Count() == 0 ? 100000 : db.clsTipoMovimientosBE.Max(x => x.TipoMovimientoID)) + 1;
                db.clsTipoMovimientosBE.Add(new clsTipoMovimientosBE { TipoMovimientoID = ID, Fecha = DateTime.Now, Movimiento = TipoMovimiento, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TipoMovimientosUpdate(int TipoMovimientoID, string TipoMovimiento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoMovimientosBE.Where(x => x.TipoMovimientoID == TipoMovimientoID).FirstOrDefault();
                row.Movimiento = TipoMovimiento;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TipoMovimientosDelete(int TipoMovimientoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoMovimientosBE.Where(x => x.TipoMovimientoID == TipoMovimientoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsTipoMovimientosBE> TipoMovimientosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoMovimientosBE.Where(x => x.Movimiento.Contains(Search) && x.TipoMovimientoID > 0).ToList();
                }
                else
                {
                    return db.clsTipoMovimientosBE.Where(x => x.TipoMovimientoID >= 0).ToList();
                }
            }
            catch
            {
                return new List<clsTipoMovimientosBE>();
            }
        }

        #endregion

        #region Bancos

        public OperationResult BancosCreate(string Banco, int AuxiliarID, int SucursalID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsBancosBE.Count() == 0 ? 100000 : db.clsBancosBE.Max(x => x.BancoID)) + 1;
                db.clsBancosBE.Add(new clsBancosBE { BancoID = ID, Fecha = DateTime.Now, Banco = Banco, AuxiliarID = AuxiliarID, SucursalID = SucursalID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult BancosUpdate(int BancoID, string Banco, int AuxiliarID, int SucursalID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsBancosBE.Where(x => x.BancoID == BancoID).FirstOrDefault();
                row.Banco = Banco;
                row.AuxiliarID = AuxiliarID;
                row.SucursalID = SucursalID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult BancosDelete(int BancoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsBancosBE.Where(x => x.BancoID == BancoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsBancosBE> BancosGet(string Search, string Documento)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();
                if (row.Roles.ViewAllBank == true)
                {
                    if (!string.IsNullOrEmpty(Search))
                    {
                        return db.clsBancosBE.Where(x => x.Banco.Contains(Search)).ToList();
                    }
                    else
                    {
                        return db.clsBancosBE.ToList();
                    }
                }
                else
                {
                    if (!string.IsNullOrEmpty(Search))
                    {
                        return db.clsBancosBE.Where(x => x.SucursalID == row.SucursalID && x.Banco.Contains(Search)).ToList();
                    }
                    else
                    {
                        return db.clsBancosBE.Where(x => x.SucursalID == row.SucursalID).ToList();
                    }
                }
            }
            catch
            {
                return new List<clsBancosBE>();
            }
        }

        #endregion

        #region SolicitudCheques

        public OperationResult SolicitudChequesCreate(DateTime Fecha, int? ContratoID, int BancoID, string Beneficiario, string Concepto, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsSolicitudChequesBE.Count() == 0 ? 100000 : db.clsSolicitudChequesBE.Max(x => x.SolicitudChequeID)) + 1;
                if (ContratoID > 0)
                {
                    db.clsSolicitudChequesBE.Add(new clsSolicitudChequesBE { SolicitudChequeID = ID, Fecha = Fecha, ContratoID = ContratoID, BancoID = BancoID, Beneficiario = Beneficiario, Concepto = Concepto, Monto = Monto, EstadoID = 1, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                }
                else
                {
                    db.clsSolicitudChequesBE.Add(new clsSolicitudChequesBE { SolicitudChequeID = ID, Fecha = Fecha, BancoID = BancoID, Beneficiario = Beneficiario, Concepto = Concepto, Monto = Monto, EstadoID = 1, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                }
                db.SaveChanges();

                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult SolicitudChequesUpdate(int SolicitudChequeID, DateTime Fecha, int? ContratoID, int BancoID, string Beneficiario, string Concepto, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsSolicitudChequesBE.Where(x => x.SolicitudChequeID == SolicitudChequeID).FirstOrDefault();
                row.BancoID = BancoID;
                if (ContratoID > 0)
                {
                    row.ContratoID = ContratoID;
                }
                row.Beneficiario = Beneficiario;
                row.Concepto = Concepto;
                row.Monto = Monto;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult SolicitudChequesDelete(int SolicitudChequeID, int EstadoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsSolicitudChequesBE.Where(x => x.SolicitudChequeID == SolicitudChequeID).FirstOrDefault();
                row.EstadoID = EstadoID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsSolicitudChequesBE> SolicitudChequesGet(string Search, int EstadoID, string Documento)
        {
            try
            {
                db = new DAL.Context();

                var row = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();
                if (row.Roles.ViewAllApplicationCheck == true)
                {
                    if (!string.IsNullOrEmpty(Search))
                    {
                        return db.clsSolicitudChequesBE.Where(x => x.EstadoID == EstadoID && x.Beneficiario.Contains(Search) || x.Concepto.Contains(Search) || x.Monto.ToString().Contains(Search)).ToList();
                    }
                    else
                    {
                        return db.clsSolicitudChequesBE.Where(x => x.EstadoID == EstadoID).ToList();
                    }
                }
                else
                {
                    if (!string.IsNullOrEmpty(Search))
                    {
                        return db.clsSolicitudChequesBE.Where(x => x.EstadoID == EstadoID && x.Bancos.SucursalID == row.SucursalID && x.Beneficiario.Contains(Search) || x.Concepto.Contains(Search) || x.Monto.ToString().Contains(Search)).ToList();
                    }
                    else
                    {
                        return db.clsSolicitudChequesBE.Where(x => x.EstadoID == EstadoID && x.Bancos.SucursalID == row.SucursalID).ToList();
                    }
                }
            }
            catch
            {
                return new List<clsSolicitudChequesBE>();
            }
        }

        public clsSolicitudChequesBE SolicitudChequesGetBySolicitudChequeID(int SolicitudChequeID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsSolicitudChequesBE.Where(x => x.SolicitudChequeID == SolicitudChequeID).FirstOrDefault();
            }
            catch
            {
                return new clsSolicitudChequesBE();
            }
        }

        #endregion

        #region DetalleSolicitudCheques

        public OperationResult DetalleSolicitudChequesCreate(int SolicitudChequeID, int AuxiliarID, float Debito, float Credito, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsDetalleSolicitudChequesBE.Count() == 0 ? 100000 : db.clsDetalleSolicitudChequesBE.Max(x => x.DetalleSolicitudChequeID)) + 1;

                db.clsDetalleSolicitudChequesBE.Add(new clsDetalleSolicitudChequesBE { DetalleSolicitudChequeID = ID, SolicitudChequeID = SolicitudChequeID, AuxiliarID = AuxiliarID, Debito = Debito, Credito = Credito, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DetalleSolicitudChequesUpdate(int DetalleSolicitudChequeID, int SolicitudChequeID, int AuxiliarID, float Debito, float Credito, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleSolicitudChequesBE.Where(x => x.DetalleSolicitudChequeID == DetalleSolicitudChequeID).FirstOrDefault();
                row.AuxiliarID = AuxiliarID;
                row.Debito = Debito;
                row.Credito = Credito;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DetalleSolicitudChequesDelete(int SolicitudChequeID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleSolicitudChequesBE.Where(x => x.SolicitudChequeID == SolicitudChequeID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsDetalleSolicitudChequesBE> DetalleSolicitudChequesGetSolicitudChequeID(int SolicituChequeID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetalleSolicitudChequesBE.Where(x => x.SolicitudChequeID == SolicituChequeID).ToList();
            }
            catch
            {
                return new List<clsDetalleSolicitudChequesBE>();
            }
        }

        #endregion

        #region Entradas

        public OperationResult EntradasCreate(DateTime Fecha, int TipoMovimientoID, int SucursalID, string Referencia, string Concepto, float Debito, float Credito, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsEntradasBE.Count() == 0 ? 100000 : db.clsEntradasBE.Max(x => x.EntradaID)) + 1;
                db.clsEntradasBE.Add(new clsEntradasBE { EntradaID = ID, Fecha = Fecha, TipoMovimientoID = TipoMovimientoID, Referencia = Referencia, Concepto = Concepto, SucursalID = SucursalID, Debito = Debito, Credito = Credito, EstadoID = true, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult EntradasUpdate(int EntradaID, DateTime Fecha, int TipoMovimientoID, int SucursalID, string Referencia, string Concepto, float Debito, float Credito, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsEntradasBE.Where(x => x.EntradaID == EntradaID).FirstOrDefault();
                row.Fecha = Fecha;
                row.Concepto = Concepto;
                row.Credito = Credito;
                row.Debito = Debito;
                row.Referencia = Referencia;
                row.SucursalID = SucursalID;
                row.TipoMovimientoID = TipoMovimientoID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = EntradaID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult EntradasDelete(int EntradaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsEntradasBE.Where(x => x.EntradaID == EntradaID).FirstOrDefault();
                row.EstadoID = false;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsEntradasBE> EntradasGet(DateTime Desde, DateTime Hasta, string Search, string Documento)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                List<clsEntradasBE> result = new List<clsEntradasBE>();
                List<clsEntradasBE> BE = new List<clsEntradasBE>();
                List<clsEntradasBE> _be = new List<clsEntradasBE>();

                var row = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();
                if (row.Roles.ViewAllAccountting == true)
                {
                    BE = db.clsEntradasBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta).ToList();
                }
                else
                {
                    BE = db.clsEntradasBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.SucursalID == row.SucursalID).ToList();
                }

                if (!string.IsNullOrEmpty(Search))
                {
                    Search = Search.ToUpper();
                    result = BE.Where(x => x.EntradaID.ToString().Contains(Search) || x.Referencia.ToUpper().Contains(Search) || x.Concepto.ToUpper().Contains(Search) || x.Debito.ToString().ToUpper().Contains(Search) || x.Credito.ToString().ToString().Contains(Search) || x.TipoMovimientos.Movimiento.ToUpper().Contains(Search)).ToList();
                }
                else
                {
                    result = BE.ToList();
                }

                return result;
            }
            catch
            {
                return new List<clsEntradasBE>();
            }
        }

        #endregion

        #region DetalleEntradas

        public OperationResult DetalleEntradasCreate(int EntradaID, int AuxiliarID, int TipoEntradaID, int Numero, float Debito, float Credito, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsDetalleEntradasBE.Count() == 0 ? 100000 : db.clsDetalleEntradasBE.Max(x => x.DetalleEntradaID)) + 1;
                db.clsDetalleEntradasBE.Add(new clsDetalleEntradasBE { DetalleEntradaID = ID, AuxiliarID = AuxiliarID, EntradaID = EntradaID, Numero = Numero, TipoEntradaID = TipoEntradaID, Debito = Debito, Credito = Credito, EstadoID = true, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DetalleEntradasUpdate(int DetalleEntradaID, int EntradaID, int AuxiliarID, int TipoEntradaID, int Numero, float Debito, float Credito, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleEntradasBE.Where(x => x.DetalleEntradaID == DetalleEntradaID).FirstOrDefault();
                row.EntradaID = EntradaID;
                row.AuxiliarID = AuxiliarID;
                row.Credito = Credito;
                row.Debito = Debito;
                row.Numero = Numero;
                row.TipoEntradaID = TipoEntradaID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }


        public OperationResult DetalleEntradasDelete(int EntradaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleEntradasBE.Where(x => x.EntradaID == EntradaID).ToList();
                foreach (var r in row)
                {
                    db.Entry(r).State = EntityState.Deleted;
                }
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsDetalleEntradasBE> DetalleEntradasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    //return db.clsDetalleEntradasBE.Where(x => x.DetalleEntrada.Contains(Search)).ToList();
                    return db.clsDetalleEntradasBE.ToList();
                }
                else
                {
                    return db.clsDetalleEntradasBE.ToList();
                }
            }
            catch
            {
                return new List<clsDetalleEntradasBE>();
            }
        }

        public List<clsDetalleEntradasBE> DetalleEntradasGetByAuxiliarID(int AuxiliarID)
        {
            try
            {
                db = new DAL.Context();
                var result = db.clsDetalleEntradasBE.Where(x => x.AuxiliarID == AuxiliarID && x.Entradas.EstadoID == true).ToList();
                return result;
            }
            catch
            {
                return new List<clsDetalleEntradasBE>();
            }
        }

        public List<clsDetalleEntradasBE> DetalleEntradasGetByEntradaID(int EntradaID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetalleEntradasBE.Where(x => x.EntradaID == EntradaID).ToList();
            }
            catch
            {
                return new List<clsDetalleEntradasBE>();
            }
        }

        #endregion

        #region Desembolsos

        public OperationResult DesembolsosCreate(DateTime Fecha, int SucursalID, string Beneficiario, string Concepto, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsDesembolsosBE.Count() == 0 ? 100000 : db.clsDesembolsosBE.Max(x => x.DesembolsoID)) + 1;

                db.clsDesembolsosBE.Add(new clsDesembolsosBE { DesembolsoID = ID, Fecha = Fecha, SucursalID = SucursalID, Beneficiario = Beneficiario, Concepto = Concepto, Monto = Monto, EstadoID = true, Usuario = Usuario, Contabilizado = false, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();

                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DesembolsosUpdate(int DesembolsoID, DateTime Fecha, int SucursalID, string Beneficiario, string Concepto, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDesembolsosBE.Where(x => x.DesembolsoID == DesembolsoID).FirstOrDefault();
                row.SucursalID = SucursalID;

                row.Beneficiario = Beneficiario;
                row.Concepto = Concepto;
                row.Monto = Monto;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DesembolsosDelete(int DesembolsoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDesembolsosBE.Where(x => x.DesembolsoID == DesembolsoID).FirstOrDefault();
                row.EstadoID = false;
                row.Contabilizado = false;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsDesembolsosBE> DesembolsosGet(DateTime Desde, DateTime Hasta, string Search, string Documento)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                List<clsDesembolsosBE> BE = new List<clsDesembolsosBE>();
                Search = Search.ToUpper();
                var row = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();
                if (row.Roles.ViewAllExpenditure == true)
                {
                    BE = db.clsDesembolsosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta).ToList();
                }
                else
                {
                    BE = db.clsDesembolsosBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.SucursalID == row.SucursalID).ToList();
                }

                if (!string.IsNullOrEmpty(Search))
                {
                    return BE.Where(x => x.Beneficiario.ToUpper().Contains(Search) || x.Concepto.ToUpper().Contains(Search) || x.Monto.ToString().Contains(Search)).ToList();
                }
                else
                {
                    return BE;
                }
            }
            catch
            {
                return new List<clsDesembolsosBE>();
            }
        }

        public clsDesembolsosBE DesembolsosGetByDesembolsoID(int DesembolsoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsDesembolsosBE.Where(x => x.DesembolsoID == DesembolsoID).FirstOrDefault();
            }
            catch
            {
                return new clsDesembolsosBE();
            }
        }

        #endregion

        #region DetalleDesembolsos

        public OperationResult DetalleDesembolsosCreate(int DesembolsoID, int AuxiliarID, float Debito, float Credito, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsDetalleDesembolsosBE.Count() == 0 ? 100000 : db.clsDetalleDesembolsosBE.Max(x => x.DetalleDesembolsoID)) + 1;

                db.clsDetalleDesembolsosBE.Add(new clsDetalleDesembolsosBE { DetalleDesembolsoID = ID, DesembolsoID = DesembolsoID, AuxiliarID = AuxiliarID, Debito = Debito, Credito = Credito, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DetalleDesembolsosUpdate(int DetalleDesembolsoID, int DesembolsoID, int AuxiliarID, float Debito, float Credito, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleDesembolsosBE.Where(x => x.DetalleDesembolsoID == DetalleDesembolsoID).FirstOrDefault();
                row.AuxiliarID = AuxiliarID;
                row.Debito = Debito;
                row.Credito = Credito;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult DetalleDesembolsosDelete(int DesembolsoID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleDesembolsosBE.Where(x => x.DesembolsoID == DesembolsoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsDetalleDesembolsosBE> DetalleDesembolsosGetDesembolsoID(int SolicituChequeID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetalleDesembolsosBE.Where(x => x.DesembolsoID == SolicituChequeID).ToList();
            }
            catch
            {
                return new List<clsDetalleDesembolsosBE>();
            }
        }

        #endregion

        #endregion

        #region Informes

        public DataSet PrintCatalogo(int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                DataSet ds = new DataSet();

                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //Empresas
                cn.Open();
                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT Empresa, Direccion, Telefonos, Rnc, Sucursal from Empresas as E inner join Sucursales as S on S.EmpresaID = E.empresaID Where S.SucursalID=@SucursalID;";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Empresas");
                cn.Close();

                //Auxiliares
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT Concat(Grupos.Codigo, ' - ',  Grupos.Grupo) as Grupo, Concat(SubGrupos.Codigo, ' - ', SubGrupos.SubGrupo) as SubGrupo, Concat(CuentasControl.Codigo, ' - ', CuentasControl.Nombre) AS CuentaControl, Concat(SubCuentaControl.Codigo, ' - ', SubCuentaControl.Nombre) AS SubCuentaControl, Auxiliares.Codigo, Auxiliares.Auxiliar FROM Grupos INNER JOIN SubGrupos ON Grupos.GrupoID = SubGrupos.GrupoID INNER JOIN CuentasControl ON SubGrupos.SubGrupoID = CuentasControl.SubGrupoID INNER JOIN Auxiliares INNER JOIN SubCuentaControl ON Auxiliares.SubCuentaControlID = SubCuentaControl.SubCuentaControlID ON CuentasControl.CuentaControlID = SubCuentaControl.CuentaControlID;";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                da.SelectCommand = cm;
                da.Fill(ds, "Auxiliares");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }

        public DataSet PrintEntradasGetByFecha(DateTime Desde, DateTime Hasta, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                DataSet ds = new DataSet();

                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //Empresas
                da = new MySqlDataAdapter();
                cn.Open();
                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "select @Desde as Desde, @Hasta as Hasta, E.Empresa, S.Direccion, S.Telefonos, E.Rnc, S.Sucursal from Empresas as E inner join Sucursales as S on S.EmpresaID = E.EmpresaID where S.SucursalID=@SucursalID limit 1;";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Empresas");
                cn.Close();

                //Entradas
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "select e.EntradaID, e.Fecha, T.Movimiento as TipoMovimiento, E.Referencia, E.Concepto, E.Debito, E.Credito from Entradas as E inner join TipoMovimientos as T on E.TipoMovimientoID = T.TipoMovimientoID where E.EstadoID = 1 and E.SucursalID = @SucursalID and E.Fecha Between @Desde and @Hasta;";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                da.SelectCommand = cm;
                da.Fill(ds, "Entradas");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }

        public DataSet PrintDetalleEntradasGetByFecha(DateTime Desde, DateTime Hasta, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                DataSet ds = new DataSet();

                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //Empresas
                da = new MySqlDataAdapter();
                cn.Open();
                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "select @Desde as Desde, @Hasta as Hasta, E.Empresa, S.Direccion, S.Telefonos, E.Rnc, S.Sucursal from Empresas as E inner join Sucursales as S on S.EmpresaID = E.EmpresaID where S.SucursalID=@SucursalID limit 1;";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Empresas");
                cn.Close();

                //DetalleEntradas
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "select e.EntradaID, e.Fecha, TD.TipoDocumento, D.Numero, A.Codigo, A.Auxiliar, D.Debito, D.Credito from Entradas as E inner join DetalleEntradas as D on E.EntradaID = D.EntradaID inner Join Auxiliares as A on D.AuxiliarID = A.AuxiliarID inner Join TipoEntradas as TD on D.TipoEntradaID = TD.TipoEntradaID where E.EstadoID = 1 and E.SucursalID = @SucursalID and E.Fecha Between @Desde and @Hasta;";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                da.SelectCommand = cm;
                da.Fill(ds, "DetalleEntradas");
                cn.Close();


                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }

        public DataSet PrintEstadoResultadosGetByFecha(DateTime Desde, DateTime Hasta, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                DataSet ds = new DataSet();

                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //Empresas
                da = new MySqlDataAdapter();
                cn.Open();
                MySqlCommand cm = new MySqlCommand();

                cm.CommandText = "select @Desde as Desde, @Hasta as Hasta, E.Empresa, S.Direccion, S.Telefonos, E.Rnc, S.Sucursal from Empresas as E inner join Sucursales as S on S.EmpresaID = E.EmpresaID where S.SucursalID=@SucursalID limit 1;";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Empresas");
                cn.Close();

                //DetalleEntradas
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "select g.Grupo, A.Codigo, A.Auxiliar, Sum(D.Debito) as Debito, Sum(D.Credito) as Credito from Entradas as E inner join DetalleEntradas as D on E.EntradaID = D.EntradaID inner Join Auxiliares as A on D.AuxiliarID = A.AuxiliarID inner Join TipoEntradas as TD on D.TipoEntradaID = TD.TipoEntradaID inner Join SubCuentaControl as scc on a.subCuentaControlID = scc.SubCuentaControlID inner join cuentascontrol as cc on scc.CuentaControlID = cc.CuentaControlID inner join SubGrupos as sg on cc.SubGrupoID = sg.SubGrupoID inner join Grupos as g on sg.GrupoID = g.GrupoID where E.EstadoID = 1 and E.SucursalID = @SucursalID and E.Fecha >= @Desde and E.Fecha <= @Hasta and g.GrupoID between 4 and 6 group By g.Grupo, A.Codigo, A.Auxiliar;";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                da.SelectCommand = cm;
                da.Fill(ds, "DetalleEntradas");
                cn.Close();


                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }

        public DataSet PrintBalanceGeneralGetByFecha(DateTime Desde, DateTime Hasta, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                DataSet ds = new DataSet();

                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //Empresas
                da = new MySqlDataAdapter();
                cn.Open();
                MySqlCommand cm = new MySqlCommand();

                cm.CommandText = "select @Desde as Desde, @Hasta as Hasta, E.Empresa, S.Direccion, S.Telefonos, E.Rnc, S.Sucursal from Empresas as E inner join Sucursales as S on S.EmpresaID = E.EmpresaID where S.SucursalID=@SucursalID limit 1;";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Empresas");
                cn.Close();

                //DetalleEntradas
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "select g.Grupo, A.Codigo, A.Auxiliar, Sum(D.Debito) as Debito, Sum(D.Credito) as Credito from Entradas as E inner join DetalleEntradas as D on E.EntradaID = D.EntradaID inner Join Auxiliares as A on D.AuxiliarID = A.AuxiliarID inner Join TipoEntradas as TD on D.TipoEntradaID = TD.TipoEntradaID inner Join SubCuentaControl as scc on a.subCuentaControlID = scc.SubCuentaControlID inner join cuentascontrol as cc on scc.CuentaControlID = cc.CuentaControlID inner join SubGrupos as sg on cc.SubGrupoID = sg.SubGrupoID inner join Grupos as g on sg.GrupoID = g.GrupoID where E.EstadoID = 1 and E.SucursalID = @SucursalID and E.Fecha >= @Desde and E.Fecha <= @Hasta and g.GrupoID between 1 and 3 group By  g.Grupo, A.Codigo, A.Auxiliar;";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                da.SelectCommand = cm;
                da.Fill(ds, "DetalleEntradas");
                cn.Close();


                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }

        public DataSet PrintBalanzaComprobacionGetByFecha(DateTime Desde, DateTime Hasta, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                DataSet ds = new DataSet();

                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //Empresas
                da = new MySqlDataAdapter();
                cn.Open();
                MySqlCommand cm = new MySqlCommand();

                cm.CommandText = "select @Desde as Desde, @Hasta as Hasta, E.Empresa, S.Direccion, S.Telefonos, E.Rnc, S.Sucursal from Empresas as E inner join Sucursales as S on S.EmpresaID = E.EmpresaID where S.SucursalID=@SucursalID limit 1;";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Empresas");
                cn.Close();

                //DetalleEntradas
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "select concat( cc.Codigo, ' ', CC.Nombre) as Grupo, A.Codigo, A.Auxiliar, Sum(D.Debito) as Debito, Sum(D.Credito) as Credito from Entradas as E inner join DetalleEntradas as D on E.EntradaID = D.EntradaID inner Join Auxiliares as A on D.AuxiliarID = A.AuxiliarID inner Join TipoEntradas as TD on D.TipoEntradaID = TD.TipoEntradaID inner Join SubCuentaControl as scc on a.subCuentaControlID = scc.SubCuentaControlID inner join cuentascontrol as cc on scc.CuentaControlID = cc.CuentaControlID inner join SubGrupos as sg on cc.SubGrupoID = sg.SubGrupoID inner join Grupos as g on sg.GrupoID = g.GrupoID where E.EstadoID = 1 and E.SucursalID = @SucursalID and E.Fecha >= @Desde and E.Fecha <= @Hasta group By a.Codigo, a.Auxiliar, concat( cc.Codigo, ' ', CC.Nombre);";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                da.SelectCommand = cm;
                da.Fill(ds, "DetalleEntradas");
                cn.Close();


                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }

        public DataSet PrintSolicitudChequesGetBySolicitudChequeID(int SolicitudChequeID)
        {
            try
            {
                db = new DAL.Context();

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "SELECT SolicitudCheques.SolicitudChequeID, SolicitudCheques.Fecha, SolicitudCheques.Beneficiario, SolicitudCheques.Concepto, SolicitudCheques.Monto, Auxiliares.Codigo, Auxiliares.Auxiliar, DetalleSolicitudCheques.Debito, DetalleSolicitudCheques.Credito, Empresas.Empresa, Empresas.Rnc, Sucursales.Direccion, Sucursales.Telefonos, Sucursales.Sucursal FROM SolicitudCheques INNER JOIN DetalleSolicitudCheques ON SolicitudCheques.SolicitudChequeID = DetalleSolicitudCheques.SolicitudChequeID INNER JOIN Auxiliares ON DetalleSolicitudCheques.AuxiliarID = Auxiliares.AuxiliarID INNER JOIN Bancos ON SolicitudCheques.BancoID = Bancos.BancoID INNER JOIN Sucursales ON Bancos.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID WHERE (SolicitudCheques.SolicitudChequeID = @SolicitudChequeID) ORDER BY DetalleSolicitudCheques.Debito DESC";
                cm.CommandTimeout = Timeout;
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@SolicitudChequeID", SolicitudChequeID));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "SolicitudCheques");
                cn.Close();

                DataTable Cuentas = new DataTable("Cuentas");
                Cuentas.Columns.Add("BarCode", typeof(byte[]));
                Cuentas.Columns.Add("SolicitudChequeID", typeof(int));

                string Barcode = string.Empty;
                foreach (DataRow row in ds.Tables["SolicitudCheques"].Rows)
                {
                    Barcode = row["SolicitudChequeID"].ToString();
                }

                DataRow dataRow = Cuentas.NewRow();
                dataRow["BarCode"] = ImageFromText(Barcode);
                dataRow["SolicitudChequeID"] = SolicitudChequeID;
                Cuentas.Rows.Add(dataRow);

                ds.Tables.Add(Cuentas);

                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }

        public DataSet PrintCartasGetByRutaID(DateTime Desde, DateTime Hasta, int SucursalID, int TipoCartaID, int RutaID)
        {
            try
            {
                db = new DAL.Context();

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                string Where = string.Format(" WHERE (HistorialCartas.Fecha BETWEEN @Desde AND @Hasta) AND (Cartas.TipoCartaID = {0}) ", TipoCartaID);
                if (SucursalID != -1)
                {
                    Where = Where + string.Format(" AND (Clientes.SucursalID = {0}) ", SucursalID);
                }

                if (RutaID != -1)
                {
                    Where = Where + string.Format(" AND (Zonas.RutaID = {0}) ", RutaID);
                }



                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "SELECT  HistorialCartas.HistorialCartaID, Contratos.ContratoID, Cuotas.Numero, Cuotas.Vence, HistorialCartas.Fecha, HistorialCartas.Monto, TipoSolicitudes.TipoSolicitud, Empresas.Empresa, Empresas.Rnc, Sucursales.Sucursal, Sucursales.Direccion, Sucursales.Telefonos, Ciudades.Ciudad, Provincias.Provincia, Paises.Pais, Localidades.Ciudad AS Localidad, Cuotas.Capital + Cuotas.Comision + Cuotas.Interes AS Cuota, Personas.Documento, Personas.Nombres, Personas.Apellidos, Personas.Direccion AS DireccionCliente, CONCAT(Gerentes.Nombres, ' ' , Gerentes.Apellidos) AS Gerente, Gerentes.Documento AS DocumentoGerente, Gerentes.Direccion AS DireccionGerente, HistorialCartas.Atraso, Contratos.Fecha AS Emision, CONCAT(NotariosPublico.Nombres, ' ', NotariosPublico.Apellidos) AS Notario, NotariosPublico.Direccion AS DireccionNotario, NP.Exequatur AS ExequaturNotario, CONCAT(Garantes.Nombres, ' ', Garantes.Apellidos) AS Garante, Garantes.Direccion AS DireccionGarante, CONCAT(Abogados.Nombres, ' ', Abogados.Apellidos) AS Abogado, A.Direccion AS DireccionAbogado, A.Exequatur, Abogados.Documento AS DocumentoAbogado, CONCAT(Alguaciles.Nombres, ' ', Alguaciles.Apellidos) AS Alguacil, Alguaciles.Documento AS DocumentoAlguacil, Alguaciles.Direccion AS DireccionAlguacil, Ci.Ciudad AS CiudadAlguacil, CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= HistorialCartas.Fecha) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= HistorialCartas.Fecha) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END AS Balance, Ci1.Ciudad AS CiudadGerente, (SELECT SUM(Capital + Comision) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision) AS ND FROM DetalleNotaDebitos AS ND1 WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c111 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision) AS Expr1 FROM DetalleNotaDebitos AS ND1 WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c111 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c111 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c111 WHERE ContratoID = Contratos.ContratoID))) END, 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) AS MontoSolicitud FROM Abogados AS A RIGHT OUTER JOIN Personas AS Abogados ON A.Documento = Abogados.Documento RIGHT OUTER JOIN Alguaciles AS AG RIGHT OUTER JOIN HistorialCartas INNER JOIN Cartas ON HistorialCartas.CartaID = Cartas.CartaID INNER JOIN Cuotas ON HistorialCartas.CuotaID = Cuotas.CuotaID INNER JOIN Contratos ON Cuotas.ContratoID = Contratos.ContratoID INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID INNER JOIN Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN Ciudades ON Sucursales.CiudadID = Ciudades.CiudadID INNER JOIN Provincias ON Ciudades.ProvinciaID = Provincias.ProvinciaID INNER JOIN Paises ON Provincias.PaisID = Paises.PaisID INNER JOIN Ciudades AS Localidades ON Personas.CiudadID = Localidades.CiudadID INNER JOIN Personas AS Gerentes ON Sucursales.Documento = Gerentes.Documento INNER JOIN NotariosPublico AS NP ON Contratos.NotarioPublicoID = NP.NotarioPublicoID INNER JOIN Personas AS NotariosPublico ON NP.Documento = NotariosPublico.Documento ON AG.SucursalID = Sucursales.SucursalID LEFT OUTER JOIN Personas AS Garantes INNER JOIN GarantiaPersonal ON Garantes.Documento = GarantiaPersonal.Documento ON Solicitudes.SolicitudID = GarantiaPersonal.SolicitudID ON A.SucursalID = Sucursales.SucursalID INNER JOIN Personas AS Alguaciles ON AG.Documento = Alguaciles.Documento INNER JOIN Ciudades AS Ci ON Alguaciles.CiudadID = Ci.CiudadID INNER JOIN Ciudades AS Ci1 ON Gerentes.CiudadID = Ci1.CiudadID INNER JOIN Zonas on Contratos.ZonaID = Zonas.ZonaID " + Where;
                cm.CommandTimeout = Timeout;
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Cartas");
                cn.Close();

                DataTable Seguridad = new DataTable("Seguridad");
                Seguridad.Columns.Add("BarCode", typeof(byte[]));

                string Barcode = string.Empty;
                foreach (DataRow row in ds.Tables["Cartas"].Rows)
                {
                    Barcode = row["HistorialCartaID"].ToString();
                    DataRow dataRow = Seguridad.NewRow();
                    dataRow["BarCode"] = ImageFromText(Barcode);
                    Seguridad.Rows.Add(dataRow);
                }

                ds.Tables.Add(Seguridad);

                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }

        public DataSet PrintCartasGetByHistorialCartaID(int HistorialCartaID)
        {
            try
            {
                db = new DAL.Context();

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();


                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "SELECT HistorialCartas.HistorialCartaID, Contratos.ContratoID, Cuotas.Numero, Cuotas.Vence, HistorialCartas.Fecha, HistorialCartas.Monto, TipoSolicitudes.TipoSolicitud, Empresas.Empresa, Empresas.Rnc, Sucursales.Sucursal, Sucursales.Direccion, Sucursales.Telefonos, Ciudades.Ciudad, Provincias.Provincia, Paises.Pais, Localidades.Ciudad AS Localidad, Cuotas.Capital + Cuotas.Comision + Cuotas.Interes AS Cuota, Personas.Documento, Personas.Nombres, Personas.Apellidos, Personas.Direccion AS DireccionCliente, CONCAT(Gerentes.Nombres, ' ', Gerentes.Apellidos) AS Gerente, Gerentes.Documento AS DocumentoGerente, Gerentes.Direccion AS DireccionGerente, HistorialCartas.Atraso, Contratos.Fecha AS Emision, CONCAT(NotariosPublico.Nombres, ' ', NotariosPublico.Apellidos) AS Notario, NotariosPublico.Direccion AS DireccionNotario, NP.Exequatur AS ExequaturNotario, CONCAT(Garantes.Nombres, ' ', Garantes.Apellidos) AS Garante, Garantes.Direccion AS DireccionGarante, CONCAT(Abogados.Nombres, ' ', Abogados.Apellidos) AS Abogado, A.Direccion AS DireccionAbogado, A.Exequatur, Abogados.Documento AS DocumentoAbogado, CONCAT(Alguaciles.Nombres, ' ', Alguaciles.Apellidos) AS Alguacil, Alguaciles.Documento AS DocumentoAlguacil, Alguaciles.Direccion AS DireccionAlguacil, Ci.Ciudad AS CiudadAlguacil, CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= HistorialCartas.Fecha) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= HistorialCartas.Fecha) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END AS Balance, Ci1.Ciudad AS CiudadGerente, (SELECT SUM(Capital + Comision) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision) AS ND FROM DetalleNotaDebitos AS ND1 WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c111 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision) AS Expr1 FROM DetalleNotaDebitos AS ND1 WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c111 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c111 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c111 WHERE ContratoID = Contratos.ContratoID))) END, 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) AS MontoSolicitud FROM Abogados AS A RIGHT OUTER JOIN Personas AS Abogados ON A.Documento = Abogados.Documento RIGHT OUTER JOIN Alguaciles AS AG RIGHT OUTER JOIN HistorialCartas INNER JOIN Cartas ON HistorialCartas.CartaID = Cartas.CartaID INNER JOIN Cuotas ON HistorialCartas.CuotaID = Cuotas.CuotaID INNER JOIN Contratos ON Cuotas.ContratoID = Contratos.ContratoID INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID INNER JOIN Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN Ciudades ON Sucursales.CiudadID = Ciudades.CiudadID INNER JOIN Provincias ON Ciudades.ProvinciaID = Provincias.ProvinciaID INNER JOIN Paises ON Provincias.PaisID = Paises.PaisID INNER JOIN Ciudades AS Localidades ON Personas.CiudadID = Localidades.CiudadID INNER JOIN Personas AS Gerentes ON Sucursales.Documento = Gerentes.Documento INNER JOIN NotariosPublico AS NP ON Contratos.NotarioPublicoID = NP.NotarioPublicoID INNER JOIN Personas AS NotariosPublico ON NP.Documento = NotariosPublico.Documento ON AG.SucursalID = Sucursales.SucursalID LEFT OUTER JOIN Personas AS Garantes INNER JOIN GarantiaPersonal ON Garantes.Documento = GarantiaPersonal.Documento ON Solicitudes.SolicitudID = GarantiaPersonal.SolicitudID ON A.SucursalID = Sucursales.SucursalID INNER JOIN Personas AS Alguaciles ON AG.Documento = Alguaciles.Documento INNER JOIN Ciudades AS Ci ON Alguaciles.CiudadID = Ci.CiudadID INNER JOIN Ciudades AS Ci1 ON Gerentes.CiudadID = Ci1.CiudadID Where HistorialCartaID= @HistorialCartaID";
                cm.CommandTimeout = Timeout;
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@HistorialCartaID", HistorialCartaID));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Cartas");
                cn.Close();

                string Barcode = string.Empty;
                foreach (DataRow row in ds.Tables["Cartas"].Rows)
                {
                    Barcode = row["HistorialCartaID"].ToString();
                }


                DataTable Seguridad = new DataTable("Seguridad");
                Seguridad.Columns.Add("BarCode", typeof(byte[]));
                DataRow dataRow = Seguridad.NewRow();
                dataRow["BarCode"] = ImageFromText(Barcode);
                Seguridad.Rows.Add(dataRow);

                ds.Tables.Add(Seguridad);

                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }
        public DataSet PrintCartaSaldo(int ReciboID)
        {
            try
            {
                db = new DAL.Context();

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();


                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "SELECT Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal, Ciudades.Ciudad, Provincias.Provincia, Paises.Pais, CONCAT(Personas.Nombres, ' ', Personas.Apellidos) AS Gerente FROM Empresas INNER JOIN Sucursales ON Empresas.EmpresaID = Sucursales.EmpresaID INNER JOIN Ciudades ON Sucursales.CiudadID = Ciudades.CiudadID INNER JOIN Provincias ON Ciudades.ProvinciaID = Provincias.ProvinciaID INNER JOIN Paises ON Provincias.PaisID = Paises.PaisID INNER JOIN Gerentes ON Sucursales.Documento = Gerentes.Documento INNER JOIN Personas ON Gerentes.Documento = Personas.Documento INNER JOIN Recibos ON Sucursales.SucursalID = Recibos.SucursalID Where Recibos.ReciboID = @ReciboID";
                cm.CommandTimeout = Timeout;
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ReciboID", ReciboID));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Empresas");
                cn.Close();

                //Empresas
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT Recibos.ReciboID, Recibos.Fecha AS FechaSaldo, recibos.TokenID, CONCAT(Personas.Nombres, ' ', Personas.Apellidos) AS Cliente, Solicitudes.Monto, TipoSolicitudes.TipoSolicitud, Contratos.ContratoID, Personas.Direccion, Personas.Documento, Ciudades.Ciudad, Provincias.Provincia, Paises.Pais, Contratos.Fecha, Recibos.Monto as MontoSaldo FROM Recibos INNER JOIN Contratos ON Recibos.ContratoID = Contratos.ContratoID INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN Ciudades ON Personas.CiudadID = Ciudades.CiudadID INNER JOIN Provincias ON Ciudades.ProvinciaID = Provincias.ProvinciaID INNER JOIN Paises ON Provincias.PaisID = Paises.PaisID INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID Where Recibos.ReciboID = @ReciboID";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ReciboID", ReciboID));
                da.SelectCommand = cm;
                da.Fill(ds, "Recibos");
                cn.Close();


                string Barcode = string.Empty;
                foreach (DataRow row in ds.Tables["Recibos"].Rows)
                {
                    Barcode = row["ContratoID"].ToString() + row["ReciboID"].ToString();
                }


                DataTable Seguridad = new DataTable("Seguridad");
                Seguridad.Columns.Add("BarCode", typeof(byte[]));
                Seguridad.Columns.Add("QrCode", typeof(byte[]));

                DataRow dataRow = Seguridad.NewRow();
                dataRow["BarCode"] = ImageFromText(Barcode);
                dataRow["QrCode"] = TextToQrCode(ds.Tables["Recibos"].Rows[0]["TokenID"].ToString());
                Seguridad.Rows.Add(dataRow);

                ds.Tables.Add(Seguridad);

                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }
        public DataSet PrintCertificadoDocumentos(int ReciboID)
        {
            try
            {
                db = new DAL.Context();

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT Recibos.ReciboID, Personas.Documento, Personas.Nombres, Personas.Apellidos, Contratos.ContratoID, Recibos.Fecha, TipoSolicitudes.TipoSolicitud, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Empresas.Siglas, Sucursales.Sucursal, Ciudades.Ciudad, Provincias.Provincia, GarantiaHipotecaria.Descripcion, TipoVehiculos.TipoVehiculo, Modelos.Modelo, Colores.Color, Marcas.Marca, GarantiaVehiculos.Chasis, GarantiaVehiculos.Placa, GarantiaVehiculos.Registro, GarantiaVehiculos.FechaExpedicion, GarantiaVehiculos.Ano FROM TipoVehiculos INNER JOIN GarantiaVehiculos ON TipoVehiculos.TipoVehiculoID = GarantiaVehiculos.TipoVehiculoID INNER JOIN Colores ON GarantiaVehiculos.ColorID = Colores.ColorID INNER JOIN Modelos ON GarantiaVehiculos.ModeloID = Modelos.ModeloID INNER JOIN Marcas ON Modelos.MarcaID = Marcas.MarcaID RIGHT OUTER JOIN Recibos INNER JOIN Contratos ON Recibos.ContratoID = Contratos.ContratoID INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN Ciudades ON Sucursales.CiudadID = Ciudades.CiudadID INNER JOIN Provincias ON Ciudades.ProvinciaID = Provincias.ProvinciaID INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID LEFT OUTER JOIN GarantiaHipotecaria ON Solicitudes.SolicitudID = GarantiaHipotecaria.SolicitudID ON GarantiaVehiculos.SolicitudID = Solicitudes.SolicitudID Where Recibos.ReciboID = @ReciboID";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ReciboID", ReciboID));
                da.SelectCommand = cm;
                da.Fill(ds, "Recibos");
                cn.Close();



                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }
        public DataSet PrintCartasGetByFecha(DateTime Desde, DateTime Hasta, int TipoCartaID, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();

                DataTable Cartas = new DataTable("Cartas");
                Cartas.Columns.Add("ContratoID", typeof(int));
                Cartas.Columns.Add("Fecha", typeof(DateTime));
                Cartas.Columns.Add("Vence", typeof(DateTime));
                Cartas.Columns.Add("Numero", typeof(int));
                Cartas.Columns.Add("Documento", typeof(string));
                Cartas.Columns.Add("Completo", typeof(string));
                Cartas.Columns.Add("Direccion", typeof(string));
                Cartas.Columns.Add("Ciudad", typeof(string));
                Cartas.Columns.Add("Provincia", typeof(string));
                Cartas.Columns.Add("TipoSolicitud", typeof(string));
                Cartas.Columns.Add("TipoContrato", typeof(string));
                Cartas.Columns.Add("Monto", typeof(float));
                Cartas.Columns.Add("Atraso", typeof(float));
                Cartas.Columns.Add("Costo", typeof(float));
                Cartas.Columns.Add("Gerente", typeof(string));
                Cartas.Columns.Add("Abogado", typeof(string));
                Cartas.Columns.Add("Empresa", typeof(string));
                Cartas.Columns.Add("DireccionEmpresa", typeof(string));
                Cartas.Columns.Add("Telefonos", typeof(string));
                Cartas.Columns.Add("Rnc", typeof(string));
                Cartas.Columns.Add("Sucursal", typeof(string));
                Cartas.Columns.Add("CiudadEmpresa", typeof(string));
                Cartas.Columns.Add("ProvinciaEmpresa", typeof(string));
                Cartas.Columns.Add("Pais", typeof(string));

                var result = db.clsHistorialCartasBE.Where(x => x.Fecha >= Desde && x.Fecha <= Hasta && x.Cartas.TipoCartaID == TipoCartaID && x.Cuotas.Contratos.Solicitudes.Clientes.SucursalID == SucursalID).ToList();

                DataRow dataRow;
                foreach (var row in result)
                {
                    dataRow = Cartas.NewRow();
                    dataRow["ContratoID"] = row.Cuotas.ContratoID;
                    dataRow["Fecha"] = row.Fecha;
                    dataRow["Vence"] = row.Cuotas.Vence;
                    dataRow["Numero"] = row.Cuotas.Numero;
                    dataRow["Documento"] = row.Cuotas.Contratos.Solicitudes.Clientes.Documento;
                    dataRow["Completo"] = row.Cuotas.Contratos.Solicitudes.Clientes.Personas.Nombres + " " + row.Cuotas.Contratos.Solicitudes.Clientes.Personas.Apellidos;
                    dataRow["Direccion"] = row.Cuotas.Contratos.Solicitudes.Clientes.Personas.Direccion;
                    dataRow["Ciudad"] = row.Cuotas.Contratos.Solicitudes.Clientes.Personas.Ciudades.Ciudad;
                    dataRow["Provincia"] = row.Cuotas.Contratos.Solicitudes.Clientes.Personas.Ciudades.Provincias.Provincia;
                    dataRow["TipoSolicitud"] = row.Cuotas.Contratos.Solicitudes.TipoSolicitudes.TipoSolicitud;
                    dataRow["TipoContrato"] = row.Cuotas.Contratos.TipoContratos.TipoContrato;
                    dataRow["Monto"] = row.Monto;
                    dataRow["Atraso"] = row.Atraso;
                    dataRow["Costo"] = row.Cartas.Monto;
                    dataRow["Gerente"] = row.Cuotas.Contratos.Solicitudes.Clientes.Personas.Ciudades.Provincias.Provincia;
                    dataRow["Abogado"] = "";
                    dataRow["Empresa"] = row.Cuotas.Contratos.Solicitudes.Clientes.Sucursales.Empresas.Empresa;
                    dataRow["DireccionEmpresa"] = row.Cuotas.Contratos.Solicitudes.Clientes.Sucursales.Direccion;
                    dataRow["Telefonos"] = row.Cuotas.Contratos.Solicitudes.Clientes.Sucursales.Telefonos;
                    dataRow["Rnc"] = row.Cuotas.Contratos.Solicitudes.Clientes.Sucursales.Empresas.Rnc;
                    dataRow["Sucursal"] = row.Cuotas.Contratos.Solicitudes.Clientes.Sucursales.Sucursal;
                    dataRow["CiudadEmpresa"] = row.Cuotas.Contratos.Solicitudes.Clientes.Sucursales.Ciudades.Ciudad;
                    dataRow["ProvinciaEmpresa"] = row.Cuotas.Contratos.Solicitudes.Clientes.Sucursales.Ciudades.Provincias.Provincia;
                    dataRow["Pais"] = row.Cuotas.Contratos.Solicitudes.Clientes.Personas.Ciudades.Provincias.Paises.Pais;
                }


                return ds;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                return new DataSet();
            }

        }

        public DataSet PrintCuotasAVencerGetByFecha(DateTime Desde, DateTime Hasta, int SucursalID, int RutaID)
        {
            try
            {
                DataSet ds = new DataSet();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataTable Empresas = new DataTable("Empresas");
                Empresas.Columns.Add("Empresa", typeof(string));
                Empresas.Columns.Add("Direccion", typeof(string));
                Empresas.Columns.Add("Telefonos", typeof(string));
                Empresas.Columns.Add("Rnc", typeof(string));
                Empresas.Columns.Add("Sucursal", typeof(string));
                Empresas.Columns.Add("Desde", typeof(DateTime));
                Empresas.Columns.Add("Hasta", typeof(DateTime));

                var data = SucursalesGetBySucursalID(SucursalID);
                DataRow row = Empresas.NewRow();
                row["Empresa"] = data.Empresas.Empresa;
                row["Direccion"] = data.Direccion;
                row["Telefonos"] = data.Telefonos;
                row["Rnc"] = data.Empresas.Rnc;
                row["Sucursal"] = data.Sucursal;
                row["Desde"] = _Desde;
                row["Hasta"] = _Hasta;
                Empresas.Rows.Add(row);
                ds.Tables.Add(Empresas);

                DataTable Cuotas = new DataTable("Cuotas");
                Cuotas.Columns.Add("ContratoID", typeof(int));
                Cuotas.Columns.Add("Numero", typeof(int));
                Cuotas.Columns.Add("SucursalID", typeof(int));
                Cuotas.Columns.Add("Vence", typeof(DateTime));
                Cuotas.Columns.Add("Cliente", typeof(string));
                Cuotas.Columns.Add("Telefono", typeof(string));
                Cuotas.Columns.Add("Celular", typeof(string));
                Cuotas.Columns.Add("Cuota", typeof(decimal));
                Cuotas.Columns.Add("Balance", typeof(decimal));
                Cuotas.Columns.Add("Atraso", typeof(decimal));
                Cuotas.Columns.Add("Ruta", typeof(string));

                db = new DAL.Context();
                var rows = RutaID == -1 ? db.clsCuotasBE.Where(x => x.Vence >= _Desde && x.Vence <= _Hasta && x.Contratos.EstadoID == 1).ToList() : db.clsCuotasBE.Where(x => x.Vence >= _Desde && x.Vence <= _Hasta && x.Contratos.EstadoID == 1 && x.Contratos.Zonas.RutaID == RutaID).ToList();
                foreach (var item in rows)
                {
                    var view = new clsCuotasView();
                    view.SetDataSource(item.ContratoID);
                    var result = view.GetGroup().Where(x => x.Vence >= _Desde && x.Vence <= _Hasta && x.Balance > 1).OrderBy(x => x.Numero).ToList();
                    foreach (var response in result.ToList())
                    {
                        var row1 = Cuotas.NewRow();
                        row1["ContratoID"] = response.ContratoID;
                        row1["Numero"] = response.Numero;
                        row1["Vence"] = response.Vence;
                        row1["Cliente"] = $"{item.Contratos.Solicitudes.Clientes.Personas.Nombres.ToUpper()} {item.Contratos.Solicitudes.Clientes.Personas.Apellidos.ToUpper()}";
                        row1["Telefono"] = item.Contratos.Solicitudes.Clientes.Personas.Telefono;
                        row1["Celular"] = item.Contratos.Solicitudes.Clientes.Personas.Celular;
                        row1["Cuota"] = item.Contratos.Cuota;
                        row1["Balance"] = response.Balance;
                        row1["Atraso"] = view.AtrasoGet(DateTime.Today);
                        row1["Ruta"] = item.Contratos.Zonas.Rutas.Ruta.ToUpper();
                        Cuotas.Rows.Add(row1);
                    }
                }
                ds.Tables.Add(Cuotas);
                return ds;
            }
            catch (Exception ex)
            {

                return new DataSet();
            }
        }


        public DataSet PrintCuotasVencidasGetByFecha(DateTime Hasta, int SucursalID, int RutaID,  int OrderBy = 0)
        {
            try
            {
                DataSet ds = new DataSet();
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataTable Empresas = new DataTable("Empresas");
                Empresas.Columns.Add("Empresa", typeof(string));
                Empresas.Columns.Add("Direccion", typeof(string));
                Empresas.Columns.Add("Telefonos", typeof(string));
                Empresas.Columns.Add("Rnc", typeof(string));
                Empresas.Columns.Add("Sucursal", typeof(string));
                Empresas.Columns.Add("Hasta", typeof(DateTime));

                var data = SucursalesGetBySucursalID(SucursalID);
                DataRow row = Empresas.NewRow();
                row["Empresa"] = data.Empresas.Empresa;
                row["Direccion"] = data.Direccion;
                row["Telefonos"] = data.Telefonos;
                row["Rnc"] = data.Empresas.Rnc;
                row["Sucursal"] = data.Sucursal;
                row["Hasta"] = _Hasta;
                Empresas.Rows.Add(row);
                ds.Tables.Add(Empresas);

                DataTable Contratos = new DataTable("Contratos");
                Contratos.Columns.Add("ContratoID", typeof(int));
                Contratos.Columns.Add("Vencido", typeof(string));
                Contratos.Columns.Add("SucursalID", typeof(int));

                Contratos.Columns.Add("Fecha", typeof(DateTime));
                Contratos.Columns.Add("Cliente", typeof(string));
                Contratos.Columns.Add("Telefono", typeof(string));
                Contratos.Columns.Add("Celular", typeof(string));
                Contratos.Columns.Add("Ruta", typeof(string));
                Contratos.Columns.Add("Cuota", typeof(decimal));
                Contratos.Columns.Add("Balance", typeof(decimal));
                Contratos.Columns.Add("Cantidad", typeof(int));
                Contratos.Columns.Add("Atraso", typeof(decimal));
                

                db = new DAL.Context();
                List<clsContratosBE> rows = new List<clsContratosBE>();
                switch (OrderBy)
                {
                    case 0: 
                        {
                            rows = RutaID == -1 ? db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1).OrderBy(x=>x.ContratoID).ToList() : db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1 && x.Zonas.RutaID == RutaID).OrderBy(x => x.ContratoID).ToList();
                        }
                        break;
                    case 1:
                        {
                            rows = RutaID == -1 ? db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1).OrderBy(x => x.Fecha).ToList() : db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1 && x.Zonas.RutaID == RutaID).OrderBy(x => x.Fecha).ToList();
                        }
                        break;
                    case 2:
                        {
                            rows = RutaID == -1 ? db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1).OrderBy(x => x.Solicitudes.Clientes.Personas.Nombres).ToList() : db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1 && x.Zonas.RutaID == RutaID).OrderBy(x => x.Solicitudes.Clientes.Personas.Nombres).ToList();
                        }
                        break;
                    case 3:
                        {
                            rows = RutaID == -1 ? db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1).OrderBy(x => x.Solicitudes.Clientes.Personas.Telefono).ToList() : db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1 && x.Zonas.RutaID == RutaID).OrderBy(x => x.Solicitudes.Clientes.Personas.Telefono).ToList();
                        }
                        break;
                    case 4:
                        {
                            rows = RutaID == -1 ? db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1).OrderBy(x => x.Solicitudes.Clientes.Personas.Celular).ToList() : db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1 && x.Zonas.RutaID == RutaID).OrderBy(x => x.Solicitudes.Clientes.Personas.Celular).ToList();
                        }
                        break;

                    case 5:
                        {
                            rows = RutaID == -1 ? db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1).OrderBy(x => x.Cuota).ToList() : db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1 && x.Zonas.RutaID == RutaID).OrderBy(x => x.Cuota).ToList();
                        }
                        break;
                    default:
                        {
                            rows = RutaID == -1 ? db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1).OrderBy(x => x.ContratoID).ToList() : db.clsContratosBE.Where(x => x.Fecha <= _Hasta && x.EstadoID == 1 && x.Zonas.RutaID == RutaID).OrderBy(x => x.ContratoID).ToList();
                        }
                        break;

                }



                foreach (var item in rows)
                {
                    var view = new clsCuotasView();
                    view.SetDataSource(item.ContratoID);
                    var result = view.GetGroup().Where(x => x.Vence <= _Hasta && x.Balance > 1).OrderBy(x => x.Numero).ToList();
                    if(view.AtrasoGet(_Hasta) > 1)
                    {
                        var row1 = Contratos.NewRow();
                        row1["ContratoID"] = item.ContratoID;
                        row1["Vencido"] = item.Vence < _Hasta ? "Si" : "";
                        row1["Fecha"] = item.Fecha;
                        row1["Cliente"] = $"{item.Solicitudes.Clientes.Personas.Nombres.ToUpper()} {item.Solicitudes.Clientes.Personas.Apellidos.ToUpper()}";
                        row1["Telefono"] = item.Solicitudes.Clientes.Personas.Telefono;
                        row1["Celular"] = item.Solicitudes.Clientes.Personas.Celular;
                        row1["Ruta"] = item.Zonas.Rutas.Ruta.ToUpper();
                        row1["Cuota"] = Math.Round(item.Cuota,0);

                        row1["Cantidad"] = view.CantidadAtrasoGet(_Hasta);
                        row1["Balance"] = Math.Round(view.BalanceCapitalAtrasosGetByReciboID(_Hasta),0);
                        row1["Atraso"] = Math.Round(view.AtrasoGet(_Hasta),0);

                        Contratos.Rows.Add(row1);
                    }
                }
                ds.Tables.Add(Contratos);
                return ds;
            }
            catch (Exception ex)
            {

                return new DataSet();
            }
        }

        public DataSet PrintCuotasVencidasGetByFecha1(DateTime Hasta, int SucursalID, int RutaID, string OrderBy = " Order by Contratos.ContratoID")
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Hasta.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string query = System.IO.File.ReadAllText(Environment.CurrentDirectory + "/Script/CuotasVencidasGetByFecha.txt");

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;

                if (RutaID != -1)
                {
                    query = query + " AND Zonas.RutaID = @RutaID";
                    cm.Parameters.Add(new MySqlParameter("@RutaID", RutaID));
                }


                if (SucursalID == -1)
                {
                    cm.CommandText = query + " " + OrderBy;
                }
                else
                {
                    cm.CommandText = query + " AND Sucursales.SucursalID = @SucursalID " + OrderBy;
                    cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                }

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }

        }

        public DataSet PrintListadoCobroGetByInstitucionID(DateTime Hasta, int SucursalID, int InstitucionID)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string query = "SELECT Contratos.ContratoID, Contratos.Fecha, CAST(@Hasta as DateTime) AS Hasta, Contratos.Vence, CASE WHEN Contratos.VENCE < @Hasta THEN 'Si' ELSE '' END AS Vencido, Personas.Documento, CONCAT(Personas.Nombres, ' ', Personas.Apellidos) as Completo, Personas.Telefono, Personas.Celular, Solicitudes.Monto + Solicitudes.Monto * (Contratos.Comision / 100) * Solicitudes.Tiempo AS Monto, CASE WHEN CONTRATOS.tipoContratoID = 3 THEN (SELECT COUNT(CuotaID) AS Expr1 FROM Cuotas WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND ({ fn IFNULL(Capital + Comision + Interes + Mora + Legal, 0) } + { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaDebitos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR2 WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND estadoid = 1))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaCreditos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) }) > 1) ELSE ((SELECT COUNT(CuotaID) AS Expr1 FROM Cuotas WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND ({ fn IFNULL(Capital + Comision + Interes + Mora + Legal, 0) } + { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaDebitos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR2 WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND estadoID = 1))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaCreditos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) }) > 1)) END AS Cantidad, CASE WHEN CASE WHEN CONTRATOS.tipoContratoID = 3 THEN (SELECT IFNULL(SUM(Capital + Comision + Interes + Mora + Legal), 0) AS Expr1 FROM Cuotas WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND ({ fn IFNULL(Capital + Comision + Interes + Mora + Legal, 0) } + { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaDebitos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR2 WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID)))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaCreditos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) }) > 0) ELSE IFNULL((SELECT { fn IFNULL(SUM(Capital + Comision + interes + Mora + Legal), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR3 WHERE (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)), 0) END < 0 THEN 0 ELSE CASE WHEN CONTRATOS.tipoContratoID = 3 THEN (SELECT IFNULL(SUM(Capital + Comision + Interes + Mora + Legal), 0) AS Expr1 FROM Cuotas WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND ({ fn IFNULL(Capital + Comision + Interes + Mora + Legal, 0) } + { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaDebitos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR2 WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID)))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaCreditos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) }) > 0) ELSE IFNULL((SELECT { fn IFNULL(SUM(Capital + Comision + Interes + Mora + Legal), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR3 WHERE (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)), 0) END END AS Atraso, CASE WHEN Contratos.VENCE < @Hasta THEN 0 ELSE Contratos.Cuota END AS Cuota, CASE WHEN CASE WHEN CONTRATOS.tipoContratoID = 3 THEN (SELECT IFNULL(SUM(Capital + Comision + Interes + Mora + Legal) , 0) AS Expr1 FROM Cuotas WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND ({ fn IFNULL(Capital + Comision + Interes + Mora + Legal , 0) } + { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaDebitos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))) , 0) } - { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR2 WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID)))) , 0) } - { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaCreditos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))) , 0) }) > 0) ELSE IFNULL((SELECT { fn IFNULL(SUM(Capital + Comision + interes + Mora + Legal) , 0) } - { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR3 WHERE (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))) , 0) } AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)) , 0) END < 0 THEN 0 ELSE CASE WHEN CONTRATOS.tipoContratoID = 3 THEN (SELECT IFNULL(SUM(Capital + Comision + Interes + Mora + Legal) , 0) AS Expr1 FROM Cuotas WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND ({ fn IFNULL(Capital + Comision + Interes + Mora + Legal , 0) } + { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaDebitos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))) , 0) } - { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR2 WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID)))) , 0) } - { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaCreditos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))) , 0) }) > 0) ELSE IFNULL((SELECT { fn IFNULL(SUM(Capital + Comision + Interes + Mora + Legal) , 0) } - { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR3 WHERE (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))) , 0) } AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)) , 0) END END + CASE WHEN Contratos.VENCE < @Hasta THEN 0 ELSE Contratos.Cuota END as Balance, Empresas.Empresa,  Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Empresas.Siglas, Sucursales.Sucursal, Sucursales.SucursalID, TipoSolicitudes.TipoSolicitud, Personas.Correo, Instituciones.Institucion FROM Contratos INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN  Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID INNER JOIN DatosEconomicos ON Clientes.Documento = DatosEconomicos.Documento INNER JOIN Instituciones ON DatosEconomicos.InstitucionID = Instituciones.InstitucionID WHERE (Contratos.EstadoID = 1) AND (Contratos.Fecha <= @Hasta)";

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;

                if (SucursalID == -1)
                {
                    if (InstitucionID == -1)
                    {
                        cm.CommandText = query + " ORDER BY Contratos.ContratoID";
                    }
                    else
                    {
                        cm.CommandText = query + " AND DatosEconomicos.InstitucionID = @InstitucionID ORDER BY Contratos.ContratoID";
                        cm.Parameters.Add(new MySqlParameter("@InstitucionID", InstitucionID));
                    }
                }
                else
                {
                    if (InstitucionID == -1)
                    {
                        cm.CommandText = query + " AND Sucursales.SucursalID = @SucursalID ORDER BY Contratos.ContratoID";
                        cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                    }
                    else
                    {
                        cm.CommandText = query + " AND Sucursales.SucursalID = @SucursalID AND DatosEconomicos.InstitucionID = @InstitucionID ORDER BY Contratos.ContratoID";
                        cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                        cm.Parameters.Add(new MySqlParameter("@InstitucionID", InstitucionID));
                    }
                }
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                return new DataSet();
            }

        }

        public DataSet PrintListadoCobroGetByRutaID(DateTime Hasta, int SucursalID, int RutaID)
        {
            try
            {
                db = new DAL.Context();
                //DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));
                DateTime _Hasta = Hasta.Add(new TimeSpan(0, 0, 0));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string query = "SELECT Contratos.ContratoID, Contratos.Fecha, CAST(@Hasta as DateTime) AS Hasta, Contratos.Vence, CASE WHEN Contratos.VENCE < @Hasta THEN 'Si' ELSE '' END AS Vencido, Personas.Documento, CONCAT(Personas.Nombres, ' ', Personas.Apellidos) as Completo, Personas.Telefono, Personas.Celular, Solicitudes.Monto + Solicitudes.Monto * (Contratos.Comision / 100) * Solicitudes.Tiempo AS Monto, CASE WHEN CONTRATOS.tipoContratoID = 3 THEN (SELECT COUNT(CuotaID) AS Expr1 FROM Cuotas WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND ({ fn IFNULL(Capital + Comision + Interes + Mora + Legal, 0) } + { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaDebitos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR2 WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND estadoid = 1))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaCreditos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) }) > 1) ELSE ((SELECT COUNT(CuotaID) AS Expr1 FROM Cuotas WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND ({ fn IFNULL(Capital + Comision + Interes + Mora + Legal, 0) } + { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaDebitos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR2 WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND estadoID = 1))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaCreditos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) }) > 1)) END AS Cantidad, CASE WHEN CASE WHEN CONTRATOS.tipoContratoID = 3 THEN (SELECT IFNULL(SUM(Capital + Comision + Interes + Mora + Legal), 0) AS Expr1 FROM Cuotas WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND ({ fn IFNULL(Capital + Comision + Interes + Mora + Legal, 0) } + { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaDebitos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR2 WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID)))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaCreditos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) }) > 0) ELSE IFNULL((SELECT { fn IFNULL(SUM(Capital + Comision + interes + Mora + Legal), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR3 WHERE (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)), 0) END < 0 THEN 0 ELSE CASE WHEN CONTRATOS.tipoContratoID = 3 THEN (SELECT IFNULL(SUM(Capital + Comision + Interes + Mora + Legal), 0) AS Expr1 FROM Cuotas WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND ({ fn IFNULL(Capital + Comision + Interes + Mora + Legal, 0) } + { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaDebitos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR2 WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID)))), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaCreditos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))), 0) }) > 0) ELSE IFNULL((SELECT { fn IFNULL(SUM(Capital + Comision + Interes + Mora + Legal), 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR3 WHERE (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)), 0) END END AS Atraso, CASE WHEN Contratos.VENCE < @Hasta THEN 0 ELSE Contratos.Cuota END AS Cuota, CASE WHEN CASE WHEN CONTRATOS.tipoContratoID = 3 THEN (SELECT IFNULL(SUM(Capital + Comision + Interes + Mora + Legal) , 0) AS Expr1 FROM Cuotas WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND ({ fn IFNULL(Capital + Comision + Interes + Mora + Legal , 0) } + { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaDebitos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))) , 0) } - { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR2 WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID)))) , 0) } - { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaCreditos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))) , 0) }) > 0) ELSE IFNULL((SELECT { fn IFNULL(SUM(Capital + Comision + interes + Mora + Legal) , 0) } - { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR3 WHERE (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))) , 0) } AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)) , 0) END < 0 THEN 0 ELSE CASE WHEN CONTRATOS.tipoContratoID = 3 THEN (SELECT IFNULL(SUM(Capital + Comision + Interes + Mora + Legal) , 0) AS Expr1 FROM Cuotas WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND ({ fn IFNULL(Capital + Comision + Interes + Mora + Legal , 0) } + { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaDebitos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))) , 0) } - { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR2 WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID)))) , 0) } - { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleNotaCreditos WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS C1 WHERE (ContratoID = Contratos.ContratoID)))) , 0) }) > 0) ELSE IFNULL((SELECT { fn IFNULL(SUM(Capital + Comision + Interes + Mora + Legal) , 0) } - { fn IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Pagado FROM DetalleRecibos AS DR3 WHERE (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))) , 0) } AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)) , 0) END END + CASE WHEN Contratos.VENCE < @Hasta THEN 0 ELSE Contratos.Cuota END as Balance, Empresas.Empresa,  Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Empresas.Siglas, Sucursales.Sucursal, Sucursales.SucursalID, TipoSolicitudes.TipoSolicitud, Personas.Correo, Rutas.Ruta FROM Contratos INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID INNER JOIN Zonas ON Contratos.ZonaID = Zonas.ZonaID INNER JOIN Rutas ON Rutas.RutaID = Zonas.RutaID WHERE (Contratos.EstadoID = 1) AND (Contratos.Fecha <= @Hasta)";

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                if (SucursalID == -1)
                {
                    if (RutaID == -1)
                    {
                        cm.CommandText = query + " ORDER BY Contratos.ContratoID";
                    }
                    else
                    {
                        cm.CommandText = query + " AND Rutas.RutaID = @RutaID ORDER BY Contratos.ContratoID";
                        cm.Parameters.Add(new MySqlParameter("@RutaID", RutaID));
                    }
                }
                else
                {
                    if (RutaID == -1)
                    {
                        cm.CommandText = query + " AND Sucursales.SucursalID = @SucursalID ORDER BY Contratos.ContratoID";
                        cm.Parameters.Add(new MySqlParameter("@RutaID", RutaID));
                    }
                    else
                    {
                        cm.CommandText = query + " AND Sucursales.SucursalID = @SucursalID AND Rutas.RutaID = @RutaID ORDER BY Contratos.ContratoID";
                        cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                        cm.Parameters.Add(new MySqlParameter("@RutaID", RutaID));
                    }
                }
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                return new DataSet();
            }

        }
        public DataSet PrintCuentasPorCobrarEmpresasGetByFecha(DateTime Hasta, int SucursalID, int TipoSolicitudID, int RutaID, int InstitucionID)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string Where = "WHERE (Contratos.EstadoID = 1) AND (Contratos.Fecha <= @Hasta) ";

                if (SucursalID != -1)
                {
                    Where = string.Format("WHERE (Contratos.EstadoID = 1) AND (Contratos.Fecha <= @Hasta) AND (Clientes.SucursalID = {0})", SucursalID);
                }

                if (TipoSolicitudID != -1)
                {
                    Where = string.Format(Where + " AND (TipoSolicitudes.TipoSolicitudID = {0})", TipoSolicitudID);
                }

                if (RutaID != -1)
                {
                    Where = string.Format(Where + " AND (Contratos.RutaID = {0})", RutaID);
                }

                if (InstitucionID != -1)
                {
                    Where = string.Format(Where + " AND (Instituciones.InstitucionID = {0})", InstitucionID);
                }

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT DISTINCT Contratos.ContratoID, Instituciones.Institucion, CAST(@Hasta as DateTime) AS Hasta, Contratos.Fecha, Contratos.Vence, CASE WHEN Contratos.Vence < @Hasta THEN 'Si' ELSE '' END AS Vencido, TipoSolicitudes.TipoSolicitud, CONCAT(Personas.Nombres, ' ', Personas.Apellidos AS Cliente, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Empresas.Siglas, Sucursales.Sucursal, (SELECT SUM(Capital + Comision) AS Expr1 FROM Cuotas WHERE (ContratoID = Contratos.ContratoID)) + { fn IFNULL ((SELECT SUM(ND.Capital + ND.Comision) AS Expr1 FROM Cuotas AS C INNER JOIN DetalleNotaDebitos AS ND ON C.CuotaID = ND.CuotaID WHERE (C.ContratoID = Contratos.ContratoID)), 0) } AS Debitos, { fn IFNULL ((SELECT SUM(NC.Capital + NC.Comision) AS Expr1 FROM  Cuotas AS C INNER JOIN DetalleNotaCreditos AS NC ON C.CuotaID = NC.CuotaID WHERE (C.ContratoID = Contratos.ContratoID)), 0) } + { fn IFNULL ((SELECT  SUM(DR.Capital + DR.Comision) AS Expr1 FROM DetalleRecibos AS DR INNER JOIN Recibos AS R ON DR.ReciboID = R.ReciboID WHERE (R.EstadoID = 1) AND (R.ContratoID = Contratos.ContratoID)), 0) } AS Creditos FROM Sucursales INNER JOIN Clientes INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN Solicitudes ON Clientes.ClienteID = Solicitudes.ClienteID INNER JOIN Contratos ON Solicitudes.SolicitudID = Contratos.SolicitudID ON Sucursales.SucursalID = Clientes.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID INNER JOIN DatosEconomicos ON Personas.Documento = DatosEconomicos.Documento INNER JOIN Instituciones ON DatosEconomicos.InstitucionID = Instituciones.InstitucionID " + Where + " ORDER BY Contratos.ContratoID";

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "CuentasPorCobrar");
                cn.Close();

                return ds;
            }
            catch
            {
                return new DataSet();
            }

        }

        public DataSet PrintListadoAnalisisMorosidad(DateTime Hasta, int SucursalID, int RutaID, int OficialID)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string query = System.IO.File.ReadAllText(Environment.CurrentDirectory + "/Script/AnalisisMorosidad.txt");
                string where = string.Empty;

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = 43200;
                if (SucursalID != -1)
                {
                    query = query + " AND (Sucursales.SucursalID = @SucursalID)";
                    cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                }

                if (RutaID != -1)
                {
                    query = query + " AND (Zonas.RutaID = @RutaID)";
                    cm.Parameters.Add(new MySqlParameter("@RutaID", RutaID));
                }


                if (OficialID != -1)
                {
                    query = query + " AND (Contratos.OficialID = @OficialID)";
                    cm.Parameters.Add(new MySqlParameter("@OficialID", OficialID));
                }

                cm.CommandText = query + " ORDER BY Contratos.ContratoID;";

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }

        }

        public DataSet PrintListadoDataCreditoGetByFecha(DateTime Hasta, int SucursalID, int RutaID =-1)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string query = System.IO.File.ReadAllText(Environment.CurrentDirectory + "/Script/DataCreditoGetByFecha.txt");

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = 43200; 
                
                if(RutaID != -1)
                {
                    query = query + $" AND Zonas.RutaID = {RutaID} ";
                }

                if (SucursalID == -1)
                {
                    cm.CommandText = query + " ORDER BY ContratoID;";
                }
                else
                {
                    cm.CommandText = query + " AND (Sucursales.SucursalID = @SucursalID) ORDER BY ContratoID;";
                    cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                }



                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }

        }

        public DataSet PrintListadoTransUnionGetByFecha(DateTime Hasta, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string query = System.IO.File.ReadAllText(Environment.CurrentDirectory + "/Script/TransUnionGetByFecha.txt");

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = 43200;
                if (SucursalID == -1)
                {
                    cm.CommandText = query + " ORDER BY ContratoID;";
                }
                else
                {
                    cm.CommandText = query + " AND (Sucursales.SucursalID = @SucursalID) ORDER BY ContratoID;";
                    cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                }

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }

        }

        public List<BoxReportItem> EstadoCuentasGetByContratoID(int ContratoID)
        {
            try
            {
                db = new DAL.Context();

                var BE = (from r in db.clsRecibosBE.Where(x => x.ContratoID == ContratoID).Include(x => x.DetalleRecibos)
                          select new BoxReportItem
                          {
                              Numero = r.ReciboID,
                              Vence = r.Fecha,
                              Capital = r.DetalleRecibos.Sum(x => x.Capital),
                              Interes = r.DetalleRecibos.Sum(x => x.Interes),
                              Mora = r.DetalleRecibos.Sum(x => x.Mora) + r.DetalleRecibos.Sum(x => x.Legal) + r.DetalleRecibos.Sum(x => x.Seguro),
                              CuotaID = r.ReciboID,
                              IsComputed = r.EstadoID
                          }).ToList();

                List<BoxReportItem> result = new List<BoxReportItem>();
                foreach (var item in BE)
                {
                    clsCuotasView model = new clsCuotasView();
                    model.SetDataSource(ContratoID, item.CuotaID);

                    result.Add(new BoxReportItem
                    {
                        Numero = item.Numero,
                        Vence = item.Vence,
                        Capital = item.Capital,
                        Interes = item.Interes,
                        Mora = item.Mora,
                        Atraso = item.Capital + item.Interes + item.Mora,
                        IsComputed = item.IsComputed,
                        Balance = model.BalanceGetByReciboID()
                    }); ;
                }


                return result.OrderBy(x => x.Vence).ToList();
            }
            catch
            {
                return new List<BoxReportItem>();
            }
        }

        public DataSet PrintEstadoCuentasGetByContratoID(int ContratoID)
        {
            try
            {
                db = new DAL.Context();

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT Recibos.ReciboID, Recibos.Descuento,  Recibos.Fecha, Contratos.ContratoID, Contratos.Fecha AS FechaContrato, Contratos.Vence, Solicitudes.Monto, Personas.Documento, Personas.Nombres, Personas.Apellidos, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal, Ciudades.Ciudad, SUM(DetalleRecibos.Capital) AS Capital, SUM(DetalleRecibos.Comision) AS Comision, SUM(DetalleRecibos.Interes) AS Interes, SUM(DetalleRecibos.Mora) AS Mora, SUM(DetalleRecibos.Legal) AS Legal, SUM(DetalleRecibos.Seguro) AS Seguro, SUM(DetalleRecibos.SubTotal) AS SubTotal, Recibos.EstadoID FROM Recibos INNER JOIN DetalleRecibos ON Recibos.ReciboID = DetalleRecibos.ReciboID INNER JOIN Contratos ON Recibos.ContratoID = Contratos.ContratoID INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN Ciudades ON Personas.CiudadID = Ciudades.CiudadID Where Contratos.ContratoID = @ContratoID GROUP BY Recibos.ReciboID, Recibos.Fecha, Contratos.ContratoID, Contratos.Fecha, Contratos.Vence, Solicitudes.Monto, Personas.Documento, Personas.Nombres, Personas.Apellidos, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal, Ciudades.Ciudad, Recibos.EstadoID";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ContratoID", ContratoID));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Recibos");
                cn.Close();

                DataTable Header = new DataTable("Header");
                Header.Columns.Add("Fotografia", typeof(byte[]));
                Header.Columns.Add("BarCode", typeof(byte[]));
                DataRow dataRow = Header.NewRow();
                if (db.clsContratosBE.Where(x => x.ContratoID == ContratoID).FirstOrDefault().Solicitudes.Clientes.Personas.Fotografias != null)
                {
                    dataRow["Fotografia"] = (byte[])db.clsContratosBE.Where(x => x.ContratoID == ContratoID).FirstOrDefault().Solicitudes.Clientes.Personas.Fotografias.Foto == null ? null : (byte[])db.clsContratosBE.Where(x => x.ContratoID == ContratoID).FirstOrDefault().Solicitudes.Clientes.Personas.Fotografias.Foto; //ImageFromUrl(@"C:\Users\Stalin\Documents\App Developer\SoftArch\Payment Bank\Payment.Bank\Images\13335.png");// db.clsContratosBE.Where(x => x.ContratoID == ContratoID).FirstOrDefault().Solicitudes.Clientes.Personas.Fotografia);
                }
                dataRow["BarCode"] = ImageFromText(ContratoID.ToString());
                Header.Rows.Add(dataRow);

                ds.Tables.Add(Header);


                DataTable Balances = new DataTable("Balances");
                Balances.Columns.Add("ReciboID", typeof(int));
                Balances.Columns.Add("Balance", typeof(float));

                foreach (DataRow row in ds.Tables["Recibos"].Rows)
                {
                    DataRow dataRow1 = Balances.NewRow();

                    clsCuotasView Cuotas = new clsCuotasView();
                    Cuotas.SetDataSource(ContratoID, (int)row["ReciboID"]);
                    var result = Cuotas.GetGroup();
                    var balance = Cuotas.BalanceCapitalGetByReciboID();
                    dataRow1["ReciboID"] = row["ReciboID"];
                    dataRow1["Balance"] = balance;
                    Balances.Rows.Add(dataRow1);
                }

                ds.Tables.Add(Balances);

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }

        }

        public DataSet PrintContratosGetByContratoID(int ContratoID, bool IsPagare)
        {
            try
            {
                db = new DAL.Context();

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //Contratos
                cn.Open();
                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                if (IsPagare)
                {
                    cm.CommandText = "SELECT Contratos.ContratoID, Contratos.Fecha, Contratos.Vence, Solicitudes.Monto, Contratos.Acto, Solicitudes.Tiempo, Condiciones.Condicion, TipoSolicitudes.TipoSolicitud, Contratos.Interes, Contratos.Mora, Contratos.Comision, Contratos.Cuota, TipoContratos.TipoContratoID, TipoContratos.TipoContrato, Contratos.DiasGracia FROM Contratos INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Condiciones ON Solicitudes.CondicionID = Condiciones.CondicionID INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID INNER JOIN Cuotas ON Contratos.ContratoID = Cuotas.ContratoID INNER JOIN TipoContratos ON Contratos.TipoContratoID = TipoContratos.TipoContratoID Where Contratos.ContratoID = @ContratoID limit 1";
                }
                else
                {
                    cm.CommandText = "SELECT Contratos.ContratoID, Contratos.Fecha, Cuotas.Vence, Solicitudes.Monto, Contratos.Acto, Solicitudes.Tiempo, Condiciones.Condicion, TipoSolicitudes.TipoSolicitud, Contratos.Interes, Contratos.Mora, Contratos.Comision, Contratos.Cuota, TipoContratos.TipoContratoID, TipoContratos.TipoContrato, Contratos.DiasGracia FROM Contratos INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Condiciones ON Solicitudes.CondicionID = Condiciones.CondicionID INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID INNER JOIN Cuotas ON Contratos.ContratoID = Cuotas.ContratoID INNER JOIN TipoContratos ON Contratos.TipoContratoID = TipoContratos.TipoContratoID Where Contratos.ContratoID = @ContratoID limit 1";
                }
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ContratoID", ContratoID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                //Empresas
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Empresas.CSR, Ciudades.Ciudad, Provincias.Provincia, Paises.Pais FROM Empresas INNER JOIN Sucursales ON Empresas.EmpresaID = Sucursales.EmpresaID INNER JOIN Clientes ON Sucursales.SucursalID = Clientes.SucursalID INNER JOIN Solicitudes ON Clientes.ClienteID = Solicitudes.ClienteID INNER JOIN Contratos ON Solicitudes.SolicitudID = Contratos.SolicitudID INNER JOIN Ciudades ON Sucursales.CiudadID = Ciudades.CiudadID INNER JOIN Provincias ON Ciudades.ProvinciaID = Provincias.ProvinciaID INNER JOIN Paises ON Provincias.PaisID = Paises.PaisID Where Contratos.ContratoID = @ContratoID";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ContratoID", ContratoID));
                da.SelectCommand = cm;
                da.Fill(ds, "Empresas");
                cn.Close();

                //Clientes
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT Personas.Documento, Personas.Nombres, Personas.Apellidos, Personas.Direccion, Sexos.Sexo, EstadosCiviles.EstadoCivil, Ciudades.Ciudad, Provincias.Provincia, Paises.Pais,  Personas.Celular FROM Contratos INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN Ciudades ON Personas.CiudadID = Ciudades.CiudadID INNER JOIN EstadosCiviles ON Personas.EstadoCivilID = EstadosCiviles.EstadoCivilID INNER JOIN Provincias ON Ciudades.ProvinciaID = Provincias.ProvinciaID INNER JOIN Paises ON Provincias.PaisID = Paises.PaisID INNER JOIN Sexos ON Personas.SexoID = Sexos.SexoID Where Contratos.ContratoID = @ContratoID";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ContratoID", ContratoID));
                da.SelectCommand = cm;
                da.Fill(ds, "Clientes");
                cn.Close();

                //Gerentes
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT Personas.Documento, Personas.Nombres, Personas.Apellidos, Personas.Direccion, Ciudades.Ciudad, Provincias.Provincia, Paises.Pais, EstadosCiviles.EstadoCivil FROM EstadosCiviles INNER JOIN Empresas INNER JOIN Sucursales ON Empresas.EmpresaID = Sucursales.EmpresaID INNER JOIN Gerentes ON Sucursales.Documento = Gerentes.Documento INNER JOIN Personas ON Gerentes.Documento = Personas.Documento INNER JOIN Clientes ON Sucursales.SucursalID = Clientes.SucursalID INNER JOIN Solicitudes ON Clientes.ClienteID = Solicitudes.ClienteID INNER JOIN Contratos ON Solicitudes.SolicitudID = Contratos.SolicitudID ON EstadosCiviles.EstadoCivilID = Personas.EstadoCivilID INNER JOIN Ciudades ON Personas.CiudadID = Ciudades.CiudadID INNER JOIN Provincias INNER JOIN Paises ON Provincias.PaisID = Paises.PaisID ON Ciudades.ProvinciaID = Provincias.ProvinciaID Where Contratos.ContratoID = @ContratoID";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ContratoID", ContratoID));
                da.SelectCommand = cm;
                da.Fill(ds, "Gerentes");
                cn.Close();

                //Notarios
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT Personas.Documento, Personas.Nombres, Personas.Telefono, Personas.Celular, Personas.Apellidos, NotariosPublico.Direccion, Ciudades.Ciudad, Provincias.Provincia, Paises.Pais, NotariosPublico.DocumentoPrimerTestigo, NotariosPublico.NombrePrimerTestigo, NotariosPublico.DireccionPrimerTestigo, NotariosPublico.DocumentoSegundoTestigo, NotariosPublico.NombreSegundoTestigo, NotariosPublico.DireccionSegundoTestigo, NotariosPublico.Exequatur, EstadosCiviles.EstadoCivil FROM Contratos INNER JOIN NotariosPublico ON Contratos.NotarioPublicoID = NotariosPublico.NotarioPublicoID INNER JOIN Personas ON NotariosPublico.Documento = Personas.Documento INNER JOIN Ciudades ON Personas.CiudadID = Ciudades.CiudadID INNER JOIN Provincias ON Ciudades.ProvinciaID = Provincias.ProvinciaID INNER JOIN Paises ON Provincias.PaisID = Paises.PaisID INNER JOIN EstadosCiviles ON Personas.EstadoCivilID = EstadosCiviles.EstadoCivilID Where Contratos.ContratoID = @ContratoID";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ContratoID", ContratoID));
                da.SelectCommand = cm;
                da.Fill(ds, "NotariosPublico");
                cn.Close();

                //SecureData
                DataTable SecureData = new DataTable("SecureData");
                SecureData.Columns.Add("ContratoID", typeof(int));
                SecureData.Columns.Add("BarCode", typeof(byte[]));
                SecureData.Columns.Add("QrCode", typeof(byte[]));
                DataRow dataRow = SecureData.NewRow();
                dataRow["ContratoID"] = ContratoID;
                dataRow["BarCode"] = ImageFromText(ContratoID.ToString());
                dataRow["QrCode"] = TextToQrCode(ContratoID.ToString());
                SecureData.Rows.Add(dataRow);

                ds.Tables.Add(SecureData);

                //GarantiaPersonal
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT Personas.Documento, Personas.Nombres, Personas.Apellidos, Personas.Direccion, Ciudades.Ciudad, Sexos.Sexo, EstadosCiviles.EstadoCivil FROM Garantes INNER JOIN Personas ON Garantes.Documento = Personas.Documento INNER JOIN Ciudades ON Personas.CiudadID = Ciudades.CiudadID INNER JOIN Sexos ON Personas.SexoID = Sexos.SexoID INNER JOIN EstadosCiviles ON Personas.EstadoCivilID = EstadosCiviles.EstadoCivilID INNER JOIN GarantiaPersonal ON Garantes.Documento = GarantiaPersonal.Documento INNER JOIN Solicitudes ON GarantiaPersonal.SolicitudID = Solicitudes.SolicitudID INNER JOIN Contratos ON Solicitudes.SolicitudID = Contratos.SolicitudID WHERE (Contratos.ContratoID = @ContratoID)";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ContratoID", ContratoID));
                da.SelectCommand = cm;
                da.Fill(ds, "GarantiaPersonal");
                cn.Close();

                //GarantiaHipotecaria
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT GarantiaHipotecaria.SolicitudID, GarantiaHipotecaria.Fecha, GarantiaHipotecaria.Descripcion, GarantiaHipotecaria.Monto, GarantiaHipotecaria.Usuario, GarantiaHipotecaria.ModificadoPor, GarantiaHipotecaria.FechaModificacion FROM GarantiaHipotecaria INNER JOIN Solicitudes ON GarantiaHipotecaria.SolicitudID = Solicitudes.SolicitudID INNER JOIN Contratos ON Solicitudes.SolicitudID = Contratos.SolicitudID WHERE (Contratos.ContratoID = @ContratoID)";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ContratoID", ContratoID));
                da.SelectCommand = cm;
                da.Fill(ds, "GarantiaHipotecaria");
                cn.Close();


                //GarantiaVehiculos
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT TipoVehiculos.TipoVehiculo, Modelos.Modelo, Marcas.Marca, Colores.Color, GarantiaVehiculos.Placa, GarantiaVehiculos.Chasis, GarantiaVehiculos.Registro, GarantiaVehiculos.FechaExpedicion, GarantiaVehiculos.Ano FROM GarantiaVehiculos INNER JOIN TipoVehiculos ON GarantiaVehiculos.TipoVehiculoID = TipoVehiculos.TipoVehiculoID INNER JOIN Modelos ON GarantiaVehiculos.ModeloID = Modelos.ModeloID INNER JOIN Marcas ON Modelos.MarcaID = Marcas.MarcaID INNER JOIN Colores ON GarantiaVehiculos.ColorID = Colores.ColorID INNER JOIN Solicitudes ON GarantiaVehiculos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Contratos ON Solicitudes.SolicitudID = Contratos.SolicitudID WHERE (Contratos.ContratoID = @ContratoID)";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ContratoID", ContratoID));
                da.SelectCommand = cm;
                da.Fill(ds, "GarantiaVehiculos");
                cn.Close();

                //Garantia Tarjetas
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT GarantiaTarjetas.SolicitudID, GarantiaTarjetas.Fecha, GarantiaTarjetas.Holder, GarantiaTarjetas.Numero, GarantiaTarjetas.Mes, GarantiaTarjetas.Ano, GarantiaTarjetas.Cvv, GarantiaTarjetas.Usuario, GarantiaTarjetas.ModificadoPor, GarantiaTarjetas.FechaModificacion FROM GarantiaTarjetas INNER JOIN Solicitudes ON GarantiaTarjetas.SolicitudID = Solicitudes.SolicitudID INNER JOIN Contratos ON Solicitudes.SolicitudID = Contratos.SolicitudID WHERE (Contratos.ContratoID = @ContratoID)";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ContratoID", ContratoID));
                da.SelectCommand = cm;
                da.Fill(ds, "GarantiaTarjetas");
                cn.Close();


                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }

        }


        public DataSet PrintContratosVencidasGetByFecha(DateTime Hasta, int SucursalID, int TipoSolicitudID, bool Interes)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string Where = "WHERE (Contratos.EstadoID = 1) AND (Contratos.Fecha <= @Hasta) AND CASE WHEN Contratos.Vence < @Hasta THEN 'Si' ELSE '' END = 'Si' ";
                if (SucursalID != -1)
                {
                    Where = string.Format("WHERE (Contratos.EstadoID = 1) AND (Contratos.Fecha < @Hasta) AND CASE WHEN Contratos.Vence < @Hasta THEN 'Si' ELSE '' END <> '' AND  (Clientes.SucursalID = {0})", SucursalID);
                }

                if (TipoSolicitudID != -1)
                {
                    Where = string.Format(Where + " AND (TipoSolicitudes.TipoSolicitudID = {0})", TipoSolicitudID);
                }

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                if (Interes == true)
                {
                    cm.CommandText = "SELECT Contratos.ContratoID, CAST(@Hasta as DateTime) AS Hasta, Contratos.Fecha, Contratos.Vence, CASE WHEN Contratos.Vence < @Hasta THEN 'Si' ELSE '' END AS Vencido, TipoSolicitudes.TipoSolicitud, CONCAT(Personas.Nombres, ' ', Personas.Apellidos) AS Cliente, SUM(Cuotas.Capital + Cuotas.Interes + Cuotas.Comision) + IFNULL(SUM(DetalleNotaDebitos.Capital + DetalleNotaDebitos.Interes + DetalleNotaDebitos.Comision), 0) AS Debitos, IFNULL(Creditos.Monto, 0) + IFNULL(SUM(DetalleNotaCreditos.Capital + DetalleNotaCreditos.Interes + DetalleNotaCreditos.Comision ), 0) AS Creditos, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Empresas.Siglas, Sucursales.Sucursal FROM Sucursales INNER JOIN Clientes INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN Solicitudes ON Clientes.ClienteID = Solicitudes.ClienteID INNER JOIN Contratos ON Solicitudes.SolicitudID = Contratos.SolicitudID INNER JOIN Cuotas ON Contratos.ContratoID = Cuotas.ContratoID ON Sucursales.SucursalID = Clientes.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID LEFT OUTER JOIN DetalleNotaCreditos ON Cuotas.CuotaID = DetalleNotaCreditos.CuotaID LEFT OUTER JOIN (SELECT R.ContratoID, SUM(DR.Capital + DR.Comision + DR.Interes ) AS Monto FROM DetalleRecibos AS DR INNER JOIN Recibos AS R ON DR.ReciboID = R.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) GROUP BY R.ContratoID) AS Creditos ON Contratos.ContratoID = Creditos.ContratoID LEFT OUTER JOIN DetalleNotaDebitos ON Cuotas.CuotaID = DetalleNotaDebitos.CuotaID " + Where + " GROUP BY Contratos.ContratoID, Contratos.Fecha, CONCAT(Personas.Nombres, ' ', Personas.Apellidos), Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Empresas.Siglas, Sucursales.Sucursal, CASE WHEN Contratos.Vence < @Hasta THEN 'Si' ELSE '' END, TipoSolicitudes.TipoSolicitud, Creditos.Monto, Contratos.Vence ORDER BY Contratos.ContratoID";

                }
                else
                {
                    cm.CommandText = "SELECT Contratos.ContratoID, CAST(@Hasta as DateTime) AS Hasta, Contratos.Fecha, Contratos.Vence, CASE WHEN Contratos.Vence < @Hasta THEN 'Si' ELSE '' END AS Vencido, TipoSolicitudes.TipoSolicitud, CONCAT(Personas.Nombres, ' ', Personas.Apellidos) AS Cliente,   Solicitudes.Monto * Contratos.Comision / 100  + Solicitudes.Monto  + IFNULL(SUM(DetalleNotaDebitos.Capital +  DetalleNotaDebitos.Comision ), 0) AS Debitos, IFNULL(Creditos.Monto, 0) + IFNULL(SUM(DetalleNotaCreditos.Capital + DetalleNotaCreditos.Comision), 0) AS Creditos, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Empresas.Siglas, Sucursales.Sucursal FROM Sucursales INNER JOIN Clientes INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN Solicitudes ON Clientes.ClienteID = Solicitudes.ClienteID INNER JOIN Contratos ON Solicitudes.SolicitudID = Contratos.SolicitudID INNER JOIN Cuotas ON Contratos.ContratoID = Cuotas.ContratoID ON Sucursales.SucursalID = Clientes.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID LEFT OUTER JOIN DetalleNotaCreditos ON Cuotas.CuotaID = DetalleNotaCreditos.CuotaID LEFT OUTER JOIN (SELECT R.ContratoID, SUM(DR.Capital + DR.Comision) AS Monto FROM DetalleRecibos AS DR INNER JOIN Recibos AS R ON DR.ReciboID = R.ReciboID WHERE (R.EstadoID = 1)  AND (R.Fecha <= @Hasta) GROUP BY R.ContratoID) AS Creditos ON Contratos.ContratoID = Creditos.ContratoID LEFT OUTER JOIN DetalleNotaDebitos ON Cuotas.CuotaID = DetalleNotaDebitos.CuotaID " + Where + " GROUP BY Contratos.ContratoID, Contratos.Fecha, CONCAT(Personas.Nombres, ' ', Personas.Apellidos), Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Empresas.Siglas, Sucursales.Sucursal, CASE WHEN Contratos.Vence < @Hasta THEN 'Si' ELSE '' END, TipoSolicitudes.TipoSolicitud,  Solicitudes.Monto * Contratos.Comision / 100 * Solicitudes.Tiempo + Solicitudes.Monto , Creditos.Monto, Contratos.Vence ORDER BY Contratos.ContratoID";
                }

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "CuentasPorCobrar");
                cn.Close();

                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }

        public DataSet PrintCuentasPorCobrarInmuebles(DateTime Hasta, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                int MesID = _Hasta.Month;
                int AnoID = _Hasta.Year;

                string Where = "WHERE (Alquileres.EstadoID = 1) AND (Rentas.Fecha <= @Hasta) and (rentas.Monto - IFNULL(Creditos.Monto, 0)) > 0 ";

                if (SucursalID != -1)
                {
                    Where = Where + string.Format(" AND (Sucursales.SucursalID = {0})", SucursalID);
                }


                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;

                cm.CommandText = "SELECT rentas.RentaID, @Hasta AS Hasta, personas.Documento, personas.Nombres, personas.Apellidos, personas.Telefono, personas.Celular, rentas.Concepto, rentas.Monto - IFNULL(Creditos.Monto, 0) AS Monto, empresas.Empresa, sucursales.Sucursal, sucursales.Direccion, sucursales.Telefonos, empresas.Rnc FROM empresas INNER JOIN sucursales ON empresas.EmpresaID = sucursales.EmpresaID INNER JOIN notariospublico ON sucursales.SucursalID = notariospublico.SucursalID INNER JOIN rentas INNER JOIN alquileres ON rentas.AlquilerID = alquileres.AlquilerID INNER JOIN personas ON alquileres.Documento = personas.Documento ON notariospublico.NotarioPublicoID = alquileres.NotarioPublicoID LEFT OUTER JOIN (SELECT DPR.RentaID, SUM(DPR.Monto) AS Monto FROM detallepagorentas DPR INNER JOIN pagorentas PR ON DPR.PagoRentaID = PR.PagoRentaID WHERE (PR.EstadoID = 1) GROUP BY DPR.RentaID) Creditos ON rentas.RentaID = Creditos.RentaID " + Where + " ORDER BY Rentas.RentaID";

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Rentas");
                cn.Close();

                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }

        public DataSet PrintCuentasPorCobrar(DateTime Hasta, int SucursalID, int TipoSolicitudID, int RutaID, string OrderBy)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string Where = " AND Contratos.EstadoID Between 1 and 2 AND (Contratos.Fecha <= @Hasta) ";

                if (SucursalID != -1)
                {
                    Where = string.Format(" AND Contratos.EstadoID Between 1 and 2 AND (Clientes.SucursalID = {0}) ", SucursalID);
                }

                if (TipoSolicitudID != -1)
                {
                    Where = string.Format(Where + " AND (Solicitudes.TipoSolicitudID = {0}) ", TipoSolicitudID);
                }

                if (RutaID != -1)
                {
                    Where = string.Format(Where + " AND (Zonas.RutaID = {0}) ", RutaID);
                }


                string exePath = AppDomain.CurrentDomain.BaseDirectory;

                string query = System.IO.File.ReadAllText(AppDomain.CurrentDomain.BaseDirectory + "/Script/CuentasPorCobrarGetByFecha.txt");

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = 43200;
                cm.CommandText = query + " " + Where + " " + OrderBy;

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                return ds;
            }
            catch(Exception ex)
            {
                return new DataSet();
            }
        }

        public DataSet PrintAntiguedadSaldosGetByFecha(DateTime Hasta, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string Where = "WHERE (Contratos.EstadoID = 1) AND (Contratos.Fecha <= @Hasta) ORDER BY Contratos.ContratoID"; //WHERE (Contratos.EstadoID = 1) ORDER BY Contratos.ContratoID

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                if (SucursalID != -1)
                {
                    cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                    Where = string.Format("WHERE (Contratos.EstadoID = 1) AND (Contratos.Fecha <= @Hasta) AND (Clientes.SucursalID = {0}) ORDER BY Contratos.ContratoID", SucursalID);
                }

                cm.CommandText = "SELECT CAST(@Hasta as DateTime) AS Hasta, Contratos.ContratoID, Contratos.Fecha, Contratos.Vence, Personas.Telefono, CONCAT(Personas.Nombres, ' ', Personas.Apellidos) AS Cliente, CASE WHEN DATEDIFF(CUOTAS.VENCE, @Hasta) <= 0 THEN CASE WHEN { fn IFNULL(Cuotas.Capital + Cuotas.Comision, 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision) AS CPagado FROM DetalleRecibos WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } < 0 THEN 0 ELSE { fn IFNULL(Cuotas.Capital + Cuotas.Comision, 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision) AS CPagado FROM DetalleRecibos WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } END ELSE 0 END AS ENTRE0Y30, CASE WHEN DATEDIFF(CUOTAS.VENCE, @Hasta) > 0 AND DATEDIFF(CUOTAS.VENCE, @Hasta) <= 30 THEN CASE WHEN { fn IFNULL(Cuotas.Capital + Cuotas.Comision, 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision) AS CPagado FROM DetalleRecibos WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } < 0 THEN 0 ELSE { fn IFNULL(Cuotas.Capital + Cuotas.Comision, 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision) AS CPagado FROM DetalleRecibos WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } END ELSE 0 END AS ENTRE31Y60, CASE WHEN DATEDIFF(CUOTAS.VENCE, @Hasta) >= 31 AND DATEDIFF(CUOTAS.VENCE, @Hasta) <= 60 THEN CASE WHEN { fn IFNULL(Cuotas.Capital + Cuotas.Comision, 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision) AS CPagado FROM DetalleRecibos WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } < 0 THEN 0 ELSE { fn IFNULL(Cuotas.Capital + Cuotas.Comision, 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision) AS CPagado FROM DetalleRecibos WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } END ELSE 0 END AS ENTRE61Y90, CASE WHEN DATEDIFF(CUOTAS.VENCE, @Hasta) >= 61 THEN CASE WHEN { fn IFNULL(Cuotas.Capital + Cuotas.Comision, 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision) AS CPagado FROM  DetalleRecibos WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } < 0 THEN 0 ELSE { fn IFNULL(Cuotas.Capital + Cuotas.Comision, 0) } - { fn IFNULL ((SELECT SUM(Capital + Comision) AS CPagado FROM  DetalleRecibos WHERE (CuotaID = Cuotas.CuotaID) AND (ReciboID IN (SELECT ReciboID FROM Recibos WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } END ELSE 0 END AS MAS90, CASE WHEN (Solicitudes.Monto + ((Solicitudes.Monto * Contratos.Comision / 100) * Solicitudes.Tiempo)) - { fn IFNULL ((SELECT SUM(Capital + Comision) AS Capital FROM DetalleRecibos AS DetalleRecibos_1 WHERE (ReciboID IN (SELECT ReciboID FROM Recibos AS Recibos_1 WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } < 0 THEN 0 ELSE (Solicitudes.Monto + ((Solicitudes.Monto * Contratos.Comision / 100) * Solicitudes.Tiempo)) - { fn IFNULL ((SELECT SUM(Capital + comision) AS Capital FROM DetalleRecibos AS DetalleRecibos_1 WHERE (ReciboID IN (SELECT ReciboID FROM Recibos AS Recibos_1 WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } END AS Balance, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal FROM Contratos INNER JOIN Cuotas ON Contratos.ContratoID = Cuotas.ContratoID INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID " + Where;

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }

        public DataSet PrintRelacionIngresosInmueblesGetByFecha(DateTime Desde, DateTime Hasta, int SucursalID, string Documento)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string Where = "WHERE (PagoRentas.Fecha BETWEEN @Desde AND @Hasta)";
                if (SucursalID != -1)
                {
                    Where = string.Format("WHERE (PagoRentas.Fecha BETWEEN @Desde AND @Hasta) AND (PagoRentas.SucursalID = {0}) ", SucursalID);
                }

                if (Documento != "-1")
                {
                    Where = string.Format(Where + " AND (PagoRentas.Usuario = '{0}') ", Documento);
                }

                //if (RutaID != -1)
                //{
                //    Where = string.Format(Where + " AND (Contratos.RutaID = '{0}') ", RutaID);
                //}

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT  CAST(@Desde as DateTime) AS Desde, CAST(@Hasta as DateTime) AS Hasta, pagorentas.PagoRentaID, pagorentas.Fecha, CASE WHEN pagorentas.EstadoID = 1 THEN  pagorentas.SubTotal else 0 end as SubTotal, CASE WHEN pagorentas.EstadoID = 1 THEN  pagorentas.Descuento else 0 end as Descuento, CASE WHEN pagorentas.EstadoID = 1 THEN  pagorentas.Monto else 0 end as Monto, pagorentas.EstadoID, sucursales.Sucursal, sucursales.Direccion, sucursales.Telefonos, empresas.Empresa, empresas.Rnc, empresas.Siglas, personas.Nombres, personas.Apellidos, formapagos.Nombre AS FormaPago, pagorentas.Usuario FROM pagorentas INNER JOIN sucursales ON pagorentas.SucursalID = sucursales.SucursalID INNER JOIN empresas ON sucursales.EmpresaID = empresas.EmpresaID INNER JOIN alquileres ON pagorentas.AlquilerID = alquileres.AlquilerID INNER JOIN personas ON alquileres.Documento = personas.Documento INNER JOIN formapagos ON pagorentas.FormaPagoID = formapagos.FormaPagoID " + Where + " ORDER BY pagorentas.pagorentaID ";

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "PagoRentas");
                cn.Close();

                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }

        public DataSet PrintRelacionIngresosGetByFecha(DateTime Desde, DateTime Hasta, int SucursalID, string Documento, int RutaID, int FormaPagoID, bool Eliminados, bool Saldos, int OficialID =-1)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                string orderBy = " ORDER BY Recibos.ReciboID;";
                string Where = "WHERE (Recibos.Fecha BETWEEN @Desde AND @Hasta)";
                if (SucursalID != -1)
                {
                    Where = string.Format("WHERE (Recibos.Fecha BETWEEN @Desde AND @Hasta) AND (Recibos.SucursalID = {0}) ", SucursalID);
                }

                if (Documento != "-1")
                {
                    Where = string.Format(Where + " AND (Recibos.Usuario = '{0}') ", Documento);
                }

                if (OficialID !=-1)
                {
                    Where = string.Format(Where + " AND (Contratos.OficialID = '{0}') ", OficialID);
                }

                if (RutaID != -1)
                {
                    Where = string.Format(Where + " AND (Zonas.RutaID = '{0}') ", RutaID);
                }

                if (FormaPagoID != -1)
                {
                    Where = string.Format(Where + " AND (Recibos.FormaPagoID = '{0}') ", FormaPagoID);
                }

                if (Eliminados == true)
                {
                    int EstadoID = 0;
                    Where = string.Format(Where + " AND (Recibos.EstadoID = '{0}') ", EstadoID);
                }

                if (Saldos == true)
                {
                    cn.Open();
                    MySqlCommand cmd1 = new MySqlCommand();
                    cmd1.CommandText = "SELECT ReciboID, ContratoID from Recibos Where EstadoID = 1 and Fecha Between @Desde and @Hasta;";
                    cmd1.CommandType = CommandType.Text;
                    cmd1.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                    cmd1.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                    cmd1.Connection = cn;

                    string numeros = string.Empty;
                    MySqlDataReader drPersonas = cmd1.ExecuteReader();
                    while (drPersonas.Read())
                    {
                        clsCuotasView Cuotas = new clsCuotasView();
                        Cuotas.SetDataSource(int.Parse(drPersonas["ContratoID"].ToString()), int.Parse(drPersonas["ReciboID"].ToString()));
                        var result = Cuotas.GetGroup();
                        float balance = Cuotas.BalanceGetByReciboID();
                        if (balance <= 1)
                        {
                            numeros = numeros + int.Parse(drPersonas["ReciboID"].ToString()) + ", ";
                        }
                    }

                    cn.Close();

                    var text = numeros.Substring(0, numeros.Length - 2);


                    Where = string.Format(Where + " AND (Recibos.ReciboID in ({0})) ", text);
                    //orderBy = "";
                }

                cn.Open();
                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT  CAST(@Desde as DateTime) AS Desde, CAST(@Hasta as DateTime) AS Hasta, oficiales.Porciento, Recibos.ReciboID, Recibos.Fecha, Personas.Nombres, Personas.Apellidos, FormaPagos.Nombre AS FormaPago, CASE WHEN Recibos.EstadoID = 1 THEN (SELECT SUM(Capital) AS Expr1 FROM DetalleRecibos AS DR WHERE (ReciboID = Recibos.ReciboID)) ELSE 0 END AS Capital, CASE WHEN Recibos.EstadoID = 1 THEN (SELECT SUM(Interes) AS Expr1 FROM DetalleRecibos AS DR WHERE (ReciboID = Recibos.ReciboID)) ELSE 0 END AS Interes, CASE WHEN Recibos.EstadoID = 1 THEN (SELECT SUM(Comision) AS Expr1 FROM DetalleRecibos AS DR WHERE (ReciboID = Recibos.ReciboID)) ELSE 0 END AS Comision, CASE WHEN Recibos.EstadoID = 1 THEN (SELECT SUM(Mora) AS Expr1 FROM DetalleRecibos AS DR WHERE (ReciboID = Recibos.ReciboID)) ELSE 0 END AS Mora, CASE WHEN Recibos.EstadoID = 1 THEN (SELECT SUM(Legal) AS Expr1 FROM DetalleRecibos AS DR WHERE (ReciboID = Recibos.ReciboID)) ELSE 0 END AS Legal, CASE WHEN Recibos.EstadoID = 1 THEN (SELECT SUM(Seguro) AS Expr1 FROM DetalleRecibos AS DR WHERE (ReciboID = Recibos.ReciboID)) ELSE 0 END AS Seguro, CASE WHEN Recibos.EstadoID = 1 THEN Recibos.SubTotal ELSE 0 END AS SubTotal, CASE WHEN Recibos.EstadoID = 1 THEN Recibos.Descuento ELSE 0 END AS Descuento, CASE WHEN Recibos.EstadoID = 1 THEN Recibos.Monto ELSE 0 END AS Monto, TipoSolicitudes.TipoSolicitud, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal, (SELECT CONCAT(Nombres, ' ', Apellidos) as Cajero from Personas as P Where Documento = Recibos.Usuario ) as Cajero, (SELECT CONCAT(Nombres, ' ', Apellidos) as Oficial from Personas as P Where Documento = Oficiales.Documento ) as Oficial FROM Oficiales INNER JOIN Recibos INNER JOIN FormaPagos ON Recibos.FormaPagoID = FormaPagos.FormaPagoID INNER JOIN Contratos ON Recibos.ContratoID = Contratos.ContratoID INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID ON Oficiales.OficialID = Contratos.OficialID INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID INNER JOIN Personas INNER JOIN Clientes ON Personas.Documento = Clientes.Documento ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Sucursales ON Recibos.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID  INNER JOIN Zonas ON Contratos.ZonaID = Zonas.ZonaID INNER JOIN Rutas ON Rutas.RutaID = Zonas.RutaID " + Where + $" {orderBy}";

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Recibos");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }


        public DataSet PrintRenovacionGetByCuota(int Cantidad, int SucursalID, int OficialID, int RutaID)
        {
            try
            {
                db = new DAL.Context();

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                string orderBy = " ORDER BY Co.ContratoID;";
                string Where = "WHERE (Co.EstadoID = 1)";
                if (SucursalID != -1)
                {
                    Where = string.Format("WHERE (Co.EstadoID = 1) and (Cl.SucursalID = {0}) ", SucursalID);
                }

                if (OficialID != -1)
                {
                    Where = string.Format(Where + " AND (Co.OficialID = '{0}') ", OficialID);
                }

                if (RutaID != -1)
                {
                    Where = string.Format(Where + " AND (Zonas.RutaID = '{0}') ", RutaID);
                }

                Where = Where + $" AND (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Co.ContratoID) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0)  - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID = C.CuotaID)) <1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID = C.CuotaID)) END, 0)  - IFNULL(CASE WHEN (SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)) END, 0) > 1))  <= {Cantidad}";

                cn.Open();
                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT  E.Empresa, Suc.Direccion, Suc.Telefonos, E.Rnc, Suc.Sucursal, Co.ContratoID, Co.Fecha, P.Documento, ucase(P.Nombres) AS Nombres, ucase(p.Apellidos) as Apellidos, P.Telefono, P.Celular, S.Tiempo, Condicion, (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Co.ContratoID) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0)  - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID = C.CuotaID)) <1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)) END, 0) > 1)) AS Cantidad, round(IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Co.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Co.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Co.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Co.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Co.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Co.ContratoID) ) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Co.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Co.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Co.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Co.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Co.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Co.ContratoID) ) END, 0), 2) AS Balance, ucase(Concat(P1.Nombres, p1.Apellidos)) as Oficial, Rutas.Ruta FROM  Contratos AS Co INNER JOIN Solicitudes AS S ON Co.SolicitudID = S.SolicitudID INNER JOIN Clientes AS Cl ON Cl.ClienteID = S.ClienteID INNER JOIN Personas AS P ON P.Documento = Cl.Documento INNER JOIN Sucursales as Suc ON Suc.SucursalID = Cl.SucursalID INNER JOIN Empresas as E ON E.EmpresaID = Suc.EmpresaID INNER JOIN Oficiales as A ON A.OficialID = Co.OficialID INNER JOIN Personas as P1  On P1.Documento = A.Documento INNER JOIN TipoSolicitudes as TS ON Ts.TipoSolicitudID = S.TipoSolicitudID INNER JOIN Condiciones On Condiciones.CondicionID = S.CondicionID  INNER JOIN Zonas ON co.ZonaID = Zonas.ZonaID INNER JOIN Rutas ON Rutas.RutaID = Zonas.RutaID " + Where + $" {orderBy}";

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                //cm.Parameters.Add(new MySqlParameter("@Hasta", Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }

        public DataSet PrintListadoComisionesGetByFecha(DateTime Desde, DateTime Hasta, int SucursalID, int OficialID)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string Where = "WHERE (Contratos.EstadoID BETWEEN 1 AND 2) AND (Contratos.EstadoID = 1) AND (Contratos.Fecha BETWEEN @Desde AND @Hasta)";

                if (SucursalID != -1)
                {
                    Where = string.Format("WHERE (Contratos.EstadoID BETWEEN 1 AND 2) AND (Contratos.Fecha BETWEEN @Desde AND @Hasta) AND (Clientes.SucursalID = {0})", SucursalID);
                }

                if (OficialID != -1)
                {
                    Where = Where + string.Format(" AND (Contratos.OficialID = {0})", OficialID);
                }

                MySqlCommand cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT Contratos.ContratoID, Contratos.Fecha, CAST(@Desde as DateTime) AS Desde, CAST(@Hasta as DateTime) AS Hasta, Contratos.Vence, Contratos.Comision, Clientes.Documento, Personas.Nombres, Personas.Apellidos, TipoSolicitudes.TipoSolicitud, Solicitudes.Monto, Solicitudes.Tiempo, Condiciones.Condicion, CONCAT(P.Nombres, ' ', P.Apellidos) AS Oficial, Sucursales.Sucursal, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Empresas.Siglas FROM Contratos INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID INNER JOIN Condiciones ON Solicitudes.CondicionID = Condiciones.CondicionID INNER JOIN Oficiales ON Contratos.OficialID = Oficiales.OficialID INNER JOIN Personas AS P ON Oficiales.Documento = P.Documento INNER JOIN Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID " + Where + " Order By Contratos.ContratoID";

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }

        public DataSet PrintRelacionContratosGetByFecha(DateTime Desde, DateTime Hasta, int SucursalID, int OficialID, int RutaID, int ObjetivoID)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string Where = "WHERE (Contratos.EstadoID BETWEEN 1 AND 2) AND (Contratos.EstadoID = 1) AND (Contratos.Fecha BETWEEN @Desde AND @Hasta)";

                if (SucursalID != -1)
                {
                    Where = string.Format("WHERE (Contratos.EstadoID BETWEEN 1 AND 2) AND (Contratos.Fecha BETWEEN @Desde AND @Hasta) AND (Clientes.SucursalID = {0})", SucursalID);
                }

                if (OficialID != -1)
                {
                    Where = Where + string.Format(" AND (Contratos.OficialID = {0})", OficialID);
                }

                if (RutaID != -1)
                {
                    Where = Where + string.Format(" AND (Zonas.RutaID = {0})", RutaID);
                }

                if (ObjetivoID != -1)
                {
                    Where = Where + string.Format(" AND (Contratos.ObjetivoID = {0})", ObjetivoID);
                }


                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "SELECT Contratos.ContratoID, Contratos.Fecha, CAST(@Desde as DateTime) AS Desde, CAST(@Hasta as DateTime) AS Hasta, Contratos.Vence, Clientes.Documento, Personas.Nombres, Personas.Apellidos, TipoSolicitudes.TipoSolicitud, round( Contratos.Legal/100 * Solicitudes.Monto,0) as Legal,  round(Contratos.Comision/100 * Solicitudes.Monto,0) as Comision, Contratos.Interes, Solicitudes.Monto, Solicitudes.Tiempo, Condiciones.Condicion, CONCAT(P.Nombres, ' ', P.Apellidos) AS Oficial, Sucursales.Sucursal, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Empresas.Siglas,  ifnull((SELECT Banco from Bancos as B inner join SolicitudCheques as SC on B.BancoID = SC.BancoID where SC.ContratoID = Contratos.ContratoID limit 1), 'CAJA GENERAL') as Banco, Objetivo FROM Contratos INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER Join Objetivos On Contratos.ObjetivoID = Objetivos.ObjetivoID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID INNER JOIN Condiciones ON Solicitudes.CondicionID = Condiciones.CondicionID INNER JOIN Oficiales ON Contratos.OficialID = Oficiales.OficialID INNER JOIN Personas AS P ON Oficiales.Documento = P.Documento INNER JOIN Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID  INNER JOIN Zonas ON Contratos.ZonaID = Zonas.ZonaID INNER JOIN Rutas ON Rutas.RutaID = Zonas.RutaID " + Where + " Order By Contratos.ContratoID";
                cm.CommandTimeout = Timeout;
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Contratos");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }

        public DataSet PrintListadoSmsGetByFecha(DateTime Desde, DateTime Hasta, int SucursalID)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "SELECT Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal, @Desde AS Desde, @Hasta AS Hasta FROM Empresas INNER JOIN Sucursales ON Empresas.EmpresaID = Sucursales.EmpresaID Where Sucursales.SucursalID = @SucursalID";
                cm.CommandTimeout = Timeout;
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Empresas");
                cn.Close();

                cn.Open();


                cm = new MySqlCommand();
                cm.CommandText = "SELECT Sms.ContratoID, P.Nombres + P.Apellidos AS Cliente, Sms.Fecha, Sms.Celular, Sms.Mensaje FROM Sms INNER JOIN Contratos AS C ON Sms.ContratoID = C.ContratoID INNER JOIN Solicitudes AS S ON C.SolicitudID = S.SolicitudID INNER JOIN Clientes AS Cl ON S.ClienteID = Cl.ClienteID INNER JOIN Personas AS P ON Cl.Documento = P.Documento WHERE (Cl.SucursalID = @SucursalID) AND (Sms.FechaModificacion BETWEEN @Desde AND @Hasta)";
                cm.CommandTimeout = Timeout;
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                da.Fill(ds, "Sms");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }

        public DataSet PrintListadoLlamadasGetByFecha(DateTime Desde, DateTime Hasta, int SucursalID, bool IsQuery = false)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "SELECT Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal, @Desde AS Desde, @Hasta AS Hasta FROM Empresas INNER JOIN Sucursales ON Empresas.EmpresaID = Sucursales.EmpresaID Where Sucursales.SucursalID = @SucursalID";
                cm.CommandTimeout = Timeout;
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Empresas");
                cn.Close();

                cn.Open();


                cm = new MySqlCommand();
                if (!IsQuery)
                {
                    cm.CommandText = "SELECT Sms.ContratoID, Sms.HableCon AS Cliente, Sms.Fecha, Sms.Mensaje FROM Llamadas as sms INNER JOIN Contratos AS C ON Sms.ContratoID = C.ContratoID INNER JOIN Solicitudes AS S ON C.SolicitudID = S.SolicitudID INNER JOIN Clientes AS Cl ON S.ClienteID = Cl.ClienteID INNER JOIN Personas AS P ON Cl.Documento = P.Documento WHERE (Cl.SucursalID = @SucursalID) AND (Sms.FechaModificacion BETWEEN @Desde AND @Hasta)";
                }
                else
                {
                    cm.CommandText = "SELECT Sms.ContratoID, Sms.HableCon AS Cliente, Sms.Fecha, Sms.Mensaje FROM Llamadas as sms INNER JOIN Contratos AS C ON Sms.ContratoID = C.ContratoID INNER JOIN Solicitudes AS S ON C.SolicitudID = S.SolicitudID INNER JOIN Clientes AS Cl ON S.ClienteID = Cl.ClienteID INNER JOIN Personas AS P ON Cl.Documento = P.Documento WHERE (Cl.SucursalID = @SucursalID) AND (Sms.Fecha BETWEEN @Desde AND @Hasta)";
                }
                cm.CommandTimeout = Timeout;
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@SucursalID", SucursalID));
                cm.Parameters.Add(new MySqlParameter("@Desde", _Desde));
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                da.Fill(ds, "Llamadas");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }

        public DataSet PrintListadoRutasGetByFecha(DateTime Hasta, int SucursalID, int RutaID, int ZonaID, int OficialID, bool flat = false)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Hasta = Hasta; //Hasta.Add(new TimeSpan(23, 59, 59));
                DateTime Fin = Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string Where = " WHERE (Contratos.EstadoID = 1) ";

                if (flat == true)
                {
                    Where = " WHERE (Contratos.EstadoID = 1) AND Contratos.ContratoID Not In (select ContratoID from Recibos where EstadoID = 1 and Fecha Between @Hasta and @Fin)";
                }

                if (SucursalID != -1)
                {
                    Where = Where + string.Format(" AND (Clientes.SucursalID = {0}) ", SucursalID);
                }

                if (RutaID != -1)
                {
                    Where = Where + string.Format(" AND (Zonas.RutaID = {0}) ", RutaID);
                }

                if (ZonaID != -1)
                {
                    Where = Where + string.Format(" AND (Zonas.ZonaID = {0}) ", ZonaID);
                }

                if (OficialID != -1)
                {
                    Where = Where + string.Format(" AND (Contratos.OficialID = {0}) ", OficialID);
                }

                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "SELECT CASE WHEN VENCE < @Hasta THEN 'Si' ELSE '' END AS Vencido, Clientes.Latitude, Clientes.Longitude, Contratos.ContratoID, Solicitudes.Monto, CAST(@Hasta AS datetime) AS Hasta,  CONVERT(CASE WHEN VENCE <= @Hasta THEN '' ELSE (SELECT COUNT(CuotaID) FROM  Cuotas AS A WHERE a.ContratoID = Contratos.ContratoID AND A.Vence <= @Hasta) END, char) AS Semana, Contratos.Fecha, Contratos.Vence, CASE WHEN Contratos.Vence < @Hasta THEN 'Si' END AS Vencido, CONCAT( Personas.Nombres, ' ', Personas.Apellidos) as Completo, CONCAT(Personas.Nombres, ' ', Personas.Apellidos) AS Cliente, Personas.Apodo, Personas.Celular, Personas.Documento, Ciudades.Ciudad, Personas.Direccion AS DireccionCliente, Personas.Telefono, CASE WHEN VENCE < @Hasta THEN 0 ELSE Contratos.Cuota END AS Cuotas,IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha < @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence < @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)),0) AS Atraso, Rutas.Ruta, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal, (SELECT CONCAT(Nombres, ' ', Apellidos) AS Oficial FROM Personas AS P WHERE (Documento = Oficiales.Documento)) AS Oficial FROM  Solicitudes INNER JOIN Contratos ON Solicitudes.SolicitudID = Contratos.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN Ciudades ON Personas.CiudadID = Ciudades.CiudadID INNER JOIN Oficiales ON Contratos.OficialID = Oficiales.OficialID INNER JOIN Condiciones ON Solicitudes.CondicionID = Condiciones.CondicionID INNER JOIN Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN Zonas on Contratos.ZonaID = Zonas.ZonaID INNER JOIN Rutas ON Zonas.RutaID = Rutas.RutaID " + Where + " ORDER By Contratos.ContratoID";
                cm.CommandType = CommandType.Text;
                cm.CommandTimeout = Timeout;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                cm.Parameters.Add(new MySqlParameter("@Fin", Fin));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Cuotas");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }

        //public DataSet PrintListadoRutasGetByFechaNoCobrado(DateTime Hasta, int SucursalID, int RutaID, int OficialID)
        //{
        //    try
        //    {
        //        db = new DAL.Context();
        //        DateTime _Hasta = Hasta; //Hasta.Add(new TimeSpan(23, 59, 59));
        //        DateTime Fin = Hasta.Add(new TimeSpan(23, 59, 59));

        //        DataSet ds = new DataSet();
        //        MySqlDataAdapter da = new MySqlDataAdapter();
        //        MySqlConnection cn = new MySqlConnection();
        //        cn.ConnectionString = db.Database.Connection.ConnectionString;
        //        cn.Open();

        //        string Where = " WHERE (Contratos.EstadoID = 1) AND Contratos.ContratoID Not In (select ContratoID from Recibos where EstadoID = 1 and Fecha Between @Hasta and @Fin)";

        //        if (SucursalID != -1)
        //        {
        //            Where = Where + string.Format(" AND (Clientes.SucursalID = {0}) ", SucursalID);
        //        }

        //        if (RutaID != -1)
        //        {
        //            Where = Where + string.Format(" AND (Contratos.RutaID = {0}) ", RutaID);
        //        }

        //        if (OficialID != -1)
        //        {
        //            Where = Where + string.Format(" AND (Contratos.OficialID = {0}) ", OficialID);
        //        }

        //        MySqlCommand cm = new MySqlCommand();
        //        cm.CommandText = "SELECT CASE WHEN VENCE < @Hasta THEN 'Si' ELSE '' END AS Vencido, Clientes.Latitude, Clientes.Longitude, Contratos.ContratoID, Solicitudes.Monto, CAST(@Hasta AS datetime) AS Hasta, CONVERT(varchar(10), CASE WHEN VENCE < @Hasta THEN '' ELSE (SELECT COUNT(CuotaID) FROM  Cuotas AS A WHERE a.ContratoID = Contratos.ContratoID AND A.Vence < DATEADD(day,1, @Hasta)) END) AS Semana, Contratos.Fecha, Contratos.Vence, CASE WHEN Contratos.Vence < @Hasta THEN 'Si' END AS Vencido, Personas.Nombres + ' ' + Personas.Apellidos as Completo, Personas.Nombres + ' ' + Personas.Apellidos AS Cliente, Personas.Apodo, Personas.Celular, Personas.Documento, Ciudades.Ciudad, Personas.Direccion AS DireccionCliente, Personas.Telefono, CASE WHEN VENCE < @Hasta THEN 0 ELSE Contratos.Cuota END AS Cuotas,IFNULL((SELECT SUM(Capital + Comision + Interes + Mora + Legal) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha < @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence < @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)),0) AS Atraso, Rutas.Ruta, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal, (SELECT Nombres + ' ' + Apellidos AS Oficial FROM Personas AS P WHERE (Documento = Oficiales.Documento)) AS Oficial FROM  Solicitudes INNER JOIN Contratos ON Solicitudes.SolicitudID = Contratos.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN Ciudades ON Personas.CiudadID = Ciudades.CiudadID INNER JOIN Oficiales ON Contratos.OficialID = Oficiales.OficialID INNER JOIN Condiciones ON Solicitudes.CondicionID = Condiciones.CondicionID INNER JOIN Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN Rutas ON Contratos.RutaID = Rutas.RutaID " + Where + " ORDER By Contratos.ContratoID";

        //        cm.CommandType = CommandType.Text;
        //        cm.Connection = cn;
        //        cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
        //        cm.Parameters.Add(new MySqlParameter("@Fin", Fin));
        //        da.SelectCommand = cm;

        //        ds = new DataSet();
        //        da.Fill(ds, "Cuotas");
        //        cn.Close();

        //        return ds;
        //    }
        //    catch (Exception ex)
        //    {
        //        return new DataSet();
        //    }
        //}

        public DataSet PrintRecibosRutasGetByFecha(DateTime Hasta, int SucursalID, int RutaID, int ZonaID, int OficialID)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Hasta = Hasta; //Hasta.Add(new TimeSpan(23, 59, 59));

                DataSet ds = new DataSet();
                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;
                cn.Open();

                string Where = "WHERE (Contratos.EstadoID = 1) ";

                if (SucursalID != -1)
                {
                    Where = string.Format("WHERE (Contratos.EstadoID = 1) AND (Clientes.SucursalID = {0}) ", SucursalID);
                }

                if (RutaID != -1)
                {
                    Where = Where + string.Format(" AND (Zonas.RutaID = {0}) ", RutaID);
                }

                if (ZonaID != -1)
                {
                    Where = Where + string.Format(" AND (Zonas.ZonaID = {0}) ", ZonaID);
                }

                if (OficialID != -1)
                {
                    Where = Where + string.Format(" AND (Contratos.OficialID = {0}) ", OficialID);
                }

                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "SELECT CASE WHEN VENCE < @Hasta THEN 'Si' ELSE '' END AS Vencido, Contratos.ContratoID, Solicitudes.Monto, CAST(@Hasta AS datetime) AS Hasta, CONVERT(CASE WHEN VENCE < @Hasta THEN '' ELSE (SELECT COUNT(CuotaID) FROM  Cuotas AS A WHERE a.ContratoID = Contratos.ContratoID AND A.Vence <= @Hasta) END, char) AS Semana, Contratos.Fecha, Contratos.Vence, CASE WHEN Contratos.Vence < @Hasta THEN 'Si' else '' END AS Vencido, CONCAT(Personas.Nombres, ' ', Personas.Apellidos, ' [',  Personas.Documento, '] ') AS Cliente, Ciudades.Ciudad, Personas.Direccion AS DireccionCliente, Personas.Telefono, Personas.Celular, CASE WHEN VENCE < @Hasta THEN 0 ELSE Contratos.Cuota END AS Cuotas, CASE WHEN (SELECT { fn IFNULL(SUM(Capital + Interes + Mora + Comision + Legal), 0) } - { fn IFNULL ((SELECT SUM(Capital + Interes + Comision + Mora + Legal) AS Pagado  FROM DetalleRecibos AS DetalleRecibos_2 WHERE (ReciboID IN (SELECT ReciboID FROM Recibos AS Recibos_2 WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } AS Atraso FROM Cuotas AS Cuotas_1 WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)) < 0 THEN 0 ELSE (SELECT { fn IFNULL(SUM(Capital + Interes + Mora + Comision + Legal), 0) } - { fn IFNULL ((SELECT SUM(Capital + Interes + Comision + Mora + Legal) AS Pagado FROM DetalleRecibos AS DetalleRecibos_2 WHERE (ReciboID IN (SELECT ReciboID FROM Recibos AS Recibos_2 WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1)))), 0) } AS Atraso FROM Cuotas AS Cuotas_1  WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)) END AS Atraso, Concat(Rutas.Ruta, ' [', Zonas.Zona, '] ') as Ruta, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal FROM  Solicitudes INNER JOIN Contratos ON Solicitudes.SolicitudID = Contratos.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN Ciudades ON Personas.CiudadID = Ciudades.CiudadID INNER JOIN Oficiales ON Contratos.OficialID = Oficiales.OficialID INNER JOIN Condiciones ON Solicitudes.CondicionID = Condiciones.CondicionID INNER JOIN Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN Zonas ON Contratos.ZonaID = Zonas.ZonaID INNER JOIN Rutas on Zonas.RutaID = Rutas.RutaID " + Where + " and CASE WHEN VENCE < @Hasta THEN 'Si' ELSE '' END <> 'Si' AND CONVERT (CASE WHEN VENCE < @Hasta THEN '' ELSE (select COUNT( CuotaID) from Cuotas as A where a.ContratoID=Contratos.ContratoID and A.Vence<= @Hasta) END, char) <> '' Order By Contratos.ContratoID";

                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@Hasta", _Hasta));
                da.SelectCommand = cm;

                ds = new DataSet();
                da.Fill(ds, "Cuotas");
                cn.Close();

                return ds;
            }
            catch (Exception ex)
            {
                return new DataSet();
            }
        }
        public DataSet PrintCuotasGetByContratoID(int ContratoID)
        {
            try
            {
                db = new DAL.Context();
                DataSet ds = new DataSet();

                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //Cuotas
                cn.Open();
                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "SELECT Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal, Personas.Documento, Personas.Nombres, Personas.Apellidos, Personas.Fotografia, Ciudades.Ciudad, Contratos.ContratoID, Contratos.Fecha, Contratos.Vence, Solicitudes.Monto + Solicitudes.Monto * Contratos.Comision / 100 AS Monto, Contratos.Interes, Contratos.Cuota, Personas.Telefono, Personas.Celular, Solicitudes.Tiempo, Objetivos.Objetivo FROM Contratos INNER JOIN Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN Personas ON Clientes.Documento = Personas.Documento INNER JOIN Ciudades ON Personas.CiudadID = Ciudades.CiudadID INNER JOIN Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID inner join Objetivos on Contratos.ObjetivoID = Objetivos.ObjetivoID WHERE (Contratos.ContratoID = @ContratoID)";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@ContratoID", ContratoID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Cuotas");
                cn.Close();

                DataTable Header = new DataTable("Header");
                Header.Columns.Add("Fotografia", typeof(byte[]));
                Header.Columns.Add("BarCode", typeof(byte[]));
                DataRow dataRow = Header.NewRow();
                if (db.clsContratosBE.Where(x => x.ContratoID == ContratoID).FirstOrDefault().Solicitudes.Clientes.Personas.Fotografias != null)
                {
                    dataRow["Fotografia"] = (byte[])db.clsContratosBE.Where(x => x.ContratoID == ContratoID).FirstOrDefault().Solicitudes.Clientes.Personas.Fotografias.Foto;//ImageFromUrl(@"C:\Users\Stalin\Documents\App Developer\SoftArch\Payment Bank\Payment.Bank\Images\13335.png");// db.clsContratosBE.Where(x => x.ContratoID == ContratoID).FirstOrDefault().Solicitudes.Clientes.Personas.Fotografia);
                }
                dataRow["BarCode"] = ImageFromText(ContratoID.ToString());
                Header.Rows.Add(dataRow);
                ds.Tables.Add(Header);

                clsCuotasView Cuotas = new clsCuotasView();
                Cuotas.SetDataSource(ContratoID);
                var result = Cuotas.GetGroup();

                //Detalle
                DataTable Detalle = new DataTable("Detalle");
                Detalle.Columns.Add("Numero", typeof(int));
                Detalle.Columns.Add("Vencimiento", typeof(DateTime));
                Detalle.Columns.Add("Capital", typeof(float));
                Detalle.Columns.Add("Comision", typeof(float));
                Detalle.Columns.Add("Interes", typeof(float));
                Detalle.Columns.Add("Mora", typeof(float));
                Detalle.Columns.Add("Legal", typeof(float));
                Detalle.Columns.Add("Seguro", typeof(float));
                Detalle.Columns.Add("Balance", typeof(float));


                foreach (var fila in result.ToList())
                {
                    DataRow row = Detalle.NewRow();

                    row["Numero"] = fila.Numero;
                    row["Vencimiento"] = (DateTime)fila.Vence;
                    row["Capital"] = fila.Capital;
                    row["Comision"] = fila.Comision;
                    row["Interes"] = fila.Interes;
                    row["Mora"] = fila.Mora;
                    row["Legal"] = fila.Legal;
                    row["Seguro"] = fila.Seguro;
                    row["Balance"] = fila.Balance;
                    Detalle.Rows.Add(row);

                }

                ds.Tables.Add(Detalle);
                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }

        public DataSet PrintCertificadosGetByCertificadoID(int CertificadoID)
        {
            try
            {
                db = new DAL.Context();
                DataSet ds = new DataSet();

                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //Cuotas
                cn.Open();
                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "SELECT Certificados.CertificadoID, Certificados.Fecha, Certificados.Vence, Certificados.Documento, Personas.Nombres, Personas.Apellidos, Personas.Direccion, Certificados.Tiempo, Certificados.Interes, Certificados.Monto, Monedas.Codigo, Monedas.Moneda, Certificados.TipoCertificadoID, Provincias.Provincia FROM Certificados INNER JOIN Personas ON Certificados.Documento = Personas.Documento INNER JOIN Monedas ON Certificados.MonedaID = Monedas.MonedaID INNER JOIN Sucursales ON Certificados.SucursalID = Sucursales.SucursalID INNER JOIN Ciudades ON Personas.CiudadID = Ciudades.CiudadID INNER JOIN Provincias ON Ciudades.ProvinciaID = Provincias.ProvinciaID WHERE (Certificados.CertificadoID = @CertificadoID)";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@CertificadoID", CertificadoID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Certificados");
                cn.Close();

                DataTable Header = new DataTable("Security");
                Header.Columns.Add("BarCode", typeof(byte[]));
                DataRow dataRow = Header.NewRow();
                dataRow["BarCode"] = ImageFromText(CertificadoID.ToString());
                Header.Rows.Add(dataRow);
                ds.Tables.Add(Header);


                return ds;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                return new DataSet();
            }
        }

        #endregion

        #region Inmobiliaria

        #region Tipo Apartamentos

        public OperationResult TipoApartamentosCreate(string TipoApartamento, bool IsDefault, bool ContinueOnTime, bool InteresDiario, bool MoraDiaria, bool CanMinimumPay, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeAlquileresDefault(Usuario);
                }
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsTipoApartamentosBE.Count() == 0 ? 100000 : db.clsTipoApartamentosBE.Max(x => x.TipoApartamentoID)) + 1;
                db.clsTipoApartamentosBE.Add(new clsTipoApartamentosBE { TipoApartamentoID = ID, Fecha = DateTime.Now, TipoApartamento = TipoApartamento, IsDefault = IsDefault, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        private bool ChangeApartamentosDefault(string Usuario)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoApartamentosBE.Where(x => x.IsDefault == true).FirstOrDefault();
                row.IsDefault = false;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                return true;
            }
            catch { return false; }
        }
        public OperationResult TipoApartamentosUpdate(int TipoApartamentoID, string TipoApartamento, bool IsDefault, bool ContinueOnTime, bool InteresDiario, bool MoraDiaria, bool CanMinimumPay, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeApartamentosDefault(Usuario);
                }
                db = new DAL.Context();
                var row = db.clsTipoApartamentosBE.Where(x => x.TipoApartamentoID == TipoApartamentoID).FirstOrDefault();
                row.TipoApartamento = TipoApartamento;
                row.IsDefault = IsDefault;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TipoApartamentosDelete(int TipoApartamentoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoApartamentosBE.Where(x => x.TipoApartamentoID == TipoApartamentoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsTipoApartamentosBE> TipoApartamentosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoApartamentosBE.Where(x => x.TipoApartamento.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsTipoApartamentosBE.ToList();
                }
            }
            catch
            {
                return new List<clsTipoApartamentosBE>();
            }
        }

        #endregion

        #region Tipo Alquileres

        public OperationResult TipoAlquileresCreate(string TipoAlquiler, bool IsDefault, bool ContinueOnTime, bool InteresDiario, bool MoraDiaria, bool CanMinimumPay, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeAlquileresDefault(Usuario);
                }
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsTipoAlquileresBE.Count() == 0 ? 100000 : db.clsTipoAlquileresBE.Max(x => x.TipoAlquilerID)) + 1;
                db.clsTipoAlquileresBE.Add(new clsTipoAlquileresBE { TipoAlquilerID = ID, Fecha = DateTime.Now, TipoAlquiler = TipoAlquiler, IsDefault = IsDefault, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        private bool ChangeAlquileresDefault(string Usuario)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoAlquileresBE.Where(x => x.IsDefault == true).FirstOrDefault();
                row.IsDefault = false;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                return true;
            }
            catch { return false; }
        }
        public OperationResult TipoAlquileresUpdate(int TipoAlquilerID, string TipoAlquiler, bool IsDefault, bool ContinueOnTime, bool InteresDiario, bool MoraDiaria, bool CanMinimumPay, string Usuario)
        {
            OperationResult result;
            try
            {
                if (IsDefault == true)
                {
                    ChangeAlquileresDefault(Usuario);
                }
                db = new DAL.Context();
                var row = db.clsTipoAlquileresBE.Where(x => x.TipoAlquilerID == TipoAlquilerID).FirstOrDefault();
                row.TipoAlquiler = TipoAlquiler;
                row.IsDefault = IsDefault;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TipoAlquileresDelete(int TipoAlquilerID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoAlquileresBE.Where(x => x.TipoAlquilerID == TipoAlquilerID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsTipoAlquileresBE> TipoAlquileresGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoAlquileresBE.Where(x => x.TipoAlquiler.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsTipoAlquileresBE.ToList();
                }
            }
            catch
            {
                return new List<clsTipoAlquileresBE>();
            }
        }

        #endregion

        #region Pisos

        public OperationResult PisosCreate(string Piso, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsPisosBE.Count() == 0 ? 100000 : db.clsPisosBE.Max(x => x.PisoID)) + 1;
                db.clsPisosBE.Add(new clsPisosBE { PisoID = ID, Fecha = DateTime.Now, Piso = Piso, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PisosUpdate(int PisoID, string Piso, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsPisosBE.Where(x => x.PisoID == PisoID).FirstOrDefault();
                row.Piso = Piso;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PisosDelete(int PisoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsPisosBE.Where(x => x.PisoID == PisoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsPisosBE> PisosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsPisosBE.Where(x => x.Piso.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsPisosBE.ToList();
                }
            }
            catch
            {
                return new List<clsPisosBE>();
            }
        }

        #endregion

        #region Edificios

        public OperationResult EdificiosCreate(string Edificio, int CiudadID, string Direccion, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsEdificiosBE.Count() == 0 ? 100000 : db.clsEdificiosBE.Max(x => x.EdificioID)) + 1;
                db.clsEdificiosBE.Add(new clsEdificiosBE { EdificioID = ID, Fecha = DateTime.Now, Edificio = Edificio, CiudadID = CiudadID, Direccion = Direccion, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult EdificiosUpdate(int EdificioID, string Edificio, int CiudadID, string Direccion, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsEdificiosBE.Where(x => x.EdificioID == EdificioID).FirstOrDefault();
                row.Edificio = Edificio;
                row.CiudadID = CiudadID;
                row.Direccion = Direccion;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult EdificiosDelete(int EdificioID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsEdificiosBE.Where(x => x.EdificioID == EdificioID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsEdificiosBE> EdificiosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsEdificiosBE.Where(x => x.Edificio.Contains(Search) || x.Ciudades.Ciudad.Contains(Search)).OrderBy(x => x.Edificio).ToList();
                }
                else
                {
                    return db.clsEdificiosBE.OrderBy(x => x.Edificio).ToList();
                }
            }
            catch
            {
                return new List<clsEdificiosBE>();
            }
        }

        #endregion

        #region Garantia Alquileres

        public OperationResult GarantiaAlquileresCreate(int AlquilerID, string Documento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaAlquileresBE.Where(x => x.AlquilerID == AlquilerID);
                if (row.Count() == 0)
                {
                    //var g = db.clsGarantesBE.Where(x => x.Documento == Documento);
                    //if (g.Count() == 0)
                    //{
                    //    db.clsGarantesBE.Add(new clsGarantesBE { Documento = Documento, Fecha = DateTime.Now, Estado = true, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    //}
                    db.clsGarantiaAlquileresBE.Add(new clsGarantiaAlquileresBE { AlquilerID = AlquilerID, Fecha = DateTime.Now, Documento = Documento, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                    result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                }
                else
                {
                    result = GarantiaAlquileresUpdate(AlquilerID, Documento, Usuario);
                }
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult GarantiaAlquileresUpdate(int AlquilerID, string Documento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsGarantiaAlquileresBE.Where(x => x.AlquilerID == AlquilerID).FirstOrDefault();
                row.Documento = Documento;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        #endregion  

        #region Apartamentos

        public OperationResult ApartamentosCreate(string Apartamento, int EdificioID, int PisoID, string Descripcion, int TipoApartamento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsApartamentosBE.Count() == 0 ? 100000 : db.clsApartamentosBE.Max(x => x.ApartamentoID)) + 1;
                db.clsApartamentosBE.Add(new clsApartamentosBE { ApartamentoID = ID, Fecha = DateTime.Now, Apartamento = Apartamento, EdificioID = EdificioID, PisoID = PisoID, Descripcion = Descripcion, TipoApartamentoID = TipoApartamento, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ApartamentosUpdate(int ApartamentoID, string Apartamento, int EdicificioID, int PisoID, string Descripcion, int TipoApartamento, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsApartamentosBE.Where(x => x.ApartamentoID == ApartamentoID).FirstOrDefault();
                row.Apartamento = Apartamento;
                row.EdificioID = EdicificioID;
                row.PisoID = PisoID;
                row.Descripcion = Descripcion;
                row.TipoApartamentoID = TipoApartamento;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult ApartamentosDelete(int ApartamentoID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsApartamentosBE.Where(x => x.ApartamentoID == ApartamentoID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsApartamentosBE> ApartamentosGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsApartamentosBE.Where(x => x.Apartamento.Contains(Search) || x.Edificios.Edificio.Contains(Search)).OrderBy(x => x.Apartamento).ToList();
                }
                else
                {
                    return db.clsApartamentosBE.OrderBy(x => x.Apartamento).ToList();
                }
            }
            catch
            {
                return new List<clsApartamentosBE>();
            }
        }

        public clsApartamentosBE ApartamentosGetByApartamentoID(int ApartamentoID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsApartamentosBE.Where(x => x.ApartamentoID == ApartamentoID).FirstOrDefault();
            }
            catch
            {
                return new clsApartamentosBE();
            }
        }

        public List<clsApartamentosBE> ApartamentosDisponiblesGet()
        {
            try
            {
                db = new DAL.Context();
                var result = db.clsApartamentosBE.Where(p => !db.clsAlquileresBE.Where(x => x.EstadoID == true).Any(p2 => p2.ApartamentoID == p.ApartamentoID)).ToList();
                return result;
            }
            catch
            {
                return new List<clsApartamentosBE>();
            }
        }

        #endregion

        #region Alquileres

        public OperationResult AlquileresCreate(DateTime Fecha, int TipoAlquilerID, int ApartamentoID, string Documento, int Tiempo, int NotarioPublicoID, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsAlquileresBE.Count() == 0 ? 100000 : db.clsAlquileresBE.Max(x => x.AlquilerID)) + 1;
                db.clsAlquileresBE.Add(new clsAlquileresBE { AlquilerID = ID, Fecha = Fecha, ApartamentoID = ApartamentoID, Documento = Documento, Tiempo = Tiempo, NotarioPublicoID = NotarioPublicoID, Monto = Monto, EstadoID = true, TipoAlquilerID = TipoAlquilerID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult AlquileresUpdate(int AlquilerID, DateTime Fecha, int TipoAlquilerID, int ApartamentoID, string Documento, int Tiempo, int NotarioPublicoID, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsAlquileresBE.Where(x => x.AlquilerID == AlquilerID).FirstOrDefault();
                row.ApartamentoID = ApartamentoID;
                row.Documento = Documento;
                row.Fecha = Fecha;
                row.Monto = Monto;
                row.Tiempo = Tiempo;
                row.TipoAlquilerID = TipoAlquilerID;
                row.NotarioPublicoID = NotarioPublicoID;

                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult AlquileresDelete(int AlquilerID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsAlquileresBE.Where(x => x.AlquilerID == AlquilerID).FirstOrDefault();
                row.EstadoID = false;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsAlquileresBE> AlquileresGet(string Search, bool EstadoID)
        {
            try
            {
                db = new DAL.Context();
                var result = db.clsAlquileresBE.Where(x => x.EstadoID == EstadoID);

                if (!string.IsNullOrEmpty(Search))
                {
                    return result.Where(x => x.TipoAlquileres.TipoAlquiler.Contains(Search) || x.Personas.Nombres.Contains(Search) || x.Personas.Apellidos.Contains(Search) || x.Apartamentos.Apartamento.Contains(Search) || x.Apartamentos.Edificios.Edificio.Contains(Search)).OrderBy(x => x.AlquilerID).ToList();
                }
                else
                {
                    return result.OrderBy(x => x.AlquilerID).ToList();
                }
            }
            catch
            {
                return new List<clsAlquileresBE>();
            }
        }

        public clsAlquileresBE AlquileresGetByAlquilerID(int AlquilerID)
        {
            db = new DAL.Context();
            return db.clsAlquileresBE.Where(x => x.AlquilerID == AlquilerID).FirstOrDefault();
        }

        public DataSet PrintAlquileresGetByAlquilerID(int ArquilerID)
        {
            DataSet ds = new DataSet();
            try
            {
                db = new DAL.Context();

                //Alquileres
                DataTable Alquileres = new DataTable("Alquileres");
                Alquileres.Columns.Add("AlquilerID", typeof(int));
                Alquileres.Columns.Add("Fecha", typeof(DateTime));
                Alquileres.Columns.Add("Tiempo", typeof(int));
                Alquileres.Columns.Add("Monto", typeof(float));
                Alquileres.Columns.Add("TipoApartamento", typeof(string));
                Alquileres.Columns.Add("Apartamento", typeof(string));
                Alquileres.Columns.Add("Descripcion", typeof(string));
                Alquileres.Columns.Add("Piso", typeof(string));
                Alquileres.Columns.Add("Edificio", typeof(string));
                Alquileres.Columns.Add("Direccion", typeof(string));
                Alquileres.Columns.Add("Ciudad", typeof(string));
                Alquileres.Columns.Add("Provincia", typeof(string));
                Alquileres.Columns.Add("Pais", typeof(string));
                Alquileres.Columns.Add("FechaInicio", typeof(DateTime));

                var a = db.clsAlquileresBE.Where(x => x.AlquilerID == ArquilerID).FirstOrDefault();
                DataRow RowA = Alquileres.NewRow();
                RowA["AlquilerID"] = a.AlquilerID;
                RowA["Fecha"] = a.Fecha;
                RowA["Tiempo"] = a.Tiempo;
                RowA["Monto"] = a.Monto;
                RowA["TipoApartamento"] = a.Apartamentos.TipoApartamentos.TipoApartamento;
                RowA["Apartamento"] = a.Apartamentos.Apartamento;
                RowA["Descripcion"] = a.Apartamentos.Descripcion;
                RowA["Piso"] = a.Apartamentos.Pisos.Piso;
                RowA["Edificio"] = a.Apartamentos.Edificios.Edificio;
                RowA["Direccion"] = a.Apartamentos.Edificios.Direccion;
                RowA["Ciudad"] = a.Apartamentos.Edificios.Ciudades.Ciudad;
                RowA["Provincia"] = a.Apartamentos.Edificios.Ciudades.Provincias.Provincia;
                RowA["Pais"] = a.Apartamentos.Edificios.Ciudades.Provincias.Paises.Pais;
                RowA["FechaInicio"] = a.Rentas.Where(x => x.IsDeposito == false).FirstOrDefault().Fecha;
                Alquileres.Rows.Add(RowA);
                ds.Tables.Add(Alquileres);

                //Gerentes
                DataTable Gerentes = new DataTable("Gerentes");
                Gerentes.Columns.Add("AlquilerID", typeof(int));
                Gerentes.Columns.Add("Documento", typeof(string));
                Gerentes.Columns.Add("Nombres", typeof(string));
                Gerentes.Columns.Add("Apellidos", typeof(string));
                Gerentes.Columns.Add("Direccion", typeof(string));
                Gerentes.Columns.Add("Ciudad", typeof(string));
                Gerentes.Columns.Add("Provincia", typeof(string));
                Gerentes.Columns.Add("Pais", typeof(string));
                Gerentes.Columns.Add("EstadoCivil", typeof(string));


                DataRow RowG = Gerentes.NewRow();
                RowG["AlquilerID"] = a.AlquilerID;
                RowG["Documento"] = a.NotariosPublico.Sucursales.Gerentes.Personas.Documento;
                RowG["Nombres"] = a.NotariosPublico.Sucursales.Gerentes.Personas.Nombres.ToUpper();
                RowG["Apellidos"] = a.NotariosPublico.Sucursales.Gerentes.Personas.Apellidos.ToUpper();
                RowG["Direccion"] = a.NotariosPublico.Sucursales.Gerentes.Personas.Direccion.ToUpper();
                RowG["Ciudad"] = a.NotariosPublico.Sucursales.Gerentes.Personas.Ciudades.Ciudad.ToUpper();
                RowG["Provincia"] = a.NotariosPublico.Sucursales.Gerentes.Personas.Ciudades.Provincias.Provincia.ToUpper();
                RowG["Pais"] = a.NotariosPublico.Sucursales.Gerentes.Personas.Ciudades.Provincias.Paises.Pais.ToUpper();
                RowG["EstadoCivil"] = a.NotariosPublico.Sucursales.Gerentes.Personas.EstadosCiviles.EstadoCivil.ToUpper();
                Gerentes.Rows.Add(RowG);
                ds.Tables.Add(Gerentes);

                //Notarios
                DataTable Notarios = new DataTable("NotarioPublico");
                Notarios.Columns.Add("AlquilerID", typeof(int));
                Notarios.Columns.Add("Documento", typeof(string));
                Notarios.Columns.Add("Nombres", typeof(string));
                Notarios.Columns.Add("Apellidos", typeof(string));
                Notarios.Columns.Add("Direccion", typeof(string));
                Notarios.Columns.Add("Ciudad", typeof(string));
                Notarios.Columns.Add("Provincia", typeof(string));
                Notarios.Columns.Add("Pais", typeof(string));
                Notarios.Columns.Add("EstadoCivil", typeof(string));
                Notarios.Columns.Add("Execuatur", typeof(string));

                DataRow RowN = Notarios.NewRow();
                RowN["AlquilerID"] = a.AlquilerID;
                RowN["Documento"] = a.NotariosPublico.Documento;
                RowN["Nombres"] = a.NotariosPublico.Personas.Nombres.ToUpper();
                RowN["Apellidos"] = a.NotariosPublico.Personas.Apellidos.ToUpper();
                RowN["Direccion"] = a.NotariosPublico.Personas.Direccion.ToUpper();
                RowN["Ciudad"] = a.NotariosPublico.Personas.Ciudades.Ciudad.ToUpper();
                RowN["Provincia"] = a.NotariosPublico.Personas.Ciudades.Provincias.Provincia.ToUpper();
                RowN["Pais"] = a.NotariosPublico.Personas.Ciudades.Provincias.Paises.Pais.ToUpper();
                RowN["EstadoCivil"] = a.NotariosPublico.Personas.EstadosCiviles.EstadoCivil.ToUpper();
                RowN["Execuatur"] = a.NotariosPublico.Exequatur.ToUpper();
                Notarios.Rows.Add(RowN);
                ds.Tables.Add(Notarios);

                //Inquilinos
                DataTable Inquilino = new DataTable("Inquilino");
                Inquilino.Columns.Add("AlquilerID", typeof(int));
                Inquilino.Columns.Add("Documento", typeof(string));
                Inquilino.Columns.Add("Nombres", typeof(string));
                Inquilino.Columns.Add("Apellidos", typeof(string));
                Inquilino.Columns.Add("Direccion", typeof(string));
                Inquilino.Columns.Add("Ciudad", typeof(string));
                Inquilino.Columns.Add("Provincia", typeof(string));
                Inquilino.Columns.Add("Pais", typeof(string));
                Inquilino.Columns.Add("EstadoCivil", typeof(string));

                DataRow RowI = Inquilino.NewRow();
                RowI["AlquilerID"] = a.AlquilerID;
                RowI["Documento"] = a.Personas.Documento;
                RowI["Nombres"] = a.Personas.Nombres.ToUpper();
                RowI["Apellidos"] = a.Personas.Apellidos.ToUpper();
                RowI["Direccion"] = a.Personas.Direccion.ToUpper();
                RowI["Ciudad"] = a.Personas.Ciudades.Ciudad.ToUpper();
                RowI["Provincia"] = a.Personas.Ciudades.Provincias.Provincia.ToUpper();
                RowI["Pais"] = a.Personas.Ciudades.Provincias.Paises.Pais.ToUpper();
                RowI["EstadoCivil"] = a.Personas.EstadosCiviles.EstadoCivil.ToUpper();
                Inquilino.Rows.Add(RowI);
                ds.Tables.Add(Inquilino);


                //Garantas
                DataTable Garantes = new DataTable("Garantes");
                Garantes.Columns.Add("AlquilerID", typeof(int));
                Garantes.Columns.Add("Documento", typeof(string));
                Garantes.Columns.Add("Nombres", typeof(string));
                Garantes.Columns.Add("Apellidos", typeof(string));
                Garantes.Columns.Add("Direccion", typeof(string));
                Garantes.Columns.Add("Ciudad", typeof(string));
                Garantes.Columns.Add("Provincia", typeof(string));
                Garantes.Columns.Add("Pais", typeof(string));
                Garantes.Columns.Add("EstadoCivil", typeof(string));

                DataRow RowF = Garantes.NewRow();
                RowF["AlquilerID"] = a.AlquilerID;
                RowF["Documento"] = a.GarantiaAlquileres.Documento;
                RowF["Nombres"] = a.GarantiaAlquileres.Personas.Nombres.ToUpper();
                RowF["Apellidos"] = a.GarantiaAlquileres.Personas.Apellidos.ToUpper();
                RowF["Direccion"] = a.GarantiaAlquileres.Personas.Direccion.ToUpper();
                RowF["Ciudad"] = a.GarantiaAlquileres.Personas.Ciudades.Ciudad.ToUpper();
                RowF["Provincia"] = a.GarantiaAlquileres.Personas.Ciudades.Provincias.Provincia.ToUpper();
                RowF["Pais"] = a.GarantiaAlquileres.Personas.Ciudades.Provincias.Paises.Pais.ToUpper();
                RowF["EstadoCivil"] = a.GarantiaAlquileres.Personas.EstadosCiviles.EstadoCivil.ToUpper();
                Garantes.Rows.Add(RowF);
                ds.Tables.Add(Garantes);

                return ds;
            }
            catch
            { return ds; }
        }

        #endregion

        #region Rentas

        public OperationResult RentasCreate(DateTime Fecha, int AlquilerID, int MesID, int Ano, float Monto, bool IsDeposito, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                string Concepto = "RENTA MES ";

                if (IsDeposito == false)
                {
                    switch (MesID)
                    {
                        case 1: { Concepto += "ENERO " + Ano.ToString(); } break;
                        case 2: { Concepto += "FEBRERO " + Ano.ToString(); } break;
                        case 3: { Concepto += "MARZO " + Ano.ToString(); } break;
                        case 4: { Concepto += "ABRIL " + Ano.ToString(); } break;
                        case 5: { Concepto += "MAYO " + Ano.ToString(); } break;
                        case 6: { Concepto += "JUNIO " + Ano.ToString(); } break;
                        case 7: { Concepto += "JULIO " + Ano.ToString(); } break;
                        case 8: { Concepto += "AGOSTO " + Ano.ToString(); } break;
                        case 9: { Concepto += "SEPTIEMBRE " + Ano.ToString(); } break;
                        case 10: { Concepto += "OCTUBRE " + Ano.ToString(); } break;
                        case 11: { Concepto += "NOVIEMBRE " + Ano.ToString(); } break;
                        case 12: { Concepto += "DICIEMBRE " + Ano.ToString(); } break;
                    }
                }
                else
                {
                    var Text = AlquileresGetByAlquilerID(AlquilerID).TipoAlquileres.TipoAlquiler.ToUpper();
                    Concepto = "DEPOSITO RENTA " + Text;
                }
                var exist = db.clsRentasBE.Where(x => x.AlquilerID == AlquilerID && x.Año == Ano && x.MesID == MesID && x.IsDeposito == false);
                if (exist.Count() == 0)
                {
                    ID = (db.clsRentasBE.Count() == 0 ? 100000 : db.clsRentasBE.Max(x => x.RentaID)) + 1;
                    db.clsRentasBE.Add(new clsRentasBE { RentaID = ID, Fecha = Fecha, AlquilerID = AlquilerID, Concepto = Concepto, MesID = MesID, Año = Ano, Monto = Monto, IsDeposito = IsDeposito, Contabilizado = false, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                    db.SaveChanges();
                }
                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult RentasUpdate(int RentaID, string Renta, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsRentasBE.Where(x => x.RentaID == RentaID).FirstOrDefault();
                //row.Renta = Renta;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult RentasDelete(int RentaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsRentasBE.Where(x => x.RentaID == RentaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsRentasBE> RentasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsRentasBE.Where(x => x.Concepto.Contains(Search) || x.Alquileres.TipoAlquileres.TipoAlquiler.Contains(Search) || x.Alquileres.Personas.Nombres.Contains(Search) || x.Alquileres.Personas.Apellidos.Contains(Search) || x.Alquileres.Apartamentos.Apartamento.Contains(Search) || x.Alquileres.Apartamentos.Edificios.Edificio.Contains(Search)).OrderBy(x => x.AlquilerID).ToList();
                }
                else
                {
                    return db.clsRentasBE.ToList();
                }
            }
            catch
            {
                return new List<clsRentasBE>();
            }
        }

        public clsRentasBE RentasGetByRentaID(int RentaID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsRentasBE.Where(x => x.RentaID == RentaID).FirstOrDefault();
            }
            catch
            {
                return new clsRentasBE();
            }
        }

        #endregion

        #region PagoRentas

        public OperationResult PagoRentasCreate(int AlquilerID, DateTime Fecha, int SucursalID, int ComprobanteID, int FormaPagoID, float SubTotal, float Descuento, float Monto, string Informacion, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();

                DateTime _Fecha = Fecha.Add(new TimeSpan(DateTime.Now.Hour, DateTime.Now.Minute, DateTime.Now.Second));

                string Ncf = string.Empty;
                var row = db.clsComprobantesBE.Where(x => x.ComprobanteID == ComprobanteID).FirstOrDefault();
                if (row != null)
                {
                    Ncf = row.Prefijo + string.Format("{0:00000000}", row.Secuencia + 1);
                }

                int ID = 0;
                ID = (db.clsPagoRentasBE.Count() == 0 ? 100000 : db.clsPagoRentasBE.Max(x => x.PagoRentaID)) + 1;
                db.clsPagoRentasBE.Add(new clsPagoRentasBE { PagoRentaID = ID, Fecha = _Fecha, AlquilerID = AlquilerID, ComprobanteID = ComprobanteID, SucursalID = SucursalID, Ncf = Ncf, FormaPagoID = FormaPagoID, SubTotal = SubTotal, Descuento = Descuento, Monto = Monto, EstadoID = true, Informacion = Informacion, Contabilizado = false, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();

                var c = db.clsComprobantesBE.Where(x => x.ComprobanteID == ComprobanteID).FirstOrDefault();
                c.Secuencia = c.Secuencia + 1;
                db.Entry(c).State = EntityState.Modified;
                db.SaveChanges();

                result = new OperationResult { ResponseCode = "00", ResponseMessage = ID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PagoRentasUpdate(int PagoRentaID, int AlquilerID, DateTime Fecha, int SucursalID, int ComprobanteID, int FormaPagoID, float SubTotal, float Descuento, float Monto, string Informacion, string Usuario)
        {
            OperationResult result;
            try
            {
                DateTime _Fecha = Fecha.Add(new TimeSpan(DateTime.Now.Hour, DateTime.Now.Minute, DateTime.Now.Second));
                db = new DAL.Context();

                var row = db.clsPagoRentasBE.Where(x => x.PagoRentaID == PagoRentaID).FirstOrDefault();
                row.Fecha = _Fecha;
                row.AlquilerID = AlquilerID;
                row.SucursalID = SucursalID;
                row.FormaPagoID = FormaPagoID;
                row.SubTotal = SubTotal;
                row.Descuento = Descuento;
                row.Monto = Monto;
                row.Informacion = Informacion;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult PagoRentasDelete(int PagoRentaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsPagoRentasBE.Where(x => x.PagoRentaID == PagoRentaID).FirstOrDefault();
                row.EstadoID = false;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<PagoRentas> PagoRentasGet(DateTime Desde, DateTime Hasta, string Search, string Documento)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));

                List<PagoRentas> result = new List<PagoRentas>();
                List<PagoRentas> BE = new List<PagoRentas>();

                var row = db.clsUsuariosBE.Where(x => x.Documento == Documento).FirstOrDefault();

                if (row.Roles.ViewAllReceipt == true)
                {
                    BE = (from R in db.clsPagoRentasBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta) join C in db.clsAlquileresBE on R.AlquilerID equals C.AlquilerID join P in db.clsPersonasBE on C.Documento equals P.Documento join F in db.clsFormaPagosBE on R.FormaPagoID equals F.FormaPagoID select new PagoRentas { PagoRentaID = R.PagoRentaID, AlquilerID = C.AlquilerID, Fecha = R.Fecha, Completo = P.Nombres + " " + P.Apellidos, Nombre = F.Nombre, Monto = R.Monto, EstadoID = R.EstadoID, Contabilizado = R.Contabilizado, SucursalID = R.SucursalID, ComprobanteID = R.ComprobanteID, Descuento = R.Descuento, FormaPagoID = F.FormaPagoID, Informacion = R.Informacion, Ncf = R.Ncf, SubTotal = R.SubTotal, Documento = P.Documento }).ToList();
                }
                else
                {
                    BE = (from R in db.clsPagoRentasBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.SucursalID == row.SucursalID) join C in db.clsAlquileresBE on R.AlquilerID equals C.AlquilerID join P in db.clsPersonasBE on C.Documento equals P.Documento join F in db.clsFormaPagosBE on R.FormaPagoID equals F.FormaPagoID select new PagoRentas { PagoRentaID = R.PagoRentaID, AlquilerID = C.AlquilerID, Fecha = R.Fecha, Completo = P.Nombres + " " + P.Apellidos, Nombre = F.Nombre, Monto = R.Monto, EstadoID = R.EstadoID, Contabilizado = R.Contabilizado, SucursalID = R.SucursalID, ComprobanteID = R.ComprobanteID, Descuento = R.Descuento, FormaPagoID = F.FormaPagoID, Informacion = R.Informacion, Ncf = R.Ncf, SubTotal = R.SubTotal, Documento = P.Documento }).ToList();
                }

                if (!string.IsNullOrEmpty(Search))
                {
                    Search = Search.ToUpper();
                    result = BE.Where(x => x.PagoRentaID.ToString().Contains(Search) || x.Completo.ToUpper().Contains(Search) || x.Monto.ToString().Contains(Search) || x.Nombre.ToUpper().Contains(Search) || x.AlquilerID.ToString().Contains(Search) || x.Documento.Contains(Search)).ToList();
                }
                else
                {
                    result = BE.ToList();
                }

                return result.OrderBy(x => x.PagoRentaID).ToList();
            }
            catch
            {
                return new List<PagoRentas>();
            }
        }

        public clsPagoRentasBE PagoRentasGetByPagoRentaID(int PagoRentaID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsPagoRentasBE.Where(x => x.PagoRentaID == PagoRentaID).FirstOrDefault();
            }
            catch
            {
                return new clsPagoRentasBE();
            }
        }


        public DataSet PrintPagoRentasGetByPagoRentaID(int PagoRentaID)
        {
            try
            {
                db = new DAL.Context();
                var row = db.clsPagoRentasBE.Where(x => x.PagoRentaID == PagoRentaID);
                DataSet ds = new DataSet();

                clsRentasView Cuotas = new clsRentasView();
                Cuotas.SetDataSource(row.FirstOrDefault().AlquilerID, row.FirstOrDefault().PagoRentaID);
                var result = Cuotas.GetGroup();
                float balance;

                balance = (Cuotas.BalanceGetByPagoRentaID(DateTime.Now) < 0 ? 0 : Cuotas.BalanceGetByPagoRentaID(DateTime.Now));

                //var PagoRentas = from R in row select new Entity.PagoRentas { PagoRentaID = R.PagoRentaID, Fecha = R.Fecha, ComprobanteID = R.ComprobanteID, Ncf = R.Ncf, AlquilerID = R.AlquilerID, FormaPagoID = R.FormaPagoID, EstadoID = R.EstadoID, Informacion = R.Informacion, Contabilizado = R.Contabilizado, SucursalID = R.SucursalID, SubTotal = R.SubTotal, Descuento = R.Descuento, Monto = R.Monto, Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };
                //var DetallePagoRentas = from DR in db.clsDetallePagoRentasBE.Where(x => x.PagoRentaID == PagoRentaID) select new DetallePagoRentas { PagoRentaID =DR.PagoRentaID, DetallePagoRentaID = DR.DetallePagoRentaID, CuotaID = DR.CuotaID,Numero = DR.Numero, Concepto = DR.Concepto, Capital = DR.Capital, Comision = DR.Comision, Interes = DR.Interes, Mora = DR.Mora, Legal = DR.Legal, SubTotal = DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal, Usuario = DR.Usuario, ModificadoPor = DR.ModificadoPor, FechaModificacion = DR.FechaModificacion };
                //var FormaPagos = from R in row select new FormaPagos { FormaPagoID = R.FormaPagos.FormaPagoID, Fecha = R.FormaPagos.Fecha, IsDefault = R.FormaPagos.IsDefault, Nombre = R.FormaPagos.Nombre,  Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };
                //var Sucursales = from R in row select new Sucursales { SucursalID = R.Sucursales.SucursalID, Fecha = R.Sucursales.Fecha, Sucursal = R.Sucursales.Sucursal, CiudadID = R.Sucursales.CiudadID, Documento = R.Sucursales.Documento, EmpresaID = R.Sucursales.EmpresaID, NotarioPublicoID = R.Sucursales.NotarioPublicoID,  Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };
                //var Empresas = from R in row select new Empresas { Empresa = R.Sucursales.Empresas.Empresa, EmpresaID = R.Sucursales.EmpresaID, Fecha = R.Sucursales.Empresas.Fecha, Direccion = R.Sucursales.Sucursales.Direccion, Telefonos = R.Sucursales.Telefonos, Rnc = R.Sucursales.Empresas.Rnc, Siglas = R.Sucursales.Empresas.Siglas, Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };
                //var Solicitudes = from R in row select new Solicitudes { SolicitudID = R.Contratos.Solicitudes.SolicitudID, Fecha = R.Contratos.Solicitudes.Fecha, ClienteID = R.Contratos.Solicitudes.ClienteID, CondicionID = R.Contratos.Solicitudes.CondicionID, EstadoID = R.Contratos.Solicitudes.EstadoID, Monto = R.Contratos.Solicitudes.Monto, Tiempo = R.Contratos.Solicitudes.Tiempo, TipoSolicitudID = R.Contratos.Solicitudes.TipoSolicitudID, Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };
                //var Personas = from R in row select new Personas { Documento = R.Contratos.Solicitudes.Clientes.Personas.Documento, Fecha = R.Contratos.Solicitudes.Clientes.Personas.Fecha, FechaNacimiento = R.Contratos.Solicitudes.Clientes.Personas.FechaNacimiento, Nombres = R.Contratos.Solicitudes.Clientes.Personas.Nombres, Apellidos = R.Contratos.Solicitudes.Clientes.Personas.Apellidos, Apodo = R.Contratos.Solicitudes.Clientes.Personas.Apodo, Fotografia = R.Contratos.Solicitudes.Clientes.Personas.Fotografia, CiudadID = R.Contratos.Solicitudes.Clientes.Personas.CiudadID, Direccion = R.Contratos.Solicitudes.Clientes.Personas.Direccion, Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };
                //var Comprobantes = from R in row select new Comprobantes { ComprobanteID = R.Comprobantes.ComprobanteID, Fecha = R.Comprobantes.Fecha, IsDefault = R.FormaPagos.IsDefault, Comprobante = R.Comprobantes.Comprobante, Usuario = R.Usuario, ModificadoPor = R.ModificadoPor, FechaModificacion = R.FechaModificacion };


                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //PagoRentas
                cn.Open();
                MySqlCommand cm = new MySqlCommand();
                cm.CommandText = "SELECT PagoRentas.PagoRentaID, PagoRentas.Fecha, PagoRentas.AlquilerID, Empresas.Empresa, Empresas.Logo, Sucursales.Direccion AS DireccionEmpresa, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal, Personas.Nombres, Personas.Apellidos, Personas.Direccion, FormaPagos.Nombre, Comprobantes.Comprobante, PagoRentas.Ncf, PagoRentas.SubTotal, PagoRentas.Descuento, PagoRentas.Monto, PagoRentas.Informacion, (SELECT Nombres FROM Personas AS P WHERE (Documento = PagoRentas.Usuario)) AS Usuario FROM PagoRentas INNER JOIN Sucursales ON PagoRentas.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN Alquileres ON PagoRentas.AlquilerID = Alquileres.AlquilerID INNER JOIN Personas ON Alquileres.Documento = Personas.Documento INNER JOIN FormaPagos ON PagoRentas.FormaPagoID = FormaPagos.FormaPagoID INNER JOIN Comprobantes ON PagoRentas.ComprobanteID = Comprobantes.ComprobanteID WHERE (PagoRentas.PagoRentaID = @PagoRentaID)";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@PagoRentaID", PagoRentaID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Recibos");
                cn.Close();

                //DetallePagoRentas
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT * from DetallePagoRentas Where DetallePagoRentas.PagoRentaID = @PagoRentaID";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@PagoRentaID", PagoRentaID));
                da.SelectCommand = cm;
                da.Fill(ds, "DetalleRecibos");
                cn.Close();

                DataTable Cuentas = new DataTable("Cuentas");
                Cuentas.Columns.Add("Balance", typeof(float));
                Cuentas.Columns.Add("BarCode", typeof(byte[]));
                DataRow dataRow = Cuentas.NewRow();
                dataRow["Balance"] = balance;
                dataRow["BarCode"] = ImageFromText(PagoRentaID.ToString());
                Cuentas.Rows.Add(dataRow);

                //ds.Tables.Add(EntityToDataTable(PagoRentas, "PagoRentas"));
                //ds.Tables.Add(EntityToDataTable(DetallePagoRentas, "DetallePagoRentas"));
                //ds.Tables.Add(EntityToDataTable(FormaPagos, "FormaPagos"));
                //ds.Tables.Add(EntityToDataTable(Sucursales, "Sucursales"));
                //ds.Tables.Add(EntityToDataTable(Empresas, "Empresas"));
                //ds.Tables.Add(EntityToDataTable(Solicitudes, "Solicitudes"));
                //ds.Tables.Add(EntityToDataTable(Personas, "Personas"));
                //ds.Tables.Add(EntityToDataTable(Comprobantes, "Comprobantes"));
                ds.Tables.Add(Cuentas);
                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }

        public DataSet PrintPagoRentasEmplyGetByFecha(DateTime Desde, DateTime Hasta)
        {
            try
            {
                db = new DAL.Context();
                DataSet ds = new DataSet();

                var  data = db.clsSucursalesBE.FirstOrDefault();

                DataTable Empresas = new DataTable("Empresas");
                Empresas.Columns.Add("Empresa", typeof(string));
                Empresas.Columns.Add("Direccion", typeof(string));
                Empresas.Columns.Add("Telefonos", typeof(string));
                Empresas.Columns.Add("Rnc", typeof(string));
                Empresas.Columns.Add("Sucursal", typeof(string));
                Empresas.Columns.Add("Desde", typeof(DateTime));
                Empresas.Columns.Add("Hasta", typeof(DateTime));

                DataRow dataRow = Empresas.NewRow();
                dataRow["Empresa"] = data.Empresas.Empresa;
                dataRow["Direccion"] = data.Direccion;
                dataRow["Telefonos"] = data.Telefonos;
                dataRow["Rnc"] = data.Empresas.Rnc;
                dataRow["Sucursal"] = data.Sucursal;
                dataRow["Desde"] = Desde;
                dataRow["Hasta"] = Hasta;
                Empresas.Rows.Add(dataRow);


                ds.Tables.Add(Empresas);
                return ds;
            }
            catch
            {
                return new DataSet();
            }
        }

        #endregion

        #region Detalle PagoRentas

        public List<clsDetallePagoRentasBE> DetallePagoRentasGetByAlquilerID(int AlquilerID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetallePagoRentasBE.Where(x => x.PagoRentas.AlquilerID == AlquilerID).ToList();
            }
            catch
            {
                return new List<clsDetallePagoRentasBE>();
            }
        }

        public List<clsDetallePagoRentasBE> DetallePagoRentasGet()
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetallePagoRentasBE.ToList();
            }
            catch
            {
                return new List<clsDetallePagoRentasBE>();
            }
        }

        public OperationResult DetallePagoRentasCreate(int RentaID, int PagoRentaID, string Concepto, float Monto, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                //db.clsDetallePagoRentasBE.Add(new clsDetallePagoRentasBE { RentaID = RentaID, PagoRentaID = PagoRentaID, Concepto = Concepto, Monto = Monto, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                //db.SaveChanges();
                //result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                //return result;

                int ID = 0;
                MySqlConnection cn = new MySqlConnection();
                MySqlDataAdapter da = new MySqlDataAdapter();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                cn.Open();
                MySqlCommand cmd = new MySqlCommand();
                cmd.CommandText = "SELECT IFNULL(Max(DetallePagoRentaID), 100000) +1 as DetallePagoRentaID from DetallePagoRentas;";
                cmd.CommandType = CommandType.Text;
                cmd.Connection = cn;

                MySqlDataReader drPersonas = cmd.ExecuteReader();
                while (drPersonas.Read())
                {
                    ID = int.Parse(drPersonas["DetallePagoRentaID"].ToString());
                }

                cn.Close();

                cn.Open();
                // Create the InsertCommand.
                cmd = new MySqlCommand("INSERT INTO DetallePagoRentas (DetallePagoRentaID, PagoRentaID, RentaID, Concepto, Monto, Usuario, ModificadoPor,  FechaModificacion) VALUES (@DetallePagoRentaID, @PagoRentaID, @RentaID, @Concepto, @Monto, @Usuario, @Usuario, SYSDATE());", cn);
                cmd.Parameters.Add(new MySqlParameter("@DetallePagoRentaID", ID));
                cmd.Parameters.Add(new MySqlParameter("@PagoRentaID", PagoRentaID));
                cmd.Parameters.Add(new MySqlParameter("@RentaID", RentaID));
                cmd.Parameters.Add(new MySqlParameter("@Concepto", Concepto));
                cmd.Parameters.Add(new MySqlParameter("@Monto", Monto));
                cmd.Parameters.Add(new MySqlParameter("@Usuario", Usuario));

                da.InsertCommand = cmd;
                cmd.ExecuteNonQuery();
                cn.Close();

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;

            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult DetallePagoRentasDeleteGetByPagoRentaID(int PagoRentaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetallePagoRentasBE.Where(x => x.PagoRentaID == PagoRentaID);
                db.clsDetallePagoRentasBE.RemoveRange(row);
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        #endregion

        #endregion

        #region Notificaciones

        public async Task<OperationResult> NotificacionesSent(string empresa, string message, string[] list, string Usuario)
        {
            try
            {
                NotificationHubClient hub;
                hub = NotificationHubClient.CreateClientFromConnectionString("EndBank=sb://i-bank-client.servicebus.windows.net/;SharedAccessKeyName=DefaultFullSharedAccessSignature;SharedAccessKey=jiIqH6bbHoGUfRnXzUrh1FU+3wtpbYHoDWp6eiqlqzY=", "i-bank-client");

                var tags = new List<string>();
                foreach (var x in list)
                {
                    if (!string.IsNullOrEmpty(x))
                    {
                        tags.Add("userID:" + x);
                    }
                }


                if (tags.Count > 0)
                {
                    await hub.SendFcmNativeNotificationAsync("{ \"notification\" : {\"title\":\"" + empresa + "\", \"body\":\"" + message + "\"}}", tags);
                    await hub.SendAppleNativeNotificationAsync("{ \"aps\" : {\"alert\":\"" + message + "\"}}", tags);
                }
                else
                {
                    await hub.SendFcmNativeNotificationAsync("{ \"notification\" : {\"title\":\"" + empresa + "\", \"body\":\"" + message + "\"}}");
                    await hub.SendAppleNativeNotificationAsync("{ \"aps\" : {\"alert\":\"" + message + "\"}}");
                }

                return new OperationResult { ResponseCode = "00", ResponseMessage = "" };

            }
            catch (Exception ex) { return new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message }; }
        }

        #endregion

        #region Ahorros

        #region Tipo Cuentas

        public OperationResult TipoCuentasCreate(string Descripcion, int MonedaID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int ID = 0;
                ID = (db.clsTipoCuentasBE.Count() == 0 ? 100000 : db.clsTipoCuentasBE.Max(x => x.TipoCuentaID)) + 1;
                db.clsTipoCuentasBE.Add(new clsTipoCuentasBE { TipoCuentaID = ID, Fecha = DateTime.Now, Descripcion = Descripcion, MonedaID = MonedaID, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now });
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TipoCuentasUpdate(int TipoCuentaID, string Descripcion, int MonedaID, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoCuentasBE.Where(x => x.TipoCuentaID == TipoCuentaID).FirstOrDefault();
                row.Descripcion = Descripcion;
                row.MonedaID = MonedaID;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult TipoCuentasDelete(int TipoCuentaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsTipoCuentasBE.Where(x => x.TipoCuentaID == TipoCuentaID).FirstOrDefault();
                db.Entry(row).State = EntityState.Deleted;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public List<clsTipoCuentasBE> TipoCuentasGet(string Search)
        {
            try
            {
                db = new DAL.Context();
                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsTipoCuentasBE.Where(x => x.Descripcion.ToUpper().Contains(Search) || x.Monedas.Moneda.ToUpper().Contains(Search)).ToList();
                }
                else
                {
                    return db.clsTipoCuentasBE.ToList();
                }
            }
            catch
            {
                return new List<clsTipoCuentasBE>();
            }
        }

        #endregion

        #endregion

        #region Calculos Genericos

        public Task<bool> CalcularInteres(DateTime _Date, int ContratoID = 0)
        {
            try
            {
                Manager db = new Manager();
                string Usuario = Environment.MachineName.ToString();
                var Contratos = ContratoID == 0 ? db.ContratosGet() : db.ContratosGet().Where(x => x.ContratoID == ContratoID);
                foreach (var row in Contratos)
                {
                    switch (row.TipoContratoID)
                    {
                        #region Amortizado Bancario

                        case 1:
                            {
                                Amortizar(row, _Date);
                            }
                            break;

                        #endregion

                        #region Capital e Interes

                        case 2:
                            {
                                CapitalEInteres(row, _Date);
                            }
                            break;

                        #endregion

                        #region Vencimiento

                        case 3:
                            {
                                if (row.Solicitudes.Clientes.Sucursales.EmpresaID == "3F6A-B879-167A-A21A-46D5-EEB3-D0EE-ADDC")
                                {
                                    Vencimiento_Mayi(row, _Date);
                                }
                                else
                                {
                                    Vencimiento(row, _Date);
                                }
                            }
                            break;

                        #endregion

                        #region Amortizado Simple

                        case 4:
                            {
                                Amortizar(row, _Date);
                            }
                            break;

                        #endregion

                        #region Interes Capitalizado

                        case 5:
                            {
                                Interes_Capitalizado(row, _Date);
                            }
                            break;

                        #endregion

                        #region Default
                        default:
                            {
                                Amortizar(row, _Date);
                            }
                            break;

                            #endregion
                    }
                }

                return Task.Run(() =>
                {
                    return true;
                });
            }
            catch
            {
                return Task.Run(() =>
                {
                    return false;
                });
            }


        }

        //Certificado 100%
        private void Amortizar1(clsContratosBE row, DateTime _Date)
        {
            float Interes = 0;
            bool IsComputed = false;
            DateTime oldDate;
            string Usuario = Environment.MachineName.ToString();

            clsCuotasView Cuotas = new clsCuotasView();
            Cuotas.SetDataSource(row.ContratoID);
            var result = Cuotas.GetGroupWithOutMora();
            bool Continue = true;
            bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;


            foreach (var c in result.OrderBy(X => X.Numero))
            {

                bool Iscomputed = false;
                DAL.Context cx = new DAL.Context();
                var HasPay = (from DR in cx.clsDetalleRecibosBE join R in cx.clsRecibosBE on DR.ReciboID equals R.ReciboID where R.EstadoID == true && R.ContratoID == row.ContratoID && DR.CuotaID == c.CuotaID select R);
                if (HasPay.Count() > 0)
                {
                    IsComputed = true;
                    if (c.Numero == row.Solicitudes.Tiempo)
                    {
                        Iscomputed = false;
                    }
                }
                else
                {
                    IsComputed = false;
                }

                TimeSpan dif = c.Vence - _Date;
                if (c.Balance > 0 && Continue == true && dif.Days <= row.Solicitudes.Condiciones.Dias)
                {
                    if (HasPay.Count() == 0)
                    {
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1:
                                {
                                    oldDate = c.Vence.AddMonths(-1);
                                }
                                break;
                            default:
                                {
                                    oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                }
                                break;
                        }
                    }
                    else
                    {
                        oldDate = HasPay.OrderByDescending(x => x.Fecha).Take(1).FirstOrDefault().Fecha;
                    }

                    TimeSpan ts = _Date - oldDate;

                    int time = ts.Days;

                    float Tiempo = 0;
                    switch (row.Solicitudes.CondicionID)
                    {
                        case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                        case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; ; } break;
                        case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                        case 4: { Tiempo = ts.Days; } break;
                    }

                    float B = Cuotas.BalanceCapital();

                    if (row.TipoContratoID == 4)
                    {
                        //B = row.Cuotas.Sum(t => t.Capital);
                        B = row.Cuotas.Sum(t => t.Capital + t.Comision);
                    }

                    if (row.TipoContratos.InteresDiario == true)
                    {
                        if (row.TipoContratos.ContinueOnTime == true)
                        {
                            Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses / row.Solicitudes.Condiciones.Dias) * ts.Days;
                            Continue = false;
                        }
                        else
                        {
                            if (ts.Days < row.Solicitudes.Condiciones.Dias)
                            {
                                Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                Continue = false;
                                IsComputed = false;
                            }
                            else
                            {
                                if (c.Numero == row.Solicitudes.Tiempo)
                                {
                                    Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                }
                                else
                                {
                                    Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias;
                                }
                                Continue = true;
                                IsComputed = true;
                            }
                        }
                    }
                    else
                    {
                        //Certificado 100%
                        if (row.TipoContratos.ContinueOnTime == true)
                        {
                            if (ts.Days < row.Solicitudes.Condiciones.Dias)
                            {
                                Interes = ((B * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                Continue = false;
                            }
                            else
                            {
                                Interes = (((B * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses)) * Tiempo;
                                Continue = true;
                                //IsComputed = true;
                            }
                        }
                        else
                        {
                            if (ts.Days > 0)
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    Interes = (B * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses;
                                    Continue = false;
                                }
                                else
                                {
                                    if (c.Numero == row.Solicitudes.Tiempo)
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                    }
                                    else
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                    }
                                    Continue = true;
                                }
                                IsComputed = true;
                            }
                            else
                            {
                                Continue = false;
                            }
                        }

                    }

                    if (Interes >= c.Interes)
                    {
                        if (c.IsComputed)
                        {
                            var r = NDInteresAutomaticaCreate(c.CuotaID, row.TipoContratos.InteresDiario, DateTime.Today, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                        }
                        else
                        {
                            var r = NDInteresAutomaticaCreate(c.CuotaID, row.TipoContratos.InteresDiario, DateTime.Today, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                        }

                    }
                    else
                    {
                        if (c.IsComputed == false)
                        {
                            var r = NCInteresAutomaticaCreate(c.CuotaID, row.TipoContratos.InteresDiario, DateTime.Today, "AJUSTE A CARGOS AUTOMATICOS", c.Interes - Interes, true, Usuario);
                        }
                    }

                    CuotasUpdateGetByCuotaID(c.CuotaID, IsComputed);

                    Console.WriteLine("{0} - {1} - {2} - {3} - {4}", c.ContratoID, c.CuotaID, c.Vence, c.Balance, Interes);



                }
                else
                {
                    if (c.Interes >= 1 && c.IsComputed == false)
                    {
                        var r = NCInteresAutomaticaCreate(c.CuotaID, row.TipoContratos.InteresDiario, DateTime.Today, "AJUSTE A CARGOS AUTOMATICOS", c.Interes, true, Usuario);
                    }
                }
            }
        }

   
        private void Amortizar(clsContratosBE row, DateTime _Date)
        {
            try
            {

                foreach (var i in row.Cuotas)
                {
                    if (i.Numero != 1)
                    {
                        NotaCreditoInteresAutomatica(i.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", i.Interes, true, row.Usuario);
                    }
                    //NotaDebitoInteresAutomaticaCreate(i.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", 0, true, row.Usuario);
                }

                clsCuotasView Cuotas = new clsCuotasView();
                Cuotas.SetDataSource(row.ContratoID);
                var result = Cuotas.GetGroupWithOutMora();

                DateTime oldDate;

                bool Continue = true;
                bool IsPay = false;
                bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;

                string Usuario = Environment.MachineName.ToString();

                foreach (var c in result.OrderBy(X => X.Numero))
                {
                    DAL.Context cx = new DAL.Context();

                    int Increment = 0;

                    float _pagado = 0;
                    float _cuota = 0;
                    float Interes = 0;

                    //var HasPayment = (from DR in cx.clsDetalleRecibosBE join R in cx.clsRecibosBE on DR.ReciboID equals R.ReciboID where R.EstadoID == true && R.ContratoID == row.ContratoID && DR.CuotaID == c.CuotaID select DR);
                    var HasPayment = cx.clsDetalleRecibosBE.Where(x => x.Recibos.EstadoID == true && x.Recibos.ContratoID == c.ContratoID && x.CuotaID == c.CuotaID);
                    if (HasPayment.Count() > 0)
                    {
                        if (c.Numero == row.Solicitudes.Tiempo)
                        {
                            IsPay = false;
                        }
                        else
                        {
                            _pagado = HasPayment.Sum(x => x.Interes);
                            _cuota = (((Cuotas.BalanceCapital()) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);

                            if (row.InteresDiario)
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                            else
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                        }
                    }
                    else
                    {
                        _cuota = (((Cuotas.BalanceCapital()) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        IsPay = false;
                    }


                    TimeSpan diferencia = c.Vence - _Date;
                    if ((row.TipoContratoID == 1 || row.TipoContratoID ==4) && (diferencia.Days + Increment) < row.Solicitudes.Condiciones.Dias && !IsPay && (_cuota - _pagado) > 1 && Continue == true)
                    {
                        if (HasPayment.Count() == 0)
                        {
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            if (row.InteresDiario)
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                        }
                                        break;
                                }
                            }
                            else
                            {
                                //oldDate = HasPay.OrderByDescending(x => x.Recibos.Fecha).Take(1).FirstOrDefault().Recibos.Fecha;
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                        }
                                        break;
                                }

                            }
                        }

                        TimeSpan ts = _Date - oldDate;
                        int time = ts.Days;

                        float Tiempo = 0;
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                            case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; } break;
                            case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                            case 4: { Tiempo = ts.Days; } break;
                        }

                        var Balance = Cuotas.BalanceCapital();
                        bool CalculateFirst = false;
                        if (c.Numero == row.Solicitudes.Tiempo && ts.Days > 0)
                        {
                            c.Numero = 0;
                            CalculateFirst = true;
                        }

                        if (row.InteresDiario == true)
                        {
                            if (c.Numero != 1)
                            {
                                if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                                if (row.TipoContratos.ContinueOnTime == true)
                                {
                                    Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Continue = false;
                                }
                                else
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = ((((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        }
                                        Continue = true;
                                    }
                                    Interes = Interes - _pagado;
                                }
                            }
                        }
                        else
                        {
                            if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                            if (row.TipoContratos.ContinueOnTime == true)
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                }
                                else
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                }
                                Continue = false;
                            }
                            else
                            {
                                if (ts.Days >= 0)
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        }
                                        Continue = true;
                                    }
                                }
                            }
                            Interes = Interes - _pagado;
                        }



                        if (Math.Round(Interes,1) >= Math.Round(c.Interes,1))
                        {
                            NDInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                        }
                        else
                        {
                            if (c.Numero != 1)
                            {
                                var r = NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes - Interes, true, Usuario);
                            }
                        }

                        Console.WriteLine("{0} - {1} - {2} - {3} - {4}", string.Format("{0:000000}", c.ContratoID), string.Format("{0:000}", c.Numero), string.Format("{0:dd/MM/yyyy}", c.Vence), string.Format("{0:N2}", c.Balance), string.Format("{0:N2}", Interes));
                    }
                    else
                    {
                        if (c.Interes >= 1 && c.Numero > 1)
                        {
                            var r = NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes, true, Usuario);
                        }
                    }

                    switch (DateTime.DaysInMonth(c.Vence.Year, c.Vence.Month))
                    {
                        case 28: { Increment = c.Vence.Day == 28 ? 1 : 0; } break;
                        case 29: { Increment = c.Vence.Day == 29 ? 1 : 0; } break;
                        case 30: { Increment = 1; } break;
                        case 31: { Increment = c.Vence.Day == 30 ? 1 : 0; } break;
                    }

                }




            }
            catch { }
        }

        private void CapitalEInteres(clsContratosBE row, DateTime _Date)
        {
            try
            {
                clsCuotasView Cuotas = new clsCuotasView();
                Cuotas.SetDataSource(row.ContratoID);
                var result = Cuotas.GetGroupWithOutMora();

                DateTime oldDate;

                bool Continue = row.TipoContratos.ContinueOnTime;
                bool IsPay = false;
                bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;



                string Usuario = Environment.MachineName.ToString();

                foreach (var c in result.OrderBy(X => X.Numero))
                {
                    DAL.Context cx = new DAL.Context();

                    int Increment = 0;

                    float _pagado = 0;
                    float _cuota = 0;
                    float Interes = 0;

                    var HasPayment = cx.clsDetalleRecibosBE.Where(x => x.Recibos.EstadoID == true && x.Recibos.ContratoID == c.ContratoID && x.CuotaID == c.CuotaID);
                    if (HasPayment.Count() > 0)
                    {
                        if (c.Numero == row.Solicitudes.Tiempo)
                        {
                            IsPay = false;
                        }
                        else
                        {
                            _pagado = HasPayment.Sum(x => x.Interes);
                            _cuota = (((Cuotas.BalanceCapital()) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);

                            if (row.InteresDiario)
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                            else
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                        }
                    }
                    else
                    {
                        _cuota = (((Cuotas.BalanceCapital()) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        IsPay = false;
                    }


                    TimeSpan diferencia = c.Vence - _Date;
                    if (row.TipoContratoID == 2 && (diferencia.Days + Increment) < row.Solicitudes.Condiciones.Dias && !IsPay && (_cuota - _pagado) > 1 && Continue == true)
                    {
                        if (HasPayment.Count() == 0)
                        {
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            if (row.InteresDiario)
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                        }
                                        break;
                                }
                            }
                            else
                            {
                                //oldDate = HasPay.OrderByDescending(x => x.Recibos.Fecha).Take(1).FirstOrDefault().Recibos.Fecha;
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                        }
                                        break;
                                }

                            }
                        }

                        TimeSpan ts = _Date - oldDate;
                        int time = ts.Days;

                        float Tiempo = 0;
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                            case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; } break;
                            case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                            case 4: { Tiempo = ts.Days; } break;
                        }

                        var Balance = c.Capital;


                        if (c.Numero == row.Solicitudes.Tiempo)
                        {
                            if (row.InteresDiario == true)
                            {
                                if (row.TipoContratos.ContinueOnTime == true)
                                {
                                    Interes = ((((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * row.Solicitudes.Tiempo / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Continue = false;
                                }
                                else
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = ((((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * row.Solicitudes.Tiempo / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = ((((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * row.Solicitudes.Tiempo/ row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        }
                                        else
                                        {
                                            Interes = ((((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * row.Solicitudes.Tiempo / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        }
                                        Continue = true;
                                    }
                                    Interes = Interes - _pagado;
                                }

                            }
                            else
                            {
                                if (row.TipoContratos.ContinueOnTime == true)
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * row.Solicitudes.Tiempo;
                                    }
                                    else
                                    {
                                        Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo * row.Solicitudes.Tiempo; 
                                    }
                                    Continue = false;
                                }
                                else
                                {
                                    if (ts.Days >= 0)
                                    {
                                        if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * row.Solicitudes.Tiempo;
                                            Continue = false;
                                        }
                                        else
                                        {
                                            if (c.Numero == row.Solicitudes.Tiempo)
                                            {
                                                Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo * row.Solicitudes.Tiempo;
                                            }
                                            else
                                            {
                                                Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * row.Solicitudes.Tiempo; ;
                                            }
                                            Continue = true;
                                        }
                                    }
                                }
                                Interes = Interes - _pagado;

                            }
                        }

                        if (c.Numero == row.Solicitudes.Tiempo && Interes > 0)
                        {
                            if (Interes >= c.Interes)
                            {
                                NDInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                            }
                            else
                            {
                                if (c.Numero != 1)
                                {
                                    var r = NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes - Interes, true, Usuario);
                                }
                            }

                            Console.WriteLine("{0} - {1} - {2} - {3} - {4}", string.Format("{0:000000}", c.ContratoID), string.Format("{0:000}", c.Numero), string.Format("{0:dd/MM/yyyy}", c.Vence), string.Format("{0:N2}", c.Balance), string.Format("{0:N2}", Interes));
                        }
                    }

                    switch (DateTime.DaysInMonth(c.Vence.Year, c.Vence.Month))
                    {
                        case 28: { Increment = c.Vence.Day == 28 ? 1 : 0; } break;
                        case 29: { Increment = c.Vence.Day == 29 ? 1 : 0; } break;
                        case 30: { Increment = 1; } break;
                        case 31: { Increment = c.Vence.Day == 30 ? 1 : 0; } break;
                    }

                }




            }
            catch { }
        }

        private void Vencimiento_10_06_2025(clsContratosBE row, DateTime _Date)
        {
            try
            {
                clsCuotasView Cuotas = new clsCuotasView();
                Cuotas.SetDataSource(row.ContratoID);
                var result = Cuotas.GetGroupWithOutMora();

                DateTime oldDate;

                bool Continue = true;
                bool IsPay = false;
                bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;



                string Usuario = Environment.MachineName.ToString();

                foreach (var c in result.OrderBy(X => X.Numero))
                {
                    DAL.Context cx = new DAL.Context();

                    int Increment = 0;
                    bool descartar = false;
                    float _pagado = 0;
                    float _cuota = 0;
                    float Interes = 0;

                    //var HasPayment = (from DR in cx.clsDetalleRecibosBE join R in cx.clsRecibosBE on DR.ReciboID equals R.ReciboID where R.EstadoID == true && R.ContratoID == row.ContratoID && DR.CuotaID == c.CuotaID select DR);
                    var HasPayment = cx.clsDetalleRecibosBE.Where(x => x.Recibos.EstadoID == true && x.Recibos.ContratoID == c.ContratoID && x.CuotaID == c.CuotaID);
                    if (HasPayment.Count() > 0)
                    {
                        if (c.Numero == row.Solicitudes.Tiempo)
                        {
                            IsPay = false;
                        }
                        else
                        {
                            _pagado =  HasPayment.Sum(x => x.Interes);
                            _cuota =  (((Cuotas.BalanceCapital()) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);

                            if (row.InteresDiario)
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                            else
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                        }
                    }
                    else
                    {
                        _cuota = (((Cuotas.BalanceCapital()) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        IsPay = false;
                    }


                    TimeSpan diferencia = c.Vence - _Date;
                    if (row.TipoContratoID == 3 && (diferencia.Days + Increment) < row.Solicitudes.Condiciones.Dias && !IsPay && (_cuota - _pagado) > 1 && Continue == true)
                    {
                        if (HasPayment.Count() == 0)
                        {
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            if (row.InteresDiario)
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                            //Completar_Interes(row, _Date, c.CuotaID, false);
                                            //descartar = true;
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                            //Completar_Interes(row, _Date, c.CuotaID, false);
                                            //descartar = true;
                                        }
                                        break;
                                }
                            }
                            else
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                        }
                                        break;
                                }

                            }
                        }

                        TimeSpan ts = _Date - oldDate;
                        int time = ts.Days;

                        float Tiempo = 0;
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                            case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; } break;
                            case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                            case 4: { Tiempo = ts.Days; } break;
                        }

                        var Balance = Cuotas.BalanceCapital();
                        bool CalculateFirst = false;
                        if (c.Numero == row.Solicitudes.Tiempo && ts.Days > 0)
                        {
                            c.Numero = 0;
                            CalculateFirst = true;
                        }

                        if (row.InteresDiario == true)
                        {
                            if (c.Numero != 1)
                            {
                                if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }
                                if (row.TipoContratos.ContinueOnTime == true)
                                {
                                    Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Continue = false;
                                }
                                else
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = ((((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        }
                                        Continue = true;
                                    }
                                    Interes = Interes - _pagado;
                                }
                            }
                        }
                        else
                        {
                            if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                            if (row.TipoContratos.ContinueOnTime == true)
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                }
                                else
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                }
                                Continue = false;
                            }
                            else
                            {
                                if (ts.Days >= 0)
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        }
                                        Continue = true;
                                    }
                                }
                            }
                            //Interes = Interes - _pagado;
                        }

                        if (!descartar)
                        {

                            if (Interes >= c.Interes)
                            {
                                NDInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                            }
                            else
                            {
                                if (c.Numero != 1)
                                {
                                    var r = NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes - Interes, true, Usuario);
                                }
                            }

                            Console.WriteLine("{0} - {1} - {2} - {3} - {4}", string.Format("{0:000000}", c.ContratoID), string.Format("{0:000}", c.Numero), string.Format("{0:dd/MM/yyyy}", c.Vence), string.Format("{0:N2}", c.Balance), string.Format("{0:N2}", Interes));
                        }
                    }
                    else
                    {
                        if (c.Interes >= 1 && c.Numero > 1)
                        {
                            var r = NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes, true, Usuario);
                        }
                    }

                    switch (DateTime.DaysInMonth(c.Vence.Year, c.Vence.Month))
                    {
                        case 28: { Increment = c.Vence.Day == 28 ? 1 : 0; } break;
                        case 29: { Increment = c.Vence.Day == 29 ? 1 : 0; } break;
                        case 30: { Increment = 1; } break;
                        case 31: { Increment = c.Vence.Day == 30 ? 1 : 0; } break;
                    }

                }




            }
            catch { }
        }

        private void Vencimiento_16_06_2025(clsContratosBE row, DateTime _Date)
        {
            try
            {

                foreach (var i in row.Cuotas)
                {
                    if (i.Numero != 1)
                    {
                        NotaCreditoInteresAutomatica(i.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", i.Interes, true, row.Usuario);
                    }
                    NotaDebitoInteresAutomaticaCreate(i.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", 0, true, row.Usuario);
                }

                clsCuotasView Cuotas = new clsCuotasView();
                Cuotas.SetDataSource(row.ContratoID);
                var result = Cuotas.GetGroupWithOutMora();

                DateTime oldDate;

                bool Continue = true;
                bool IsPay = false;
                bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;

                string Usuario = Environment.MachineName.ToString();

                foreach (var c in result.OrderBy(X => X.Numero))
                {
                    DAL.Context cx = new DAL.Context();

                    int Increment = 0;
                    bool descartar = false;
                    float _pagado = 0;
                    float _cuota = 0;
                    float Interes = 0;

                    //var HasPayment = (from DR in cx.clsDetalleRecibosBE join R in cx.clsRecibosBE on DR.ReciboID equals R.ReciboID where R.EstadoID == true && R.ContratoID == row.ContratoID && DR.CuotaID == c.CuotaID select DR);
                    var HasPayment = cx.clsDetalleRecibosBE.Where(x => x.Recibos.EstadoID == true && x.Recibos.ContratoID == c.ContratoID && x.CuotaID == c.CuotaID).ToList();
                    if (HasPayment.Count() > 0)
                    {
                        if (c.Numero == row.Solicitudes.Tiempo)
                        {
                            IsPay = false;
                        }
                        else
                        {
                            _pagado = HasPayment.Sum(x => x.Interes);
                            _cuota = (((Cuotas.BalanceCapital() ) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);

                            if (row.InteresDiario)
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                            else
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                        }
                    }
                    else
                    {
                        _cuota = (((Cuotas.BalanceCapital() ) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        IsPay = false;
                    }


                    TimeSpan diferencia = c.Vence - _Date;
                    if (row.TipoContratoID == 3 && (diferencia.Days + Increment) < row.Solicitudes.Condiciones.Dias && !IsPay && (_cuota - _pagado) > 1 && Continue == true)
                    {
                        if (HasPayment.Count() == 0)
                        {
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            if (row.InteresDiario)
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                            //Completar_Interes(row, _Date, c.CuotaID, true);
                                            //descartar = true;
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                            //Completar_Interes(row, _Date, c.CuotaID, true);
                                            //descartar = true;
                                        }
                                        break;
                                }
                            }
                            else
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                        }
                                        break;
                                }

                            }
                        }

                        TimeSpan ts = _Date - oldDate;
                        int time = ts.Days;
                        int days = ts.Days;

                        float Tiempo = 0;
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                            case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; } break;
                            case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                            case 4: { Tiempo = ts.Days; } break;
                        }

                        TimeSpan tsd;
                        var Balance = Cuotas.BalanceCapital();

                        if (row.Solicitudes.Condiciones.CondicionID == 1)
                        {
                            tsd = c.Vence - oldDate;
                            row.Solicitudes.Condiciones.Dias = tsd.Days;
                        }


                        bool CalculateFirst = false;
                        if (c.Numero == row.Solicitudes.Tiempo && ts.Days > 0)
                        {
                            c.Numero = 0;
                            CalculateFirst = true;
                        }

                        if (row.InteresDiario == true)
                        {
                            if (c.Numero != 1)
                            {
                                if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                                if (row.TipoContratos.ContinueOnTime == true)
                                {
                                    Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Continue = false;
                                }
                                else
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = ((((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        }
                                        Continue = true;
                                    }
                                    //Interes = Interes - _pagado;
                                }
                            }
                        }
                        else
                        {
                            if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                            if (row.TipoContratos.ContinueOnTime == true)
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                }
                                else
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                }
                                Continue = false;
                            }
                            else
                            {
                                if (ts.Days >= 0)
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        }
                                        Continue = true;
                                    }
                                }
                            }
                            //Interes = Interes - _pagado;
                        }


                        if (!descartar)
                        {

                            if (Interes >= c.Interes)
                            {
                                if (c.Numero != 1)
                                {
                                    NotaDebitoInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes, true, Usuario);
                                }
                            }
                            else
                            {
                                if (c.Numero != 1)
                                {
                                    NotaDebitoInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", 0, true, Usuario);

                                    c.Interes = db.clsCuotasBE.Where(x => x.CuotaID == c.CuotaID).FirstOrDefault().Interes;
                                    var r = NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes - Interes, true, Usuario);
                                }
                            }
                            Console.WriteLine("{0} - {1} - {2} - {3} - {4}", string.Format("{0:000000}", c.ContratoID), string.Format("{0:000}", c.Numero), string.Format("{0:dd/MM/yyyy}", c.Vence), string.Format("{0:N2}", c.Balance), string.Format("{0:N2}", Interes));
                        }
                    }
                    else
                    {
                        if (c.Interes >= 1 && c.Numero > 1)
                        {
                            //Aqui hay una situacion, cuando tiene el interes calculado a la fecha de hoy y atrasamos la fecha el interes se mantiene intacto.

                            c.Interes = db.clsCuotasBE.Where(x => x.CuotaID == c.CuotaID).FirstOrDefault().Interes;
                            //NotaDebitoInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", 0, true, Usuario);
                            NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes, true, Usuario);
                        }
                    }

                    switch (DateTime.DaysInMonth(c.Vence.Year, c.Vence.Month))
                    {
                        case 28: { Increment = c.Vence.Day == 28 ? 1 : 0; } break;
                        case 29: { Increment = c.Vence.Day == 29 ? 1 : 0; } break;
                        case 30: { Increment = 1; } break;
                        case 31: { Increment = c.Vence.Day == 30 ? 1 : 0; } break;
                    }

                }




            }
            catch { }
        }

        private void Vencimiento(clsContratosBE row, DateTime _Date)
        {
            try
            {

                foreach (var i in row.Cuotas)
                {
                    if (i.Numero != 1)
                    {
                        NotaCreditoInteresAutomatica(i.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", i.Interes, true, row.Usuario);
                    }
                    //NotaDebitoInteresAutomaticaCreate(i.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", 0, true, row.Usuario);
                }

                clsCuotasView Cuotas = new clsCuotasView();
                Cuotas.SetDataSource(row.ContratoID);
                var result = Cuotas.GetGroupWithOutMora();

                DateTime oldDate;

                bool Continue = true;
                bool IsPay = false;
                bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;

                string Usuario = Environment.MachineName.ToString();

                foreach (var c in result.OrderBy(X => X.Numero))
                {
                    DAL.Context cx = new DAL.Context();

                    int Increment = 0;
                    bool descartar = false;
                    float _pagado = 0;
                    float _cuota = 0;
                    float Interes = 0;

                    //var HasPayment = (from DR in cx.clsDetalleRecibosBE join R in cx.clsRecibosBE on DR.ReciboID equals R.ReciboID where R.EstadoID == true && R.ContratoID == row.ContratoID && DR.CuotaID == c.CuotaID select DR);
                    var HasPayment = cx.clsDetalleRecibosBE.Where(x => x.Recibos.EstadoID == true && x.Recibos.ContratoID == c.ContratoID && x.CuotaID == c.CuotaID).ToList();
                    if (HasPayment.Count() > 0)
                    {
                        if (c.Numero == row.Solicitudes.Tiempo)
                        {
                            IsPay = false;
                        }
                        else
                        {
                            _pagado = HasPayment.Sum(x => x.Interes);
                            _cuota = (((Cuotas.BalanceCapital()) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);

                            if (row.InteresDiario)
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                            else
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                        }
                    }
                    else
                    {
                        _cuota = (((Cuotas.BalanceCapital()) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        IsPay = false;
                    }


                    TimeSpan diferencia = c.Vence - _Date;
                    if (row.TipoContratoID == 3 && (diferencia.Days + Increment) < row.Solicitudes.Condiciones.Dias && !IsPay && (_cuota - _pagado) > 1 && Continue == true)
                    {
                        if (HasPayment.Count() == 0)
                        {
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            if (row.InteresDiario)
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                            //Completar_Interes(row, _Date, c.CuotaID, true);
                                            //descartar = true;
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                            //Completar_Interes(row, _Date, c.CuotaID, true);
                                            //descartar = true;
                                        }
                                        break;
                                }
                            }
                            else
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                        }
                                        break;
                                }

                            }
                        }

                        TimeSpan ts = _Date - oldDate;
                        int time = ts.Days;
                        int days = ts.Days;

                        float Tiempo = 0;
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                            case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; } break;
                            case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                            case 4: { Tiempo = ts.Days; } break;
                        }

                        TimeSpan tsd;

                        clsCuotasView _Cuotas = new clsCuotasView();
                        _Cuotas.SetDataSource(row.ContratoID);

                        var atrasos = _Cuotas.AtrasoGet(c.Vence);
                        var _balance = _Cuotas.BalanceCapital();

                        var Balance = c.Tmp > (_Cuotas.BalanceCapital()) ? c.Tmp : (_Cuotas.BalanceCapital());
                        if (c.Tmp == 0)
                        {
                            CuotasUpdateBalanceGetByCuotaID(c.CuotaID, Balance);
                        }


                        if (row.Solicitudes.Condiciones.CondicionID == 1)
                        {
                            tsd = c.Vence - oldDate;
                            row.Solicitudes.Condiciones.Dias = tsd.Days;
                        }


                        bool CalculateFirst = false;
                        if (c.Numero == row.Solicitudes.Tiempo && ts.Days > 0)
                        {
                            c.Numero = 0;
                            CalculateFirst = true;
                        }

                        if (row.InteresDiario == true)
                        {
                            if (c.Numero != 1)
                            {
                                if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                                if (row.TipoContratos.ContinueOnTime == true)
                                {
                                    Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Continue = false;
                                }
                                else
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = ((((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        }
                                        Continue = true;
                                    }
                                    //Interes = Interes - _pagado;
                                }
                            }
                        }
                        else
                        {
                            if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                            if (row.TipoContratos.ContinueOnTime == true)
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                }
                                else
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                }
                                Continue = false;
                            }
                            else
                            {
                                if (ts.Days >= 0)
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        }
                                        Continue = true;
                                    }
                                }
                            }
                            //Interes = Interes - _pagado;
                        }


                        if (!descartar)
                        {

                            if (Math.Round(Interes) >= Math.Round(c.Interes))
                            {
                                if (c.Numero != 1)
                                {
                                    NotaDebitoInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes, true, Usuario);
                                }
                            }
                            else
                            {
                                if (c.Numero != 1)
                                {
                                    NotaDebitoInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", 0, true, Usuario);

                                    c.Interes = db.clsCuotasBE.Where(x => x.CuotaID == c.CuotaID).FirstOrDefault().Interes;
                                    var r = NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes - Interes, true, Usuario);
                                }
                            }
                            Console.WriteLine("{0} - {1} - {2} - {3} - {4}", string.Format("{0:000000}", c.ContratoID), string.Format("{0:000}", c.Numero), string.Format("{0:dd/MM/yyyy}", c.Vence), string.Format("{0:N2}", c.Balance), string.Format("{0:N2}", Interes));
                        }
                    }
                    else
                    {
                        if (c.Interes >= 1 && c.Numero > 1)
                        {
                            //Aqui hay una situacion, cuando tiene el interes calculado a la fecha de hoy y atrasamos la fecha el interes se mantiene intacto.

                            c.Interes = db.clsCuotasBE.Where(x => x.CuotaID == c.CuotaID).FirstOrDefault().Interes;
                            NotaDebitoInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", 0, true, Usuario);
                            NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes, true, Usuario);
                        }
                    }

                    switch (DateTime.DaysInMonth(c.Vence.Year, c.Vence.Month))
                    {
                        case 28: { Increment = c.Vence.Day == 28 ? 1 : 0; } break;
                        case 29: { Increment = c.Vence.Day == 29 ? 1 : 0; } break;
                        case 30: { Increment = 1; } break;
                        case 31: { Increment = c.Vence.Day == 30 ? 1 : 0; } break;
                    }

                }




            }
            catch { }
        }

        private void Interes_Capitalizado(clsContratosBE row, DateTime _Date)
        {
            try
            {

                foreach (var i in row.Cuotas)
                {
                    if (i.Numero != 1)
                    {
                        NotaCreditoInteresAutomatica(i.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", i.Interes, true, row.Usuario);
                    }
                    //NotaDebitoInteresAutomaticaCreate(i.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", 0, true, row.Usuario);
                }

                clsCuotasView Cuotas = new clsCuotasView();
                Cuotas.SetDataSource(row.ContratoID);
                var result = Cuotas.GetGroupWithOutMora();

                DateTime oldDate;

                bool Continue = true;
                bool IsPay = false;
                bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;

                string Usuario = Environment.MachineName.ToString();

                foreach (var c in result.OrderBy(X => X.Numero))
                {
                    DAL.Context cx = new DAL.Context();

                    int Increment = 0;
                    bool descartar = false;
                    float _pagado = 0;
                    float _cuota = 0;
                    float Interes = 0;

                    //var HasPayment = (from DR in cx.clsDetalleRecibosBE join R in cx.clsRecibosBE on DR.ReciboID equals R.ReciboID where R.EstadoID == true && R.ContratoID == row.ContratoID && DR.CuotaID == c.CuotaID select DR);
                    var HasPayment = cx.clsDetalleRecibosBE.Where(x => x.Recibos.EstadoID == true && x.Recibos.ContratoID == c.ContratoID && x.CuotaID == c.CuotaID).ToList();
                    if (HasPayment.Count() > 0)
                    {
                        if (c.Numero == row.Solicitudes.Tiempo)
                        {
                            IsPay = false;
                        }
                        else
                        {
                            _pagado = HasPayment.Sum(x => x.Interes);
                            _cuota = (((Cuotas.BalanceCapital() + Cuotas.AtrasoGet(c.Vence)) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);

                            if (row.InteresDiario)
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                            else
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                        }
                    }
                    else
                    {
                        _cuota = (((Cuotas.BalanceCapital() + Cuotas.AtrasoGet(c.Vence)) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        IsPay = false;
                    }


                    TimeSpan diferencia = c.Vence - _Date;
                    if (row.TipoContratoID == 5 && (diferencia.Days + Increment) < row.Solicitudes.Condiciones.Dias && !IsPay && (_cuota - _pagado) > 1 && Continue == true && c.IsComputed == false)
                    {
                        if (HasPayment.Count() == 0)
                        {
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            if (row.InteresDiario)
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                            //Completar_Interes(row, _Date, c.CuotaID, true);
                                            //descartar = true;
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(- row.Solicitudes.Condiciones.Dias);
                                            //Completar_Interes(row, _Date, c.CuotaID, true);
                                            //descartar = true;
                                        }
                                        break;
                                }
                            }
                            else
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                        }
                                        break;
                                }

                            }
                        }

                        TimeSpan ts = _Date - oldDate;
                        int time = ts.Days;
                        int days = ts.Days;

                        float Tiempo = 0;
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                            case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; } break;
                            case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                            case 4: { Tiempo = ts.Days; } break;
                        }

                        TimeSpan tsd;

                        clsCuotasView _Cuotas = new clsCuotasView();
                        _Cuotas.SetDataSource(row.ContratoID);

                        var atrasos = _Cuotas.AtrasoGet(c.Vence);
                        var _balance = _Cuotas.BalanceCapital();

                        var Balance = c.Tmp > (_Cuotas.BalanceCapital() + _Cuotas.AtrasoGet(c.Vence)) ? c.Tmp : (_Cuotas.BalanceCapital() + _Cuotas.AtrasoGet(c.Vence));
                        //if (c.Tmp == 0)
                        //{
                        //    CuotasUpdateBalanceGetByCuotaID(c.CuotaID, Balance);
                        //}


                        if (row.Solicitudes.Condiciones.CondicionID == 1)
                        {
                            tsd = c.Vence - oldDate;
                            row.Solicitudes.Condiciones.Dias = tsd.Days;
                        }


                        bool CalculateFirst = false;
                        if (c.Numero == row.Solicitudes.Tiempo && ts.Days > 0)
                        {
                            c.Numero = 0;
                            CalculateFirst = true;
                        }

                        if (row.InteresDiario == true)
                        {
                            if (c.Numero != 1)
                            {
                                if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                                if (row.TipoContratos.ContinueOnTime == true)
                                {
                                    Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Continue = false;
                                }
                                else
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = ((((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                            CuotasUpdateGetByCuotaID(c.CuotaID, true);
                                            CuotasUpdateBalanceGetByCuotaID(c.CuotaID, Balance);
                                            
                                        }
                                        Continue = true;
                                    }
                                    //Interes = Interes - _pagado;
                                }
                            }
                        }
                        else
                        {
                            if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                            if (row.TipoContratos.ContinueOnTime == true)
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                }
                                else
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                }
                                Continue = false;
                            }
                            else
                            {
                                if (ts.Days >= 0)
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                            CuotasUpdateGetByCuotaID(c.CuotaID, true);
                                            CuotasUpdateBalanceGetByCuotaID(c.CuotaID, Balance);
                                        }
                                        Continue = true;
                                    }
                                }
                            }
                            //Interes = Interes - _pagado;
                        }


                        if (!descartar)
                        {

                            if (Math.Round(Interes) >= Math.Round(c.Interes))
                            {
                                if (c.Numero != 1 && c.IsComputed == false)
                                {
                                    NotaDebitoInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes, true, Usuario);
                                }
                            }
                            else
                            {
                                if (c.Numero != 1 && c.IsComputed == false)
                                {
                                    NotaDebitoInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", 0, true, Usuario);

                                    c.Interes = db.clsCuotasBE.Where(x => x.CuotaID == c.CuotaID).FirstOrDefault().Interes;
                                    var r = NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes - Interes, true, Usuario);
                                }
                            }
                            Console.WriteLine("{0} - {1} - {2} - {3} - {4}", string.Format("{0:000000}", c.ContratoID), string.Format("{0:000}", c.Numero), string.Format("{0:dd/MM/yyyy}", c.Vence), string.Format("{0:N2}", c.Balance), string.Format("{0:N2}", Interes));
                        }
                    }
                    else
                    {
                        if (c.Interes >= 1 && c.Numero > 1 && c.IsComputed== false)
                        {
                            //Aqui hay una situacion, cuando tiene el interes calculado a la fecha de hoy y atrasamos la fecha el interes se mantiene intacto.

                            c.Interes = db.clsCuotasBE.Where(x => x.CuotaID == c.CuotaID).FirstOrDefault().Interes;
                            NotaDebitoInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", 0, true, Usuario);
                            NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes, true, Usuario);
                        }
                    }

                    switch (DateTime.DaysInMonth(c.Vence.Year, c.Vence.Month))
                    {
                        case 28: { Increment = c.Vence.Day == 28 ? 1 : 0; } break;
                        case 29: { Increment = c.Vence.Day == 29 ? 1 : 0; } break;
                        case 30: { Increment = 1; } break;
                        case 31: { Increment = c.Vence.Day == 30 ? 1 : 0; } break;
                    }

                }




            }
            catch { }
        }

        private void Completar_Interes(clsContratosBE row, DateTime _Date,int CuotaID, bool IsCapitalizable)
        {
            try
            {
                clsCuotasView Cuotas = new clsCuotasView();
                Cuotas.SetDataSource(row.ContratoID);
                var result = Cuotas.GetGroupWithOutMora();

                DateTime oldDate;

                bool Continue = true;
                bool IsPay = false;
                bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;

                string Usuario = Environment.MachineName.ToString();

                foreach (var c in result.Where(x=>x.CuotaID == CuotaID).OrderBy(X => X.Numero))
                {
                    DAL.Context cx = new DAL.Context();

                    int Increment = 0;

                    float _pagado = 0;
                    float _cuota = 0;
                    float Interes = 0;

                    var HasPayment = cx.clsDetalleRecibosBE.Where(x => x.Recibos.EstadoID == true && x.Recibos.ContratoID == c.ContratoID && x.CuotaID == c.CuotaID).ToList();
                    if (HasPayment.Count() > 0)
                    {
                        if (c.Numero == row.Solicitudes.Tiempo)
                        {
                            IsPay = false;
                        }
                        else
                        {
                            _pagado = HasPayment.Sum(x => x.Interes);
                            _cuota = (((Cuotas.BalanceCapital() + (IsCapitalizable == true ? Cuotas.AtrasoGet(c.Vence) : 0)) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);

                            if (row.InteresDiario)
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                            else
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                        }
                    }
                    else
                    {
                        _cuota = (((Cuotas.BalanceCapital() + (IsCapitalizable == true ? Cuotas.AtrasoGet(c.Vence) : 0)) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        IsPay = false;
                    }


                    TimeSpan diferencia = c.Vence - _Date;
                    if (row.TipoContratoID == 5 && (diferencia.Days + Increment) < row.Solicitudes.Condiciones.Dias && !IsPay && (_cuota - _pagado) > 1 && Continue == true)
                    {
                        if (HasPayment.Count() == 0)
                        {
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            if (row.InteresDiario)
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = HasPayment.Count() == 0 ? c.Vence.AddMonths(-1) : HasPayment.FirstOrDefault().Recibos.Fecha;
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                        }
                                        break;
                                }
                            }
                            else
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                        }
                                        break;
                                }

                            }
                        }

                        TimeSpan ts = (HasPayment.Count == 0 ? _Date : c.Vence) - oldDate;
                        int time = ts.Days;
                        int days = ts.Days;

                        float Tiempo = 0;
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                            case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; } break;
                            case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                            case 4: { Tiempo = ts.Days; } break;
                        }

                        TimeSpan tsd;

                        var Balance = Cuotas.BalanceCapital() + (IsCapitalizable == true ? Cuotas.AtrasoGet(c.Vence) : 0);
                        if (row.Solicitudes.Condiciones.CondicionID == 1)
                        {
                            tsd = c.Vence - (HasPayment.Count == 0 ? oldDate : c.Vence.AddMonths(-1));
                            row.Solicitudes.Condiciones.Dias = tsd.Days;

                        }


                        bool CalculateFirst = false;
                        if (c.Numero == row.Solicitudes.Tiempo && ts.Days > 0)
                        {
                            c.Numero = 0;
                            CalculateFirst = true;
                        }

                        if (row.InteresDiario == true)
                        {
                            if (c.Numero != 1)
                            {
                                if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                                if (row.TipoContratos.ContinueOnTime == true)
                                {
                                    Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Continue = false;
                                }
                                else
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = ((((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        }
                                        Continue = true;
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                            if (row.TipoContratos.ContinueOnTime == true)
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                }
                                else
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                }
                                Continue = false;
                            }
                            else
                            {
                                if (ts.Days >= 0)
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        }
                                        Continue = true;
                                    }
                                }
                            }
                            //Interes = Interes - _pagado;
                        }



                        if (Interes >= c.Interes)
                        {
                            NDInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                        }


                        Console.WriteLine("{0} - {1} - {2} - {3} - {4}", string.Format("{0:000000}", c.ContratoID), string.Format("{0:000}", c.Numero), string.Format("{0:dd/MM/yyyy}", c.Vence), string.Format("{0:N2}", c.Balance), string.Format("{0:N2}", Interes));
                    }

                    switch (DateTime.DaysInMonth(c.Vence.Year, c.Vence.Month))
                    {
                        case 28: { Increment = c.Vence.Day == 28 ? 1 : 0; } break;
                        case 29: { Increment = c.Vence.Day == 29 ? 1 : 0; } break;
                        case 30: { Increment = 1; } break;
                        case 31: { Increment = c.Vence.Day == 30 ? 1 : 0; } break;
                    }

                }




            }
            catch { }
        }

        private void Interes_Capitalizado_10_06_2025(clsContratosBE row, DateTime _Date)
        {
            try
            {
                clsCuotasView Cuotas = new clsCuotasView();
                Cuotas.SetDataSource(row.ContratoID);
                var result = Cuotas.GetGroupWithOutMora();

                DateTime oldDate;

                bool Continue = true;
                bool IsPay = false;
                bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;

                string Usuario = Environment.MachineName.ToString();

                foreach (var c in result.OrderBy(X => X.Numero))
                {
                    DAL.Context cx = new DAL.Context();

                    int Increment = 0;
                    bool descartar = false;
                    float _pagado = 0;
                    float _cuota = 0;
                    float Interes = 0;

                    //var HasPayment = (from DR in cx.clsDetalleRecibosBE join R in cx.clsRecibosBE on DR.ReciboID equals R.ReciboID where R.EstadoID == true && R.ContratoID == row.ContratoID && DR.CuotaID == c.CuotaID select DR);
                    var HasPayment = cx.clsDetalleRecibosBE.Where(x => x.Recibos.EstadoID == true && x.Recibos.ContratoID == c.ContratoID && x.CuotaID == c.CuotaID).ToList();
                    if (HasPayment.Count() > 0)
                    {
                        if (c.Numero == row.Solicitudes.Tiempo)
                        {
                            IsPay = false;
                        }
                        else
                        {
                            _pagado = HasPayment.Sum(x => x.Interes);
                            _cuota = (((Cuotas.BalanceCapital() + Cuotas.AtrasoGet(c.Vence)) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);

                            if (row.InteresDiario)
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                            else
                            {
                                if (_pagado >= _cuota)
                                {
                                    IsPay = true;
                                }
                                else
                                {
                                    IsPay = false;
                                }
                            }
                        }
                    }
                    else
                    {
                        _cuota = (((Cuotas.BalanceCapital() + Cuotas.AtrasoGet(c.Vence)) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        IsPay = false;
                    }


                    TimeSpan diferencia = c.Vence - _Date;
                    if (row.TipoContratoID == 5 && (diferencia.Days + Increment) < row.Solicitudes.Condiciones.Dias && !IsPay && (_cuota - _pagado) > 1 && Continue == true)
                    {
                        if (HasPayment.Count() == 0)
                        {
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            if (row.InteresDiario)
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                            //Completar_Interes(row, _Date, c.CuotaID, true);
                                            //descartar = true;
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                            //Completar_Interes(row, _Date, c.CuotaID, true);
                                            //descartar = true;
                                        }
                                        break;
                                }
                            }
                            else
                            {
                                //oldDate = HasPay.OrderByDescending(x => x.Recibos.Fecha).Take(1).FirstOrDefault().Recibos.Fecha;
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                        }
                                        break;
                                }

                            }
                        }

                        TimeSpan ts = _Date - oldDate;
                        int time = ts.Days;
                        int days = ts.Days;

                        float Tiempo = 0;
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                            case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; } break;
                            case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                            case 4: { Tiempo = ts.Days; } break;
                        }

                        TimeSpan tsd;
                        var Balance = Cuotas.BalanceCapital() + Cuotas.AtrasoGet(c.Vence);

                        if (row.Solicitudes.Condiciones.CondicionID == 1)
                        {
                            tsd = c.Vence - oldDate;
                            row.Solicitudes.Condiciones.Dias = tsd.Days;
                        }


                        bool CalculateFirst = false;
                        if (c.Numero == row.Solicitudes.Tiempo && ts.Days > 0)
                        {
                            c.Numero = 0;
                            CalculateFirst = true;
                        }

                        if (row.InteresDiario == true)
                        {
                            if (c.Numero != 1)
                            {
                                if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                                if (row.TipoContratos.ContinueOnTime == true)
                                {
                                    Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Continue = false;
                                }
                                else
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = ((((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                            //Interes = ((((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        }
                                        Continue = true;
                                    }
                                    Interes = Interes - _pagado;
                                }
                            }
                        }
                        else
                        {
                            if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                            if (row.TipoContratos.ContinueOnTime == true)
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                }
                                else
                                {
                                    Interes = ((Balance * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                }
                                Continue = false;
                            }
                            else
                            {
                                if (ts.Days >= 0)
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        }
                                        Continue = true;
                                    }
                                }
                            }
                            Interes = Interes - _pagado;
                        }


                        if (!descartar)
                        {
                            if (Interes >= c.Interes)
                            {
                                NDInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                            }
                            else
                            {
                                if (c.Numero != 1)
                                {
                                    var r = NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes - Interes, true, Usuario);
                                }
                            }
                            Console.WriteLine("{0} - {1} - {2} - {3} - {4}", string.Format("{0:000000}", c.ContratoID), string.Format("{0:000}", c.Numero), string.Format("{0:dd/MM/yyyy}", c.Vence), string.Format("{0:N2}", c.Balance), string.Format("{0:N2}", Interes));
                        }
                    }
                    else
                    {
                        if (c.Interes >= 1 && c.Numero > 1)
                        {
                            var r = NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes, true, Usuario);
                        }
                    }

                    switch (DateTime.DaysInMonth(c.Vence.Year, c.Vence.Month))
                    {
                        case 28: { Increment = c.Vence.Day == 28 ? 1 : 0; } break;
                        case 29: { Increment = c.Vence.Day == 29 ? 1 : 0; } break;
                        case 30: { Increment = 1; } break;
                        case 31: { Increment = c.Vence.Day == 30 ? 1 : 0; } break;
                    }

                }




            }
            catch { }
        }

        private void Interes_Capitalizado_root(clsContratosBE row, DateTime _Date)
        {
            try
            {
                clsCuotasView Cuotas = new clsCuotasView();
                Cuotas.SetDataSource(row.ContratoID);
                var result = Cuotas.GetGroupWithOutMora();

                DateTime oldDate;

                bool Continue = true;
                bool IsPay = false;
                bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;

                string Usuario = Environment.MachineName.ToString();

                foreach (var c in result.OrderBy(X => X.Numero))
                {
                    DAL.Context cx = new DAL.Context();
                    int Increment = 0;
          
                    float _pagado = 0;
                    float _cuota = 0;
                    float Interes = 0;

                    var recibos = cx.clsDetalleRecibosBE.Where(x => x.Recibos.EstadoID == true && x.Recibos.ContratoID == c.ContratoID && x.CuotaID == c.CuotaID).ToList();
                   
                    _pagado = recibos.Sum(x => x.Interes);
                    _cuota = (((Cuotas.BalanceCapital() + Cuotas.AtrasoGet(c.Vence)) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);


                    if (recibos.Count() == 0)
                    {  
                        IsPay = false;
                    }
                    else
                    {
                        oldDate = recibos.FirstOrDefault().Recibos.Fecha;
                        if (c.Numero == row.Solicitudes.Tiempo)
                        {
                            IsPay = false;
                        }
                        else
                        { 
                            if(_pagado >= _cuota)
                            {
                                IsPay = true;
                            }
                            else
                            {
                                IsPay = false;
                            }
                        }
                    }

                    TimeSpan diferencia = c.Vence - _Date;
                    if (row.TipoContratoID == 5 && (diferencia.Days + Increment) < row.Solicitudes.Condiciones.Dias && !IsPay && (_cuota - _pagado) > 1 && Continue == true)
                    {
                        if (recibos.Count() == 0)
                        {
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            if (row.InteresDiario)
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                            //oldDate = recibos.Count() == 0 ? c.Vence.AddMonths(-1) : recibos.FirstOrDefault().Recibos.Fecha;
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                        }
                                        break;
                                }
                            }
                            else
                            {
                                switch (row.Solicitudes.CondicionID)
                                {
                                    case 1:
                                        {
                                            oldDate = c.Vence.AddMonths(-1);
                                        }
                                        break;
                                    default:
                                        {
                                            oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                        }
                                        break;
                                }

                            }
                        }

                        //TimeSpan ts = recibos.Count == 0 ? _Date - oldDate : c.Vence - oldDate;
                        TimeSpan ts = _Date - oldDate;
                        //int time = ts.Days;
                        //int days = ts.Days;

                        float Tiempo = 0;
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                            case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; } break;
                            case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                            case 4: { Tiempo = ts.Days; } break;
                        }

                        var Balance = Cuotas.BalanceCapital() + Cuotas.AtrasoGet(c.Vence);
                        TimeSpan tsd;

                        if (row.Solicitudes.Condiciones.CondicionID == 1)
                        {
                            tsd = c.Vence - (recibos.Count == 0 ? oldDate : c.Vence.AddMonths(-1));
                            row.Solicitudes.Condiciones.Dias = tsd.Days;

                            //if ((row.Solicitudes.Condiciones.Dias - ts.Days) > 10)
                            //{
                            //    days = row.Solicitudes.Condiciones.Dias;
                            //}
                            //else
                            //{
                            //    days = tsd.Days;
                            //}
                        }

                        if (row.InteresDiario == true)
                        {
                            if (c.Numero != 1)
                            {
                                //if (CalculateFirst) { c.Numero = row.Solicitudes.Tiempo; }

                                if (row.TipoContratos.ContinueOnTime == true)
                                {
                                    Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Continue = false;
                                }
                                else
                                {
                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                    {
                                        Interes = ((((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        Continue = false;
                                    }
                                    else
                                    {
                                        if (c.Numero == row.Solicitudes.Tiempo)
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                        }
                                        else
                                        {
                                            Interes = (((Balance) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                        }
                                        Continue = true;
                                    }
                                    //Interes = Interes - _pagado;
                                }
                            }
                        }
                        else
                        {

                        }

                        if (Interes >= c.Interes)
                        {
                            NDInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                        }
                        else
                        {
                            if (c.Numero != 1)
                            {
                                var r = NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes - Interes, true, Usuario);
                            }
                        }
                        Console.WriteLine("{0} - {1} - {2} - {3} - {4}", string.Format("{0:000000}", c.ContratoID), string.Format("{0:000}", c.Numero), string.Format("{0:dd/MM/yyyy}", c.Vence), string.Format("{0:N2}", c.Balance), string.Format("{0:N2}", Interes));

                    }
                    else
                    {
                        if (c.Interes >= 1 && c.Numero > 1)
                        {
                            var r = NotaCreditoInteresAutomatica(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes, true, Usuario);
                        }
                    }

                    switch (DateTime.DaysInMonth(c.Vence.Year, c.Vence.Month))
                    {
                        case 28: { Increment = c.Vence.Day == 28 ? 1 : 0; } break;
                        case 29: { Increment = c.Vence.Day == 29 ? 1 : 0; } break;
                        case 30: { Increment = 1; } break;
                        case 31: { Increment = c.Vence.Day == 30 ? 1 : 0; } break;
                    }
                }
            }
            catch { }
        }

        private void Amortizar00(clsContratosBE row, DateTime _Date)
        {
            float Interes = 0;
            bool IsComputed = false;
            DateTime oldDate;
            string Usuario = Environment.MachineName.ToString();

            clsCuotasView Cuotas = new clsCuotasView();
            Cuotas.SetDataSource(row.ContratoID);
            var result = Cuotas.GetGroupWithOutMora();
            bool Continue = true;
            bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;
            int Increment = 0;

            foreach (var c in result.OrderBy(X => X.Numero))
            {
                DAL.Context cx = new DAL.Context();
                float pago = 0;

                var HasPay = (from DR in cx.clsDetalleRecibosBE join R in cx.clsRecibosBE on DR.ReciboID equals R.ReciboID where R.EstadoID == true && R.ContratoID == row.ContratoID && DR.CuotaID == c.CuotaID select DR);
                if (HasPay.Count() > 0)
                {
                    if (c.Numero == row.Solicitudes.Tiempo)
                    {
                        IsComputed = false;
                    }
                    else
                    {
                        pago = HasPay.Sum(x => x.Interes);
                        var CI = (((Cuotas.BalanceCapital()) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        if (row.InteresDiario)
                        {
                            if (pago >= CI)
                            {
                                IsComputed = true;
                            }
                            else
                            {
                                IsComputed = false;
                            }
                        }
                        else
                        {
                            if (pago >= CI)
                            {
                                IsComputed = true;
                            }
                            else
                            {
                                IsComputed = false;
                            }
                        }
                    }
                }
                else
                {
                    IsComputed = false;
                }


                TimeSpan dif = c.Vence - _Date;
                if ((row.TipoContratoID == 1 || row.TipoContratoID == 4) && IsComputed == false && Continue == true && (dif.Days + Increment) < row.Solicitudes.Condiciones.Dias)
                {
                    if (HasPay.Count() == 0)
                    {
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1:
                                {
                                    oldDate = c.Vence.AddMonths(-1);
                                }
                                break;
                            default:
                                {
                                    oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                }
                                break;
                        }
                    }
                    else
                    {
                        if (row.InteresDiario)
                        {
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            //oldDate = HasPay.OrderByDescending(x => x.Recibos.Fecha).Take(1).FirstOrDefault().Recibos.Fecha;
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                    }

                    TimeSpan ts = _Date - oldDate;
                    int time = ts.Days;

                    float Tiempo = 0;
                    switch (row.Solicitudes.CondicionID)
                    {
                        case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                        case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; } break;
                        case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                        case 4: { Tiempo = ts.Days; } break;
                    }

                    var B = Cuotas.BalanceCapital();
                    if (row.InteresDiario == true)
                    {
                        if (c.Numero != 1)
                        {
                            if (row.TipoContratos.ContinueOnTime == true)
                            {
                                Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                Continue = false;
                            }
                            else
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    //Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Interes = ((((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Continue = false;
                                    IsComputed = false;
                                }
                                else
                                {
                                    if (c.Numero == row.Solicitudes.Tiempo)
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    }
                                    else
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                    }
                                    Continue = true;
                                    IsComputed = true;
                                }
                                Interes = Interes - pago;
                            }
                        }
                    }
                    else
                    {
                        //Certificado 100%
                        if (row.TipoContratos.ContinueOnTime == true)
                        {
                            if (ts.Days < row.Solicitudes.Condiciones.Dias)
                            {
                                Interes = ((B * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                Continue = false;
                            }
                            else
                            {
                                Interes = Interes = ((B * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                Continue = false;
                                //IsComputed = true;
                            }
                        }
                        else
                        {
                            if (ts.Days >= 0)
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                    Continue = false;
                                }
                                else
                                {
                                    if (c.Numero == row.Solicitudes.Tiempo)
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                    }
                                    else
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                    }
                                    Continue = true;
                                }
                                IsComputed = true;
                            }
                            else
                            {
                                Continue = false;
                            }
                            Interes = Interes - pago;
                        }
                    }

                    if (Interes >= c.Interes)
                    {
                        if (c.IsComputed)
                        {
                            var r = NDInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                        }
                        else
                        {
                            var r = NDInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                        }
                    }
                    else
                    {
                        if (c.IsComputed == false)
                        {
                            if (c.Numero != 1)
                            {
                                var r = NCInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes - Interes, true, Usuario);
                            }
                        }
                    }

                    //CuotasUpdateGetByCuotaID(c.CuotaID, IsComputed);
                    Console.WriteLine("{0} - {1} - {2} - {3} - {4}", c.ContratoID, c.CuotaID, c.Vence, c.Balance, Interes);
                }
                else
                {
                    if (c.Interes >= 1 && c.IsComputed == false && c.Numero > 1)
                    {
                        float _interes = Interes = ((Cuotas.BalanceCapital() * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        var r = NCInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, DateTime.Today, "AJUSTE A CARGOS AUTOMATICOS", _interes, true, Usuario);
                    }
                }

                switch (DateTime.DaysInMonth(c.Vence.Year, c.Vence.Month))
                {
                    case 28: { Increment = c.Vence.Day == 28 ? 1 : 0; } break;
                    case 29: { Increment = c.Vence.Day == 29 ? 1 : 0; } break;
                    case 30: { Increment = 1; } break;
                    case 31: { Increment = c.Vence.Day == 30 ? 1 : 0; } break;
                }
            }
        }

        private void Vencimiento00(clsContratosBE row, DateTime _Date)
        {
            DateTime tmpDate = _Date;
            float Interes = 0;
            bool IsComputed = false;
            DateTime oldDate;
            string Usuario = Environment.MachineName.ToString();

            clsCuotasView Cuotas = new clsCuotasView();
            Cuotas.SetDataSource(row.ContratoID);
            var result = Cuotas.GetGroupWithOutMora();
            bool Continue = true;
            bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;
            int Increment = 0;

            foreach (var c in result.OrderBy(X => X.Numero))
            {
                DAL.Context cx = new DAL.Context();
                float pago = 0;

                if(c.Numero == 11 )
                { }

                var HasPay = (from DR in cx.clsDetalleRecibosBE join R in cx.clsRecibosBE on DR.ReciboID equals R.ReciboID where R.EstadoID == true && R.ContratoID == row.ContratoID && DR.CuotaID == c.CuotaID select DR);
                if (HasPay.Count() > 0)
                {
                    if (c.Numero == row.Solicitudes.Tiempo)
                    {
                        IsComputed = false;
                    }
                    else
                    {
                        pago = HasPay.Sum(x => x.Interes);
                        var CI = (((Cuotas.BalanceCapital()) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        if (row.InteresDiario)
                        {
                            if (pago >= CI)
                            {
                                IsComputed = true;
                            }
                            else
                            {
                                IsComputed = false;
                            }
                        }
                        else
                        {
                            if (pago >= CI)
                            {
                                IsComputed = true;
                            }
                            else
                            {
                                IsComputed = false;
                            }
                        }
                    }
                }
                else
                {
                    IsComputed = false;
                }

                TimeSpan dif = c.Vence - _Date;
                if (row.TipoContratoID == 3 && Continue == true && IsComputed == false && (dif.Days+Increment) < row.Solicitudes.Condiciones.Dias)
                //if (row.TipoContratoID == 3 && Continue == true && IsComputed == false && c.Vence <= _Date)
                {

                    if (HasPay.Count() == 0)
                    {
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1:
                                {
                                    oldDate = c.Vence.AddMonths(-1);
                                }
                                break;
                            default:
                                {
                                    oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                }
                                break;
                        }
                    }
                    else
                    {
                        if (row.InteresDiario)
                        {
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            //oldDate = HasPay.OrderByDescending(x => x.Recibos.Fecha).Take(1).FirstOrDefault().Recibos.Fecha;
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }

                        }
                    }

                    TimeSpan ts =   _Date - oldDate;

                    int time = ts.Days;

                    float Tiempo = 0;
                    switch (row.Solicitudes.CondicionID)
                    {
                        case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                        case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; } break;
                        case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                        case 4: { Tiempo = ts.Days; } break;
                    }

                    var B = Cuotas.BalanceCapital();

                    if (c.Numero == 11)
                    { }


                    if (row.InteresDiario == true)
                    {
                        if (c.Numero != 1)
                        {
                            if (row.TipoContratos.ContinueOnTime == true)
                            {
                                Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                Continue = false;
                            }
                            else
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    Interes = ((((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses)/row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Continue = false;
                                    IsComputed = false;
                                }
                                else
                                {
                                    if (c.Numero == row.Solicitudes.Tiempo)
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    }
                                    else
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                    }
                                    Continue = true;
                                    IsComputed = true;
                                }
                                Interes = Interes - pago;
                            }
                        }
                    }
                    else
                    {
                        //Certificado 100%
                        if (row.TipoContratos.ContinueOnTime == true)
                        {
                            if (ts.Days < row.Solicitudes.Condiciones.Dias)
                            {
                                Interes = ((B * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                Continue = false;
                            }
                            else
                            {
                                Interes = Interes = ((B * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                Continue = false;
                                //IsComputed = true;
                            }
                        }
                        else
                        {
                            if (ts.Days >= 0)
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                    Continue = false;
                                }
                                else
                                {
                                    if (c.Numero == row.Solicitudes.Tiempo)
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                    }
                                    else
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                    }
                                    Continue = true;
                                }
                                IsComputed = true;
                            }
                            else
                            {
                                Continue = false;
                            }
                            Interes = Interes - pago;
                        }
                    }

                    if (Interes >= c.Interes)
                    {
                        if (c.IsComputed)
                        {
                            var r = NDInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                        }
                        else
                        {
                            var r = NDInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                        }
                    }
                    else
                    {
                        if (c.IsComputed == false)
                        {
                            if (c.Numero != 1)
                            {
                                var r = NCInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes - Interes, true, Usuario);
                            }
                        }
                    }

                    //CuotasUpdateGetByCuotaID(c.CuotaID, IsComputed);
                    Console.WriteLine("{0} - {1} - {2} - {3} - {4}", c.ContratoID, c.CuotaID, c.Vence, c.Balance, Interes);
                }
                else
                {
                    if (c.Interes >= 1 && c.IsComputed == false && c.Numero > 1)
                    {
                        float _interes = Interes = ((Cuotas.BalanceCapital() * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        var r = NCInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, DateTime.Today, "AJUSTE A CARGOS AUTOMATICOS", _interes, true, Usuario);
                    }
                }

                switch (DateTime.DaysInMonth(c.Vence.Year, c.Vence.Month))
                {
                    case 28: { Increment = c.Vence.Day == 28 ? 1 : 0; } break;
                    case 29: { Increment = c.Vence.Day == 29 ? 1 : 0; } break;
                    case 30: { Increment = 1; } break;
                    case 31: { Increment = c.Vence.Day == 30 ? 1 : 0; } break;
                }
            }
        }

        private void Interes_Capitalizado00(clsContratosBE row, DateTime _Date)
        {
            float Interes = 0;
            bool IsComputed = false;
            DateTime oldDate;
            string Usuario = Environment.MachineName.ToString();

            clsCuotasView Cuotas = new clsCuotasView();
            Cuotas.SetDataSource(row.ContratoID);
            var result = Cuotas.GetGroupWithOutMora();
            bool Continue = true;
            bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;
            int Increment = 0;

            foreach (var c in result.OrderBy(X => X.Numero))
            {

                DAL.Context cx = new DAL.Context();
                float pago = 0;

                var HasPay = (from DR in cx.clsDetalleRecibosBE join R in cx.clsRecibosBE on DR.ReciboID equals R.ReciboID where R.EstadoID == true && R.ContratoID == row.ContratoID && DR.CuotaID == c.CuotaID select DR);
                if (HasPay.Count() > 0)
                {
                    if (c.Numero == row.Solicitudes.Tiempo)
                    {
                        IsComputed = false;
                    }
                    else
                    {
                        pago = HasPay.Sum(x => x.Interes);

                        var CI = (((Cuotas.BalanceCapital() + Cuotas.AtrasoGet(c.Vence)) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        if (row.InteresDiario)
                        {
                            if (pago >= CI)
                            {
                                IsComputed = true;
                            }
                            else
                            {
                                IsComputed = false;
                            }
                        }
                        else
                        {
                            if (pago >= CI)
                            {
                                IsComputed = true;
                            }
                            else
                            {
                                IsComputed = false;
                            }
                        }
                    }
                }
                else
                {
                    IsComputed = false;
                }


                TimeSpan dif = c.Vence - _Date;
                if (row.TipoContratoID == 5 && Continue == true && IsComputed == false && (dif.Days + Increment) < row.Solicitudes.Condiciones.Dias)
                {

                    if (HasPay.Count() == 0)
                    {
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1:
                                {
                                    oldDate = c.Vence.AddMonths(-1);
                                }
                                break;
                            default:
                                {
                                    oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                }
                                break;
                        }
                    }
                    else
                    {
                        if (row.InteresDiario)
                        {
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                        else
                        {
                            //oldDate = HasPay.OrderByDescending(x => x.Recibos.Fecha).Take(1).FirstOrDefault().Recibos.Fecha;
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1:
                                    {
                                        oldDate = c.Vence.AddMonths(-1);
                                    }
                                    break;
                                default:
                                    {
                                        oldDate = c.Vence.AddDays(-row.Solicitudes.Condiciones.Dias);
                                    }
                                    break;
                            }
                        }
                    }

                    TimeSpan ts = _Date - oldDate;

                    int time = ts.Days;

                    float Tiempo = 0;
                    switch (row.Solicitudes.CondicionID)
                    {
                        case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                        case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; } break;
                        case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                        case 4: { Tiempo = ts.Days; } break;
                    }

                    var B = Cuotas.BalanceCapital() + Cuotas.AtrasoGet(c.Vence);
                    //var atraso = Cuotas.AtrasoGet(_Date);

                    if (row.InteresDiario == true)
                    {
                        if (c.Numero != 1)
                        {
                            if (row.TipoContratos.ContinueOnTime == true)
                            {
                                Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                Continue = false;
                            }
                            else
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    //Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Interes = ((((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    Continue = false;
                                    IsComputed = false;
                                }
                                else
                                {
                                    if (c.Numero == row.Solicitudes.Tiempo)
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                    }
                                    else
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                    }
                                    Continue = true;
                                    IsComputed = true;
                                }
                                Interes = Interes - pago;
                            }
                        }
                    }
                    else
                    {
                        //Certificado 100%
                        if (row.TipoContratos.ContinueOnTime == true)
                        {
                            if (ts.Days < row.Solicitudes.Condiciones.Dias)
                            {
                                Interes = ((B * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                Continue = false;
                            }
                            else
                            {
                                Interes = Interes = ((B * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                Continue = false;
                                //IsComputed = true;
                            }
                        }
                        else
                        {
                            if (ts.Days >= 0)
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                    Continue = false;
                                }
                                else
                                {
                                    if (c.Numero == row.Solicitudes.Tiempo)
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                    }
                                    else
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                    }
                                    Continue = true;
                                }
                                IsComputed = true;
                            }
                            else
                            {
                                Continue = false;
                            }
                            Interes = Interes - pago;
                        }
                    }

                    if (Interes >= c.Interes)
                    {
                        if (c.IsComputed)
                        {
                            var r = NDInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                        }
                        else
                        {
                            var r = NDInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                        }
                    }
                    else
                    {
                        if (c.IsComputed == false)
                        {
                            if (c.Numero != 1)
                            {
                                var r = NCInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, _Date, "AJUSTE A CARGOS AUTOMATICOS", c.Interes - Interes, true, Usuario);
                            }
                        }
                    }

                    //CuotasUpdateGetByCuotaID(c.CuotaID, IsComputed);
                    Console.WriteLine("{0} - {1} - {2} - {3} - {4}", c.ContratoID, c.CuotaID, c.Vence, c.Balance, Interes);
                }
                else
                {
                    if (c.Interes >= 1 && c.IsComputed == false && c.Numero > 1)
                    {
                        float _interes = Interes = ((Cuotas.BalanceCapital() * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                        var r = NCInteresAutomaticaCreate(c.CuotaID, row.InteresDiario, DateTime.Today, "AJUSTE A CARGOS AUTOMATICOS", _interes, true, Usuario);
                    }
                }

                switch (DateTime.DaysInMonth(c.Vence.Year, c.Vence.Month))
                {
                    case 28: { Increment = c.Vence.Day == 28 ? 1 : 0; } break;
                    case 29: { Increment = c.Vence.Day == 29 ? 1 : 0; } break;
                    case 30: { Increment = 1; } break;
                    case 31: { Increment = c.Vence.Day == 30 ? 1 : 0; } break;
                }
            }
        }


        public Task<bool> CalcularMoras(DateTime _Date, int ContratoID = 0)
        {
            try
            {
                Manager db = new Manager();
                string Usuario = Environment.MachineName.ToString();
                var Contratos = ContratoID == 0 ? db.ContratosGet() : db.ContratosGet().Where(x => x.ContratoID == ContratoID);

                foreach (var row in Contratos.Where(x => x.MoraAutomatica == true))
                {
                    clsCuotasView Cuotas = new clsCuotasView();
                    Cuotas.SetDataSource(row.ContratoID);
                    var result = Cuotas.GetGroupWithOutMora();
                    bool Continue = true;

                    foreach (var c in result.OrderBy(x => x.Numero))
                    {
                        if (c.Vence.AddDays(row.DiasGracia) < _Date && c.Balance > 0 && Continue == true)
                        {
                            float Mora = 0;
                            DateTime oldDate = c.Vence;
                            TimeSpan ts = _Date - oldDate;

                            float Tiempo = 0;
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                                case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; ; } break;
                                case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                                case 4: { Tiempo = ts.Days; } break;
                            }

                            switch (row.TipoContratoID)
                            {
                                #region Capital e Interes

                                case 2:
                                    {
                                        if (row.MoraDiaria == true)
                                        {
                                            if (row.TipoContratos.IsMoraOverTime == true)
                                            {
                                                if (row.TipoContratos.OnlyInteger == false)
                                                {
                                                    Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                                }
                                                else
                                                {
                                                    if(ts.Days < row.Solicitudes.Condiciones.Dias)
                                                    {
                                                        Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                                    }
                                                    else
                                                    {
                                                        if (c.Numero == row.Solicitudes.Tiempo)
                                                        {
                                                            Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                                        }
                                                        else
                                                        {
                                                            Mora = (c.Balance * (row.Mora / 100));
                                                        }
                                                    }
                                                }
                                                Continue = true;
                                            }
                                            else
                                            {
                                                if (ts.Days > 0)
                                                {
                                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                                    {
                                                        Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias;
                                                        Continue = false;
                                                    }
                                                    else
                                                    {
                                                        if (c.Numero == row.Solicitudes.Tiempo)
                                                        {
                                                            if (row.TipoContratos.OnlyInteger == true)
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) ) * ts.Days;
                                                                }
                                                                else
                                                                {
                                                                    Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                                                }
                                                            }
                                                            else
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            if (row.TipoContratos.OnlyInteger == true)
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                        }
                                                        Continue = true;
                                                        //IsComputed = true;
                                                    }
                                                }
                                                else
                                                {
                                                    Continue = false;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            if (row.TipoContratos.ContinueOnTime == true)
                                            {
                                                if (row.TipoContratos.OnlyInteger == true)
                                                {
                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                }
                                                else
                                                {
                                                    // Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                    Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias;
                                                }
                                                Continue = true;
                                            }
                                            else
                                            {
                                                if (ts.Days > 0)
                                                {
                                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                                    {
                                                        Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias;
                                                        Continue = false;
                                                    }
                                                    else
                                                    {
                                                        if (c.Numero == row.Solicitudes.Tiempo)
                                                        {
                                                            if (row.TipoContratos.OnlyInteger == true)
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                            }
                                                            else
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            if (row.TipoContratos.OnlyInteger == true)
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                        }
                                                        Continue = true;
                                                        //IsComputed = true;
                                                    }
                                                }
                                                else
                                                {
                                                    Continue = false;
                                                }
                                            }
                                        }

                                        if (Continue == false)
                                        {
                                            break;
                                        }
                                    }
                                    break;

                                #endregion

                                #region Default

                                default:
                                    {
                                        if (row.MoraDiaria == true)
                                        {
                                            if (row.TipoContratos.IsMoraOverTime == true)
                                            {
                                                if (row.TipoContratos.OnlyInteger == false)
                                                {
                                                    Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                                }
                                                else
                                                {
                                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                                    {
                                                        Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                                    }
                                                    else
                                                    {
                                                        if (c.Numero == row.Solicitudes.Tiempo)
                                                        {
                                                            Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                                        }
                                                        else
                                                        {
                                                            Mora = (c.Balance * (row.Mora / 100));
                                                        }
                                                    }
                                                }
                                                Continue = true;
                                            }
                                            else
                                            {
                                                if (ts.Days > 0)
                                                {
                                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                                    {
                                                        Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias;
                                                        Continue = false;
                                                    }
                                                    else
                                                    {
                                                        if (c.Numero == row.Solicitudes.Tiempo)
                                                        {
                                                            if (row.TipoContratos.OnlyInteger == true)
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias)) * ts.Days;
                                                                }
                                                                else
                                                                {
                                                                    Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                                                }
                                                            }
                                                            else
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            if (row.TipoContratos.OnlyInteger == true)
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                        }
                                                        Continue = true;
                                                        //IsComputed = true;
                                                    }
                                                }
                                                else
                                                {
                                                    Continue = false;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            if (row.TipoContratos.ContinueOnTime == true)
                                            {
                                                if (row.TipoContratos.OnlyInteger == true)
                                                {
                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                }
                                                else
                                                {
                                                    // Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                    Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias;
                                                }
                                                Continue = true;
                                            }
                                            else
                                            {
                                                if (ts.Days > 0)
                                                {
                                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                                    {
                                                        Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias;
                                                        Continue = false;
                                                    }
                                                    else
                                                    {
                                                        if (c.Numero == row.Solicitudes.Tiempo)
                                                        {
                                                            if (row.TipoContratos.OnlyInteger == true)
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                            }
                                                            else
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            if (row.TipoContratos.OnlyInteger == true)
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                        }
                                                        Continue = true;
                                                        //IsComputed = true;
                                                    }
                                                }
                                                else
                                                {
                                                    Continue = false;
                                                }
                                            }
                                        }

                                        if (Continue == false)
                                        {
                                            break;
                                        }
                                    }
                                    break;

                                    #endregion
                            }

                            db.MorasAutomaticaCreate(c.CuotaID, row.MoraDiaria, _Date, "CARGOS AUTOMATICOS", Mora, true, Usuario);
                            Console.WriteLine("{0} - {1} - {2} - {3} - {4}", c.ContratoID, c.CuotaID, c.Vence, c.Balance, Mora);
                        }
                    }
                }

                return Task.Run(() =>
                {
                    return true;
                });
            }
            catch
            {
                return Task.Run(() =>
                {
                    return false;
                });
            }
        }


        public Task<bool> CalcularMoras_original(DateTime _Date, int ContratoID = 0)
        {
            try
            {
                Manager db = new Manager();
                string Usuario = Environment.MachineName.ToString();
                var Contratos = ContratoID == 0 ? db.ContratosGet() : db.ContratosGet().Where(x => x.ContratoID == ContratoID);

                foreach (var row in Contratos.Where(x => x.MoraAutomatica == true))
                {
                    clsCuotasView Cuotas = new clsCuotasView();
                    Cuotas.SetDataSource(row.ContratoID);
                    var result = Cuotas.GetGroupWithOutMora();
                    bool Continue = true;

                    foreach (var c in result.OrderBy(x => x.Numero))
                    {
                        if (c.Vence.AddDays(row.DiasGracia) < _Date && c.Balance > 0 && Continue == true)
                        {
                            float Mora = 0;
                            DateTime oldDate = c.Vence;
                            TimeSpan ts = _Date - oldDate;

                            float Tiempo = 0;
                            switch (row.Solicitudes.CondicionID)
                            {
                                case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                                case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; ; } break;
                                case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                                case 4: { Tiempo = ts.Days; } break;
                            }

                            switch (row.TipoContratoID)
                            {
                                #region Capital e Interes

                                case 2:
                                    {
                                        if (row.MoraDiaria == true)
                                        {
                                            if (row.TipoContratos.ContinueOnTime == true)
                                            {
                                                if (row.TipoContratos.OnlyInteger == true)
                                                {
                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                }
                                                else
                                                {
                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                }
                                                Continue = true;
                                            }
                                            else
                                            {
                                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                                {
                                                    //Mora = (((c.Balance) * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                                    Mora = (((c.Balance) * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                                    Continue = false;
                                                }
                                                else
                                                {
                                                    //Mora = (((c.Balance) * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * (row.Solicitudes.Condiciones.Dias);
                                                    Mora = ((c.Balance) * (row.Mora / 100));
                                                    Continue = true;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            if (row.TipoContratos.ContinueOnTime == true)
                                            {
                                                if (row.TipoContratos.OnlyInteger == true)
                                                {
                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                }
                                                else
                                                {
                                                    // Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                    Mora =  ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias;
                                                }
                                                Continue = true;
                                            }
                                            else
                                            {
                                                if (ts.Days > 0)
                                                {
                                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                                    {
                                                        Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias;
                                                        Continue = false;
                                                    }
                                                    else
                                                    {
                                                        if (c.Numero == row.Solicitudes.Tiempo)
                                                        {
                                                            if (row.TipoContratos.OnlyInteger == true)
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                            }
                                                            else
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                        }
                                                        else
                                                        {
                                                            if (row.TipoContratos.OnlyInteger == true)
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                            else
                                                            {
                                                                if (row.TipoContratos.IsMoraOverTime == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias);
                                                                }
                                                            }
                                                        }
                                                        Continue = true;
                                                        //IsComputed = true;
                                                    }
                                                }
                                                else
                                                {
                                                    Continue = false;
                                                }
                                            }
                                        }

                                        if (Continue == false)
                                        {
                                            break;
                                        }
                                    }
                                    break;

                                #endregion

                                #region Default

                                default:
                                    {
                                        if (row.TipoContratos.MoraDiaria == true)
                                        {
                                            if (row.TipoContratos.ContinueOnTime == true)
                                            {
                                                if (row.TipoContratos.OnlyInteger == true)
                                                {
                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                }
                                                else
                                                {
                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                }
                                                Continue = true;
                                            }
                                            else
                                            {
                                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                                {
                                                    Mora = (((c.Balance) * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                                    //Mora = (((c.Balance) * (row.Mora / 100)) / 30);//row.Solicitudes.Condiciones.Dias) * ts.Days;
                                                    Continue = false;
                                                }
                                                else
                                                {
                                                    Mora = (((c.Balance) * (row.Mora / 100)));
                                                    Continue = true;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            if (row.TipoContratos.ContinueOnTime == true)
                                            {
                                                if (row.TipoContratos.OnlyInteger == true)
                                                {
                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                }
                                                else
                                                {
                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                }
                                                Continue = false;
                                            }
                                            else
                                            {
                                                if (ts.Days > 0)
                                                {
                                                    if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                                    {
                                                        Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias;
                                                        Continue = false;
                                                    }
                                                    else
                                                    {
                                                        if (c.Numero == row.Solicitudes.Tiempo)
                                                        {
                                                            if (row.TipoContratos.OnlyInteger == true)
                                                            {
                                                                Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                            }
                                                            else
                                                            {
                                                                Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                            }
                                                        }
                                                        else
                                                        {
                                                            if (row.TipoContratos.IsMoraOverTime == true)
                                                            {
                                                                if (row.TipoContratos.OnlyInteger == true)
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * (float)Math.Truncate(Tiempo + 1);
                                                                }
                                                                else
                                                                {
                                                                    Mora = (((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias) * Tiempo;
                                                                }
                                                            }
                                                            else
                                                            {
                                                                Mora = ((c.Balance * (row.Mora / 100)) / row.Solicitudes.Condiciones.Dias) * row.Solicitudes.Condiciones.Dias;
                                                            }
                                                        }
                                                        Continue = true;
                                                        //IsComputed = true;
                                                    }
                                                }
                                                else
                                                {
                                                    Continue = false;
                                                }
                                            }
                                        }


                                        if (Continue == false)
                                        {
                                            break;
                                        }
                                    }
                                    break;

                                    #endregion
                            }

                            db.MorasAutomaticaCreate(c.CuotaID, row.MoraDiaria, _Date, "CARGOS AUTOMATICOS", Mora, true, Usuario);
                            Console.WriteLine("{0} - {1} - {2} - {3} - {4}", c.ContratoID, c.CuotaID, c.Vence, c.Balance, Mora);
                        }
                    }
                }

                return Task.Run(() =>
                {
                    return true;
                });
            }
            catch
            {
                return Task.Run(() =>
                {
                    return false;
                });
            }
        }

        private void Vencimiento_Mayi(clsContratosBE row, DateTime _Date)
        {
            float Interes = 0;
            bool IsComputed = false;
            DateTime oldDate;
            string Usuario = Environment.MachineName.ToString();

            clsCuotasView Cuotas = new clsCuotasView();
            Cuotas.SetDataSource(row.ContratoID);
            var result = Cuotas.GetGroupWithOutMora();
            bool Continue = true;
            bool OnTime = row.TipoContratos.ContinueOnTime == true ? false : true;

            foreach (var c in result.OrderBy(X => X.Numero))
            {

                DAL.Context cx = new DAL.Context();
                var HasPay = (from DR in cx.clsDetalleRecibosBE join R in cx.clsRecibosBE on DR.ReciboID equals R.ReciboID where R.EstadoID == true && R.ContratoID == row.ContratoID && DR.CuotaID == c.CuotaID select DR);
                if (HasPay.Count() > 0)
                {
                    if (c.Numero == row.Solicitudes.Tiempo)
                    {
                        IsComputed = false;
                    }
                    else
                    {
                        //if (HasPay.FirstOrDefault().Concepto.Contains("SALDO") || HasPay.FirstOrDefault().Concepto.Contains("FEE PAYMENT"))
                        //{
                        IsComputed = true;
                        //}
                        //else { IsComputed = false; }
                    }
                }
                else
                {
                    IsComputed = false;
                }


                TimeSpan dif = c.Vence - _Date;
                if (row.TipoContratoID == 3 && IsComputed == false && Continue == true && dif.Days < row.Solicitudes.Condiciones.Dias)
                {

                    if (HasPay.Count() == 0)
                    {
                        switch (row.Solicitudes.CondicionID)
                        {
                            case 1:
                                {
                                    oldDate = c.Vence.AddMonths(-1);
                                }
                                break;
                            default:
                                {
                                    oldDate = c.Vence.AddDays(-(row.Solicitudes.Condiciones.Dias - 1));
                                }
                                break;
                        }
                    }
                    else
                    {
                        oldDate = HasPay.OrderByDescending(x => x.Recibos.Fecha).Take(1).FirstOrDefault().Recibos.Fecha;
                    }

                    TimeSpan ts = _Date - oldDate;

                    int time = ts.Days;

                    float Tiempo = 0;
                    switch (row.Solicitudes.CondicionID)
                    {
                        case 1: { Tiempo = ts.Days < 30 ? 1 : ts.Days / 30; } break;
                        case 2: { Tiempo = ts.Days < 15 ? 1 : ts.Days / 15; } break;
                        case 3: { Tiempo = ts.Days < 7 ? 1 : ts.Days / 7; } break;
                        case 4: { Tiempo = ts.Days; } break;
                    }

                    var B = Cuotas.BalanceCapital();
                    if (row.TipoContratos.InteresDiario == true)
                    {
                        if (row.TipoContratos.ContinueOnTime == true)
                        {
                            Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                            Continue = false;
                        }
                        else
                        {
                            if (ts.Days < row.Solicitudes.Condiciones.Dias)
                            {
                                Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                Continue = false;
                                IsComputed = false;
                            }
                            else
                            {
                                if (c.Numero == row.Solicitudes.Tiempo)
                                {
                                    Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * ts.Days;
                                }
                                else
                                {
                                    //Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Dias) * (row.Solicitudes.Condiciones.Dias);
                                    Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                }
                                Continue = true;
                                IsComputed = true;
                            }
                        }
                    }
                    else
                    {
                        //Certificado 100%
                        if (row.TipoContratos.ContinueOnTime == true)
                        {
                            if (ts.Days < row.Solicitudes.Condiciones.Dias)
                            {
                                Interes = ((B * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                Continue = false;
                            }
                            else
                            {
                                Interes = Interes = ((B * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                Continue = false;
                                //IsComputed = true;
                            }
                        }
                        else
                        {
                            if (ts.Days > 0)
                            {
                                if (ts.Days < row.Solicitudes.Condiciones.Dias)
                                {
                                    Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                    Continue = false;
                                }
                                else
                                {
                                    if (c.Numero == row.Solicitudes.Tiempo)
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses) * Tiempo;
                                    }
                                    else
                                    {
                                        Interes = (((B) * (row.Interes / 100)) / row.Solicitudes.Condiciones.Meses);
                                    }
                                    Continue = true;
                                }
                                IsComputed = true;
                            }
                            else
                            {
                                Continue = false;
                            }
                        }

                    }

                    if (Interes >= c.Interes)
                    {
                        if (c.IsComputed)
                        {
                            var r = NDInteresAutomaticaCreate(c.CuotaID, row.TipoContratos.InteresDiario, DateTime.Today, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                        }
                        else
                        {
                            var r = NDInteresAutomaticaCreate(c.CuotaID, row.TipoContratos.InteresDiario, DateTime.Today, "CARGOS AUTOMATICOS", Interes - c.Interes, true, Usuario);
                        }
                    }
                    else
                    {
                        if (c.IsComputed == false)
                        {
                            var r = NCInteresAutomaticaCreate(c.CuotaID, row.TipoContratos.InteresDiario, DateTime.Today, "AJUSTE A CARGOS AUTOMATICOS", c.Interes - Interes, true, Usuario);
                        }
                    }

                    CuotasUpdateGetByCuotaID(c.CuotaID, IsComputed);
                    Console.WriteLine("{0} - {1} - {2} - {3} - {4}", c.ContratoID, c.CuotaID, c.Vence, c.Balance, Interes);
                }
                else
                {
                    if (c.Interes >= 1 && c.IsComputed == false && c.Numero > 1)
                    {
                        var r = NCInteresAutomaticaCreate(c.CuotaID, row.TipoContratos.InteresDiario, DateTime.Today, "AJUSTE A CARGOS AUTOMATICOS", c.Interes, true, Usuario);
                    }
                }
            }
        }

        public async Task PagosAutomaticosAsync(DateTime _Date, int ContratoID = 0)
        {
            db = new DAL.Context();
            var Contratos = ContratoID == 0 ? ContratosGetByTipoSolicitudID(6, 1) : ContratosGetByTipoSolicitudID(6, 1).Where(x => x.ContratoID == ContratoID);
            string table = string.Empty;
            bool Send = false;

            foreach (var sucursal in db.clsSucursalesBE.ToList())
            {
                Send = false;
                table = "<TR><TH>Contrato&nbsp;</TH><TH>Cliente&nbsp;</TH><TH>Cuota&nbsp;</TH><TH>Monto&nbsp;</TH><TH>Resultado&nbsp;</TH></TR>";

                foreach (var row in Contratos.Where(x=>x.Solicitudes.Clientes.SucursalID == sucursal.SucursalID))
                {
                    await CalcularInteres(_Date, row.ContratoID);
                    await CalcularMoras(_Date, row.ContratoID);
                    await CalcularLegal(_Date, row.ContratoID);

                    clsCuotasView Cuotas = new clsCuotasView();
                    Cuotas.SetDataSource(row.ContratoID);
                    var result = Cuotas.GetGroup().OrderBy(x => x.Numero);
                    foreach (var item in result.Where(x => x.Vence <= _Date && x.Balance > 0))
                    {
                        Send = true;
                        try
                        {
                            DateTime Fecha = DateTime.Now;
                            string TokenID = $"{row.ContratoID}-{Fecha.Month}{Fecha.Day}{Fecha.Year}{Fecha.Hour}{Fecha.Minute}{Fecha.Second}-{row.Solicitudes.Clientes.SucursalID}-{item.Balance}-{row.Solicitudes.Clientes.Sucursales.Documento}";

                            Root root = new Root();
                            root.clientReferenceInformation = new ClientReferenceInformation { code = $"{TokenID}" };//$"{row.Solicitudes.Clientes.Sucursales.EmpresaID}-{Guid.NewGuid()}"};
                            root.orderInformation = new OrderInformation { amountDetails = new AmountDetails { currency = row.Solicitudes.Clientes.Personas.Ciudades.Provincias.Paises.Monedas.Codigo, totalAmount = item.Balance.ToString() }, billTo = new BillTo { country = "DO", email = string.IsNullOrEmpty(row.Solicitudes.Clientes.Personas.Correo) ? "notiene@gmail.com" : row.Solicitudes.Clientes.Personas.Correo, address1 = string.IsNullOrEmpty(row.Solicitudes.Clientes.Personas.Direccion) ? row.Solicitudes.Clientes.Personas.Ciudades.Ciudad : row.Solicitudes.Clientes.Personas.Direccion, administrativeArea = row.Solicitudes.Clientes.Personas.Ciudades.Provincias.Provincia, firstName = row.Solicitudes.Clientes.Personas.Nombres, lastName = row.Solicitudes.Clientes.Personas.Apellidos, phoneNumber = string.IsNullOrEmpty(row.Solicitudes.Clientes.Personas.Celular.Replace("(", "").Replace(")", "").Replace("-", "").Replace("_", "")) ? row.Solicitudes.Clientes.Personas.Telefono : row.Solicitudes.Clientes.Personas.Celular, locality = row.Solicitudes.Clientes.Personas.Ciudades.Ciudad, postalCode = "43002" } };
                            root.paymentInformation = new PaymentInformation { card = new Card { expirationMonth = Convert.ToString(row.Solicitudes.GarantiaTarjetas.Mes), expirationYear = Convert.ToString(row.Solicitudes.GarantiaTarjetas.Ano), number = Convert.ToString(row.Solicitudes.GarantiaTarjetas.Numero), securityCode = Convert.ToString(row.Solicitudes.GarantiaTarjetas.Cvv) } };
                            root.processingInformation = new ProcessingInformation { commerceIndicator = "internet" };
                            string JsonObj = JsonConvert.SerializeObject(root);

                            Random rnd = new Random();
                            Thread.Sleep(rnd.Next(5000, 10000));

                            Model.Response.Root response = ProcesarPagosGetByMerchantID(row.Solicitudes.Clientes.Sucursales.EmpresaID, JsonObj, Common.FingerPrint.GetKey());
                            if (response.status == "AUTHORIZED")
                            {
                                var recibos = new Models.clsRecibosBE { ReciboID = 0, Fecha = DateTime.Now, ComprobanteID = 0, ContratoID = row.ContratoID, EstadoID = true, FormaPagoID = 2, SucursalID = row.Solicitudes.Clientes.SucursalID, SubTotal = item.Balance, Descuento = 0, Monto = item.Balance, Usuario = row.Solicitudes.Clientes.Sucursales.Documento, ModificadoPor = row.Solicitudes.Clientes.Sucursales.Documento, FechaModificacion = DateTime.Now, Informacion = $"{ row.Solicitudes.GarantiaTarjetas.Numero.Substring(0, 4)} **** **** { row.Solicitudes.GarantiaTarjetas.Numero.Substring(12, 4)} Número de Aprobación: {response.processorInformation.approvalCode}", Contabilizado = false };
                                data sql = new data();
                                await sql.RecibosCreateAsync(0, row.ContratoID, DateTime.Now, row.Solicitudes.Clientes.SucursalID, 0, 2, item.Balance, $"{ row.Solicitudes.GarantiaTarjetas.Numero.Substring(0, 4)} **** **** { row.Solicitudes.GarantiaTarjetas.Numero.Substring(12, 4)} Número de Aprobación: {response.processorInformation.approvalCode}", TokenID, true, row.Solicitudes.Clientes.Sucursales.Documento);
                                table = table + $"<TR><TD>{row.ContratoID}</TD><TD style='text-transform: capitalize;'>{row.Solicitudes.Clientes.Personas.Nombres} {row.Solicitudes.Clientes.Personas.Apellidos}</TD><TD style='text-align:center'>{string.Format("{0:00}", item.Numero)}</TD><TD style='text-align:right'>{string.Format("{0:N2}", item.Balance)}</TD><TD style='text-align:left'>{$"{ row.Solicitudes.GarantiaTarjetas.Numero.Substring(0, 4)} **** **** { row.Solicitudes.GarantiaTarjetas.Numero.Substring(12, 4)} Número de Aprobación: {response.processorInformation.approvalCode}"}</TD></TR>";
                            }
                            else
                            {
                                table = table + $"<TR><TD>{row.ContratoID}</TD><TD style='text-transform: capitalize;'>{row.Solicitudes.Clientes.Personas.Nombres} {row.Solicitudes.Clientes.Personas.Apellidos}</TD><TD style='text-align:center'>{string.Format("{0:00}", item.Numero)}</TD><TD style='text-align:right'>{string.Format("{0:N2}", item.Balance)}</TD><TD style='text-align:left'>{$"{ row.Solicitudes.GarantiaTarjetas.Numero.Substring(0, 4)} **** **** { row.Solicitudes.GarantiaTarjetas.Numero.Substring(12, 4)} Mensaje de Error: {response.errorInformation.message}"}</TD></TR>";

                                //data sql = new data();
                                //await sql.RecibosCreateAsync(0, row.ContratoID, DateTime.Now, row.Solicitudes.Clientes.SucursalID, 0, 2, item.Balance, $"{ row.Solicitudes.GarantiaTarjetas.Numero.Substring(0, 4)} **** **** { row.Solicitudes.GarantiaTarjetas.Numero.Substring(12, 4)} Mensaje de Error: {response.errorInformation.message}", TokenID, false, row.Solicitudes.Clientes.Sucursales.Documento);
                            }
                        }
                        catch (Exception ex)
                        { }
                    }


                }

                if (Send)
                {
                    try
                    {
                        if (System.Text.RegularExpressions.Regex.IsMatch(sucursal.Gerentes.Personas.Correo, @"^[a-zA-Z][\w\.-]*[a-zA-Z0-9]@[a-zA-Z0-9][\w\.-]*[a-zA-Z0-9]\.[a-zA-Z][a-zA-Z\.]*[a-zA-Z]$"))
                        {
                            var message = System.IO.File.ReadAllText(Environment.CurrentDirectory + "/Correos/PagosTarjetas.html");
                            string Body = string.Format(message, sucursal.Empresas.Empresa, sucursal.Direccion, sucursal.Telefonos, sucursal.Empresas.Rnc, sucursal.Gerentes.Personas.Nombres + " " + sucursal.Gerentes.Personas.Apellidos, table, DateTime.Now.Year, sucursal.Empresas.Empresa, sucursal.Empresas.Rnc, sucursal.Empresas.Site);

                            Core.Common.clsMisc ms = new Core.Common.clsMisc();
                            ms.SendMail(sucursal.Gerentes.Personas.Correo, string.Format("Pagos con Tarjetas {0} | {1}", DateTime.Now, sucursal.Empresas.Empresa), Body);
                        }
                    }
                    catch (Exception ex)
                    { }
                }
            }
        }

        public async Task<List<clsDetalleRecibosBE>> PagosAutomaticos(int ContratoID, float Monto, string Usuario)
        {
            try
            {
                int LenguajeID = UsuariosGetByDocumento(Common.Generic.DocumentFormat(Usuario)).LenguajeID;

                List<clsDetalleRecibosBE> detalleRecibosBE = new List<clsDetalleRecibosBE>();
                clsDetalleRecibosBE _detalleRecibosBE;
                List<BoxReportItem> cuotasBE = new List<BoxReportItem>();

                var ContratosBE = ContratosGetByContratoID(ContratoID);
                var Cuotas = new clsCuotasView();
                Cuotas.SetDataSource(ContratoID);
                cuotasBE = Cuotas.GetGroup().OrderBy(x => x.Numero).ToList();

                foreach (BoxReportItem fila in cuotasBE.OrderBy(x => x.Numero).ToList())
                {
                    bool Salir = false;
                    _detalleRecibosBE = new clsDetalleRecibosBE();

                    if (fila.Balance > (float)0.1 && Monto > 0)
                    {
                        if (Monto >= fila.Balance)
                        {
                            _detalleRecibosBE.Seguro = fila.Seguro;
                            _detalleRecibosBE.Legal = fila.Legal;
                            _detalleRecibosBE.Mora = fila.Mora;
                            _detalleRecibosBE.Interes = fila.Interes;
                            _detalleRecibosBE.Comision = fila.Comision;
                            _detalleRecibosBE.Capital = fila.Capital;
                            _detalleRecibosBE.CuotaID = fila.CuotaID;
                            _detalleRecibosBE.Concepto = EtiquetasGet().Where(x => x.LenguajeID == LenguajeID && x.Nombre == "colSaldo").FirstOrDefault().Texto + string.Format("{0:000}", fila.Numero);
                            _detalleRecibosBE.Numero = fila.Numero;
                            _detalleRecibosBE.SubTotal = fila.Seguro + fila.Legal + fila.Mora + fila.Comision + fila.Interes + fila.Capital;

                            int i = 0; bool add = true;
                            foreach (clsDetalleRecibosBE row in detalleRecibosBE)
                            {
                                if (row.CuotaID == _detalleRecibosBE.CuotaID)
                                {
                                    detalleRecibosBE[i].Concepto = _detalleRecibosBE.Concepto;
                                    detalleRecibosBE[i].Capital += _detalleRecibosBE.Capital;
                                    detalleRecibosBE[i].Comision += _detalleRecibosBE.Comision;
                                    detalleRecibosBE[i].Interes += _detalleRecibosBE.Interes;
                                    detalleRecibosBE[i].Mora += _detalleRecibosBE.Mora;
                                    detalleRecibosBE[i].Legal += _detalleRecibosBE.Legal;
                                    detalleRecibosBE[i].Seguro += _detalleRecibosBE.Seguro;
                                    detalleRecibosBE[i].SubTotal = (detalleRecibosBE[i].Seguro + detalleRecibosBE[i].Legal + detalleRecibosBE[i].Mora + detalleRecibosBE[i].Comision + detalleRecibosBE[i].Interes + detalleRecibosBE[i].Capital);
                                    add = false;
                                }
                                i++;
                            }
                            if (add == true)
                            {
                                if ((ContratosBE.TipoContratoID == 2 || ContratosBE.TipoContratoID == 3 || ContratosBE.TipoContratoID == 5) && fila.Interes > 0)
                                {
                                    detalleRecibosBE.Add(_detalleRecibosBE);
                                }
                                else
                                {
                                    if ((ContratosBE.TipoContratoID == 1 || ContratosBE.TipoContratoID == 4) && (fila.Comision + fila.Interes + fila.Mora + fila.Legal + fila.Seguro) == 0)
                                    {
                                        return await PagosAmortizadosAutomaticos(ContratoID, cuotasBE, detalleRecibosBE, Monto, Usuario);
                                    }
                                    else
                                    {
                                        detalleRecibosBE.Add(_detalleRecibosBE);
                                    }
                                }
                            }
                            Monto = Monto - (fila.Seguro + fila.Legal + fila.Mora + fila.Comision + fila.Interes + fila.Capital);
                        }
                        else
                        {

                            if ((ContratosBE.TipoContratoID == 1 || ContratosBE.TipoContratoID == 4) && fila.Interes == 0)
                            {

                                return await PagosAmortizadosAutomaticos(ContratoID, cuotasBE, detalleRecibosBE, Monto, Usuario);
                            }

                            if (Monto > fila.Seguro)
                            {
                                _detalleRecibosBE.Seguro = fila.Seguro;
                                Monto = Monto - fila.Seguro;
                                Salir = false;
                            }
                            else
                            {
                                _detalleRecibosBE.Seguro = Monto;
                                Monto = Monto - fila.Seguro;
                                Salir = true;
                            }

                            if (Salir == false)
                            {
                                if (Monto > fila.Legal)
                                {
                                    _detalleRecibosBE.Legal = fila.Legal;
                                    Monto = Monto - fila.Legal;
                                    Salir = false;
                                }
                                else
                                {
                                    _detalleRecibosBE.Legal = Monto;
                                    Monto = Monto - fila.Legal;
                                    Salir = true;
                                }
                            }

                            if (Salir == false)
                            {
                                if (Monto > fila.Mora)
                                {
                                    _detalleRecibosBE.Mora = fila.Mora;
                                    Monto = Monto - fila.Mora;
                                    Salir = false;
                                }
                                else
                                {
                                    _detalleRecibosBE.Mora = Monto;
                                    Monto = Monto - fila.Mora;
                                    Salir = true;
                                }
                            }

                            if (Salir == false)
                            {
                                if (Monto > fila.Interes)
                                {
                                    _detalleRecibosBE.Interes = fila.Interes;
                                    Monto = Monto - fila.Interes;
                                    Salir = false;
                                }
                                else
                                {
                                    _detalleRecibosBE.Interes = Monto;
                                    Monto = Monto - fila.Interes;
                                    Salir = true;
                                }
                            }

                            if (Salir == false)
                            {
                                if (Monto > fila.Comision)
                                {
                                    _detalleRecibosBE.Comision = fila.Comision;
                                    Monto = Monto - fila.Comision;
                                    Salir = false;
                                }
                                else
                                {
                                    _detalleRecibosBE.Comision = Monto;
                                    Monto = Monto - fila.Comision;
                                    Salir = true;
                                }
                            }

                            if (Salir == false)
                            {
                                if (Monto > fila.Capital)
                                {
                                    _detalleRecibosBE.Capital = fila.Capital;
                                    Monto = Monto - fila.Capital;
                                    Salir = false;
                                }
                                else
                                {
                                    _detalleRecibosBE.Capital = Monto;
                                    Monto = Monto - fila.Capital;
                                    Salir = true;
                                }
                            }

                            _detalleRecibosBE.Concepto = EtiquetasGet().Where(x => x.LenguajeID == LenguajeID && x.Nombre == "colAbono").FirstOrDefault().Texto + string.Format("{0:000}", fila.Numero);
                            _detalleRecibosBE.CuotaID = fila.CuotaID;
                            _detalleRecibosBE.Numero = fila.Numero;
                            _detalleRecibosBE.SubTotal = (_detalleRecibosBE.Seguro + _detalleRecibosBE.Legal + _detalleRecibosBE.Mora + _detalleRecibosBE.Comision + _detalleRecibosBE.Interes + _detalleRecibosBE.Capital);

                            int i = 0; bool add = true;
                            foreach (clsDetalleRecibosBE row in detalleRecibosBE)
                            {
                                if (row.CuotaID == _detalleRecibosBE.CuotaID)
                                {
                                    detalleRecibosBE[i].Concepto = _detalleRecibosBE.Concepto;
                                    detalleRecibosBE[i].Capital += _detalleRecibosBE.Capital;
                                    detalleRecibosBE[i].Comision += _detalleRecibosBE.Comision;
                                    detalleRecibosBE[i].Interes += _detalleRecibosBE.Interes;
                                    detalleRecibosBE[i].Mora += _detalleRecibosBE.Mora;
                                    detalleRecibosBE[i].Legal += _detalleRecibosBE.Legal;
                                    detalleRecibosBE[i].Seguro += _detalleRecibosBE.Seguro;
                                    detalleRecibosBE[i].SubTotal = (detalleRecibosBE[i].Seguro + detalleRecibosBE[i].Legal + detalleRecibosBE[i].Mora + detalleRecibosBE[i].Comision + detalleRecibosBE[i].Interes + detalleRecibosBE[i].Capital);
                                    add = false;
                                }
                                i++;
                            }
                            if (add == true && _detalleRecibosBE.SubTotal > 0)
                            {
                                detalleRecibosBE.Add(_detalleRecibosBE);
                            }
                            Monto = Monto - (_detalleRecibosBE.Seguro + _detalleRecibosBE.Legal + _detalleRecibosBE.Mora + _detalleRecibosBE.Comision + _detalleRecibosBE.Interes + _detalleRecibosBE.Capital);
                        }
                    }
                }

                Monto = 0;
                return Task.Run(() =>
                {
                    return detalleRecibosBE;
                }).Result;

            }
            catch
            {
                return Task.Run(() =>
                {
                    return new List<clsDetalleRecibosBE>(); ;
                }).Result;
            }
        }

        private async Task<List<clsDetalleRecibosBE>> PagosAmortizadosAutomaticos(int ContratoID, List<BoxReportItem> cuotasBE, List<clsDetalleRecibosBE> detalleRecibosBE, float Monto, string Usuario)
        {
            try
            {
                int LenguajeID = UsuariosGetByDocumento(Common.Generic.DocumentFormat(Usuario)).LenguajeID;

                clsDetalleRecibosBE _detalleRecibosBE;
                foreach (BoxReportItem fila in cuotasBE.OrderByDescending(x => x.Numero).ToList())
                {
                    bool Salir = false;
                    _detalleRecibosBE = new clsDetalleRecibosBE();

                    if (fila.Balance > (float)0.5 && Monto > 0)
                    {
                        if (Monto >= fila.Balance)
                        {
                            _detalleRecibosBE.Seguro = fila.Seguro;
                            _detalleRecibosBE.Legal = fila.Legal;
                            _detalleRecibosBE.Mora = fila.Mora;
                            _detalleRecibosBE.Interes = fila.Interes;
                            _detalleRecibosBE.Comision = fila.Comision;
                            _detalleRecibosBE.Capital = fila.Capital;
                            _detalleRecibosBE.CuotaID = fila.CuotaID;
                            _detalleRecibosBE.Concepto = EtiquetasGet().Where(x => x.LenguajeID == LenguajeID && x.Nombre == "colSaldo").FirstOrDefault().Texto + string.Format("{0:000}", fila.Numero);
                            _detalleRecibosBE.Numero = fila.Numero;
                            _detalleRecibosBE.SubTotal = fila.Seguro + fila.Legal + fila.Mora + fila.Comision + fila.Interes + fila.Capital;

                            int i = 0; bool add = true;
                            foreach (clsDetalleRecibosBE row in detalleRecibosBE)
                            {
                                if (row.CuotaID == _detalleRecibosBE.CuotaID)
                                {
                                    detalleRecibosBE[i].Concepto = _detalleRecibosBE.Concepto;
                                    detalleRecibosBE[i].Capital += _detalleRecibosBE.Capital;
                                    detalleRecibosBE[i].Comision += _detalleRecibosBE.Comision;
                                    detalleRecibosBE[i].Interes += _detalleRecibosBE.Interes;
                                    detalleRecibosBE[i].Mora += _detalleRecibosBE.Mora;
                                    detalleRecibosBE[i].Legal += _detalleRecibosBE.Legal;
                                    detalleRecibosBE[i].Seguro += _detalleRecibosBE.Seguro;
                                    detalleRecibosBE[i].SubTotal = (detalleRecibosBE[i].Seguro + detalleRecibosBE[i].Legal + detalleRecibosBE[i].Mora + detalleRecibosBE[i].Comision + detalleRecibosBE[i].Interes + detalleRecibosBE[i].Capital);
                                    add = false;
                                }
                                i++;
                            }
                            if (add == true)
                            {
                                detalleRecibosBE.Add(_detalleRecibosBE);
                            }
                            Monto = Monto - (fila.Seguro + fila.Legal + fila.Mora + fila.Comision + fila.Interes + fila.Capital);
                        }
                        else
                        {

                            if (Monto > fila.Seguro)
                            {
                                _detalleRecibosBE.Seguro = fila.Seguro;
                                Monto = Monto - fila.Seguro;
                                Salir = false;
                            }
                            else
                            {
                                _detalleRecibosBE.Seguro = Monto;
                                Monto = Monto - fila.Seguro;
                                Salir = true;
                            }

                            if (Salir == false)
                            {
                                if (Monto > fila.Legal)
                                {
                                    _detalleRecibosBE.Legal = fila.Legal;
                                    Monto = Monto - fila.Legal;
                                    Salir = false;
                                }
                                else
                                {
                                    _detalleRecibosBE.Legal = Monto;
                                    Monto = Monto - fila.Legal;
                                    Salir = true;
                                }
                            }

                            if (Salir == false)
                            {
                                if (Monto > fila.Mora)
                                {
                                    _detalleRecibosBE.Mora = fila.Mora;
                                    Monto = Monto - fila.Mora;
                                    Salir = false;
                                }
                                else
                                {
                                    _detalleRecibosBE.Mora = Monto;
                                    Monto = Monto - fila.Mora;
                                    Salir = true;
                                }
                            }

                            if (Salir == false)
                            {
                                if (Monto > fila.Interes)
                                {
                                    _detalleRecibosBE.Interes = fila.Interes;
                                    Monto = Monto - fila.Interes;
                                    Salir = false;
                                }
                                else
                                {
                                    _detalleRecibosBE.Interes = Monto;
                                    Monto = Monto - fila.Interes;
                                    Salir = true;
                                }
                            }

                            if (Salir == false)
                            {
                                if (Monto > fila.Comision)
                                {
                                    _detalleRecibosBE.Comision = fila.Comision;
                                    Monto = Monto - fila.Comision;
                                    Salir = false;
                                }
                                else
                                {
                                    _detalleRecibosBE.Comision = Monto;
                                    Monto = Monto - fila.Comision;
                                    Salir = true;
                                }
                            }

                            if (Salir == false)
                            {
                                if (Monto > fila.Capital)
                                {
                                    _detalleRecibosBE.Capital = fila.Capital;
                                    Monto = Monto - fila.Capital;
                                    Salir = false;
                                }
                                else
                                {
                                    _detalleRecibosBE.Capital = Monto;
                                    Monto = Monto - fila.Capital;
                                    Salir = true;
                                }
                            }

                            _detalleRecibosBE.Concepto = EtiquetasGet().Where(x => x.LenguajeID == LenguajeID && x.Nombre == "colAbono").FirstOrDefault().Texto + string.Format("{0:000}", fila.Numero);
                            _detalleRecibosBE.CuotaID = fila.CuotaID;
                            _detalleRecibosBE.Numero = fila.Numero;
                            _detalleRecibosBE.SubTotal = (_detalleRecibosBE.Seguro + _detalleRecibosBE.Legal + _detalleRecibosBE.Mora + _detalleRecibosBE.Comision + _detalleRecibosBE.Interes + _detalleRecibosBE.Capital);

                            int i = 0; bool add = true;
                            foreach (clsDetalleRecibosBE row in detalleRecibosBE)
                            {
                                if (row.CuotaID == _detalleRecibosBE.CuotaID)
                                {
                                    detalleRecibosBE[i].Concepto = _detalleRecibosBE.Concepto;
                                    detalleRecibosBE[i].Capital += _detalleRecibosBE.Capital;
                                    detalleRecibosBE[i].Comision += _detalleRecibosBE.Comision;
                                    detalleRecibosBE[i].Interes += _detalleRecibosBE.Interes;
                                    detalleRecibosBE[i].Mora += _detalleRecibosBE.Mora;
                                    detalleRecibosBE[i].Legal += _detalleRecibosBE.Legal;
                                    detalleRecibosBE[i].Seguro += _detalleRecibosBE.Seguro;
                                    detalleRecibosBE[i].SubTotal = (detalleRecibosBE[i].Seguro + detalleRecibosBE[i].Legal + detalleRecibosBE[i].Mora + detalleRecibosBE[i].Comision + detalleRecibosBE[i].Interes + detalleRecibosBE[i].Capital);
                                    add = false;
                                }
                                i++;
                            }
                            if (add == true && _detalleRecibosBE.SubTotal > (float)0.5)
                            {
                                detalleRecibosBE.Add(_detalleRecibosBE);
                            }
                            Monto = Monto - (_detalleRecibosBE.Seguro + _detalleRecibosBE.Legal + _detalleRecibosBE.Mora + _detalleRecibosBE.Comision + _detalleRecibosBE.Interes + _detalleRecibosBE.Capital);
                        }
                    }
                }
 
                Monto = 0;
                return Task.Run(() =>
                {
                    return detalleRecibosBE;
                }).Result;
            }
            catch
            {
                return Task.Run(() =>
                {
                    return new List<clsDetalleRecibosBE>(); ;
                }).Result;
            }
        }

        public Task<bool> CalcularLegal(DateTime _Date, int ContratoID = 0)
        {
            try
            {
                Manager db = new Manager();
                var Contratos = ContratoID == 0 ? db.ContratosGet().Where(x => x.LetterDelay == true) : db.ContratosGet().Where(x => x.ContratoID == ContratoID && x.LetterDelay == true);

                foreach (var row in Contratos)
                {
                    clsCuotasView Cuotas = new clsCuotasView();
                    Cuotas.SetDataSource(row.ContratoID);
                    var result = Cuotas.GetGroupWithOutMora().Where(x => x.Balance > 1);

                    foreach (var x in result.Where(x => x.Balance > 1 && x.Vence.AddDays(row.DiasGracia) < _Date).OrderBy(i => i.Numero))
                    {
                        TimeSpan ts = _Date - x.Vence;
                        int tiempo = ts.Days;
                        var Carta = db.CartasGet(null).Where(a => tiempo >= a.Desde && tiempo <= a.Hasta);
                        var history = db.HistorialCartasGet(null).Where(u => u.Cuotas.ContratoID == x.ContratoID && u.CartaID == Carta.FirstOrDefault().CartaID);

                        if (Carta.Count() > 0 && history.Count() == 0)
                        {
                            Console.WriteLine("{0} - {1} - {2} - {3} - {4}", x.ContratoID, x.CuotaID, x.Vence, x.Balance, Carta.FirstOrDefault().Monto);
                            db.DetalleNotaDebitosCreate(x.CuotaID, "CARGOS AUTOMATICOS", 0, 0, 0, 0, Carta.FirstOrDefault().Monto, 0, true, Environment.MachineName);
                            db.HistorialCartasCreate(Carta.FirstOrDefault().CartaID, x.CuotaID, Carta.FirstOrDefault().Monto, Cuotas.AtrasoGet(DateTime.Now), Environment.MachineName);
                        }
                    }
                }

                return Task.Run(() =>
                {
                    return true;
                });
            }
            catch
            {
                return Task.Run(() =>
                {
                    return false;
                });
            }
        }

        public void CalcularCertificados(DateTime Fecha)
        {
            try
            {
                Manager db = new Manager();
                foreach (clsCertificadosBE BE in db.CertificadosGet(null, true))
                {
                    switch (BE.TipoCertificadoID)
                    {
                        case 1:
                            {
                                DateTime oldDate = db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).Count() > 0 ? db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).OrderByDescending(X => X.Fecha).Take(1).FirstOrDefault().Fecha.Date : BE.Fecha.Date;

                                TimeSpan ts = Fecha - oldDate;
                                for (int i = 1; i <= ts.Days; i++)
                                {
                                    int T = System.DateTime.DaysInMonth(oldDate.Year, oldDate.Month);
                                    if (i == T)
                                    {
                                        TimeSpan d = Convert.ToDateTime(T.ToString() + "/" + oldDate.Month.ToString() + "/" + oldDate.Year.ToString()) - oldDate;

                                        if (db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).Count() == 0)
                                        {
                                            float Monto = ((BE.Monto + (db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).Count() > 0 ? db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).Sum(X => X.Monto) : 0)) * (BE.Interes / 100) / T) * (d.Days);
                                            DateTime date = oldDate.AddDays(d.Days + 1);
                                            db.DetalleCertificadosCreate(BE.CertificadoID, date, string.Format("CALCULO DE INTERES AL {0}", date), BE.Interes, Monto, Environment.MachineName);

                                        }
                                        else
                                        {
                                            float Monto = ((BE.Monto + (db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).Count() > 0 ? db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).Sum(X => X.Monto) : 0)) * (BE.Interes / 100));
                                            DateTime date = oldDate.AddDays(d.Days + 1);
                                            db.DetalleCertificadosCreate(BE.CertificadoID, date, string.Format("CALCULO DE INTERES AL {0}", date), BE.Interes, Monto, Environment.MachineName);

                                        }

                                        oldDate = new DateTime();
                                        oldDate = db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).Count() > 0 ? db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).OrderByDescending(X => X.Fecha).Take(1).FirstOrDefault().Fecha.Date : BE.Fecha.Date;
                                        ts = Fecha - oldDate.Date.AddHours(-oldDate.Hour).AddMinutes(-oldDate.Minute).AddSeconds(-oldDate.Second).AddMilliseconds(-oldDate.Millisecond);
                                        i = 1;
                                    }
                                }
                            }
                            break;
                        case 2:
                            {
                                DateTime oldDate = db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).Count() > 0 ? db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).OrderByDescending(X => X.Fecha).Take(1).FirstOrDefault().Fecha.Date : BE.Fecha.Date;

                                TimeSpan ts = Fecha - oldDate;
                                for (int i = 1; i <= ts.Days; i++)
                                {
                                    int T = System.DateTime.DaysInMonth(oldDate.Year, oldDate.Month);
                                    if (i == T)
                                    {
                                        TimeSpan d = Convert.ToDateTime(T.ToString() + "/" + oldDate.Month.ToString() + "/" + oldDate.Year.ToString()) - oldDate;

                                        if (db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).Count() == 0)
                                        {
                                            float Monto = ((BE.Monto + (db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).Count() > 0 ? db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).Sum(X => X.Monto) : 0)) * (BE.Interes / 100) / T) * (d.Days);
                                            DateTime date = oldDate.AddDays(d.Days + 1);
                                            db.DetalleCertificadosCreate(BE.CertificadoID, date, string.Format("CALCULO DE INTERES AL {0}", date), BE.Interes, Monto, Environment.MachineName);

                                        }
                                        else
                                        {
                                            float Monto = BE.Monto * (BE.Interes / 100);
                                            DateTime date = oldDate.AddDays(d.Days + 1);
                                            db.DetalleCertificadosCreate(BE.CertificadoID, date, string.Format("CALCULO DE INTERES AL {0}", date), BE.Interes, Monto, Environment.MachineName);

                                        }

                                        oldDate = new DateTime();
                                        oldDate = db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).Count() > 0 ? db.DetalleCertificadosGetByCertificadoID(BE.CertificadoID).OrderByDescending(X => X.Fecha).Take(1).FirstOrDefault().Fecha.Date : BE.Fecha.Date;
                                        ts = Fecha - oldDate.Date.AddHours(-oldDate.Hour).AddMinutes(-oldDate.Minute).AddSeconds(-oldDate.Second).AddMilliseconds(-oldDate.Millisecond);
                                        i = 1;
                                    }
                                }

                            }
                            break;
                    }
                }
            }
            catch (Exception ex) { NotificarException(ex); Console.WriteLine(ex.Message); }
        }

        public void CalcularRentas(DateTime _date)
        {
            Manager db = new Manager();

            string Usuario = Environment.MachineName.ToString();
            var Alquileres = db.AlquileresGet(null, true);

            int dia = DateTime.DaysInMonth(_date.Year, _date.Month);
            if (dia == 31)
            {
                dia = 30;
            }
            //DateTime fecha = Convert.ToDateTime(dia.ToString() + "/" + DateTime.Now.Month.ToString() + "/" + DateTime.Now.Year.ToString());    
            foreach (var row in Alquileres)
            {
                if (row.Fecha.Day <= _date.AddDays(3).Day)
                {
                    var r = db.RentasCreate(_date, row.AlquilerID, _date.Month, _date.Year, row.Monto, false, Usuario);
                    if (r.ResponseCode == "00")
                    {
                        var renta = db.RentasGetByRentaID(int.Parse(r.ResponseMessage));
                        var sms = db.TareasGet(null).Where(a => a.TipoTareas.Codigo == "SENDSMSRENT");
                        if (sms.Count() > 0)
                        {
                            // Enviar SMS notificando renta
                        }

                        var email = db.TareasGet(null).Where(a => a.TipoTareas.Codigo == "SENTEMAILRENT");
                        if (email.Count() > 0)
                        {
                            // Enviar email notificando renta
                            try
                            {
                                var message = System.IO.File.ReadAllText(Environment.CurrentDirectory + "/Correos/Rentas.html");
                                string Body = string.Format(message, row.NotariosPublico.Sucursales.Empresas.Empresa, row.NotariosPublico.Sucursales.Direccion, row.NotariosPublico.Sucursales.Telefonos, row.NotariosPublico.Sucursales.Empresas.Rnc, row.Personas.Nombres + " " + row.Personas.Apellidos, renta.Concepto, string.Format("{0:N2}", renta.Monto), row.NotariosPublico.Sucursales.Empresas.Empresa, row.NotariosPublico.Sucursales.Direccion, row.NotariosPublico.Sucursales.Telefonos, row.NotariosPublico.Sucursales.Empresas.Rnc, DateTime.Now.Year, row.NotariosPublico.Sucursales.Empresas.Empresa, row.NotariosPublico.Sucursales.Empresas.Site);

                                Core.Common.clsMisc ms = new Core.Common.clsMisc();
                                var result = ms.SendMail(row.Personas.Correo, string.Format("Factura Alquiler #{0}", row.AlquilerID), Body);

                            }
                            catch { }
                        }

                        Console.WriteLine("Calculando renta a {0}", row.Personas.Nombres + " " + row.Personas.Apellidos);
                    }
                }
            }
        }

        #endregion

        #region Nominas

        public OperationResult NominasCreate(string Codigo, DateTime Fecha, string Nomina, bool IsMensual, bool IsRegalia, int BancoID, float SubTotal, float Descuento, float Monto, string Informacion, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                int NominaID = 0;
                NominaID = (db.clsNominasBE.Count() == 0 ? 100000 : db.clsNominasBE.Max(x => x.NominaID)) + 1;
                db.clsNominasBE.Add(new clsNominasBE { NominaID = NominaID, Codigo = Codigo, Fecha = DateTime.Now, Nomina = Nomina, IsMensual = IsMensual, IsRegalia = IsRegalia, BancoID = BancoID, SubTotal = SubTotal, Descuento = Descuento, Total = Monto, EstadoID = true, Contabilizado = false, Informacion = Informacion, Motivo = string.Empty, Usuario = Usuario, ModificadoPor = Usuario, FechaModificacion = DateTime.Now }); ;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = NominaID.ToString() };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult NominasUpdate(int NominaID, string Codigo, DateTime Fecha, string Nomina, bool IsMensual, bool IsRegalia, int BancoID, float SubTotal, float Descuento, float Monto, string Informacion, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsNominasBE.Where(x => x.NominaID == NominaID).FirstOrDefault();
                row.Codigo = Codigo;
                row.Nomina = Nomina;
                row.Fecha = Fecha;
                row.IsRegalia = IsRegalia;
                row.IsMensual = IsMensual;
                row.BancoID = BancoID;
                row.Informacion = Informacion;
                row.SubTotal = SubTotal;
                row.Descuento = Descuento;
                row.Total = Monto;
                row.FechaModificacion = DateTime.Now;
                row.ModificadoPor = Usuario;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public OperationResult NominasDelete(int NominaID, string Motivo, string Usuario)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsNominasBE.Where(x => x.NominaID == NominaID).FirstOrDefault();
                row.EstadoID = false;
                row.Motivo = Motivo;
                row.ModificadoPor = Usuario;
                row.FechaModificacion = DateTime.Now;
                db.Entry(row).State = EntityState.Modified;
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        public clsNominasBE NominasGetByNominaID(int NominaID)
        {
            try
            {
                db = new DAL.Context();
                return db.clsNominasBE.Where(x => x.NominaID == NominaID).FirstOrDefault();
            }
            catch
            {
                return new clsNominasBE();
            }
        }

        public List<clsNominasBE> NominasGet(DateTime Desde, DateTime Hasta, string search)
        {
            try
            {
                db = new DAL.Context();
                DateTime _Desde = Desde.Add(new TimeSpan(0, 0, 0));
                DateTime _Hasta = Hasta.Add(new TimeSpan(23, 59, 59));
                string Search = search.ToUpper();

                if (!string.IsNullOrEmpty(Search))
                {
                    return db.clsNominasBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta && x.Nomina.ToUpper().Contains(Search) || x.Total.ToString().Contains(Search) || x.Codigo.Contains(Search)).ToList();
                }
                else
                {
                    return db.clsNominasBE.Where(x => x.Fecha >= _Desde && x.Fecha <= _Hasta).ToList();
                }
            }
            catch
            {
                return new List<clsNominasBE>();
            }
        }

        public DataSet PrintNominasGetByNominaID(int NominaID)
        {
            try
            {

                db = new DAL.Context();
                DataSet ds = new DataSet();

                MySqlDataAdapter da = new MySqlDataAdapter();
                MySqlConnection cn = new MySqlConnection();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                //Empresas
                da = new MySqlDataAdapter();
                MySqlCommand cm = new MySqlCommand();

                cn.Open();
                cm = new MySqlCommand();
                cm.CommandTimeout = Timeout;
                cm.CommandText = "SELECT Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, Sucursales.Sucursal FROM DetalleNominas INNER JOIN Empleados ON DetalleNominas.EmpleadoID = Empleados.EmpleadoID INNER JOIN Sucursales ON Empleados.SucursalID = Sucursales.SucursalID INNER JOIN Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID WHERE (DetalleNominas.NominaID = @NominaID) limit 1;";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@NominaID", NominaID));
                da.SelectCommand = cm;
                ds = new DataSet();
                da.Fill(ds, "Empresas");
                cn.Close();


                //DetalleRecibos
                da = new MySqlDataAdapter();
                cn.Open();
                cm = new MySqlCommand();
                cm.CommandText = "SELECT n.NominaID, n.Fecha, n.Codigo, n.Nomina, n.SubTotal, n.Descuento, n.Total, p.Documento, p.Nombres, p.Apellidos, p.Direccion, c.Ciudad, p.Telefono, p.Celular, f.Foto, pu.Puesto as Cargo, dn.Sueldo, dn.Comision, dn.Sfs, dn.Afp, dn.ISR, dn.Otros,  case when n.IsMensual = 1 then 1 else 0 end as Modalidad, Concat(n.Codigo, '-', emp.Documento, '-' , dn.Sueldo, '-', dn.Comision, '-', dn.SFS, '-', dn.AFP, '-', dn.ISR, '-', dn.Otros, '-', dn.SubTotal) as ToKenID from detallenominas dn inner join nominas as n on dn.NominaID = N.NominaID inner join empleados as Emp on DN.EmpleadoID = Emp.EmpleadoID inner join puestos as Pu on Emp.PuestoID = Pu.PuestoID inner join Sucursales as S on Emp.SucursalID = S.SucursalID inner join Empresas as E on S.EmpresaID = E.EmpresaID inner join Personas as P on Emp.Documento = p.Documento LEFT OUTER JOIN Fotografias as F ON P.Documento = F.Documento inner join Ciudades as C on P.CiudadID = C.CiudadID WHERE (n.NominaID = @NominaID)";
                cm.CommandType = CommandType.Text;
                cm.Connection = cn;
                cm.Parameters.Add(new MySqlParameter("@NominaID", NominaID));
                da.SelectCommand = cm;
                da.Fill(ds, "tmp");
                cn.Close();


                DataTable Nominas = new DataTable("Nominas");
                Nominas.Columns.Add("NominaID", typeof(int));
                Nominas.Columns.Add("Fecha", typeof(DateTime));
                Nominas.Columns.Add("Nomina", typeof(string));
                Nominas.Columns.Add("Codigo", typeof(string));
                Nominas.Columns.Add("Modalidad", typeof(int));
                Nominas.Columns.Add("SubTotal", typeof(float));
                Nominas.Columns.Add("Descuento", typeof(float));
                Nominas.Columns.Add("Total", typeof(float));

                Nominas.Columns.Add("Documento", typeof(string));
                Nominas.Columns.Add("Nombres", typeof(string));
                Nominas.Columns.Add("Apellidos", typeof(string));
                Nominas.Columns.Add("Direccion", typeof(string));
                Nominas.Columns.Add("Ciudad", typeof(string));
                Nominas.Columns.Add("Telefono", typeof(string));
                Nominas.Columns.Add("Celular", typeof(string));
                Nominas.Columns.Add("Foto", typeof(byte[]));
                Nominas.Columns.Add("Cargo", typeof(string));
                Nominas.Columns.Add("Sueldo", typeof(float));
                Nominas.Columns.Add("Comision", typeof(float));
                Nominas.Columns.Add("SFS", typeof(float));
                Nominas.Columns.Add("AFP", typeof(float));
                Nominas.Columns.Add("ISR", typeof(float));
                Nominas.Columns.Add("Otros", typeof(float));
                Nominas.Columns.Add("TokenID", typeof(byte[]));


                DataRow dataRow;

                foreach (DataRow item in ds.Tables[1].Rows)
                {
                    dataRow = Nominas.NewRow();
                    dataRow["NominaID"] = int.Parse(item["NominaID"].ToString());
                    dataRow["Fecha"] = DateTime.Parse(item["Fecha"].ToString());
                    dataRow["Nomina"] = item["Nomina"].ToString();
                    dataRow["Codigo"] = item["Codigo"].ToString();
                    dataRow["Modalidad"] = int.Parse(item["Modalidad"].ToString());
                    dataRow["SubTotal"] = float.Parse(item["SubTotal"].ToString());
                    dataRow["Descuento"] = float.Parse(item["Descuento"].ToString());
                    dataRow["Total"] = float.Parse(item["Total"].ToString());

                    dataRow["Documento"] = item["Documento"].ToString();
                    dataRow["Nombres"] = item["Nombres"].ToString();
                    dataRow["Apellidos"] = item["Apellidos"].ToString();
                    dataRow["Direccion"] = item["Direccion"].ToString();
                    dataRow["Ciudad"] = item["Ciudad"].ToString();
                    dataRow["Telefono"] = item["Telefono"].ToString();
                    dataRow["Celular"] = item["Celular"].ToString();
                    dataRow["Foto"] = string.IsNullOrEmpty(item["Foto"].ToString()) == true ? null : (byte[])item["Foto"]; //ImageFromText(item["Nomina"].ToString(););
                    dataRow["Cargo"] = item["Cargo"].ToString();


                    dataRow["Sueldo"] = float.Parse(item["Sueldo"].ToString());
                    dataRow["Comision"] = float.Parse(item["Comision"].ToString());
                    dataRow["SFS"] = float.Parse(item["Sfs"].ToString());
                    dataRow["AFP"] = float.Parse(item["AFP"].ToString());
                    dataRow["ISR"] = float.Parse(item["ISR"].ToString());
                    dataRow["Otros"] = float.Parse(item["Otros"].ToString());

                    dataRow["TokenID"] = TextToQrCode(item["TokenID"].ToString());

                    Nominas.Rows.Add(dataRow);
                }

                ds.Tables.Add(Nominas);

                return ds;
            }
            catch (Exception ex)
            { return new DataSet(); }
        }

        #endregion

        #region Detalle Nominas


        public List<clsDetalleNominasBE> DetalleNominasGet()
        {
            try
            {
                db = new DAL.Context();
                return db.clsDetalleNominasBE.ToList();
            }
            catch
            {
                return new List<clsDetalleNominasBE>();
            }
        }

        public OperationResult DetalleNominasCreate(int NominaID, int EmpleadoID, float Sueldo, float Comision, float SFS, float AFP, float ISR, float Otros, float SubTotal, string Usuario)
        {
            OperationResult result;
            try
            {
                int ID = 0;
                MySqlConnection cn = new MySqlConnection();
                MySqlDataAdapter da = new MySqlDataAdapter();
                cn.ConnectionString = db.Database.Connection.ConnectionString;

                cn.Open();
                MySqlCommand cmd = new MySqlCommand();
                cmd.CommandText = "SELECT IFNULL(Max(DetalleNominaID), 100000) +1 as DetalleNominaID from DetalleNominas;";
                cmd.CommandType = CommandType.Text;
                cmd.Connection = cn;

                MySqlDataReader drPersonas = cmd.ExecuteReader();
                while (drPersonas.Read())
                {
                    ID = int.Parse(drPersonas["DetalleNominaID"].ToString());
                }

                cn.Close();

                cn.Open();
                // Create the InsertCommand.
                cmd = new MySqlCommand("INSERT INTO DetalleNominas (NominaID, DetalleNominaID,  Fecha,  EmpleadoID, Sueldo, Comision, SFS, AFP, ISR, Otros, SubTotal, Usuario, ModificadoPor,  FechaModificacion) VALUES (@NominaID, @DetalleNominaID, Sysdate(), @EmpleadoID, @Sueldo, @Comision, @SFS, @AFP, @ISR, @Otros, @SubTotal, @Usuario, @Usuario, SYSDATE());", cn);
                cmd.Parameters.Add(new MySqlParameter("@NominaID", NominaID));
                cmd.Parameters.Add(new MySqlParameter("@DetalleNominaID", ID));
                cmd.Parameters.Add(new MySqlParameter("@EmpleadoID", EmpleadoID));
                cmd.Parameters.Add(new MySqlParameter("@Sueldo", Sueldo));
                cmd.Parameters.Add(new MySqlParameter("@Comision", Comision));
                cmd.Parameters.Add(new MySqlParameter("@SFS", SFS));
                cmd.Parameters.Add(new MySqlParameter("@AFP", AFP));
                cmd.Parameters.Add(new MySqlParameter("@ISR", ISR));
                cmd.Parameters.Add(new MySqlParameter("@Otros", Otros));
                cmd.Parameters.Add(new MySqlParameter("@SubTotal", SubTotal));
                cmd.Parameters.Add(new MySqlParameter("@Usuario", Usuario));

                da.InsertCommand = cmd;
                cmd.ExecuteNonQuery();
                cn.Close();

                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.InnerException.Message };
                return result;
            }
        }

        public OperationResult DetalleNominasDeleteGetByNominaID(int NominaID)
        {
            OperationResult result;
            try
            {
                db = new DAL.Context();
                var row = db.clsDetalleNominasBE.Where(x => x.NominaID == NominaID);
                db.clsDetalleNominasBE.RemoveRange(row);
                db.SaveChanges();
                result = new OperationResult { ResponseCode = "00", ResponseMessage = "" };
                return result;
            }
            catch (Exception ex)
            {
                NotificarException(ex);
                result = new OperationResult { ResponseCode = "01", ResponseMessage = ex.Message };
                return result;
            }
        }

        #endregion

        #region Notificar Exception

        public void NotificarException(Exception ex)
        {
            clsMisc m = new clsMisc();
            m.SaveToEventLog(ex);
        }

        #endregion  

    }
}
