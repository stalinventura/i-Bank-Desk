
SELECT  Contratos.ContratoID, Contratos.Fecha, Contratos.Vence, @Hasta as Hasta, Contratos.Vence, CASE WHEN Vence < CURDATE() THEN 'Si' ELSE '' END AS Vencido,  Personas.Documento, UPPER(Personas.Nombres) as Nombres, UPPER(Personas.Apellidos) AS Apellidos, Sucursales.Direccion, Personas.Correo, 
                         Personas.Telefono, Personas.Celular, 
						 
                      round( Solicitudes.Monto +   Solicitudes.Monto * (((Contratos.Comision) / 100) ),0)
						 
						 AS Monto, Contratos.Cuota,
						 
CASE WHEN 

CASE WHEN 
(
SELECT        SUM(Capital + Comision + Interes + Mora + Legal) + IFNULL(CASE WHEN
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS ND
                               FROM            DetalleNotaDebitos AS ND
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence < @Desde AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                               FROM            DetalleNotaDebitos AS ND
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence < @Desde AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS NC
                               FROM            DetalleNotaDebitos AS ND
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence < @Desde AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                               FROM            DetalleNotaCreditos AS NC
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence < @Desde AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL
                             ((SELECT        SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado
                                 FROM            Recibos AS R INNER JOIN
                                                          DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID
                                 WHERE        (R.EstadoID = 1) AND (R.Fecha <= @Desde) AND (DR.CuotaID IN
                                                              (SELECT        CuotaID
                                                                FROM            Cuotas AS c11
                                                                WHERE        (Vence < @Desde) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance
FROM            Cuotas AS C
WHERE        (ContratoID = Contratos.ContratoID)
) < 0 THEN 0 ELSE

(
SELECT        SUM(Capital + Comision + Interes + Mora + Legal) + IFNULL(CASE WHEN
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS ND
                               FROM            DetalleNotaDebitos AS ND
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence < @Desde AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                               FROM            DetalleNotaDebitos AS ND
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence < @Desde AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS NC
                               FROM            DetalleNotaCreditos AS ND
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence < @Desde AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                               FROM            DetalleNotaCreditos AS NC
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence < @Desde AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL
                             ((SELECT        SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado
                                 FROM            Recibos AS R INNER JOIN
                                                          DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID
                                 WHERE        (R.EstadoID = 1) AND (R.Fecha <= @Desde) AND (DR.CuotaID IN
                                                              (SELECT        CuotaID
                                                                FROM            Cuotas AS c11
                                                                WHERE        (Vence < @Desde) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance
FROM            Cuotas AS C
WHERE        (ContratoID = Contratos.ContratoID)
)
END <= 0 THEN 0
ELSE
                             (SELECT        COUNT(CuotaID) AS Cantidad
                               FROM            Cuotas AS C
                               WHERE        (ContratoID = Contratos.ContratoID) AND (Vence < @Desde) AND (Capital + Comision + Interes + Mora + Legal + IFNULL(CASE WHEN
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS ND
                                                               FROM            DetalleNotaDebitos AS ND
                                                               WHERE        (CuotaID = C.CuotaID)) < 0 THEN 0 ELSE
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                                                               FROM            DetalleNotaDebitos AS ND
                                                               WHERE        (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS NC
                                                               FROM            DetalleNotaDebitos AS ND
                                                               WHERE        (CuotaID = C.CuotaID)) < 0 THEN 0 ELSE
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                                                               FROM            DetalleNotaCreditos AS NC
                                                               WHERE        (CuotaID = C.CuotaID)) END, 0) - IFNULL
                                                             ((SELECT        SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado
                                                                 FROM            Recibos AS R INNER JOIN
                                                                                          DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID
                                                                 WHERE        (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) 
																 
		END AS Cantidad,

																 
								 
IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence < @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence < @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence < @Hasta) AND
(ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence < @Hasta)) END, 0) AS Atraso,
		
		TipoSolicitudes.TipoSolicitud, Sucursales.SucursalID, Empresas.Empresa, Sucursales.Direccion, Sucursales.Telefonos, Empresas.Rnc, 
                         Empresas.Siglas, Sucursales.Sucursal

FROM            Contratos INNER JOIN
                         Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN
                         Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN
                         Personas ON Clientes.Documento = Personas.Documento INNER JOIN
                         Condiciones ON Solicitudes.CondicionID = Condiciones.CondicionID INNER JOIN
                         TipoSolicitudes ON Solicitudes.TipoSolicitudID = TipoSolicitudes.TipoSolicitudID INNER JOIN
                         Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN
                         Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN
                         Zonas on Contratos.ZonaID = Zonas.ZonaID

WHERE        (Contratos.EstadoID = 1) AND

CASE WHEN 

CASE WHEN 
(
SELECT        SUM(Capital + Comision + Interes + Mora + Legal) + IFNULL(CASE WHEN
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS ND
                               FROM            DetalleNotaDebitos AS ND
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                               FROM            DetalleNotaDebitos AS ND
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS NC
                               FROM            DetalleNotaDebitos AS ND
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                               FROM            DetalleNotaCreditos AS NC
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL
                             ((SELECT        SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado
                                 FROM            Recibos AS R INNER JOIN
                                                          DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID
                                 WHERE        (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN
                                                              (SELECT        CuotaID
                                                                FROM            Cuotas AS c11
                                                                WHERE        (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance
FROM            Cuotas AS C
WHERE        (ContratoID = Contratos.ContratoID)
) < 0 THEN 0 ELSE

(
SELECT        SUM(Capital + Comision + Interes + Mora + Legal) + IFNULL(CASE WHEN
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS ND
                               FROM            DetalleNotaDebitos AS ND
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                               FROM            DetalleNotaDebitos AS ND
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS NC
                               FROM            DetalleNotaCreditos AS ND
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                               FROM            DetalleNotaCreditos AS NC
                               WHERE        (CuotaID IN
                                                             (SELECT        CuotaID
                                                               FROM            Cuotas AS c11
                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL
                             ((SELECT        SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado
                                 FROM            Recibos AS R INNER JOIN
                                                          DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID
                                 WHERE        (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN
                                                              (SELECT        CuotaID
                                                                FROM            Cuotas AS c11
                                                                WHERE        (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance
FROM            Cuotas AS C
WHERE        (ContratoID = Contratos.ContratoID)
)
END <= 0 THEN 0
ELSE
                             (SELECT        COUNT(CuotaID) AS Cantidad
                               FROM            Cuotas AS C
                               WHERE        (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + IFNULL(CASE WHEN
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS ND
                                                               FROM            DetalleNotaDebitos AS ND
                                                               WHERE        (CuotaID = C.CuotaID)) < 0 THEN 0 ELSE
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                                                               FROM            DetalleNotaDebitos AS ND
                                                               WHERE        (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS NC
                                                               FROM            DetalleNotaDebitos AS ND
                                                               WHERE        (CuotaID = C.CuotaID)) < 0 THEN 0 ELSE
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                                                               FROM            DetalleNotaCreditos AS NC
                                                               WHERE        (CuotaID = C.CuotaID)) END, 0) - IFNULL
                                                             ((SELECT        SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado
                                                                 FROM            Recibos AS R INNER JOIN
                                                                                          DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID
                                                                 WHERE        (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) 
																 
		END > 0 

        AND

        							 IFNULL(CASE WHEN
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) + 
							 
							 IFNULL(CASE WHEN
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS ND
                                                               FROM            DetalleNotaDebitos AS ND
                                                               WHERE        (CuotaID IN
                                                                                             (SELECT        CuotaID
                                                                                               FROM            Cuotas AS c11
                                                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                                                               FROM            DetalleNotaDebitos AS ND
                                                               WHERE        (CuotaID IN
                                                                                             (SELECT        CuotaID
                                                                                               FROM            Cuotas AS c11
                                                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) 
																							   
																							   - IFNULL(CASE WHEN
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS NC
                                                               FROM            DetalleNotaCreditos AS NC
                                                               WHERE        (CuotaID IN
                                                                                             (SELECT        CuotaID
                                                                                               FROM            Cuotas AS c11
                                                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                                                               FROM            DetalleNotaCreditos AS NC
                                                               WHERE        (CuotaID IN
                                                                                             (SELECT        CuotaID
                                                                                               FROM            Cuotas AS c11
                                                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL
                                                             ((SELECT        SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado
                                                                 FROM            Recibos AS R INNER JOIN
                                                                                          DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID
                                                                 WHERE        (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN
                                                                                              (SELECT        CuotaID
                                                                                                FROM            Cuotas AS c11
                                                                                                WHERE        (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso
                               FROM            Cuotas AS C
                               WHERE        (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE
                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) + IFNULL(CASE WHEN
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS ND
                                                               FROM            DetalleNotaDebitos AS ND
                                                               WHERE        (CuotaID IN
                                                                                             (SELECT        CuotaID
                                                                                               FROM            Cuotas AS c11
                                                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                                                               FROM            DetalleNotaDebitos AS ND
                                                               WHERE        (CuotaID IN
                                                                                             (SELECT        CuotaID
                                                                                               FROM            Cuotas AS c11
                                                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS NC
                                                               FROM            DetalleNotaCreditos AS NC
                                                               WHERE        (CuotaID IN
                                                                                             (SELECT        CuotaID
                                                                                               FROM            Cuotas AS c11
                                                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE
                                                             (SELECT        SUM(Capital + Comision + Interes + Mora + Legal) AS Expr1
                                                               FROM            DetalleNotaCreditos AS NC
                                                               WHERE        (CuotaID IN
                                                                                             (SELECT        CuotaID
                                                                                               FROM            Cuotas AS c11
                                                                                               WHERE        Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL
                                                             ((SELECT        SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal) AS Pagado
                                                                 FROM            Recibos AS R INNER JOIN
                                                                                          DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID
                                                                 WHERE        (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN
                                                                                              (SELECT        CuotaID
                                                                                                FROM            Cuotas AS c11
                                                                                                WHERE        (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso
                               FROM            Cuotas AS C
                               WHERE        (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) END, 0)   > 1 and (Personas.Documento not in (select Documento from ListaNegra))

