

SELECT CASE WHEN TipoDocumentoID = 3 THEN 'E' else 'I' END as TipoEntidad, replace(Clientes.Documento,'-','') as Codigo, Sucursales.SucursalID, 'D' as RelacionCliente, UCASE(concat( Personas.Nombres, ' ', Personas.Apellidos)) as Cliente, replace (CASE WHEN Personas.TipoDocumentoID = 1 THEN Personas.Documento ELSE '' END, '-','') as Cedula, replace(CASE WHEN Personas.TipoDocumentoID = 2 THEN Personas.Documento ELSE '' END, '-','') Pasaporte,
CASE WHEN TipoDocumentoID = 3 THEN UCASE(concat( Personas.Nombres, ' ', Personas.Apellidos)) ELSE '' END as Empresa, CASE WHEN TipoDocumentoID = 3 THEN '' ELSE '' END as Siglas, CASE WHEN TipoDocumentoID = 3 THEN replace(replace(replace(replace(Personas.Documento, 'RNC', ''), ':',''), ' ',''), '-','') ELSE '' END as Rnc,
replace(replace(replace(replace(Personas.Telefono,'(',''),')',''),'-',''),'_','') as Telefono, replace(replace(replace(replace(instituciones.Telefono,'(',''),')',''),'-',''),'_','') as Oficina, replace(replace(replace(replace(Personas.Celular,'(',''),')',''),'-',''),'_','') as Celular, '' as Fax, ' ' as Correo, '' as Otro,
Personas.Direccion, '' as Esquina, '' as Casa, '' as Edificio, '' as Urbanizacion, '' as Sector, UCASE(Ciudades.Ciudad) AS Ciudad, UCase(Provincias.Provincia) as Provincia,
Contratos.ContratoID, Condiciones.Condicion, TipoContratos.TipoContratoID, TipoContratos.TipoContrato,  Contratos.Interes, CASE WHEN Paises.MonedaID = 214 THEN 'R' WHEN Paises.MonedaID = 840 THEN 'U' ELSE ''END as Moneda, CASE WHEN Solicitudes.TipoSolicitudID = 2 THEN 'HIPOTECARIO' WHEN Solicitudes.TipoSolicitudID = 4 THEN 'C' WHEN Solicitudes.TipoSolicitudID = 5 THEN 'M' ELSE 'N' END as TipoSolicitud, concat(Year(Contratos.Fecha), CASE WHEN LENGTH(Month(Contratos.Fecha)) = 1 THEN concat('0',Month(Contratos.Fecha)) ELSE Month(Contratos.Fecha) END, CASE WHEN LENGTH(day(Contratos.Fecha)) = 1 THEN concat('0',Day(Contratos.Fecha))  ELSE Day(Contratos.Fecha) END) as Fecha, 
concat(Year(Contratos.Vence), CASE WHEN LENGTH(Month(Contratos.Vence)) = 1 THEN concat('0',Month(Contratos.Vence)) ELSE Month(Contratos.Vence) END, CASE WHEN LENGTH(day(Contratos.Vence)) = 1 THEN concat('0',Day(Contratos.Vence))  ELSE Day(Contratos.Vence) END) as Vence, Solicitudes.Monto, 
(select Max(Monto) from Solicitudes as S Where ClienteID = Solicitudes.ClienteID) as MaximoCredito, Contratos.Cuota, Solicitudes.Tiempo, (SELECT Fecha FROM Recibos AS R WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1) ORDER BY ReciboID DESC Limit 1) AS FechaUltimoPago,
(SELECT Monto FROM Recibos AS R WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1) ORDER BY ReciboID DESC Limit 1) AS MontoUltimoPago, CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE   ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN
(SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM  DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE  ContratoID = Contratos.ContratoID))) < 0 THEN 0
ELSE
(SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT  SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM  Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID))
END as Balance,

IFNULL(CASE WHEN
(SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) END, 0) 
AS Atraso,

CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0
ELSE
(SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) 
END AS Cantidad,

CASE
WHEN CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE   ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM  DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT  SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM  Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END <= 10 THEN 'S' 
WHEN CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0 ELSE (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) END < 1 THEN 'N'
WHEN CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0 ELSE (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) END <= 3 THEN 'M'
WHEN CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0 ELSE (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) END <= 5 THEN 'L' ELSE 'C' END AS Status
,
Contratos.EstadoID,

CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 0 AND 30)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 0 AND 30)) END, 0) END as ENTRE0Y30,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 31 AND 60)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 31 AND 60)) END, 0) END as ENTRE31Y60,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 61 AND 90)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 61 AND 90)) END, 0) END as ENTRE61Y90,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 91 AND 120)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 91 AND 120)) END, 0) END as ENTRE91Y120,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 121 AND 150)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 121 AND 150)) END, 0) END as ENTRE121Y150,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 151 AND 180)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 151 AND 180)) END, 0) END as ENTRE151Y180,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 > 180)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 > 180)) END, 0) END as MAS180


FROM Contratos INNER JOIN
	Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN
	Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN
	Personas ON Clientes.Documento = Personas.Documento INNER JOIN
	Condiciones ON Solicitudes.CondicionID = Condiciones.CondicionID INNER JOIN
	Ciudades ON Ciudades.CiudadID = Personas.CiudadID INNER JOIN
	Provincias ON Provincias.ProvinciaID = Ciudades.ProvinciaID INNER JOIN
	Paises ON Provincias.PaisID = Paises.PaisID INNER JOIN
	TipoContratos ON Contratos.TipoContratoID = TipoContratos.TipoContratoID INNER JOIN
	Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN
	Sexos ON Personas.SexoID = Sexos.SexoID INNER JOIN
	EstadosCiviles ON Personas.EstadoCivilID = EstadosCiviles.EstadoCivilID LEFT OUTER JOIN
	DatosEconomicos ON Personas.Documento = DatosEconomicos.Documento INNER JOIN
	Ocupaciones ON DatosEconomicos.OcupacionID = Ocupaciones.OcupacionID INNER JOIN
	Instituciones ON DatosEconomicos.InstitucionID = Instituciones.InstitucionID INNER JOIN
	Zonas ON Contratos.ZonaID = Zonas.ZonaID INNER JOIN
	Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN
	TipoEmpresas ON Empresas.TipoEmpresaID = TipoEmpresas.TipoEmpresaID INNER JOIN
	Monedas ON Paises.MonedaID = Monedas.MonedaID INNER JOIN 
	TipoSolicitudes ON Solicitudes.tiposolicitudID = TipoSolicitudes.tiposolicitudID
WHERE (Contratos.EstadoID = 1) AND (Contratos.Fecha <= @Hasta) AND (Contratos.DataCredito = 1)

UNION ALL /*CONTRATOS INACTIVOS*/

SELECT CASE WHEN TipoDocumentoID = 3 THEN 'E' else 'I' END as TipoEntidad, replace(Clientes.Documento,'-','') as Codigo, Sucursales.SucursalID, 'D' as RelacionCliente, UCASE(concat( Personas.Nombres, ' ', Personas.Apellidos)) as Cliente, replace (CASE WHEN Personas.TipoDocumentoID = 1 THEN Personas.Documento ELSE '' END, '-','') as Cedula, replace(CASE WHEN Personas.TipoDocumentoID = 2 THEN Personas.Documento ELSE '' END, '-','') Pasaporte,
CASE WHEN TipoDocumentoID = 3 THEN UCASE(concat( Personas.Nombres, ' ', Personas.Apellidos)) ELSE '' END as Empresa, CASE WHEN TipoDocumentoID = 3 THEN '' ELSE '' END as Siglas, CASE WHEN TipoDocumentoID = 3 THEN replace(replace(replace(replace(Personas.Documento, 'RNC', ''), ':',''), ' ',''), '-','') ELSE '' END as Rnc,
replace(replace(replace(replace(Personas.Telefono,'(',''),')',''),'-',''),'_','') as Telefono, replace(replace(replace(replace(instituciones.Telefono,'(',''),')',''),'-',''),'_','') as Oficina, replace(replace(replace(replace(Personas.Celular,'(',''),')',''),'-',''),'_','') as Celular, '' as Fax, ' ' as Correo, '' as Otro,
Personas.Direccion, '' as Esquina, '' as Casa, '' as Edificio, '' as Urbanizacion, '' as Sector, UCASE(Ciudades.Ciudad) AS Ciudad, UCase(Provincias.Provincia) as Provincia,
Contratos.ContratoID, Condiciones.Condicion, TipoContratos.TipoContratoID, TipoContratos.TipoContrato,  Contratos.Interes, CASE WHEN Paises.MonedaID = 214 THEN 'R' WHEN Paises.MonedaID = 840 THEN 'U' ELSE ''END as Moneda, CASE WHEN Solicitudes.TipoSolicitudID = 2 THEN 'HIPOTECARIO' WHEN Solicitudes.TipoSolicitudID = 4 THEN 'C' WHEN Solicitudes.TipoSolicitudID = 5 THEN 'M' ELSE 'N' END as TipoSolicitud, concat(Year(Contratos.Fecha), CASE WHEN LENGTH(Month(Contratos.Fecha)) = 1 THEN concat('0',Month(Contratos.Fecha)) ELSE Month(Contratos.Fecha) END, CASE WHEN LENGTH(day(Contratos.Fecha)) = 1 THEN concat('0',Day(Contratos.Fecha))  ELSE Day(Contratos.Fecha) END) as Fecha, 
concat(Year(Contratos.Vence), CASE WHEN LENGTH(Month(Contratos.Vence)) = 1 THEN concat('0',Month(Contratos.Vence)) ELSE Month(Contratos.Vence) END, CASE WHEN LENGTH(day(Contratos.Vence)) = 1 THEN concat('0',Day(Contratos.Vence))  ELSE Day(Contratos.Vence) END) as Vence, Solicitudes.Monto, 
(select Max(Monto) from Solicitudes as S Where ClienteID = Solicitudes.ClienteID) as MaximoCredito, Contratos.Cuota, Solicitudes.Tiempo, (SELECT Fecha FROM Recibos AS R WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1) ORDER BY ReciboID DESC Limit 1) AS FechaUltimoPago,
(SELECT Monto FROM Recibos AS R WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1) ORDER BY ReciboID DESC Limit 1) AS MontoUltimoPago, CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE   ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN
(SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM  DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE  ContratoID = Contratos.ContratoID))) < 0 THEN 0
ELSE
(SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT  SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM  Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID))
END as Balance,

IFNULL(CASE WHEN
(SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) END, 0) 
AS Atraso,

CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0
ELSE
(SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) 
END AS Cantidad,

CASE
WHEN CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE   ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM  DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT  SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM  Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END <= 10 THEN 'S' 
WHEN CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0 ELSE (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) END < 1 THEN 'N'
WHEN CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0 ELSE (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) END <= 3 THEN 'M'
WHEN CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0 ELSE (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) END <= 5 THEN 'L' ELSE 'C' END AS Status
,
Contratos.EstadoID,

CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 0 AND 30)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 0 AND 30)) END, 0) END as ENTRE0Y30,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 31 AND 60)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 31 AND 60)) END, 0) END as ENTRE31Y60,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 61 AND 90)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 61 AND 90)) END, 0) END as ENTRE61Y90,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 91 AND 120)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 91 AND 120)) END, 0) END as ENTRE91Y120,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 121 AND 150)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 121 AND 150)) END, 0) END as ENTRE121Y150,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 151 AND 180)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 151 AND 180)) END, 0) END as ENTRE151Y180,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 > 180)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 > 180)) END, 0) END as MAS180


FROM Contratos INNER JOIN
	Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN
	Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN
	Personas ON Clientes.Documento = Personas.Documento INNER JOIN
	Condiciones ON Solicitudes.CondicionID = Condiciones.CondicionID INNER JOIN
	Ciudades ON Ciudades.CiudadID = Personas.CiudadID INNER JOIN
	Provincias ON Provincias.ProvinciaID = Ciudades.ProvinciaID INNER JOIN
	Paises ON Provincias.PaisID = Paises.PaisID INNER JOIN
	TipoContratos ON Contratos.TipoContratoID = TipoContratos.TipoContratoID INNER JOIN
	Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN
	Sexos ON Personas.SexoID = Sexos.SexoID INNER JOIN
	EstadosCiviles ON Personas.EstadoCivilID = EstadosCiviles.EstadoCivilID LEFT OUTER JOIN
	DatosEconomicos ON Personas.Documento = DatosEconomicos.Documento INNER JOIN
	Ocupaciones ON DatosEconomicos.OcupacionID = Ocupaciones.OcupacionID INNER JOIN
	Instituciones ON DatosEconomicos.InstitucionID = Instituciones.InstitucionID INNER JOIN
	Zonas ON Contratos.ZonaID = Zonas.ZonaID INNER JOIN
	Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN
	TipoEmpresas ON Empresas.TipoEmpresaID = TipoEmpresas.TipoEmpresaID INNER JOIN
	Monedas ON Paises.MonedaID = Monedas.MonedaID INNER JOIN 
	TipoSolicitudes ON Solicitudes.tiposolicitudID = TipoSolicitudes.tiposolicitudID
WHERE (Contratos.EstadoID >= 2) AND (Contratos.Fecha <= @Hasta) AND (Contratos.DataCredito = 1) AND (DATEDIFF(@Hasta, (SELECT Fecha FROM Recibos AS R WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1) ORDER BY ReciboID DESC Limit 1)) <= 60)

UNION ALL /*GARANTES ACTIVOS*/

SELECT CASE WHEN TipoDocumentoID = 3 THEN 'E' else 'I' END as TipoEntidad, replace(Clientes.Documento,'-','') as Codigo, Sucursales.SucursalID, 'C' as RelacionCliente, UCASE(concat( Personas.Nombres, ' ', Personas.Apellidos)) as Cliente, replace (CASE WHEN Personas.TipoDocumentoID = 1 THEN Personas.Documento ELSE '' END, '-','') as Cedula, replace(CASE WHEN Personas.TipoDocumentoID = 2 THEN Personas.Documento ELSE '' END, '-','') Pasaporte,
CASE WHEN TipoDocumentoID = 3 THEN UCASE(concat( Personas.Nombres, ' ', Personas.Apellidos)) ELSE '' END as Empresa, CASE WHEN TipoDocumentoID = 3 THEN '' ELSE '' END as Siglas, CASE WHEN TipoDocumentoID = 3 THEN replace(replace(replace(replace(Personas.Documento, 'RNC', ''), ':',''), ' ',''), '-','') ELSE '' END as Rnc,
replace(replace(replace(replace(Personas.Telefono,'(',''),')',''),'-',''),'_','') as Telefono, replace(replace(replace(replace(instituciones.Telefono,'(',''),')',''),'-',''),'_','') as Oficina, replace(replace(replace(replace(Personas.Celular,'(',''),')',''),'-',''),'_','') as Celular, '' as Fax, '' as Correo, '' as Otro,
Personas.Direccion, '' as Esquina, '' as Casa, '' as Edificio, '' as Urbanizacion, '' as Sector, UCASE(Ciudades.Ciudad) AS Ciudad, UCase(Provincias.Provincia) as Provincia,
Contratos.ContratoID, Condiciones.Condicion, TipoContratos.TipoContratoID, TipoContratos.TipoContrato,  Contratos.Interes, CASE WHEN Paises.MonedaID = 214 THEN 'R' WHEN Paises.MonedaID = 840 THEN 'U' ELSE ''END as Moneda, CASE WHEN Solicitudes.TipoSolicitudID = 2 THEN 'HIPOTECARIO' WHEN Solicitudes.TipoSolicitudID = 4 THEN 'C' WHEN Solicitudes.TipoSolicitudID = 5 THEN 'M' ELSE 'N' END as TipoSolicitud, concat(Year(Contratos.Fecha), CASE WHEN LENGTH(Month(Contratos.Fecha)) = 1 THEN concat('0',Month(Contratos.Fecha)) ELSE Month(Contratos.Fecha) END, CASE WHEN LENGTH(day(Contratos.Fecha)) = 1 THEN concat('0',Day(Contratos.Fecha))  ELSE Day(Contratos.Fecha) END) as Fecha, 
concat(Year(Contratos.Vence), CASE WHEN LENGTH(Month(Contratos.Vence)) = 1 THEN concat('0',Month(Contratos.Vence)) ELSE Month(Contratos.Vence) END, CASE WHEN LENGTH(day(Contratos.Vence)) = 1 THEN concat('0',Day(Contratos.Vence))  ELSE Day(Contratos.Vence) END) as Vence, Solicitudes.Monto, 
(select Max(Monto) from Solicitudes as S Where ClienteID = Solicitudes.ClienteID) as MaximoCredito, Contratos.Cuota, Solicitudes.Tiempo, (SELECT Fecha FROM Recibos AS R WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1) ORDER BY ReciboID DESC Limit 1) AS FechaUltimoPago,
(SELECT Monto FROM Recibos AS R WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1) ORDER BY ReciboID DESC Limit 1) AS MontoUltimoPago, CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE   ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN
(SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM  DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE  ContratoID = Contratos.ContratoID))) < 0 THEN 0
ELSE
(SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT  SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM  Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID))
END as Balance,

IFNULL(CASE WHEN
(SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) END, 0) 
AS Atraso,

CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0
ELSE
(SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) 
END AS Cantidad,

CASE
WHEN CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE   ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM  DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT  SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM  Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END <= 10 THEN 'S' 
WHEN CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0 ELSE (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) END < 1 THEN 'N'
WHEN CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0 ELSE (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) END <= 3 THEN 'M'
WHEN CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0 ELSE (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) END <= 5 THEN 'L' ELSE 'C' END AS Status
,
Contratos.EstadoID,

CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 0 AND 30)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 0 AND 30)) END, 0) END as ENTRE0Y30,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 31 AND 60)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 31 AND 60)) END, 0) END as ENTRE31Y60,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 61 AND 90)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 61 AND 90)) END, 0) END as ENTRE61Y90,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 91 AND 120)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 91 AND 120)) END, 0) END as ENTRE91Y120,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 121 AND 150)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 121 AND 150)) END, 0) END as ENTRE121Y150,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 151 AND 180)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 151 AND 180)) END, 0) END as ENTRE151Y180,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 > 180)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 > 180)) END, 0) END as MAS180


FROM Contratos INNER JOIN
	Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN
	Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN
	GarantiaPersonal ON Solicitudes.SolicitudID = GarantiaPersonal.SolicitudID INNER JOIN
	Personas ON GarantiaPersonal.Documento = Personas.Documento INNER JOIN
	Condiciones ON Solicitudes.CondicionID = Condiciones.CondicionID INNER JOIN
	Ciudades ON Ciudades.CiudadID = Personas.CiudadID INNER JOIN
	Provincias ON Provincias.ProvinciaID = Ciudades.ProvinciaID INNER JOIN
	Paises ON Provincias.PaisID = Paises.PaisID INNER JOIN
	TipoContratos ON Contratos.TipoContratoID = TipoContratos.TipoContratoID INNER JOIN
	Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN
	Sexos ON Personas.SexoID = Sexos.SexoID INNER JOIN
	EstadosCiviles ON Personas.EstadoCivilID = EstadosCiviles.EstadoCivilID LEFT OUTER JOIN
	DatosEconomicos ON Personas.Documento = DatosEconomicos.Documento INNER JOIN
	Ocupaciones ON DatosEconomicos.OcupacionID = Ocupaciones.OcupacionID INNER JOIN
	Instituciones ON DatosEconomicos.InstitucionID = Instituciones.InstitucionID INNER JOIN
	Zonas ON Contratos.ZonaID = Zonas.ZonaID INNER JOIN
	Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN
	TipoEmpresas ON Empresas.TipoEmpresaID = TipoEmpresas.TipoEmpresaID INNER JOIN
	Monedas ON Paises.MonedaID = Monedas.MonedaID INNER JOIN 
	TipoSolicitudes ON Solicitudes.tiposolicitudID = TipoSolicitudes.tiposolicitudID
WHERE (Contratos.EstadoID = 1) AND (Contratos.Fecha <= @Hasta) AND (Contratos.DataCredito = 1)

UNION ALL /*GARANTES INACTIVOS*/

SELECT CASE WHEN TipoDocumentoID = 3 THEN 'E' else 'I' END as TipoEntidad, replace(Clientes.Documento,'-','') as Codigo, Sucursales.SucursalID, 'C' as RelacionCliente, UCASE(concat( Personas.Nombres, ' ', Personas.Apellidos)) as Cliente, replace (CASE WHEN Personas.TipoDocumentoID = 1 THEN Personas.Documento ELSE '' END, '-','') as Cedula, replace(CASE WHEN Personas.TipoDocumentoID = 2 THEN Personas.Documento ELSE '' END, '-','') Pasaporte,
CASE WHEN TipoDocumentoID = 3 THEN UCASE(concat( Personas.Nombres, ' ', Personas.Apellidos)) ELSE '' END as Empresa, CASE WHEN TipoDocumentoID = 3 THEN '' ELSE '' END as Siglas, CASE WHEN TipoDocumentoID = 3 THEN replace(replace(replace(replace(Personas.Documento, 'RNC', ''), ':',''), ' ',''), '-','') ELSE '' END as Rnc,
replace(replace(replace(replace(Personas.Telefono,'(',''),')',''),'-',''),'_','') as Telefono, replace(replace(replace(replace(instituciones.Telefono,'(',''),')',''),'-',''),'_','') as Oficina, replace(replace(replace(replace(Personas.Celular,'(',''),')',''),'-',''),'_','') as Celular, '' as Fax, '' as Correo, '' as Otro,
Personas.Direccion, '' as Esquina, '' as Casa, '' as Edificio, '' as Urbanizacion, '' as Sector, UCASE(Ciudades.Ciudad) AS Ciudad, UCase(Provincias.Provincia) as Provincia,
Contratos.ContratoID, Condiciones.Condicion, TipoContratos.TipoContratoID, TipoContratos.TipoContrato,  Contratos.Interes, CASE WHEN Paises.MonedaID = 214 THEN 'R' WHEN Paises.MonedaID = 840 THEN 'U' ELSE ''END as Moneda, CASE WHEN Solicitudes.TipoSolicitudID = 2 THEN 'HIPOTECARIO' WHEN Solicitudes.TipoSolicitudID = 4 THEN 'C' WHEN Solicitudes.TipoSolicitudID = 5 THEN 'M' ELSE 'N' END as TipoSolicitud, concat(Year(Contratos.Fecha), CASE WHEN LENGTH(Month(Contratos.Fecha)) = 1 THEN concat('0',Month(Contratos.Fecha)) ELSE Month(Contratos.Fecha) END, CASE WHEN LENGTH(day(Contratos.Fecha)) = 1 THEN concat('0',Day(Contratos.Fecha))  ELSE Day(Contratos.Fecha) END) as Fecha, 
concat(Year(Contratos.Vence), CASE WHEN LENGTH(Month(Contratos.Vence)) = 1 THEN concat('0',Month(Contratos.Vence)) ELSE Month(Contratos.Vence) END, CASE WHEN LENGTH(day(Contratos.Vence)) = 1 THEN concat('0',Day(Contratos.Vence))  ELSE Day(Contratos.Vence) END) as Vence, Solicitudes.Monto, 
(select Max(Monto) from Solicitudes as S Where ClienteID = Solicitudes.ClienteID) as MaximoCredito, Contratos.Cuota, Solicitudes.Tiempo, (SELECT Fecha FROM Recibos AS R WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1) ORDER BY ReciboID DESC Limit 1) AS FechaUltimoPago,
(SELECT Monto FROM Recibos AS R WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1) ORDER BY ReciboID DESC Limit 1) AS MontoUltimoPago, CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE   ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN
(SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM  DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE  ContratoID = Contratos.ContratoID))) < 0 THEN 0
ELSE
(SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT  SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM  Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID))
END as Balance,

IFNULL(CASE WHEN
(SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) END, 0) 
AS Atraso,

CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0
ELSE
(SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) 
END AS Cantidad,

CASE
WHEN CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM  DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE   ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM  DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT  SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM  Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END <= 10 THEN 'S' 
WHEN CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0 ELSE (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) END < 1 THEN 'N'
WHEN CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0 ELSE (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) END <= 3 THEN 'M'
WHEN CASE WHEN CASE WHEN ( SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM  Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE Vence <= @Hasta AND ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (Vence <= @Hasta) AND (ContratoID = Contratos.ContratoID)))), 0) AS Balance FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID)) END < 1 THEN 0 ELSE (SELECT COUNT(CuotaID) AS Cantidad FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (Capital + Comision + Interes + Mora + Legal + Seguro + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE  (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaDebitos AS ND WHERE (CuotaID = C.CuotaID)) < 1 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID = C.CuotaID)) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (DR.CuotaID = C.CuotaID)), 0) > 1)) END <= 5 THEN 'L' ELSE 'C' END AS Status
,
Contratos.EstadoID,

CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 0 AND 30)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 0 AND 30)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 0 AND 30)) END, 0) END as ENTRE0Y30,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 31 AND 60)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 31 AND 60)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 31 AND 60)) END, 0) END as ENTRE31Y60,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 61 AND 90)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 61 AND 90)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 61 AND 90)) END, 0) END as ENTRE61Y90,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 91 AND 120)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 91 AND 120)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 91 AND 120)) END, 0) END as ENTRE91Y120,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 121 AND 150)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 121 AND 150)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 121 AND 150)) END, 0) END as ENTRE121Y150,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 151 AND 180)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 BETWEEN 151 AND 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 BETWEEN 151 AND 180)) END, 0) END as ENTRE151Y180,
CASE WHEN IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 > 180)) END, 0) < 0 THEN 0 ELSE IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM  Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta)) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) + IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS ND FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaDebitos AS ND WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL(CASE WHEN (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS NC FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) < 0 THEN 0 ELSE (SELECT SUM(Capital + Comision + Interes + Mora + Legal + Seguro) AS Expr1 FROM DetalleNotaCreditos AS NC WHERE (CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND  ContratoID = Contratos.ContratoID))) END, 0) - IFNULL ((SELECT SUM(DR.Capital + DR.Comision + DR.Interes + DR.Mora + DR.Legal + DR.Seguro) AS Pagado FROM Recibos AS R INNER JOIN DetalleRecibos AS DR ON R.ReciboID = DR.ReciboID WHERE (R.EstadoID = 1) AND (R.Fecha <= @Hasta) AND (DR.CuotaID IN (SELECT CuotaID FROM Cuotas AS c11 WHERE (c11.Vence <= @Hasta) AND (DATEDIFF(c11.Vence, @Hasta) * -1 > 180)  AND (ContratoID = Contratos.ContratoID)))), 0) AS Atraso FROM Cuotas AS C WHERE (ContratoID = Contratos.ContratoID) AND (Vence <= @Hasta) AND (DATEDIFF(Vence, @Hasta) * -1 > 180)) END, 0) END as MAS180


FROM Contratos INNER JOIN
	Solicitudes ON Contratos.SolicitudID = Solicitudes.SolicitudID INNER JOIN
	Clientes ON Solicitudes.ClienteID = Clientes.ClienteID INNER JOIN
	GarantiaPersonal ON Solicitudes.SolicitudID = GarantiaPersonal.SolicitudID INNER JOIN
	Personas ON GarantiaPersonal.Documento = Personas.Documento INNER JOIN
	Condiciones ON Solicitudes.CondicionID = Condiciones.CondicionID INNER JOIN
	Ciudades ON Ciudades.CiudadID = Personas.CiudadID INNER JOIN
	Provincias ON Provincias.ProvinciaID = Ciudades.ProvinciaID INNER JOIN
	Paises ON Provincias.PaisID = Paises.PaisID INNER JOIN
	TipoContratos ON Contratos.TipoContratoID = TipoContratos.TipoContratoID INNER JOIN
	Sucursales ON Clientes.SucursalID = Sucursales.SucursalID INNER JOIN
	Sexos ON Personas.SexoID = Sexos.SexoID INNER JOIN
	EstadosCiviles ON Personas.EstadoCivilID = EstadosCiviles.EstadoCivilID LEFT OUTER JOIN
	DatosEconomicos ON Personas.Documento = DatosEconomicos.Documento INNER JOIN
	Ocupaciones ON DatosEconomicos.OcupacionID = Ocupaciones.OcupacionID INNER JOIN
	Instituciones ON DatosEconomicos.InstitucionID = Instituciones.InstitucionID INNER JOIN
	Zonas ON Contratos.ZonaID = Zonas.ZonaID INNER JOIN
	Empresas ON Sucursales.EmpresaID = Empresas.EmpresaID INNER JOIN
	TipoEmpresas ON Empresas.TipoEmpresaID = TipoEmpresas.TipoEmpresaID INNER JOIN
	Monedas ON Paises.MonedaID = Monedas.MonedaID INNER JOIN 
	TipoSolicitudes ON Solicitudes.tiposolicitudID = TipoSolicitudes.tiposolicitudID
WHERE (Contratos.EstadoID >= 2) AND (Contratos.Fecha <= @Hasta) AND (Contratos.DataCredito = 1) AND (DATEDIFF(@Hasta, (SELECT Fecha FROM Recibos AS R WHERE (ContratoID = Contratos.ContratoID) AND (EstadoID = 1) ORDER BY ReciboID DESC Limit 1)) <= 60)
